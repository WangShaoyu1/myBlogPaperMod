<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>大模型LLM&#43;（有限）在线搜索 | PaperMod</title>
<meta name="keywords" content="GPT相关">
<meta name="description" content="GPT相关">
<meta name="author" content="王宇">
<link rel="canonical" href="http://localhost:1313/posts/wiki/%E5%A4%A7%E6%A8%A1%E5%9E%8Bllm&#43;%E6%9C%89%E9%99%90%E5%9C%A8%E7%BA%BF%E6%90%9C%E7%B4%A2/">
<meta name="google-site-verification" content="XYZabc">
<link crossorigin="anonymous" href="/assets/css/stylesheet.7b92bf4867c997b58ec50f63451b83777173d5bd5593376852abd85746d09d71.css" integrity="sha256-e5K/SGfJl7WOxQ9jRRuDd3Fz1b1VkzdoUqvYV0bQnXE=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/%3Clink%20/%20abs%20url%3E">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/%3Clink%20/%20abs%20url%3E">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/%3Clink%20/%20abs%20url%3E">
<link rel="apple-touch-icon" href="http://localhost:1313/%3Clink%20/%20abs%20url%3E">
<link rel="mask-icon" href="http://localhost:1313/%3Clink%20/%20abs%20url%3E">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="http://localhost:1313/posts/wiki/%E5%A4%A7%E6%A8%A1%E5%9E%8Bllm&#43;%E6%9C%89%E9%99%90%E5%9C%A8%E7%BA%BF%E6%90%9C%E7%B4%A2/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript><meta property="og:title" content="大模型LLM&#43;（有限）在线搜索" />
<meta property="og:description" content="GPT相关" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/posts/wiki/%E5%A4%A7%E6%A8%A1%E5%9E%8Bllm&#43;%E6%9C%89%E9%99%90%E5%9C%A8%E7%BA%BF%E6%90%9C%E7%B4%A2/" />
<meta property="og:image" content="http://localhost:1313/images/papermod-cover.png" />
<meta property="article:section" content="posts" />




<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="http://localhost:1313/images/papermod-cover.png" />
<meta name="twitter:title" content="大模型LLM&#43;（有限）在线搜索"/>
<meta name="twitter:description" content="GPT相关"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "http://localhost:1313/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "大模型LLM+（有限）在线搜索",
      "item": "http://localhost:1313/posts/wiki/%E5%A4%A7%E6%A8%A1%E5%9E%8Bllm+%E6%9C%89%E9%99%90%E5%9C%A8%E7%BA%BF%E6%90%9C%E7%B4%A2/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "大模型LLM+（有限）在线搜索",
  "name": "大模型LLM\u002b（有限）在线搜索",
  "description": "GPT相关",
  "keywords": [
    "GPT相关"
  ],
  "articleBody": " 众所周知，大模型的能力非常强，但是其训练数据是截至某个时间的数据，故对于某些需要搜索近期信息的场景，无法满足，这可以结合搜索引擎来弥补。同时，还可以结合某些/某个具体的网站来提供近期信息。比如说，某个用户输入，大模型无法回答，就调用知乎或者github或者其他专业网站上的信息。\n1. 需求描述 Actor\n大模型LLM\nPrompt\n大模型知识库\n外部知识\n向量库\n外部搜索\n补充：本需求先不探讨这个方向\n大模型能够回复\n大模型不能回复\n//\u003c![CDATA[ (function() { $ = AJS.$; var graphContainer = document.getElementById(‘drawio-macro-content-3e866b00-a6ca-4dc8-8b3c-e2624395e867’); DrawioProperties = { contextPath : AJS.contextPath(), buildNumber : 8401 }; var readerOpts = {}; readerOpts.loadUrl = ’’ + ‘/rest/drawio/1.0/diagram/crud/%E6%9C%AA%E5%91%BD%E5%90%8D%E7%BB%98%E5%9B%BE/129181863?revision=2’; readerOpts.imageUrl = ’’ + ‘/download/attachments/129181863/未命名绘图.png’ + ‘?version=2\u0026api=v2’; readerOpts.editUrl = ’’ + ‘/plugins/drawio/addDiagram.action?ceoId=129181863\u0026owningPageId=129181863\u0026diagramName=%E6%9C%AA%E5%91%BD%E5%90%8D%E7%BB%98%E5%9B%BE\u0026revision=2’; readerOpts.editable = true; readerOpts.canComment = true; readerOpts.stylePath = STYLE_PATH; readerOpts.stencilPath = STENCIL_PATH; readerOpts.imagePath = IMAGE_PATH + ‘/reader’; readerOpts.border = true; readerOpts.width = ‘600’; readerOpts.simpleViewer = false; readerOpts.tbstyle = ’top’; readerOpts.links = ‘auto’; readerOpts.lightbox = true; readerOpts.resourcePath = ATLAS_RESOURCE_BASE + ‘/resources/viewer’; readerOpts.disableButtons = false; readerOpts.zoomToFit = true; readerOpts.language = ‘zh’; readerOpts.licenseStatus = ‘OK’; readerOpts.contextPath = AJS.contextPath(); readerOpts.diagramName = decodeURIComponent(’%E6%9C%AA%E5%91%BD%E5%90%8D%E7%BB%98%E5%9B%BE’); readerOpts.diagramDisplayName = ‘’; readerOpts.aspect = ‘’; readerOpts.ceoName = ‘大模型LLM+（有限）在线搜索’; readerOpts.attVer = ‘2’; readerOpts.attId = ‘129181867’; readerOpts.lastModifierName = ‘王宇’; readerOpts.lastModified = ‘2024-07-14 22:17:20.791’; readerOpts.creatorName = ‘王宇’; //Embed macro specific info readerOpts.extSrvIntegType = ‘$extSrvIntegType’; readerOpts.gClientId = ‘$gClientId’; readerOpts.oClientId = ‘$oClientId’; readerOpts.service = ‘$service’; readerOpts.sFileId = ‘$sFileId’; readerOpts.odriveId = ‘$odriveId’; readerOpts.diagramUrl = ‘$diagramUrl’; readerOpts.csvFileUrl = ‘$csvFileUrl’; readerOpts.pageId = ‘$pageId’ || Confluence.getContentId(); readerOpts.aspectHash = ‘$aspectHash’; readerOpts.useExternalImageService = ‘$useExternalImageService’ == ’true’; readerOpts.isTemplate = ‘$isTemplate’ == ’true’; if (readerOpts.width == ‘’) { readerOpts.width = null; } // LATER: Check if delayed loading of resources can be used for image placeholder mode var viewerPromise = createViewer(graphContainer, readerOpts); if(readerOpts.editable) { $(graphContainer).data(‘viewerConfig’, readerOpts); $(graphContainer).on(‘drawioViewerUpdate’, updateDrawioViewer); } viewerPromise.done(function(viewer) { updateCachedDiagram(graphContainer, readerOpts, viewer); }); })(); //]]\u003e\n2. 方案设计 Actor\n大模型知识库\n搜索引擎能力\n(谷歌)\n大模型LLM\n判断\n1、爬取网站\n2、获取具体内容\n内容存放在文件中\n大模型LLM推理，组合答案\nPrompt\n能\n不能\nFunction Calling\n目标网址\n知乎\nGithub\nCSDN\nStackOverFlow\nHuggingFace\n……\n//\u003c![CDATA[ (function() { $ = AJS.$; var graphContainer = document.getElementById(‘drawio-macro-content-17c00d34-7b64-4e82-924c-c1515904e05a’); DrawioProperties = { contextPath : AJS.contextPath(), buildNumber : 8401 }; var readerOpts = {}; readerOpts.loadUrl = ’’ + ‘/rest/drawio/1.0/diagram/crud/%31%31/129181863?revision=1’; readerOpts.imageUrl = ’’ + ‘/download/attachments/129181863/11.png’ + ‘?version=1\u0026api=v2’; readerOpts.editUrl = ’’ + ‘/plugins/drawio/addDiagram.action?ceoId=129181863\u0026owningPageId=129181863\u0026diagramName=%31%31\u0026revision=1’; readerOpts.editable = true; readerOpts.canComment = true; readerOpts.stylePath = STYLE_PATH; readerOpts.stencilPath = STENCIL_PATH; readerOpts.imagePath = IMAGE_PATH + ‘/reader’; readerOpts.border = true; readerOpts.width = ‘600’; readerOpts.simpleViewer = false; readerOpts.tbstyle = ’top’; readerOpts.links = ‘auto’; readerOpts.lightbox = true; readerOpts.resourcePath = ATLAS_RESOURCE_BASE + ‘/resources/viewer’; readerOpts.disableButtons = false; readerOpts.zoomToFit = true; readerOpts.language = ‘zh’; readerOpts.licenseStatus = ‘OK’; readerOpts.contextPath = AJS.contextPath(); readerOpts.diagramName = decodeURIComponent(’%31%31’); readerOpts.diagramDisplayName = ‘’; readerOpts.aspect = ‘’; readerOpts.ceoName = ‘大模型LLM+（有限）在线搜索’; readerOpts.attVer = ‘1’; readerOpts.attId = ‘129181878’; readerOpts.lastModifierName = ‘王宇’; readerOpts.lastModified = ‘2024-07-14 22:45:25.331’; readerOpts.creatorName = ‘王宇’; //Embed macro specific info readerOpts.extSrvIntegType = ‘$extSrvIntegType’; readerOpts.gClientId = ‘$gClientId’; readerOpts.oClientId = ‘$oClientId’; readerOpts.service = ‘$service’; readerOpts.sFileId = ‘$sFileId’; readerOpts.odriveId = ‘$odriveId’; readerOpts.diagramUrl = ‘$diagramUrl’; readerOpts.csvFileUrl = ‘$csvFileUrl’; readerOpts.pageId = ‘$pageId’ || Confluence.getContentId(); readerOpts.aspectHash = ‘$aspectHash’; readerOpts.useExternalImageService = ‘$useExternalImageService’ == ’true’; readerOpts.isTemplate = ‘$isTemplate’ == ’true’; if (readerOpts.width == ‘’) { readerOpts.width = null; } // LATER: Check if delayed loading of resources can be used for image placeholder mode var viewerPromise = createViewer(graphContainer, readerOpts); if(readerOpts.editable) { $(graphContainer).data(‘viewerConfig’, readerOpts); $(graphContainer).on(‘drawioViewerUpdate’, updateDrawioViewer); } viewerPromise.done(function(viewer) { updateCachedDiagram(graphContainer, readerOpts, viewer); }); })(); //]]\u003e\n2.1. 技术选型 功能模块\n技术选型\n备注\n功能模块\n技术选型\n备注\n大模型\nGPT模型/GLM4大模型/其他模型\n调用API的方法，目前绝大部分模型都和GPT系列差不多。考虑到获取API_KEY操作的方便性，本文选用智谱AI的API\n搜索技术\n谷歌搜索API、爬虫\n也可以用其他的搜索。如：DuckDuckGo\n性能优化\n提示词工程\n针对不同的网站，提示词可以进一步优化\n2.2. 谷歌云平台注册 2.2.1. 第一步：获取API_KEY 访问地址：https://console.cloud.google.com/\n操作步骤如下：\n第一步\n第二步\n第三步\n第四步\n第五步\n第六步\n第七步\n第八步\n第九步\n第十步\n2.2.2. 第二步：注册可编程的搜索引擎 访问地址：https://programmablesearchengine.google.com/\n第一步\n第二步\n第三步\n第一步\n第二步\n第三步\n经过这两个步骤，就能够完成谷歌搜索的API调用了，有两个地方需要注意下：\n搜索引擎可以选择在指定域名下搜索，见2.2.2第二步 谷歌搜索API每天免费使用100次，见：https://developers.google.com/custom-search/v1/overview?hl=zh_CN 2.2.3. 谷歌搜索API的使用 请求网址为：https://www.googleapis.com/customsearch/v1?[parameters]\n具体的使用文档见：https://developers.google.com/custom-search/v1/using_rest?hl=zh-cn\n详细的字段说明文档见：https://developers.google.com/custom-search/v1/reference/rest/v1/cse/list#request\n常用参数解析：\n参数名\n详情\n备注\n参数名\n详情\n备注\nkey\n谷歌搜索API密钥，详见：2.2.1步骤\n必填\ncx\n可编程搜索引擎ID，详见：2.2.2步骤\n必填\nq\n搜索内容表达式\n必填\nc2coff\n启用或停用简体中文，默认为0（启用）\n0：启用\n1：停用\ncr\n将搜索结果限制为来自特定国家/地区的文档\n1、国家 /地区标识查询：https://developers.google.com/custom-search/docs/json_api_reference?hl=zh-cn#countryCollections\n2、Google 搜索通过分析以下内容来确定文档所在的国家/地区：\n文档网址的顶级域名 (TLD)\nWeb 服务器 IP 地址的地理位置\ndateRestrict\n搜索特定时间段\nlr\n搜索以特定语言撰写的文档\nnum\n要返回的搜索结果数\n有效值为 1 到 10 之间的整数（包括 1 和 10）\nsiteSearch\n指定应始终从结果中包含或排除的给定网站\n结合下面的siteSearchFilter\nsiteSearchFilter\nenum (`[SiteSearchFilter](https://developers.google.com/custom-search/v1/reference/rest/v1/SiteSearchFilter?hl=zh-cn)`)\n控制是否包含或排除 siteSearch 参数中指定的网站的结果。\n可接受的值为：\n\"e\"：排除\n\"i\"：包含\n默认为：\"i\"：包含\n3. 具体实现（含代码） 3.1. ZhiPu AI GPT模型（示例） 智谱AI官网：https://bigmodel.cn/，注册一个账号，登录进去，进入 “开发工作台”，很方便就能获取到API_KEY\n一个最简版本的请求如下：\n?\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\nffrom zhipuai import ZhipuAI\nclient = ZhipuAI(api_key``=``api_key)\ndef chat_completion_request(messages, tools``=``None``, tool_choice``=``None``, model``=``GPT_MODEL):\ntry``:\nresponse = client.chat.completions.create(\nmodel``=``model,\nmessages``=``messages,\ntools``=``tools,\ntool_choice``=``tool_choice,\n)\nreturn response\nexcept Exception as e:\nprint``(``\"Unable to generate ChatCompletion response\"``)\nprint``(f``\"Exception: {e}\"``)\nreturn e\n在一步中，需要用到ZhiPu的Function calling功能，以实现，如果大模型能回答则直接回答，如果不能回答就执行Function Calling。其中需要关注的有两点：\nZhiPu GPT的Function Calling的写法 提示词上需要实现如上流程流转 补充上Function calling实现：\n?\n1\n/``/ 定义Tool，函数定义\n3.2. 一些测试 3.2.1. 大模型回答问题策略测试 3.2.1.1. 提示词 ?\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\nresponse = client.chat.completions.create(\nmodel``=``\"glm-4\"``,\nmessages``=``[\n{``\"role\"``: \"system\"``, \"content\"``: \"根据用户输入的问题进行回答，如果知道问题的答案，请回答问题答案，如果不知道问题答案，请回复‘抱歉，这个问题我并不知道’\"``},\n{``\"role\"``: \"user\"``, \"content\"``: \"请问，什么是机器学习？\"``}\n]\n)\nresponse.choices[``0``].message.content\n-``-``-``output\n'机器学习是人工智能的一个核心领域，它让计算机能够模拟人类的学习和思考方式。通过使用大量数据和算法，机器学习可以使计算机学会分类、回归和聚类等任务，从而让计算机能够从数据中提取知识，进行决策和预测。在机器学习的流程中，包括数据获取、特征工程、建立模型、模型评估以及调参等步骤。深度学习和强化学习是机器学习的两个重要分支。深度学习主要用于处理复杂结构数据的建模问题，而强化学习则让机器在探索环境中通过试错进行学习。'\n?\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\nresponse = client.chat.completions.create(\nmodel``=``\"glm-4\"``,\nmessages``=``[\n{``\"role\"``: \"system\"``, \"content\"``: \"根据用户输入的问题进行回答，如果知道问题的答案，请回答问题答案，如果不知道问题答案，请回复‘抱歉，这个问题我并不知道’\"``},\n{``\"role\"``: \"user\"``, \"content\"``: \"介绍一下关于GPT-6的猜想\"``}\n]\n)\nresponse.choices[``0``].message.content\n-``-``-``output\n'抱歉，这个问题我并不知道。\\n\\n到2023为止，GPT-6尚未被公开提及或发布。GPT（Generative Pre-trained Transformer）系列模型由OpenAI开发，至今已发布了多个版本，如GPT-2和GPT-3。关于未来版本的GPT，如GPT-6，可能会有很多猜想和预期，但具体的内容和功能我无法提供，因为那将基于未来尚未公开的技术和信息。如果GPT-6在您提问之后有了新的消息，我可能无法获取那些最新的信息。'\n3.2.1.2. 增加外部函数 测试的目的是：检测增加了外部函数的情况下，glm4回答同一个问题的时候，是不是都倾向于走外部函数\n外部函数：有参数定义、函数描述、返回值\n智谱的tools格式为：\n?\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\ntools = [\n{\n\"type\"``: \"function\"``,\n\"function\"``: {\n\"name\"``: \"get_flight_number\"``,\n\"description\"``: \"根据始发地、目的地和日期，查询对应日期的航班号\"``,\n\"parameters\"``: {\n......\n},\n}\n}，\n...\n]\n测试函数为：\n?\n1\n2\n3\n4\n5\n6\n7\ndef ml_answer(q``=``'什么是机器学习'``):\n\"\"\"\n解释什么是机器学习，返回机器学习的定义和解释\n:param q: 询问的问题，非必要参数，字符串类型对象\n:return：返回机器学习的定义和解释\n\"\"\"\nreturn``(``\"机器学习是一种人工智能（AI）的分支领域，旨在使计算机系统通过学习和经验改进性能。\"``)\n现在将测试函数转化为tool需要的格式，写一个转换函数，里面也会用到glm4：\nauto_functions生成tool需要的格式 展开源码\nexpand source?\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n37\n38\n39\n40\n41\n42\n43\n44\n45\n46\n47\n48\n49\n50\n51\n52\n53\ndef auto_functions(functions_list):\n\"\"\"\nChat模型的functions参数编写函数\n:param functions_list: 包含一个或者多个函数对象的列表；\n:return：满足Chat模型functions参数要求的functions对象\n\"\"\"\ndef functions_generate(functions_list):\n# 创建空列表，用于保存每个函数的描述字典\nfunctions = []\n# 对每个外部函数进行循环\nfor function in functions_list:\n# 读取函数对象的函数说明\nfunction_description = inspect.getdoc(function)\n# 读取函数的函数名字符串\nfunction_name = function.__name__\nsystem_prompt = '以下是某的函数说明：%s,输出结果必须是一个JSON格式的字典，只输出这个字典即可，前后不需要任何前后修饰或说明的语句' % function_description\nuser_prompt = '根据这个函数的函数说明，请帮我创建一个JSON格式的字典，这个字典有如下``5``点要求：\\\n1.``字典总共有三个键值对；\\\n2.``第一个键值对的Key是字符串name，value是该函数的名字：``%``s，也是字符串；\\\n3.``第二个键值对的Key是字符串description，value是该函数的函数的功能说明，也是字符串；\\\n4.``第三个键值对的Key是字符串parameters，value是一个JSON Schema对象，用于说明该函数的参数输入规范。\\\n5.``输出结果必须是一个JSON格式的字典，只输出这个字典即可，前后不需要任何前后修饰或说明的语句' % function_name\nresponse = client.chat.completions.create(\nmodel``=``\"glm-4\"``,\nmessages``=``[\n{``\"role\"``: \"system\"``, \"content\"``: system_prompt},\n{``\"role\"``: \"user\"``, \"content\"``: user_prompt}\n]\n)\njson_str``=``response.choices[``0``].message.content.replace(``\"```json\"``,\"``\").replace(\"`` ``` ``\",\"``\")\njson_function_description``=``json.loads(json_str)\njson_str``=``{``\"type\"``: \"function\"``,``\"function\"``:json_function_description}\nfunctions.append(json_str)\nreturn functions\n## 最大可以尝试4次\nmax_attempts = 4\nattempts = 0\nwhile attempts \u003c max_attempts:\ntry``:\nfunctions = functions_generate(functions_list)\nbreak # 如果代码成功执行，跳出循环\nexcept Exception as e:\nattempts +``= 1 # 增加尝试次数\nprint``(``\"发生错误：\"``, e)\nif attempts =``= max_attempts:\nprint``(``\"已达到最大尝试次数，程序终止。\"``)\nraise # 重新引发最后一个异常\nelse``:\nprint``(``\"正在重新运行...\"``)\nreturn functions\n执行auto_function([ml_answer])，能够生成tool需要的格式。接下来测试面对一个问题，在有外部函数能执行functuon call的情况下，到底是执行function call呢还是大模型直接执行。\n直接执行glm4执行函数，发现面对同一个问题“什么是机器学习”，有时候直接回答，有时候通过外部函数回答，要解决这个不稳定的问题\nglm4执行 展开源码\nexpand source?\n1\n2\n3\n4\n5\n6\n7\n8\n9\nresponse = client.chat.completions.create(\nmodel``=``\"glm-4\"``,\nmessages``=``[\n{``\"role\"``: \"user\"``, \"content\"``: \"解释什么是机器学习？\"``}\n],\ntools``=``tools,\ntool_choice``=``\"auto\"\n)\nresponse.choices[``0``].message\n提示词很细腻，轻微的差别，也许回复就会差别很大，\n提示词1：system_prompt = ‘以下是某函数的函数说明：%s，输出结果必须是一个JSON格式的字典，只输出这个字典即可，前后不需要任何修饰或说明的语句’ % function_description\n提示词2：system_prompt = ‘以下是某函数的函数说明：%s，输出结果必须是一个JSON格式的字典，只输出这个字典即可，前后不需要任何前后修饰或说明的语句’ % function_description\n提示词1返回结果为：\nglm4执行 展开源码\nexpand source?\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n以下是符合您要求的JSON格式字典：\n```json\n{\n\"name\"``: \"sunwukong_function\"``,\n\"description\"``: \"该函数定义了数据集计算过程，接受数据表作为输入，并返回计算后的结果。\"``,\n\"parameters\"``: {\n\"type\"``: \"object\"``,\n\"required\"``: [``\"data\"``],\n\"properties\"``: {\n\"data\"``: {\n\"type\"``: \"string\"``,\n\"description\"``: \"带入计算的数据表，用字符串进行表示\"\n}\n},\n\"additionalProperties\"``: false\n}\n}\n```\n这个JSON对象包含三个键值对：\n1. ` ```\"name\"``` ` 键对应着函数的名字。\n2. ` ```\"description\"``` ` 键提供了函数的功能说明。\n3. ` ```\"parameters\"``` ` 键包含一个JSON Schema对象，描述了函数的参数输入规范，包括数据类型和描述，并指出` ```\"data\"``` `参数是必须的（` ```\"required\": [\"data\"``` ]`）。此外，` ```\"additionalProperties\"```: false`确保没有其他额外的参数被传入函数。\n提示词2返回结果为：\nglm4执行 展开源码\nexpand source?\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n{\n\"name\"``: \"sunwukong_function\"``,\n\"description\"``: \"该函数定义了数据集计算过程，接收一个数据表作为输入，并返回计算后的结果。\"``,\n\"parameters\"``: {\n\"type\"``: \"object\"``,\n\"properties\"``: {\n\"data\"``: {\n\"type\"``: \"string\"``,\n\"description\"``: \"必要参数，表示带入计算的数据表，用字符串进行表示\"\n}\n},\n\"required\"``: [``\"data\"``]\n}\n}\n提示词2的输出100%是json格式的内容，而提示词1的输出内容中，每次都包含前后的修饰性的中文，当然也包含JSON部分的内容，夹在在一起。而这两份提示词之间的区别，就是提示词2多了两个字“前后”，差别却很大。\n工程上的处理，其实要预防着 输出的文本不只是 纯字符串类型的JSON格式的内容，抽取夹杂着修饰性文本+JSON格式内容字符串的，而不能完全依赖大模型的返回。可以保险期间，如果结果是需要代码块的，需要执行代码提取函数。函数如下：\nextract_code_block提取代码块\n?\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\ndef extract_code_block(text, language):\n\"\"\"\n提取文本中的指定语言的代码块，并返回代码块的字符串内容。\n:param text: 包含代码块的字符串\n:param language: 代码块语言标记，例如'json', 'python', 'java'等\n:return: 提取的代码块内容字符串，如果未找到则返回None\n\"\"\"\npattern = re.``compile``(rf``'```{language}\\n(.*?)\\n```'``, re.DOTALL)\nmatch = pattern.search(text)\nif match:\nreturn match.group(``1``)\nelse``:\nprint``(f``\"未找到 {language} 代码块\"``)\nreturn None\n3.3. 增加外部函数回复稳定性 Filter table dataCreate a pivot tableCreate a chart from data series\nConfigure buttons visibility\n",
  "wordCount" : "1183",
  "inLanguage": "zh",
  "image": "http://localhost:1313/images/papermod-cover.png","datePublished": "0001-01-01T00:00:00Z",
  "dateModified": "0001-01-01T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "王宇"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://localhost:1313/posts/wiki/%E5%A4%A7%E6%A8%A1%E5%9E%8Bllm+%E6%9C%89%E9%99%90%E5%9C%A8%E7%BA%BF%E6%90%9C%E7%B4%A2/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "PaperMod",
    "logo": {
      "@type": "ImageObject",
      "url": "http://localhost:1313/%3Clink%20/%20abs%20url%3E"
    }
  }
}
</script>
</head>

<body class=" dark" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Home (Alt + H)">
                        
                    <img src="http://localhost:1313/images/msg_hu15231257772499651944.png" alt="" aria-label="logo"
                        height="20">Home</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/archives" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://github.com/adityatelange/hugo-PaperMod/wiki/" title="WiKi">
                    <span>WiKi</span>&nbsp;
                    <svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round"
                        stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12">
                        <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path>
                        <path d="M15 3h6v6"></path>
                        <path d="M10 14L21 3"></path>
                    </svg>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/">主页</a>&nbsp;»&nbsp;<a href="http://localhost:1313/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      大模型LLM&#43;（有限）在线搜索
    </h1>
    <div class="post-description">
      GPT相关
    </div>
    <div class="post-meta">6 分钟&nbsp;·&nbsp;王宇&nbsp;|&nbsp;<a href="https://github.com/WangShaoyu1/myBlogPaperMod/tree/master/content/posts/wiki/%e5%a4%a7%e6%a8%a1%e5%9e%8bLLM&#43;%ef%bc%88%e6%9c%89%e9%99%90%ef%bc%89%e5%9c%a8%e7%ba%bf%e6%90%9c%e7%b4%a2.md" rel="noopener noreferrer" target="_blank">Suggest Changes</a>

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">目录</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#1-%e9%9c%80%e6%b1%82%e6%8f%8f%e8%bf%b0" aria-label="1. 需求描述">1. 需求描述</a></li>
                <li>
                    <a href="#2-%e6%96%b9%e6%a1%88%e8%ae%be%e8%ae%a1" aria-label="2. 方案设计">2. 方案设计</a><ul>
                        
                <li>
                    <a href="#21-%e6%8a%80%e6%9c%af%e9%80%89%e5%9e%8b" aria-label="2.1. 技术选型">2.1. 技术选型</a></li>
                <li>
                    <a href="#22-%e8%b0%b7%e6%ad%8c%e4%ba%91%e5%b9%b3%e5%8f%b0%e6%b3%a8%e5%86%8c" aria-label="2.2. 谷歌云平台注册">2.2. 谷歌云平台注册</a><ul>
                        
                <li>
                    <a href="#221-%e7%ac%ac%e4%b8%80%e6%ad%a5%e8%8e%b7%e5%8f%96api_key" aria-label="2.2.1. 第一步：获取API_KEY">2.2.1. 第一步：获取API_KEY</a></li>
                <li>
                    <a href="#222-%e7%ac%ac%e4%ba%8c%e6%ad%a5%e6%b3%a8%e5%86%8c%e5%8f%af%e7%bc%96%e7%a8%8b%e7%9a%84%e6%90%9c%e7%b4%a2%e5%bc%95%e6%93%8e" aria-label="2.2.2. 第二步：注册可编程的搜索引擎">2.2.2. 第二步：注册可编程的搜索引擎</a></li>
                <li>
                    <a href="#223-%e8%b0%b7%e6%ad%8c%e6%90%9c%e7%b4%a2api%e7%9a%84%e4%bd%bf%e7%94%a8" aria-label="2.2.3. 谷歌搜索API的使用">2.2.3. 谷歌搜索API的使用</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#3-%e5%85%b7%e4%bd%93%e5%ae%9e%e7%8e%b0%e5%90%ab%e4%bb%a3%e7%a0%81" aria-label="3. 具体实现（含代码）">3. 具体实现（含代码）</a><ul>
                        
                <li>
                    <a href="#31-zhipu-ai-gpt%e6%a8%a1%e5%9e%8b%e7%a4%ba%e4%be%8b" aria-label="3.1. ZhiPu AI GPT模型（示例）">3.1. ZhiPu AI GPT模型（示例）</a></li>
                <li>
                    <a href="#32-%e4%b8%80%e4%ba%9b%e6%b5%8b%e8%af%95" aria-label="3.2. 一些测试">3.2. 一些测试</a><ul>
                        
                <li>
                    <a href="#321-%e5%a4%a7%e6%a8%a1%e5%9e%8b%e5%9b%9e%e7%ad%94%e9%97%ae%e9%a2%98%e7%ad%96%e7%95%a5%e6%b5%8b%e8%af%95" aria-label="3.2.1. 大模型回答问题策略测试">3.2.1. 大模型回答问题策略测试</a><ul>
                        
                <li>
                    <a href="#3211-%e6%8f%90%e7%a4%ba%e8%af%8d" aria-label="3.2.1.1. 提示词">3.2.1.1. 提示词</a></li>
                <li>
                    <a href="#3212-%e5%a2%9e%e5%8a%a0%e5%a4%96%e9%83%a8%e5%87%bd%e6%95%b0" aria-label="3.2.1.2. 增加外部函数">3.2.1.2. 增加外部函数</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#33-%e5%a2%9e%e5%8a%a0%e5%a4%96%e9%83%a8%e5%87%bd%e6%95%b0%e5%9b%9e%e5%a4%8d%e7%a8%b3%e5%ae%9a%e6%80%a7" aria-label="3.3. 增加外部函数回复稳定性">3.3. 增加外部函数回复稳定性</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>        众所周知，大模型的能力非常强，但是其训练数据是截至某个时间的数据，故对于某些需要搜索近期信息的场景，无法满足，这可以结合搜索引擎来弥补。同时，还可以结合某些/某个具体的网站来提供近期信息。比如说，某个用户输入，大模型无法回答，就调用知乎或者github或者其他专业网站上的信息。</p>
<h1 id="1-需求描述">1. 需求描述<a hidden class="anchor" aria-hidden="true" href="#1-需求描述">#</a></h1>
<p>Actor</p>
<p>大模型LLM</p>
<p>Prompt</p>
<p>大模型知识库</p>
<p>外部知识<br>
向量库</p>
<p>外部搜索</p>
<p>补充：本需求先不探讨这个方向</p>
<p>大模型能够回复</p>
<p>大模型不能回复</p>
<p><img loading="lazy" src="data:image/svg&#43;xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0Ij48cGF0aCBkPSJNMjEuOTkgNGMwLTEuMS0uODktMi0xLjk5LTJINGMtMS4xIDAtMiAuOS0yIDJ2MTJjMCAxLjEuOSAyIDIgMmgxNGw0IDQtLjAxLTE4ek0xOCAxNEg2di0yaDEydjJ6bTAtM0g2VjloMTJ2MnptMC0zSDZWNmgxMnYyeiIvPjxwYXRoIGQ9Ik0wIDBoMjR2MjRIMHoiIGZpbGw9Im5vbmUiLz48L3N2Zz4=" alt=""  title="显示评论"  />
</p>
<p>//&lt;![CDATA[ (function() { $ = AJS.$; var graphContainer = document.getElementById(&lsquo;drawio-macro-content-3e866b00-a6ca-4dc8-8b3c-e2624395e867&rsquo;); DrawioProperties = { contextPath : AJS.contextPath(), buildNumber : 8401 }; var readerOpts = {}; readerOpts.loadUrl = &rsquo;&rsquo; + &lsquo;/rest/drawio/1.0/diagram/crud/%E6%9C%AA%E5%91%BD%E5%90%8D%E7%BB%98%E5%9B%BE/129181863?revision=2&rsquo;; readerOpts.imageUrl = &rsquo;&rsquo; + &lsquo;/download/attachments/129181863/未命名绘图.png&rsquo; + &lsquo;?version=2&amp;api=v2&rsquo;; readerOpts.editUrl = &rsquo;&rsquo; + &lsquo;/plugins/drawio/addDiagram.action?ceoId=129181863&amp;owningPageId=129181863&amp;diagramName=%E6%9C%AA%E5%91%BD%E5%90%8D%E7%BB%98%E5%9B%BE&amp;revision=2&rsquo;; readerOpts.editable = true; readerOpts.canComment = true; readerOpts.stylePath = STYLE_PATH; readerOpts.stencilPath = STENCIL_PATH; readerOpts.imagePath = IMAGE_PATH + &lsquo;/reader&rsquo;; readerOpts.border = true; readerOpts.width = &lsquo;600&rsquo;; readerOpts.simpleViewer = false; readerOpts.tbstyle = &rsquo;top&rsquo;; readerOpts.links = &lsquo;auto&rsquo;; readerOpts.lightbox = true; readerOpts.resourcePath = ATLAS_RESOURCE_BASE + &lsquo;/resources/viewer&rsquo;; readerOpts.disableButtons = false; readerOpts.zoomToFit = true; readerOpts.language = &lsquo;zh&rsquo;; readerOpts.licenseStatus = &lsquo;OK&rsquo;; readerOpts.contextPath = AJS.contextPath(); readerOpts.diagramName = decodeURIComponent(&rsquo;%E6%9C%AA%E5%91%BD%E5%90%8D%E7%BB%98%E5%9B%BE&rsquo;); readerOpts.diagramDisplayName = &lsquo;&rsquo;; readerOpts.aspect = &lsquo;&rsquo;; readerOpts.ceoName = &lsquo;大模型LLM+（有限）在线搜索&rsquo;; readerOpts.attVer = &lsquo;2&rsquo;; readerOpts.attId = &lsquo;129181867&rsquo;; readerOpts.lastModifierName = &lsquo;王宇&rsquo;; readerOpts.lastModified = &lsquo;2024-07-14 22:17:20.791&rsquo;; readerOpts.creatorName = &lsquo;王宇&rsquo;; //Embed macro specific info readerOpts.extSrvIntegType = &lsquo;$extSrvIntegType&rsquo;; readerOpts.gClientId = &lsquo;$gClientId&rsquo;; readerOpts.oClientId = &lsquo;$oClientId&rsquo;; readerOpts.service = &lsquo;$service&rsquo;; readerOpts.sFileId = &lsquo;$sFileId&rsquo;; readerOpts.odriveId = &lsquo;$odriveId&rsquo;; readerOpts.diagramUrl = &lsquo;$diagramUrl&rsquo;; readerOpts.csvFileUrl = &lsquo;$csvFileUrl&rsquo;; readerOpts.pageId = &lsquo;$pageId&rsquo; || Confluence.getContentId(); readerOpts.aspectHash = &lsquo;$aspectHash&rsquo;; readerOpts.useExternalImageService = &lsquo;$useExternalImageService&rsquo; == &rsquo;true&rsquo;; readerOpts.isTemplate = &lsquo;$isTemplate&rsquo; == &rsquo;true&rsquo;; if (readerOpts.width == &lsquo;&rsquo;) { readerOpts.width = null; } // LATER: Check if delayed loading of resources can be used for image placeholder mode var viewerPromise = createViewer(graphContainer, readerOpts); if(readerOpts.editable) { $(graphContainer).data(&lsquo;viewerConfig&rsquo;, readerOpts); $(graphContainer).on(&lsquo;drawioViewerUpdate&rsquo;, updateDrawioViewer); } viewerPromise.done(function(viewer) { updateCachedDiagram(graphContainer, readerOpts, viewer); }); })(); //]]&gt;</p>
<h1 id="2-方案设计">2. 方案设计<a hidden class="anchor" aria-hidden="true" href="#2-方案设计">#</a></h1>
<p>Actor</p>
<p>大模型知识库</p>
<p>搜索引擎能力<br>
(谷歌)</p>
<p>大模型LLM<br>
判断</p>
<p>1、爬取网站<br>
2、获取具体内容</p>
<p>内容存放在文件中</p>
<p>大模型LLM推理，组合答案</p>
<p>Prompt</p>
<p>能</p>
<p>不能</p>
<p>Function Calling</p>
<p>目标网址</p>
<p>知乎</p>
<p>Github</p>
<p>CSDN</p>
<p>StackOverFlow</p>
<p>HuggingFace</p>
<p>&hellip;&hellip;</p>
<p><img loading="lazy" src="data:image/svg&#43;xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0Ij48cGF0aCBkPSJNMjEuOTkgNGMwLTEuMS0uODktMi0xLjk5LTJINGMtMS4xIDAtMiAuOS0yIDJ2MTJjMCAxLjEuOSAyIDIgMmgxNGw0IDQtLjAxLTE4ek0xOCAxNEg2di0yaDEydjJ6bTAtM0g2VjloMTJ2MnptMC0zSDZWNmgxMnYyeiIvPjxwYXRoIGQ9Ik0wIDBoMjR2MjRIMHoiIGZpbGw9Im5vbmUiLz48L3N2Zz4=" alt=""  title="显示评论"  />
</p>
<p>//&lt;![CDATA[ (function() { $ = AJS.$; var graphContainer = document.getElementById(&lsquo;drawio-macro-content-17c00d34-7b64-4e82-924c-c1515904e05a&rsquo;); DrawioProperties = { contextPath : AJS.contextPath(), buildNumber : 8401 }; var readerOpts = {}; readerOpts.loadUrl = &rsquo;&rsquo; + &lsquo;/rest/drawio/1.0/diagram/crud/%31%31/129181863?revision=1&rsquo;; readerOpts.imageUrl = &rsquo;&rsquo; + &lsquo;/download/attachments/129181863/11.png&rsquo; + &lsquo;?version=1&amp;api=v2&rsquo;; readerOpts.editUrl = &rsquo;&rsquo; + &lsquo;/plugins/drawio/addDiagram.action?ceoId=129181863&amp;owningPageId=129181863&amp;diagramName=%31%31&amp;revision=1&rsquo;; readerOpts.editable = true; readerOpts.canComment = true; readerOpts.stylePath = STYLE_PATH; readerOpts.stencilPath = STENCIL_PATH; readerOpts.imagePath = IMAGE_PATH + &lsquo;/reader&rsquo;; readerOpts.border = true; readerOpts.width = &lsquo;600&rsquo;; readerOpts.simpleViewer = false; readerOpts.tbstyle = &rsquo;top&rsquo;; readerOpts.links = &lsquo;auto&rsquo;; readerOpts.lightbox = true; readerOpts.resourcePath = ATLAS_RESOURCE_BASE + &lsquo;/resources/viewer&rsquo;; readerOpts.disableButtons = false; readerOpts.zoomToFit = true; readerOpts.language = &lsquo;zh&rsquo;; readerOpts.licenseStatus = &lsquo;OK&rsquo;; readerOpts.contextPath = AJS.contextPath(); readerOpts.diagramName = decodeURIComponent(&rsquo;%31%31&rsquo;); readerOpts.diagramDisplayName = &lsquo;&rsquo;; readerOpts.aspect = &lsquo;&rsquo;; readerOpts.ceoName = &lsquo;大模型LLM+（有限）在线搜索&rsquo;; readerOpts.attVer = &lsquo;1&rsquo;; readerOpts.attId = &lsquo;129181878&rsquo;; readerOpts.lastModifierName = &lsquo;王宇&rsquo;; readerOpts.lastModified = &lsquo;2024-07-14 22:45:25.331&rsquo;; readerOpts.creatorName = &lsquo;王宇&rsquo;; //Embed macro specific info readerOpts.extSrvIntegType = &lsquo;$extSrvIntegType&rsquo;; readerOpts.gClientId = &lsquo;$gClientId&rsquo;; readerOpts.oClientId = &lsquo;$oClientId&rsquo;; readerOpts.service = &lsquo;$service&rsquo;; readerOpts.sFileId = &lsquo;$sFileId&rsquo;; readerOpts.odriveId = &lsquo;$odriveId&rsquo;; readerOpts.diagramUrl = &lsquo;$diagramUrl&rsquo;; readerOpts.csvFileUrl = &lsquo;$csvFileUrl&rsquo;; readerOpts.pageId = &lsquo;$pageId&rsquo; || Confluence.getContentId(); readerOpts.aspectHash = &lsquo;$aspectHash&rsquo;; readerOpts.useExternalImageService = &lsquo;$useExternalImageService&rsquo; == &rsquo;true&rsquo;; readerOpts.isTemplate = &lsquo;$isTemplate&rsquo; == &rsquo;true&rsquo;; if (readerOpts.width == &lsquo;&rsquo;) { readerOpts.width = null; } // LATER: Check if delayed loading of resources can be used for image placeholder mode var viewerPromise = createViewer(graphContainer, readerOpts); if(readerOpts.editable) { $(graphContainer).data(&lsquo;viewerConfig&rsquo;, readerOpts); $(graphContainer).on(&lsquo;drawioViewerUpdate&rsquo;, updateDrawioViewer); } viewerPromise.done(function(viewer) { updateCachedDiagram(graphContainer, readerOpts, viewer); }); })(); //]]&gt;</p>
<h2 id="21-技术选型">2.1. 技术选型<a hidden class="anchor" aria-hidden="true" href="#21-技术选型">#</a></h2>
<p>功能模块</p>
<p>技术选型</p>
<p>备注</p>
<p>功能模块</p>
<p>技术选型</p>
<p>备注</p>
<p>大模型</p>
<p>GPT模型/GLM4大模型/其他模型</p>
<p>调用API的方法，目前绝大部分模型都和GPT系列差不多。考虑到获取API_KEY操作的方便性，本文选用智谱AI的API</p>
<p>搜索技术</p>
<p>谷歌搜索API、爬虫</p>
<p>也可以用其他的搜索。如：DuckDuckGo</p>
<p>性能优化</p>
<p>提示词工程</p>
<p>针对不同的网站，提示词可以进一步优化</p>
<h2 id="22-谷歌云平台注册">2.2. 谷歌云平台注册<a hidden class="anchor" aria-hidden="true" href="#22-谷歌云平台注册">#</a></h2>
<h3 id="221-第一步获取api_key">2.2.1. 第一步：获取API_KEY<a hidden class="anchor" aria-hidden="true" href="#221-第一步获取api_key">#</a></h3>
<p>访问地址：<a href="https://console.cloud.google.com/">https://console.cloud.google.com/</a></p>
<p>操作步骤如下：<br>
  </p>
<p>第一步</p>
<p>第二步</p>
<p>第三步</p>
<p>第四步</p>
<p>第五步</p>
<p>第六步</p>
<p><img loading="lazy" src="/download/thumbnails/129181863/image2024-7-14_22-51-48.png?version=1&amp;modificationDate=1720968708407&amp;api=v2" alt=""  />
</p>
<p><img loading="lazy" src="/download/thumbnails/129181863/image2024-7-14_22-52-41.png?version=1&amp;modificationDate=1720968761954&amp;api=v2" alt=""  />
</p>
<p><img loading="lazy" src="/download/thumbnails/129181863/image2024-7-14_22-53-31.png?version=1&amp;modificationDate=1720968811749&amp;api=v2" alt=""  />
</p>
<p><img loading="lazy" src="/download/thumbnails/129181863/image2024-7-14_22-56-34.png?version=1&amp;modificationDate=1720968994372&amp;api=v2" alt=""  />
</p>
<p><img loading="lazy" src="/download/thumbnails/129181863/image2024-7-14_22-57-19.png?version=1&amp;modificationDate=1720969039726&amp;api=v2" alt=""  />
</p>
<p><img loading="lazy" src="/download/thumbnails/129181863/image2024-7-14_22-59-17.png?version=1&amp;modificationDate=1720969157865&amp;api=v2" alt=""  />
</p>
<p>第七步</p>
<p>第八步</p>
<p>第九步</p>
<p>第十步</p>
<p><img loading="lazy" src="/download/thumbnails/129181863/image2024-7-14_23-1-52.png?version=1&amp;modificationDate=1720969312873&amp;api=v2" alt=""  />
</p>
<p><img loading="lazy" src="/download/thumbnails/129181863/image2024-7-14_23-6-16.png?version=1&amp;modificationDate=1720969576876&amp;api=v2" alt=""  />
</p>
<p><img loading="lazy" src="/download/thumbnails/129181863/image2024-7-14_23-6-43.png?version=1&amp;modificationDate=1720969604151&amp;api=v2" alt=""  />
</p>
<p><img loading="lazy" src="/download/thumbnails/129181863/image2024-7-14_23-7-0.png?version=1&amp;modificationDate=1720969620622&amp;api=v2" alt=""  />
</p>
<p><img loading="lazy" src="/download/thumbnails/129181863/image2024-7-14_23-8-47.png?version=1&amp;modificationDate=1720969728209&amp;api=v2" alt=""  />
</p>
<h3 id="222-第二步注册可编程的搜索引擎">2.2.2. 第二步：注册可编程的搜索引擎<a hidden class="anchor" aria-hidden="true" href="#222-第二步注册可编程的搜索引擎">#</a></h3>
<p>访问地址：<a href="https://programmablesearchengine.google.com/">https://programmablesearchengine.google.com/</a></p>
<p>第一步</p>
<p>第二步</p>
<p>第三步</p>
<p>第一步</p>
<p>第二步</p>
<p>第三步</p>
<p><img loading="lazy" src="/download/attachments/129181863/image2024-7-14_23-18-59.png?version=1&amp;modificationDate=1720970339800&amp;api=v2" alt=""  />
</p>
<p><img loading="lazy" src="/download/attachments/129181863/image2024-7-14_23-19-47.png?version=1&amp;modificationDate=1720970388167&amp;api=v2" alt=""  />
</p>
<p><img loading="lazy" src="/download/attachments/129181863/image2024-7-14_23-22-26.png?version=1&amp;modificationDate=1720970547035&amp;api=v2" alt=""  />
</p>
<p>经过这两个步骤，就能够完成谷歌搜索的API调用了，有两个地方需要注意下：</p>
<ul>
<li>搜索引擎可以选择在指定域名下搜索，见2.2.2第二步</li>
<li>谷歌搜索API每天免费使用100次，见：<a href="https://developers.google.com/custom-search/v1/overview?hl=zh_CN">https://developers.google.com/custom-search/v1/overview?hl=zh_CN</a></li>
</ul>
<h3 id="223-谷歌搜索api的使用">2.2.3. 谷歌搜索API的使用<a hidden class="anchor" aria-hidden="true" href="#223-谷歌搜索api的使用">#</a></h3>
<p>请求网址为：<a href="https://www.googleapis.com/customsearch/v1?[parameters">https://www.googleapis.com/customsearch/v1?[parameters</a>]</p>
<p>具体的使用文档见：<a href="https://developers.google.com/custom-search/v1/using_rest?hl=zh-cn">https://developers.google.com/custom-search/v1/using_rest?hl=zh-cn</a></p>
<p>详细的字段说明文档见：<a href="https://developers.google.com/custom-search/v1/reference/rest/v1/cse/list#request">https://developers.google.com/custom-search/v1/reference/rest/v1/cse/list#request</a></p>
<p>常用参数解析：</p>
<p>参数名</p>
<p>详情</p>
<p>备注</p>
<p>参数名</p>
<p>详情</p>
<p>备注</p>
<p>key</p>
<p>谷歌搜索API密钥，详见：2.2.1步骤</p>
<p>必填</p>
<p>cx</p>
<p>可编程搜索引擎ID，详见：2.2.2步骤</p>
<p>必填</p>
<p>q</p>
<p>搜索内容表达式</p>
<p>必填</p>
<p>c2coff</p>
<p>启用或停用简体中文，默认为0（启用）</p>
<p>0：启用<br>
1：停用</p>
<p>cr</p>
<p>将搜索结果限制为来自特定国家/地区的文档</p>
<p>1、国家 /地区标识查询：<a href="https://developers.google.com/custom-search/docs/json_api_reference?hl=zh-cn#countryCollections">https://developers.google.com/custom-search/docs/json_api_reference?hl=zh-cn#countryCollections</a></p>
<p>2、Google 搜索通过分析以下内容来确定文档所在的国家/地区：</p>
<ul>
<li>
<p>文档网址的顶级域名 (TLD)</p>
</li>
<li>
<p>Web 服务器 IP 地址的地理位置</p>
</li>
</ul>
<p>dateRestrict</p>
<p>搜索特定时间段</p>
<p>lr</p>
<p>搜索以特定语言撰写的文档</p>
<p>num</p>
<p>要返回的搜索结果数</p>
<p>有效值为 1 到 10 之间的整数（包括 1 和 10）</p>
<p>siteSearch</p>
<p>指定应始终从结果中包含或排除的给定网站</p>
<p>结合下面的siteSearchFilter</p>
<p>siteSearchFilter</p>
<p><code>enum (`[SiteSearchFilter](https://developers.google.com/custom-search/v1/reference/rest/v1/SiteSearchFilter?hl=zh-cn)`)</code></p>
<p>控制是否包含或排除 <code>siteSearch</code> 参数中指定的网站的结果。</p>
<p>可接受的值为：</p>
<ul>
<li>
<p><code>&quot;e&quot;</code>：排除</p>
</li>
<li>
<p><code>&quot;i&quot;</code>：包含</p>
</li>
</ul>
<p>默认为：<code>&quot;i&quot;：包含</code></p>
<h1 id="3-具体实现含代码">3. 具体实现（含代码）<a hidden class="anchor" aria-hidden="true" href="#3-具体实现含代码">#</a></h1>
<h2 id="31-zhipu-ai-gpt模型示例">3.1. ZhiPu AI GPT模型（示例）<a hidden class="anchor" aria-hidden="true" href="#31-zhipu-ai-gpt模型示例">#</a></h2>
<p>智谱AI官网：<a href="https://bigmodel.cn/">https://bigmodel.cn/</a>，注册一个账号，登录进去，进入 “开发工作台”，很方便就能获取到API_KEY</p>
<p>一个最简版本的请求如下：</p>
<p><a href="/">?</a></p>
<p>1</p>
<p>2</p>
<p>3</p>
<p>4</p>
<p>5</p>
<p>6</p>
<p>7</p>
<p>8</p>
<p>9</p>
<p>10</p>
<p>11</p>
<p>12</p>
<p>13</p>
<p>14</p>
<p>15</p>
<p>16</p>
<p><code>ffrom zhipuai</code> <code>import</code> <code>ZhipuAI</code></p>
<p><code>client</code> <code>=</code> <code>ZhipuAI(api_key``=``api_key)</code></p>
<p><code>def</code> <code>chat_completion_request(messages, tools``=``None``, tool_choice``=``None``, model``=``GPT_MODEL):</code></p>
<p>    <code>try``:</code></p>
<p>        <code>response</code> <code>=</code> <code>client.chat.completions.create(</code></p>
<p>            <code>model``=``model,</code></p>
<p>            <code>messages``=``messages,</code></p>
<p>            <code>tools``=``tools,</code></p>
<p>            <code>tool_choice``=``tool_choice,</code></p>
<p>        <code>)</code></p>
<p>        <code>return</code> <code>response</code></p>
<p>    <code>except</code> <code>Exception as e:</code></p>
<p>        <code>print``(``&quot;Unable to generate ChatCompletion response&quot;``)</code></p>
<p>        <code>print``(f``&quot;Exception: {e}&quot;``)</code></p>
<p>        <code>return</code> <code>e</code></p>
<p>在一步中，需要用到ZhiPu的Function calling功能，以实现，如果大模型能回答则直接回答，如果不能回答就执行Function Calling。其中需要关注的有两点：</p>
<ol>
<li>ZhiPu GPT的Function Calling的写法</li>
<li>提示词上需要实现如上流程流转</li>
</ol>
<p>补充上Function calling实现：</p>
<p><a href="/">?</a></p>
<p>1</p>
<p><code>/``/</code> <code>定义Tool，函数定义</code></p>
<h2 id="32-一些测试">3.2. 一些测试<a hidden class="anchor" aria-hidden="true" href="#32-一些测试">#</a></h2>
<h3 id="321-大模型回答问题策略测试">3.2.1. 大模型回答问题策略测试<a hidden class="anchor" aria-hidden="true" href="#321-大模型回答问题策略测试">#</a></h3>
<h4 id="3211-提示词">3.2.1.1. 提示词<a hidden class="anchor" aria-hidden="true" href="#3211-提示词">#</a></h4>
<p><a href="/">?</a></p>
<p>1</p>
<p>2</p>
<p>3</p>
<p>4</p>
<p>5</p>
<p>6</p>
<p>7</p>
<p>8</p>
<p>9</p>
<p>10</p>
<p>11</p>
<p><code>response</code> <code>=</code> <code>client.chat.completions.create(</code></p>
<p>  <code>model``=``&quot;glm-4&quot;``,</code></p>
<p>  <code>messages``=``[</code></p>
<p>    <code>{``&quot;role&quot;``:</code> <code>&quot;system&quot;``,</code> <code>&quot;content&quot;``:</code> <code>&quot;根据用户输入的问题进行回答，如果知道问题的答案，请回答问题答案，如果不知道问题答案，请回复‘抱歉，这个问题我并不知道’&quot;``},</code></p>
<p>    <code>{``&quot;role&quot;``:</code> <code>&quot;user&quot;``,</code> <code>&quot;content&quot;``:</code> <code>&quot;请问，什么是机器学习？&quot;``}</code></p>
<p>  <code>]</code></p>
<p><code>)</code></p>
<p><code>response.choices[``0``].message.content</code></p>
<p><code>-``-``-``output</code></p>
<p><code>'机器学习是人工智能的一个核心领域，它让计算机能够模拟人类的学习和思考方式。通过使用大量数据和算法，机器学习可以使计算机学会分类、回归和聚类等任务，从而让计算机能够从数据中提取知识，进行决策和预测。在机器学习的流程中，包括数据获取、特征工程、建立模型、模型评估以及调参等步骤。深度学习和强化学习是机器学习的两个重要分支。深度学习主要用于处理复杂结构数据的建模问题，而强化学习则让机器在探索环境中通过试错进行学习。'</code></p>
<p><a href="/">?</a></p>
<p>1</p>
<p>2</p>
<p>3</p>
<p>4</p>
<p>5</p>
<p>6</p>
<p>7</p>
<p>8</p>
<p>9</p>
<p>10</p>
<p>11</p>
<p><code>response</code> <code>=</code> <code>client.chat.completions.create(</code></p>
<p>  <code>model``=``&quot;glm-4&quot;``,</code></p>
<p>  <code>messages``=``[</code></p>
<p>    <code>{``&quot;role&quot;``:</code> <code>&quot;system&quot;``,</code> <code>&quot;content&quot;``:</code> <code>&quot;根据用户输入的问题进行回答，如果知道问题的答案，请回答问题答案，如果不知道问题答案，请回复‘抱歉，这个问题我并不知道’&quot;``},</code></p>
<p>    <code>{``&quot;role&quot;``:</code> <code>&quot;user&quot;``,</code> <code>&quot;content&quot;``:</code> <code>&quot;介绍一下关于GPT-6的猜想&quot;``}</code></p>
<p>  <code>]</code></p>
<p><code>)</code></p>
<p><code>response.choices[``0``].message.content</code></p>
<p><code>-``-``-``output</code></p>
<p><code>'抱歉，这个问题我并不知道。\n\n到2023为止，GPT-6尚未被公开提及或发布。GPT（Generative Pre-trained Transformer）系列模型由OpenAI开发，至今已发布了多个版本，如GPT-2和GPT-3。关于未来版本的GPT，如GPT-6，可能会有很多猜想和预期，但具体的内容和功能我无法提供，因为那将基于未来尚未公开的技术和信息。如果GPT-6在您提问之后有了新的消息，我可能无法获取那些最新的信息。'</code></p>
<h4 id="3212-增加外部函数">3.2.1.2. 增加外部函数<a hidden class="anchor" aria-hidden="true" href="#3212-增加外部函数">#</a></h4>
<p>测试的目的是：检测增加了外部函数的情况下，glm4回答同一个问题的时候，是不是都倾向于走外部函数</p>
<p>外部函数：有参数定义、函数描述、返回值</p>
<p>智谱的tools格式为：</p>
<p><a href="/">?</a></p>
<p>1</p>
<p>2</p>
<p>3</p>
<p>4</p>
<p>5</p>
<p>6</p>
<p>7</p>
<p>8</p>
<p>9</p>
<p>10</p>
<p>11</p>
<p>12</p>
<p>13</p>
<p><code>tools</code> <code>=</code> <code>[</code></p>
<p>    <code>{</code></p>
<p>        <code>&quot;type&quot;``:</code> <code>&quot;function&quot;``,</code></p>
<p>        <code>&quot;function&quot;``: {</code></p>
<p>            <code>&quot;name&quot;``:</code> <code>&quot;get_flight_number&quot;``,</code></p>
<p>            <code>&quot;description&quot;``:</code> <code>&quot;根据始发地、目的地和日期，查询对应日期的航班号&quot;``,</code></p>
<p>            <code>&quot;parameters&quot;``: {</code></p>
<p>                <code>......</code></p>
<p>            <code>},</code></p>
<p>        <code>}</code></p>
<p>    <code>}，</code></p>
<p>    <code>...</code></p>
<p><code>]</code></p>
<p>测试函数为：</p>
<p><a href="/">?</a></p>
<p>1</p>
<p>2</p>
<p>3</p>
<p>4</p>
<p>5</p>
<p>6</p>
<p>7</p>
<p><code>def</code> <code>ml_answer(q``=``'什么是机器学习'``):</code></p>
<p>    <code>&quot;&quot;&quot;</code></p>
<p>    <code>解释什么是机器学习，返回机器学习的定义和解释</code></p>
<p>    <code>:param q: 询问的问题，非必要参数，字符串类型对象</code></p>
<p>    <code>:return：返回机器学习的定义和解释</code></p>
<p>    <code>&quot;&quot;&quot;</code></p>
<p>    <code>return``(``&quot;机器学习是一种人工智能（AI）的分支领域，旨在使计算机系统通过学习和经验改进性能。&quot;``)</code></p>
<p>现在将测试函数转化为tool需要的格式，写一个转换函数，里面也会用到glm4：</p>
<p><strong>auto_functions生成tool需要的格式</strong>  展开源码</p>
<p><a href="/">expand source</a><a href="/">?</a></p>
<p>1</p>
<p>2</p>
<p>3</p>
<p>4</p>
<p>5</p>
<p>6</p>
<p>7</p>
<p>8</p>
<p>9</p>
<p>10</p>
<p>11</p>
<p>12</p>
<p>13</p>
<p>14</p>
<p>15</p>
<p>16</p>
<p>17</p>
<p>18</p>
<p>19</p>
<p>20</p>
<p>21</p>
<p>22</p>
<p>23</p>
<p>24</p>
<p>25</p>
<p>26</p>
<p>27</p>
<p>28</p>
<p>29</p>
<p>30</p>
<p>31</p>
<p>32</p>
<p>33</p>
<p>34</p>
<p>35</p>
<p>36</p>
<p>37</p>
<p>38</p>
<p>39</p>
<p>40</p>
<p>41</p>
<p>42</p>
<p>43</p>
<p>44</p>
<p>45</p>
<p>46</p>
<p>47</p>
<p>48</p>
<p>49</p>
<p>50</p>
<p>51</p>
<p>52</p>
<p>53</p>
<p><code>def</code> <code>auto_functions(functions_list):</code></p>
<p>    <code>&quot;&quot;&quot;</code></p>
<p>    <code>Chat模型的functions参数编写函数</code></p>
<p>    <code>:param functions_list: 包含一个或者多个函数对象的列表；</code></p>
<p>    <code>:return：满足Chat模型functions参数要求的functions对象</code></p>
<p>    <code>&quot;&quot;&quot;</code></p>
<p>    <code>def</code> <code>functions_generate(functions_list):</code></p>
<p>        <code># 创建空列表，用于保存每个函数的描述字典</code></p>
<p>        <code>functions</code> <code>=</code> <code>[]</code></p>
<p>        <code># 对每个外部函数进行循环</code></p>
<p>        <code>for</code> <code>function</code> <code>in</code> <code>functions_list:</code></p>
<p>            <code># 读取函数对象的函数说明</code></p>
<p>            <code>function_description</code> <code>=</code> <code>inspect.getdoc(function)</code></p>
<p>            <code># 读取函数的函数名字符串</code></p>
<p>            <code>function_name</code> <code>=</code> <code>function.__name__</code></p>
<p>            <code>system_prompt</code> <code>=</code> <code>'以下是某的函数说明：%s,输出结果必须是一个JSON格式的字典，只输出这个字典即可，前后不需要任何前后修饰或说明的语句'</code> <code>%</code> <code>function_description</code></p>
<p>            <code>user_prompt</code> <code>=</code> <code>'根据这个函数的函数说明，请帮我创建一个JSON格式的字典，这个字典有如下``5``点要求：\</code></p>
<p>                           <code>1.``字典总共有三个键值对；\</code></p>
<p>                           <code>2.``第一个键值对的Key是字符串name，value是该函数的名字：``%``s，也是字符串；\</code></p>
<p>                           <code>3.``第二个键值对的Key是字符串description，value是该函数的函数的功能说明，也是字符串；\</code></p>
<p>                           <code>4.``第三个键值对的Key是字符串parameters，value是一个JSON Schema对象，用于说明该函数的参数输入规范。\</code></p>
<p>                           <code>5.``输出结果必须是一个JSON格式的字典，只输出这个字典即可，前后不需要任何前后修饰或说明的语句'</code> <code>%</code> <code>function_name</code></p>
<p>            <code>response</code> <code>=</code> <code>client.chat.completions.create(</code></p>
<p>                              <code>model``=``&quot;glm-4&quot;``,</code></p>
<p>                              <code>messages``=``[</code></p>
<p>                                <code>{``&quot;role&quot;``:</code> <code>&quot;system&quot;``,</code> <code>&quot;content&quot;``: system_prompt},</code></p>
<p>                                <code>{``&quot;role&quot;``:</code> <code>&quot;user&quot;``,</code> <code>&quot;content&quot;``: user_prompt}</code></p>
<p>                              <code>]</code></p>
<p>                            <code>)</code></p>
<p>            <code>json_str``=``response.choices[``0``].message.content.replace(``&quot;```json&quot;``,&quot;``&quot;).replace(&quot;`` ``` ``&quot;,&quot;``&quot;)</code></p>
<p>            <code>json_function_description``=``json.loads(json_str)</code></p>
<p>            <code>json_str``=``{``&quot;type&quot;``:</code> <code>&quot;function&quot;``,``&quot;function&quot;``:json_function_description}</code></p>
<p>            <code>functions.append(json_str)</code></p>
<p>        <code>return</code> <code>functions</code></p>
<p>    <code>## 最大可以尝试4次</code></p>
<p>    <code>max_attempts</code> <code>=</code> <code>4</code></p>
<p>    <code>attempts</code> <code>=</code> <code>0</code></p>
<p>    <code>while</code> <code>attempts &lt; max_attempts:</code></p>
<p>        <code>try``:</code></p>
<p>            <code>functions</code> <code>=</code> <code>functions_generate(functions_list)</code></p>
<p>            <code>break</code>  <code># 如果代码成功执行，跳出循环</code></p>
<p>        <code>except</code> <code>Exception as e:</code></p>
<p>            <code>attempts</code> <code>+``=</code> <code>1</code>  <code># 增加尝试次数</code></p>
<p>            <code>print``(``&quot;发生错误：&quot;``, e)</code></p>
<p>            <code>if</code> <code>attempts</code> <code>=``=</code> <code>max_attempts:</code></p>
<p>                <code>print``(``&quot;已达到最大尝试次数，程序终止。&quot;``)</code></p>
<p>                <code>raise</code>  <code># 重新引发最后一个异常</code></p>
<p>            <code>else``:</code></p>
<p>                <code>print``(``&quot;正在重新运行...&quot;``)</code></p>
<p>    <code>return</code> <code>functions</code></p>
<p>执行auto_function([ml_answer])，能够生成tool需要的格式。接下来测试面对一个问题，在有外部函数能执行functuon call的情况下，到底是执行function call呢还是大模型直接执行。</p>
<p>直接执行glm4执行函数，发现面对同一个问题“什么是机器学习”，有时候直接回答，有时候通过外部函数回答，要解决这个不稳定的问题</p>
<p><strong>glm4执行</strong>  展开源码</p>
<p><a href="/">expand source</a><a href="/">?</a></p>
<p>1</p>
<p>2</p>
<p>3</p>
<p>4</p>
<p>5</p>
<p>6</p>
<p>7</p>
<p>8</p>
<p>9</p>
<p><code>response</code> <code>=</code> <code>client.chat.completions.create(</code></p>
<p>        <code>model``=``&quot;glm-4&quot;``,</code></p>
<p>        <code>messages``=``[</code></p>
<p>            <code>{``&quot;role&quot;``:</code> <code>&quot;user&quot;``,</code> <code>&quot;content&quot;``:</code> <code>&quot;解释什么是机器学习？&quot;``}</code></p>
<p>        <code>],</code></p>
<p>        <code>tools``=``tools,</code></p>
<p>        <code>tool_choice``=``&quot;auto&quot;</code></p>
<p>    <code>)</code></p>
<p><code>response.choices[``0``].message</code></p>
<p>提示词很细腻，轻微的差别，也许回复就会差别很大，</p>
<p>提示词1：system_prompt = &lsquo;以下是某函数的函数说明：%s，输出结果必须是一个JSON格式的字典，只输出这个字典即可，前后不需要任何修饰或说明的语句&rsquo; % function_description</p>
<p>提示词2：system_prompt = &lsquo;以下是某函数的函数说明：%s，输出结果必须是一个JSON格式的字典，只输出这个字典即可，前后不需要任何前后修饰或说明的语句&rsquo; % function_description</p>
<p>提示词1返回结果为：</p>
<p><strong>glm4执行</strong>  展开源码</p>
<p><a href="/">expand source</a><a href="/">?</a></p>
<p>1</p>
<p>2</p>
<p>3</p>
<p>4</p>
<p>5</p>
<p>6</p>
<p>7</p>
<p>8</p>
<p>9</p>
<p>10</p>
<p>11</p>
<p>12</p>
<p>13</p>
<p>14</p>
<p>15</p>
<p>16</p>
<p>17</p>
<p>18</p>
<p>19</p>
<p>20</p>
<p>21</p>
<p>22</p>
<p>23</p>
<p>24</p>
<p>25</p>
<p><code>以下是符合您要求的JSON格式字典：</code></p>
<p><code>```json</code></p>
<p><code>{</code></p>
<p><code>&quot;name&quot;``:</code> <code>&quot;sunwukong_function&quot;``,</code></p>
<p><code>&quot;description&quot;``:</code> <code>&quot;该函数定义了数据集计算过程，接受数据表作为输入，并返回计算后的结果。&quot;``,</code></p>
<p><code>&quot;parameters&quot;``: {</code></p>
<p><code>&quot;type&quot;``:</code> <code>&quot;object&quot;``,</code></p>
<p><code>&quot;required&quot;``: [``&quot;data&quot;``],</code></p>
<p><code>&quot;properties&quot;``: {</code></p>
<p><code>&quot;data&quot;``: {</code></p>
<p><code>&quot;type&quot;``:</code> <code>&quot;string&quot;``,</code></p>
<p><code>&quot;description&quot;``:</code> <code>&quot;带入计算的数据表，用字符串进行表示&quot;</code></p>
<p><code>}</code></p>
<p><code>},</code></p>
<p><code>&quot;additionalProperties&quot;``: false</code></p>
<p><code>}</code></p>
<p><code>}</code></p>
<p><code>```</code></p>
<p><code>这个JSON对象包含三个键值对：</code></p>
<p><code>1.</code> <code>` ```&quot;name&quot;``` ` 键对应着函数的名字。</code></p>
<p><code>2.</code> <code>` ```&quot;description&quot;``` ` 键提供了函数的功能说明。</code></p>
<p><code>3.</code> <code> ` ```&quot;parameters&quot;``` ` 键包含一个JSON Schema对象，描述了函数的参数输入规范，包括数据类型和描述，并指出` ```&quot;data&quot;``` `参数是必须的（` ```&quot;required&quot;</code>: [<code>&quot;data&quot;``` ]`）。此外，` ```&quot;additionalProperties&quot;```: false`确保没有其他额外的参数被传入函数。</code></p>
<p>提示词2返回结果为：</p>
<p><strong>glm4执行</strong>  展开源码</p>
<p><a href="/">expand source</a><a href="/">?</a></p>
<p>1</p>
<p>2</p>
<p>3</p>
<p>4</p>
<p>5</p>
<p>6</p>
<p>7</p>
<p>8</p>
<p>9</p>
<p>10</p>
<p>11</p>
<p>12</p>
<p>13</p>
<p>14</p>
<p><code>{</code></p>
<p>  <code>&quot;name&quot;``:</code> <code>&quot;sunwukong_function&quot;``,</code></p>
<p>  <code>&quot;description&quot;``:</code> <code>&quot;该函数定义了数据集计算过程，接收一个数据表作为输入，并返回计算后的结果。&quot;``,</code></p>
<p>  <code>&quot;parameters&quot;``: {</code></p>
<p>    <code>&quot;type&quot;``:</code> <code>&quot;object&quot;``,</code></p>
<p>    <code>&quot;properties&quot;``: {</code></p>
<p>      <code>&quot;data&quot;``: {</code></p>
<p>        <code>&quot;type&quot;``:</code> <code>&quot;string&quot;``,</code></p>
<p>        <code>&quot;description&quot;``:</code> <code>&quot;必要参数，表示带入计算的数据表，用字符串进行表示&quot;</code></p>
<p>      <code>}</code></p>
<p>    <code>},</code></p>
<p>    <code>&quot;required&quot;``: [``&quot;data&quot;``]</code></p>
<p>  <code>}</code></p>
<p><code>}</code></p>
<p>提示词2的输出100%是json格式的内容，而提示词1的输出内容中，每次都包含前后的修饰性的中文，当然也包含JSON部分的内容，夹在在一起。而这两份提示词之间的区别，就是提示词2多了两个字“前后”，差别却很大。</p>
<p>工程上的处理，其实要预防着 输出的文本不只是 纯字符串类型的JSON格式的内容，抽取夹杂着修饰性文本+JSON格式内容字符串的，而不能完全依赖大模型的返回。可以保险期间，如果结果是需要代码块的，需要执行代码提取函数。函数如下：</p>
<p><strong>extract_code_block提取代码块</strong></p>
<p><a href="/">?</a></p>
<p>1</p>
<p>2</p>
<p>3</p>
<p>4</p>
<p>5</p>
<p>6</p>
<p>7</p>
<p>8</p>
<p>9</p>
<p>10</p>
<p>11</p>
<p>12</p>
<p>13</p>
<p>14</p>
<p>15</p>
<p><code>def</code> <code>extract_code_block(text, language):</code></p>
<p>    <code>&quot;&quot;&quot;</code></p>
<p>    <code>提取文本中的指定语言的代码块，并返回代码块的字符串内容。</code></p>
<p>    <code>:param text: 包含代码块的字符串</code></p>
<p>    <code>:param language: 代码块语言标记，例如'json', 'python', 'java'等</code></p>
<p>    <code>:return: 提取的代码块内容字符串，如果未找到则返回None</code></p>
<p>    <code>&quot;&quot;&quot;</code></p>
<p>    <code>pattern</code> <code>=</code> <code>re.``compile``(rf``'```{language}\n(.*?)\n```'``, re.DOTALL)</code></p>
<p>    <code>match</code> <code>=</code> <code>pattern.search(text)</code></p>
<p>    <code>if</code> <code>match:</code></p>
<p>        <code>return</code> <code>match.group(``1``)</code></p>
<p>    <code>else``:</code></p>
<p>        <code>print``(f``&quot;未找到 {language} 代码块&quot;``)</code></p>
<p>        <code>return</code> <code>None</code></p>
<h2 id="33-增加外部函数回复稳定性">3.3. 增加外部函数回复稳定性<a hidden class="anchor" aria-hidden="true" href="#33-增加外部函数回复稳定性">#</a></h2>
<p><a href="/">Filter table data</a><a href="/">Create a pivot table</a><a href="/">Create a chart from data series</a></p>
<p><a href="/users/tfac-settings.action">Configure buttons visibility</a></p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/gpt%E7%9B%B8%E5%85%B3/">GPT相关</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="http://localhost:1313/posts/wiki/20230802%E6%9C%88%E4%BE%8B%E4%BC%9A/">
    <span class="title">« 上一页</span>
    <br>
    <span>20230802月例会</span>
  </a>
  <a class="next" href="http://localhost:1313/posts/wiki/nvidiachatwithrtxdemo%E6%B5%8B%E8%AF%84%E7%90%86%E8%A7%A3%E6%8B%93%E5%B1%95/">
    <span class="title">下一页 »</span>
    <br>
    <span>NVIDIAChatWithRTXDemo测评、理解、拓展</span>
  </a>
</nav>


<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 大模型LLM&#43;（有限）在线搜索 on x"
            href="https://x.com/intent/tweet/?text=%e5%a4%a7%e6%a8%a1%e5%9e%8bLLM%2b%ef%bc%88%e6%9c%89%e9%99%90%ef%bc%89%e5%9c%a8%e7%ba%bf%e6%90%9c%e7%b4%a2&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2fwiki%2f%25E5%25A4%25A7%25E6%25A8%25A1%25E5%259E%258Bllm%2b%25E6%259C%2589%25E9%2599%2590%25E5%259C%25A8%25E7%25BA%25BF%25E6%2590%259C%25E7%25B4%25A2%2f&amp;hashtags=GPT%e7%9b%b8%e5%85%b3">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 大模型LLM&#43;（有限）在线搜索 on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2fwiki%2f%25E5%25A4%25A7%25E6%25A8%25A1%25E5%259E%258Bllm%2b%25E6%259C%2589%25E9%2599%2590%25E5%259C%25A8%25E7%25BA%25BF%25E6%2590%259C%25E7%25B4%25A2%2f&amp;title=%e5%a4%a7%e6%a8%a1%e5%9e%8bLLM%2b%ef%bc%88%e6%9c%89%e9%99%90%ef%bc%89%e5%9c%a8%e7%ba%bf%e6%90%9c%e7%b4%a2&amp;summary=%e5%a4%a7%e6%a8%a1%e5%9e%8bLLM%2b%ef%bc%88%e6%9c%89%e9%99%90%ef%bc%89%e5%9c%a8%e7%ba%bf%e6%90%9c%e7%b4%a2&amp;source=http%3a%2f%2flocalhost%3a1313%2fposts%2fwiki%2f%25E5%25A4%25A7%25E6%25A8%25A1%25E5%259E%258Bllm%2b%25E6%259C%2589%25E9%2599%2590%25E5%259C%25A8%25E7%25BA%25BF%25E6%2590%259C%25E7%25B4%25A2%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 大模型LLM&#43;（有限）在线搜索 on reddit"
            href="https://reddit.com/submit?url=http%3a%2f%2flocalhost%3a1313%2fposts%2fwiki%2f%25E5%25A4%25A7%25E6%25A8%25A1%25E5%259E%258Bllm%2b%25E6%259C%2589%25E9%2599%2590%25E5%259C%25A8%25E7%25BA%25BF%25E6%2590%259C%25E7%25B4%25A2%2f&title=%e5%a4%a7%e6%a8%a1%e5%9e%8bLLM%2b%ef%bc%88%e6%9c%89%e9%99%90%ef%bc%89%e5%9c%a8%e7%ba%bf%e6%90%9c%e7%b4%a2">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 大模型LLM&#43;（有限）在线搜索 on facebook"
            href="https://facebook.com/sharer/sharer.php?u=http%3a%2f%2flocalhost%3a1313%2fposts%2fwiki%2f%25E5%25A4%25A7%25E6%25A8%25A1%25E5%259E%258Bllm%2b%25E6%259C%2589%25E9%2599%2590%25E5%259C%25A8%25E7%25BA%25BF%25E6%2590%259C%25E7%25B4%25A2%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 大模型LLM&#43;（有限）在线搜索 on whatsapp"
            href="https://api.whatsapp.com/send?text=%e5%a4%a7%e6%a8%a1%e5%9e%8bLLM%2b%ef%bc%88%e6%9c%89%e9%99%90%ef%bc%89%e5%9c%a8%e7%ba%bf%e6%90%9c%e7%b4%a2%20-%20http%3a%2f%2flocalhost%3a1313%2fposts%2fwiki%2f%25E5%25A4%25A7%25E6%25A8%25A1%25E5%259E%258Bllm%2b%25E6%259C%2589%25E9%2599%2590%25E5%259C%25A8%25E7%25BA%25BF%25E6%2590%259C%25E7%25B4%25A2%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 大模型LLM&#43;（有限）在线搜索 on telegram"
            href="https://telegram.me/share/url?text=%e5%a4%a7%e6%a8%a1%e5%9e%8bLLM%2b%ef%bc%88%e6%9c%89%e9%99%90%ef%bc%89%e5%9c%a8%e7%ba%bf%e6%90%9c%e7%b4%a2&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2fwiki%2f%25E5%25A4%25A7%25E6%25A8%25A1%25E5%259E%258Bllm%2b%25E6%259C%2589%25E9%2599%2590%25E5%259C%25A8%25E7%25BA%25BF%25E6%2590%259C%25E7%25B4%25A2%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 大模型LLM&#43;（有限）在线搜索 on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=%e5%a4%a7%e6%a8%a1%e5%9e%8bLLM%2b%ef%bc%88%e6%9c%89%e9%99%90%ef%bc%89%e5%9c%a8%e7%ba%bf%e6%90%9c%e7%b4%a2&u=http%3a%2f%2flocalhost%3a1313%2fposts%2fwiki%2f%25E5%25A4%25A7%25E6%25A8%25A1%25E5%259E%258Bllm%2b%25E6%259C%2589%25E9%2599%2590%25E5%259C%25A8%25E7%25BA%25BF%25E6%2590%259C%25E7%25B4%25A2%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span><a href="https://beian.miit.gov.cn/">粤ICP备2023039897号-1</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = '复制';

        function copyingDone() {
            copybutton.innerHTML = '已复制！';
            setTimeout(() => {
                copybutton.innerHTML = '复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
