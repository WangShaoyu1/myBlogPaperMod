<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>前端架构师的git功力，你有几成火候？ | PaperMod</title>
<meta name="keywords" content="架构, 前端">
<meta name="description" content="本文从前端工程，团队协作，GitFlow，提交规范与校验，生产部署的角度，介绍架构人员需要掌握的git实践能力">
<meta name="author" content="杨成功">
<link rel="canonical" href="http://localhost:1313/posts/juejin/%E5%89%8D%E7%AB%AF%E6%9E%B6%E6%9E%84%E5%B8%88%E7%9A%84git%E5%8A%9F%E5%8A%9B%E4%BD%A0%E6%9C%89%E5%87%A0%E6%88%90%E7%81%AB%E5%80%99/">
<meta name="google-site-verification" content="XYZabc">
<link crossorigin="anonymous" href="/assets/css/stylesheet.7b92bf4867c997b58ec50f63451b83777173d5bd5593376852abd85746d09d71.css" integrity="sha256-e5K/SGfJl7WOxQ9jRRuDd3Fz1b1VkzdoUqvYV0bQnXE=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/%3Clink%20/%20abs%20url%3E">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/%3Clink%20/%20abs%20url%3E">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/%3Clink%20/%20abs%20url%3E">
<link rel="apple-touch-icon" href="http://localhost:1313/%3Clink%20/%20abs%20url%3E">
<link rel="mask-icon" href="http://localhost:1313/%3Clink%20/%20abs%20url%3E">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="http://localhost:1313/posts/juejin/%E5%89%8D%E7%AB%AF%E6%9E%B6%E6%9E%84%E5%B8%88%E7%9A%84git%E5%8A%9F%E5%8A%9B%E4%BD%A0%E6%9C%89%E5%87%A0%E6%88%90%E7%81%AB%E5%80%99/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript><meta property="og:title" content="前端架构师的git功力，你有几成火候？" />
<meta property="og:description" content="本文从前端工程，团队协作，GitFlow，提交规范与校验，生产部署的角度，介绍架构人员需要掌握的git实践能力" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/posts/juejin/%E5%89%8D%E7%AB%AF%E6%9E%B6%E6%9E%84%E5%B8%88%E7%9A%84git%E5%8A%9F%E5%8A%9B%E4%BD%A0%E6%9C%89%E5%87%A0%E6%88%90%E7%81%AB%E5%80%99/" />
<meta property="og:image" content="http://localhost:1313/images/papermod-cover.png" />
<meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-10-28T00:00:00+00:00" />
<meta property="article:modified_time" content="2021-10-28T00:00:00+00:00" />


<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="http://localhost:1313/images/papermod-cover.png" />
<meta name="twitter:title" content="前端架构师的git功力，你有几成火候？"/>
<meta name="twitter:description" content="本文从前端工程，团队协作，GitFlow，提交规范与校验，生产部署的角度，介绍架构人员需要掌握的git实践能力"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "http://localhost:1313/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "前端架构师的git功力，你有几成火候？",
      "item": "http://localhost:1313/posts/juejin/%E5%89%8D%E7%AB%AF%E6%9E%B6%E6%9E%84%E5%B8%88%E7%9A%84git%E5%8A%9F%E5%8A%9B%E4%BD%A0%E6%9C%89%E5%87%A0%E6%88%90%E7%81%AB%E5%80%99/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "前端架构师的git功力，你有几成火候？",
  "name": "前端架构师的git功力，你有几成火候？",
  "description": "本文从前端工程，团队协作，GitFlow，提交规范与校验，生产部署的角度，介绍架构人员需要掌握的git实践能力",
  "keywords": [
    "架构", "前端"
  ],
  "articleBody": "本文从前端工程，团队协作，生产部署的角度，介绍架构人员需要掌握的 git 实践能力。\n大纲预览 本文介绍的内容包括以下方面：\n分支管理策略 commit 规范与提交验证 误操作的撤回方案 Tag 与生产环境 永久杜绝 443 Timeout hook 实现部署？ 终极应用: CI/CD 分支管理策略 git 分支强大的同时也非常灵活，如果没有一个好的分支管理策略，团队人员随意合并推送，就会造成分支混乱，各种覆盖，冲突，丢失等问题。\n目前最流行的分支管理策略，也称工作流（Workflow），主要包含三种：\nGit Flow GitHub Flow GitLab Flow 我司前端团队结合实际情况，制定出自己的一套分支管理策略。\n我们将分支分为 4 个大类：\ndev-* develop staging release dev-* 是一组开发分支的统称，包括个人分支，模块分支，修复分支等，团队开发人员在这组分支上进行开发。\n开发前，先通过 merge 合并 develop 分支的最新代码；开发完成后，必须通过 cherry-pick 合并回 develop 分支。\ndevelop 是一个单独分支，对应开发环境，保留最新的完整的开发代码。它只接受 cherry-pick 的合并，不允许使用 merge。\nstaging 分支对应测试环境。当 develop 分支有更新并且准备发布测试时，staging 要通过 rebase 合并 develop 分支，然后将最新代码发布到测试服务器，供测试人员测试。\n测试发现问题后，再走 dev-* -\u003e develop -\u003e staging 的流程，直到测试通过。\nrelease 则表示生产环境。release 分支的最新提交永远与线上生产环境代码保持同步，也就是说，release 分支是随时可发布的。\n当 staging 测试通过后，release 分支通过 rebase 合并 staging 分支，然后将最新代码发布到生产服务器。\n总结下合并规则：\ndevelop -\u003e (merge) -\u003e dev-* dev-* -\u003e (cherry-pick) -\u003e develop develop -\u003e (rebase) -\u003e staging staging -\u003e (rebase) -\u003e release 为什么合并到 develop 必须用 cherry-pick？ 使用 merge 合并，如果有冲突，会产生分叉；dev-* 分支多而杂，直接 merge 到 develop 会产生错综复杂的分叉，难以理清提交进度。\n而 cherry-pick 只将需要的 commit 合并到 develop 分支上，且不会产生分叉，使 git 提交图谱（git graph）永远保持一条直线。\n再有，模块开发分支完成后，需要将多个 commit 合为一个 commit，再合并到 develop 分支，避免了多余的 commit，这也是不用 merge 的原因之一。\n为什么合并到 staging/release 必须用 rebase？ rebase 译为变基，合并同样不会产生分叉。当 develop 更新了许多功能，要合并到 staging 测试，不可能用 cherry-pick 一个一个把 commit 合并过去。因此要通过 rebase 一次性合并过去，并且保证了 staging 与 develop 完全同步。\nrelease 也一样，测试通过后，用 rebase 一次性将 staging 合并过去，同样保证了 staging 与 release 完全同步。\ncommit 规范与提交验证 commit 规范是指 git commit 时填写的描述信息，要符合统一规范。\n试想，如果团队成员的 commit 是随意填写的，在协作开发和 review 代码时，其他人根本不知道这个 commit 是完成了什么功能，或是修复了什么 Bug，很难把控进度。\n为了直观的看出 commit 的更新内容，开发者社区诞生了一种规范，将 commit 按照功能划分，加一些固定前缀，比如 fix:，feat:，用来标记这个 commit 主要做了什么事情。\n目前主流的前缀包括以下部分：\nbuild：表示构建，发布版本可用这个 ci：更新 CI/CD 等自动化配置 chore：杂项，其他更改 docs：更新文档 feat：常用，表示新增功能 fix：常用：表示修复 bug perf：性能优化 refactor：重构 revert：代码回滚 style：样式更改 test：单元测试更改 这些前缀每次提交都要写，刚开始很多人还是记不住的。这里推荐一个非常好用的工具，可以自动生成前缀。地址在这里\n首先全局安装：\nsh\n代码解读\n复制代码\nnpm install -g commitizen cz-conventional-changelog\n创建 ~/.czrc 文件，写入如下内容：\njs\n代码解读\n复制代码\n{ \"path\": \"cz-conventional-changelog\" }\n现在可以用 git cz 命令来代替 git commit 命令，效果如下：\n然后上下箭选择前缀，根据提示即可方便的创建符合规范的提交。\n有了规范之后，光靠人的自觉遵守是不行的，还要在流程上对提交信息进行校验。\n这个时候，我们要用到一个新东西 —— git hook，也就是 git 钩子。\ngit hook 的作用是在 git 动作发生前后触发自定义脚本。这些动作包括提交，合并，推送等，我们可以利用这些钩子在 git 流程的各个环节实现自己的业务逻辑。\ngit hook 分为客户端 hook 和服务端 hook。\n客户端 hook 主要有四个：\npre-commit：提交信息前运行，可检查暂存区的代码 prepare-commit-msg：不常用 commit-msg：非常重要，检查提交信息就用这个钩子 post-commit：提交完成后运行 服务端 hook 包括：\npre-receive：非常重要，推送前的各种检查都在这 post-receive：不常用 update：不常用 大多数团队是在客户端做校验，所以我们用 commit-msg 钩子在客户端对 commit 信息做校验。\n幸运的是，不需要我们手动去写校验逻辑，社区有成熟的方案：husky + commitlint\nhusky 是创建 git 客户端钩子的神器，commitlint 是校验 commit 信息是否符合上述规范。两者配合，可以阻止创建不符合 commit 规范的提交，从源头保证提交的规范。\nhusky + commitlint 的具体使用方法请看这里\n误操作的撤回方案 开发中频繁使用 git 拉取推送代码，难免会有误操作。这个时候不要慌，git 支持绝大多数场景的撤回方案，我们来总结一下。\n撤回主要是两个命令：reset 和 revert\ngit reset reset 命令的原理是根据 commitId 来恢复版本。因为每次提交都会生成一个 commitId，所以说 reset 可以帮你恢复到历史的任何一个版本。\n这里的版本和提交是一个意思，一个 commitId 就是一个版本\nreset 命令格式如下：\nsh\n代码解读\n复制代码\n$ git reset [option] [commitId]\n比如，要撤回到某一次提交，命令是这样：\nsh\n代码解读\n复制代码\n$ git reset --hard cc7b5be\n上面的命令，commitId 是如何获取的？很简单，用 git log 命令查看提交记录，可以看到 commitId 值，这个值很长，我们取前 7 位即可。\n这里的 option 用的是 --hard，其实共有 3 个值，具体含义如下：\n--hard：撤销 commit，撤销 add，删除工作区改动代码 --mixed：默认参数。撤销 commit，撤销 add，还原工作区改动代码 --soft：撤销 commit，不撤销 add，还原工作区改动代码 这里要格外注意 --hard，使用这个参数恢复会删除工作区代码。也就是说，如果你的项目中有未提交的代码，使用该参数会直接删除掉，不可恢复，慎重啊！\n除了使用 commitId 恢复，git reset 还提供了恢复到上一次提交的快捷方式：\nsh\n代码解读\n复制代码\n$ git reset --soft HEAD^\nHEAD^ 表示上一个提交，可多次使用。\n其实平日开发中最多的误操作是这样：刚刚提交完，突然发现了问题，比如提交信息没写好，或者代码更改有遗漏，这时需要撤回到上次提交，修改代码，然后重新提交。\n这个流程大致是这样的：\nsh\n代码解读\n复制代码\n# 1. 回退到上次提交 $ git reset HEAD^ # 2. 修改代码... ... # 3. 加入暂存 $ git add . # 4. 重新提交 $ git commit -m 'fix: ***'\n针对这个流程，git 还提供了一个更便捷的方法：\nsh\n代码解读\n复制代码\n$ git commit --amend\n这个命令会直接修改当前的提交信息。如果代码有更改，先执行 git add，然后再执行这个命令，比上述的流程更快捷更方便。\nreset 还有一个非常重要的特性，就是真正的后退一个版本。\n什么意思呢？比如说当前提交，你已经推送到了远程仓库；现在你用 reset 撤回了一次提交，此时本地 git 仓库要落后于远程仓库一个版本。此时你再 push，远程仓库会拒绝，要求你先 pull。\n如果你需要远程仓库也后退版本，就需要 -f 参数，强制推送，这时本地代码会覆盖远程代码。\n注意，-f 参数非常危险！如果你对 git 原理和命令行不是非常熟悉，切记不要用这个参数。\n那撤回上一个版本的代码，怎么同步到远程更安全呢？\n方案就是下面要说的第二个命令：git revert\ngit revert revert 与 reset 的作用一样，都是恢复版本，但是它们两的实现方式不同。\n简单来说，reset 直接恢复到上一个提交，工作区代码自然也是上一个提交的代码；而 revert 是新增一个提交，但是这个提交是使用上一个提交的代码。\n因此，它们两恢复后的代码是一致的，区别是一个新增提交（revert），一个回退提交（reset）。\n正因为 revert 永远是在新增提交，因此本地仓库版本永远不可能落后于远程仓库，可以直接推送到远程仓库，故而解决了 reset 后推送需要加 -f 参数的问题，提高了安全性。\n说完了原理，我们再看一下使用方法：\nsh\n代码解读\n复制代码\n$ git revert -n [commitId]\n掌握了原理使用就很简单，只要一个 commitId 就可以了。\nTag 与生产环境 git 支持对于历史的某个提交，打一个 tag 标签，常用于标识重要的版本更新。\n目前普遍的做法是，用 tag 来表示生产环境的版本。当最新的提交通过测试，准备发布之时，我们就可以创建一个 tag，表示要发布的生产环境版本。\n比如我要发一个 v1.2.4 的版本：\nsh\n代码解读\n复制代码\n$ git tag -a v1.2.4 -m \"my version 1.2.4\"\n然后可以查看：\nsh\n代码解读\n复制代码\n$ git show v1.2.4 \u003e tag v1.2.4 Tagger: ruims \u003c2218466341@qq.com\u003e Date: Sun Sep 26 10:24:30 2021 +0800 my version 1.2.4\n最后用 git push 将 tag 推到远程：\nsh\n代码解读\n复制代码\n$ git push origin v1.2.4\n这里注意：tag 和在哪个分支创建是没有关系的，tag 只是提交的别名。因此 commit 的能力 tag 均可使用，比如上面说的 git reset，git revert 命令。\n当生产环境出问题，需要版本回退时，可以这样：\nsh\n代码解读\n复制代码\n$ git revert [pre-tag] # 若上一个版本是 v1.2.3，则： $ git revert v1.2.3\n在频繁更新，commit 数量庞大的仓库里，用 tag 标识版本显然更清爽，可读性更佳。\n再换一个角度思考 tag 的用处。\n上面分支管理策略的部分说过，release 分支与生产环境代码同步。在 CI/CD（下面会讲到）持续部署的流程中，我们是监听 release 分支的推送然后触发自动构建。\n那是不是也可以监听 tag 推送再触发自动构建，这样版本更新的直观性是不是更好？\n诸多用处，还待大家思考。\n永久杜绝 443 Timeout 我们团队内部的代码仓库是 GitHub，众所周知的原因，GitHub 拉取和推送的速度非常慢，甚至直接报错：443 Timeout。\n我们开始的方案是，全员开启 VPN。虽然大多时候速度不错，但是确实有偶尔的一个小时，甚至一天，代码死活推不上去，严重影响开发进度。\n后来突然想到，速度慢超时是因为被墙，比如 GitHub 首页打不开。再究其根源，被墙的是访问网站时的 http 或 https 协议，那么其他协议是不是就不会有墙的情况？\n想到就做。我们发现 GitHub 除了默认的 https 协议，还支持 ssh 协议。于是准备尝试一下使用 ssh 协议克隆代码。\n用 ssh 协议比较麻烦的一点，是要配置免密登录，否则每次 pull/push 时都要输入账号密码。\nGitHub 配置 SSH 的官方文档在这里\n英文吃力的同学，可以看这里\n总之，生成公钥后，打开 GitHub 首页，点 Account -\u003e Settings -\u003e SSH and GPG keys -\u003e Add SSH key，然后将公钥粘贴进去即可。\n现在，我们用 ssh 协议克隆代码，例子如下：\nsh\n代码解读\n复制代码\n$ git clone git@github.com:[organi-name]/[project-name]\n发现瞬间克隆下来了！再测几次 pull/push，速度飞起！\n不管你用哪个代码管理平台，如果遇到 443 Timeout 问题，请试试 ssh 协议！\nhook 实现部署？ 利用 git hook 实现部署，应该是 hook 的高级应用了。\n现在有很多工具，比如 GitHub，GitLab，都提供了持续集成功能，也就是监听某一分支推送，然后触发自动构建，并自动部署。\n其实，不管这些工具有多少花样，核心的功能（监听和构建）还是由 git 提供。只不过在核心功能上做了与自家平台更好的融合。\n我们今天就抛开这些工具，追本溯源，使用纯 git 实现一个 react 项目的自动部署。掌握了这套核心逻辑，其他任何平台的持续部署也就没那么神秘了。\n由于这一部分内容较多，所以单独拆出去一篇文章，地址如下：\n纯 Git 实现前端 CI/CD\n终极应用: CI/CD 上面的一些地方也提到了持续集成，持续部署这些字眼，现在，千呼万唤始出来，主角正式登场了！\n可以这么说，上面写到的所有规范规则，都是为了更好的设计和实现这个主角 ——— CI/CD。\n首先了解一下，什么是 CI/CD ？\n核心概念，CI（Continuous Integration）译为持续集成，CD 包括两部分，持续交付（Continuous Delivery）和持续部署（Continuous Deployment）\n从全局看，CI/CD 是一种通过自动化流程来频繁向客户交付应用的方法。这个流程贯穿了应用的集成，测试，交付和部署的整个生命周期，统称为 “CI/CD 管道”。\n虽然都是像流水线一样自动化的管道，但是 CI 和 CD 各有分工。\n持续集成是频繁地将代码集成到主干分支。当新代码提交，会自动执行构建、测试，测试通过则自动合并到主干分支，实现了产品快速迭代的同时保持高质量。\n持续交付是频繁地将软件的新版本，交付给质量团队或者用户，以供评审。评审通过则可以发布生产环境。持续交付要求代码（某个分支的最新提交）是随时可发布的状态。\n持续部署是代码通过评审后，自动部署到生产环境。持续部署要求代码（某个分支的最新提交）是随时可部署的。\n持续部署与持续交付的唯一区别，就是部署到生产环境这一步，是否是自动化。\n部署自动化，看似是小小的一步，但是在实践过程中你会发现，这反而是 CI/CD 流水线中最难落实的一环。\n为什么？首先，从持续集成到持续交付，这些个环节都是由开发团队实施的。我们通过团队内部协作，产出了新版本的待发布的应用。\n然而将应用部署到服务器，这是运维团队的工作。我们要实现部署，就要与运维团队沟通，然而开发同学不了解服务器，运维同学不了解代码，沟通起来困难重重。\n再有，运维是手动部署，我们要实现自动部署，就要有服务器权限，与服务器交互。这也是个大问题，因为运维团队一定会顾虑安全问题，因而推动起来节节受阻。\n目前社区成熟的 CI/CD 方案有很多，比如老牌的 jenkins，react 使用的 circleci，还有我认为最好用的GitHub Action等，我们可以将这些方案接入到自己的系统当中。\n这篇文章篇幅已经很长了，就到这里结束吧。接下来我会基于 GitHub Action 单独出一篇详细的 react 前端项目 CI/CD 实践。\n如果这篇文章对你有帮助，请毫不犹豫的点赞，这是对我最大的鼓励。\n",
  "wordCount" : "700",
  "inLanguage": "zh",
  "image": "http://localhost:1313/images/papermod-cover.png","datePublished": "2021-10-28T00:00:00Z",
  "dateModified": "2021-10-28T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "杨成功"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://localhost:1313/posts/juejin/%E5%89%8D%E7%AB%AF%E6%9E%B6%E6%9E%84%E5%B8%88%E7%9A%84git%E5%8A%9F%E5%8A%9B%E4%BD%A0%E6%9C%89%E5%87%A0%E6%88%90%E7%81%AB%E5%80%99/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "PaperMod",
    "logo": {
      "@type": "ImageObject",
      "url": "http://localhost:1313/%3Clink%20/%20abs%20url%3E"
    }
  }
}
</script>
</head>

<body class=" dark" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Home (Alt + H)">
                        
                    <img src="http://localhost:1313/images/msg_hu15231257772499651944.png" alt="" aria-label="logo"
                        height="20">Home</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/archives" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://github.com/adityatelange/hugo-PaperMod/wiki/" title="WiKi">
                    <span>WiKi</span>&nbsp;
                    <svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round"
                        stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12">
                        <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path>
                        <path d="M15 3h6v6"></path>
                        <path d="M10 14L21 3"></path>
                    </svg>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/">主页</a>&nbsp;»&nbsp;<a href="http://localhost:1313/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      前端架构师的git功力，你有几成火候？
    </h1>
    <div class="post-description">
      本文从前端工程，团队协作，GitFlow，提交规范与校验，生产部署的角度，介绍架构人员需要掌握的git实践能力
    </div>
    <div class="post-meta"><span title='2021-10-28 00:00:00 +0000 UTC'>十月 28, 2021</span>&nbsp;·&nbsp;4 分钟&nbsp;·&nbsp;杨成功&nbsp;|&nbsp;<a href="https://github.com/WangShaoyu1/myBlogPaperMod/tree/master/content/posts/jueJin/%e5%89%8d%e7%ab%af%e6%9e%b6%e6%9e%84%e5%b8%88%e7%9a%84git%e5%8a%9f%e5%8a%9b%ef%bc%8c%e4%bd%a0%e6%9c%89%e5%87%a0%e6%88%90%e7%81%ab%e5%80%99%ef%bc%9f.md" rel="noopener noreferrer" target="_blank">Suggest Changes</a>

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">目录</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e5%a4%a7%e7%ba%b2%e9%a2%84%e8%a7%88" aria-label="大纲预览">大纲预览</a></li>
                <li>
                    <a href="#%e5%88%86%e6%94%af%e7%ae%a1%e7%90%86%e7%ad%96%e7%95%a5" aria-label="分支管理策略">分支管理策略</a><ul>
                        <ul>
                        
                <li>
                    <a href="#%e4%b8%ba%e4%bb%80%e4%b9%88%e5%90%88%e5%b9%b6%e5%88%b0-develop-%e5%bf%85%e9%a1%bb%e7%94%a8-cherry-pick" aria-label="为什么合并到 develop 必须用 cherry-pick？">为什么合并到 develop 必须用 cherry-pick？</a></li>
                <li>
                    <a href="#%e4%b8%ba%e4%bb%80%e4%b9%88%e5%90%88%e5%b9%b6%e5%88%b0-stagingrelease-%e5%bf%85%e9%a1%bb%e7%94%a8-rebase" aria-label="为什么合并到 staging/release 必须用 rebase？">为什么合并到 staging/release 必须用 rebase？</a></li></ul>
                    </ul>
                </li>
                <li>
                    <a href="#commit-%e8%a7%84%e8%8c%83%e4%b8%8e%e6%8f%90%e4%ba%a4%e9%aa%8c%e8%af%81" aria-label="commit 规范与提交验证">commit 规范与提交验证</a></li>
                <li>
                    <a href="#%e8%af%af%e6%93%8d%e4%bd%9c%e7%9a%84%e6%92%a4%e5%9b%9e%e6%96%b9%e6%a1%88" aria-label="误操作的撤回方案">误操作的撤回方案</a><ul>
                        
                <li>
                    <a href="#git-reset" aria-label="git reset">git reset</a></li>
                <li>
                    <a href="#git-revert" aria-label="git revert">git revert</a></li></ul>
                </li>
                <li>
                    <a href="#tag-%e4%b8%8e%e7%94%9f%e4%ba%a7%e7%8e%af%e5%a2%83" aria-label="Tag 与生产环境">Tag 与生产环境</a></li>
                <li>
                    <a href="#%e6%b0%b8%e4%b9%85%e6%9d%9c%e7%bb%9d-443-timeout" aria-label="永久杜绝 443 Timeout">永久杜绝 443 Timeout</a></li>
                <li>
                    <a href="#hook-%e5%ae%9e%e7%8e%b0%e9%83%a8%e7%bd%b2" aria-label="hook 实现部署？">hook 实现部署？</a></li>
                <li>
                    <a href="#%e7%bb%88%e6%9e%81%e5%ba%94%e7%94%a8-cicd" aria-label="终极应用: CI/CD">终极应用: CI/CD</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>本文从前端工程，团队协作，生产部署的角度，介绍架构人员需要掌握的 git 实践能力。</p>
<h2 id="大纲预览">大纲预览<a hidden class="anchor" aria-hidden="true" href="#大纲预览">#</a></h2>
<p>本文介绍的内容包括以下方面：</p>
<ul>
<li>分支管理策略</li>
<li>commit 规范与提交验证</li>
<li>误操作的撤回方案</li>
<li>Tag 与生产环境</li>
<li>永久杜绝 443 Timeout</li>
<li>hook 实现部署？</li>
<li>终极应用: CI/CD</li>
</ul>
<h2 id="分支管理策略">分支管理策略<a hidden class="anchor" aria-hidden="true" href="#分支管理策略">#</a></h2>
<p>git 分支强大的同时也非常灵活，如果没有一个好的分支管理策略，团队人员随意合并推送，就会造成分支混乱，各种覆盖，冲突，丢失等问题。</p>
<p>目前最流行的分支管理策略，也称工作流（Workflow），主要包含三种：</p>
<ul>
<li>Git Flow</li>
<li>GitHub Flow</li>
<li>GitLab Flow</li>
</ul>
<p>我司前端团队结合实际情况，制定出自己的一套分支管理策略。</p>
<p>我们将分支分为 4 个大类：</p>
<ul>
<li>dev-*</li>
<li>develop</li>
<li>staging</li>
<li>release</li>
</ul>
<p><code>dev-*</code> 是一组开发分支的统称，包括个人分支，模块分支，修复分支等，团队开发人员在这组分支上进行开发。</p>
<p>开发前，先通过 <code>merge</code> 合并 develop 分支的最新代码；开发完成后，必须通过 <code>cherry-pick</code> 合并回 <code>develop</code> 分支。</p>
<p><code>develop</code> 是一个单独分支，对应开发环境，保留最新的完整的开发代码。它只接受 <code>cherry-pick</code> 的合并，不允许使用 merge。</p>
<p><code>staging</code> 分支对应测试环境。当 develop 分支有更新并且准备发布测试时，staging 要通过 <code>rebase</code> 合并 develop 分支，然后将最新代码发布到测试服务器，供测试人员测试。</p>
<p>测试发现问题后，再走 <strong>dev-* -&gt; develop -&gt; staging</strong> 的流程，直到测试通过。</p>
<p><code>release</code> 则表示生产环境。release 分支的最新提交永远与线上生产环境代码保持同步，也就是说，release 分支是随时可发布的。</p>
<p>当 staging 测试通过后，<code>release</code> 分支通过 <code>rebase</code> 合并 staging 分支，然后将最新代码发布到生产服务器。</p>
<p>总结下合并规则：</p>
<ul>
<li>develop -&gt; (merge) -&gt; dev-*</li>
<li>dev-* -&gt; (cherry-pick) -&gt; develop</li>
<li>develop -&gt; (rebase) -&gt; staging</li>
<li>staging -&gt; (rebase) -&gt; release</li>
</ul>
<h4 id="为什么合并到-develop-必须用-cherry-pick">为什么合并到 develop 必须用 cherry-pick？<a hidden class="anchor" aria-hidden="true" href="#为什么合并到-develop-必须用-cherry-pick">#</a></h4>
<p>使用 merge 合并，如果有冲突，会产生分叉；<code>dev-*</code> 分支多而杂，直接 merge 到 develop 会产生错综复杂的分叉，难以理清提交进度。</p>
<p>而 cherry-pick 只将需要的 commit 合并到 develop 分支上，且不会产生分叉，使 git 提交图谱（git graph）永远保持一条直线。</p>
<p>再有，模块开发分支完成后，需要将多个 commit 合为一个 commit，再合并到 develop 分支，避免了多余的 commit，这也是不用 merge 的原因之一。</p>
<h4 id="为什么合并到-stagingrelease-必须用-rebase">为什么合并到 staging/release 必须用 rebase？<a hidden class="anchor" aria-hidden="true" href="#为什么合并到-stagingrelease-必须用-rebase">#</a></h4>
<p>rebase 译为变基，合并同样不会产生分叉。当 develop 更新了许多功能，要合并到 staging 测试，不可能用 cherry-pick 一个一个把 commit 合并过去。因此要通过 rebase 一次性合并过去，并且保证了 staging 与 develop 完全同步。</p>
<p>release 也一样，测试通过后，用 rebase 一次性将 staging 合并过去，同样保证了 staging 与 release 完全同步。</p>
<h2 id="commit-规范与提交验证">commit 规范与提交验证<a hidden class="anchor" aria-hidden="true" href="#commit-规范与提交验证">#</a></h2>
<p>commit 规范是指 git commit 时填写的描述信息，要符合统一规范。</p>
<p>试想，如果团队成员的 commit 是随意填写的，在协作开发和 review 代码时，其他人根本不知道这个 commit 是完成了什么功能，或是修复了什么 Bug，很难把控进度。</p>
<p>为了直观的看出 commit 的更新内容，开发者社区诞生了一种规范，将 commit 按照功能划分，加一些固定前缀，比如 <code>fix:</code>，<code>feat:</code>，用来标记这个 commit 主要做了什么事情。</p>
<p>目前主流的前缀包括以下部分：</p>
<ul>
<li><code>build</code>：表示构建，发布版本可用这个</li>
<li><code>ci</code>：更新 CI/CD 等自动化配置</li>
<li><code>chore</code>：杂项，其他更改</li>
<li><code>docs</code>：更新文档</li>
<li><code>feat</code>：常用，表示新增功能</li>
<li><code>fix</code>：常用：表示修复 bug</li>
<li><code>perf</code>：性能优化</li>
<li><code>refactor</code>：重构</li>
<li><code>revert</code>：代码回滚</li>
<li><code>style</code>：样式更改</li>
<li><code>test</code>：单元测试更改</li>
</ul>
<p>这些前缀每次提交都要写，刚开始很多人还是记不住的。这里推荐一个非常好用的工具，可以自动生成前缀。地址在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcommitizen%2Fcz-conventional-changelog" title="https://github.com/commitizen/cz-conventional-changelog">这里</a></p>
<p>首先全局安装：</p>
<p>sh</p>
<p>代码解读</p>
<p>复制代码</p>
<p><code>npm install -g commitizen cz-conventional-changelog</code></p>
<p>创建 <code>~/.czrc</code> 文件，写入如下内容：</p>
<p>js</p>
<p>代码解读</p>
<p>复制代码</p>
<p><code>{ &quot;path&quot;: &quot;cz-conventional-changelog&quot; }</code></p>
<p>现在可以用 <code>git cz</code> 命令来代替 <code>git commit</code> 命令，效果如下：</p>
<p><img loading="lazy" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c754c4b9be254927830979e9ef06a33e~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1016&amp;h=284&amp;s=62736&amp;e=png&amp;b=282923" alt="WX20210922.png"  />
</p>
<p>然后上下箭选择前缀，根据提示即可方便的创建符合规范的提交。</p>
<p>有了规范之后，光靠人的自觉遵守是不行的，还要在流程上对提交信息进行校验。</p>
<p>这个时候，我们要用到一个新东西 —— <code>git hook</code>，也就是 git 钩子。</p>
<p>git hook 的作用是在 git 动作发生前后触发自定义脚本。这些动作包括提交，合并，推送等，我们可以利用这些钩子在 git 流程的各个环节实现自己的业务逻辑。</p>
<p>git hook 分为客户端 hook 和服务端 hook。</p>
<p>客户端 hook 主要有四个：</p>
<ul>
<li><code>pre-commit</code>：提交信息前运行，可检查暂存区的代码</li>
<li><code>prepare-commit-msg</code>：不常用</li>
<li><code>commit-msg</code>：非常重要，检查提交信息就用这个钩子</li>
<li><code>post-commit</code>：提交完成后运行</li>
</ul>
<p>服务端 hook 包括：</p>
<ul>
<li><code>pre-receive</code>：非常重要，推送前的各种检查都在这</li>
<li><code>post-receive</code>：不常用</li>
<li><code>update</code>：不常用</li>
</ul>
<p>大多数团队是在客户端做校验，所以我们用 <code>commit-msg</code> 钩子在客户端对 commit 信息做校验。</p>
<p>幸运的是，不需要我们手动去写校验逻辑，社区有成熟的方案：<code>husky + commitlint</code></p>
<p>husky 是创建 git 客户端钩子的神器，commitlint 是校验 commit 信息是否符合上述规范。两者配合，可以阻止创建不符合 commit 规范的提交，从源头保证提交的规范。</p>
<p>husky + commitlint 的具体使用方法请看<a href="https://link.juejin.cn?target=https%3A%2F%2Fbook.ruims.top%2Fgit%2Fpractice%2Fhusky.html" title="https://book.ruims.top/git/practice/husky.html">这里</a></p>
<h2 id="误操作的撤回方案">误操作的撤回方案<a hidden class="anchor" aria-hidden="true" href="#误操作的撤回方案">#</a></h2>
<p>开发中频繁使用 git 拉取推送代码，难免会有误操作。这个时候不要慌，git 支持绝大多数场景的撤回方案，我们来总结一下。</p>
<p>撤回主要是两个命令：<code>reset</code> 和 <code>revert</code></p>
<h3 id="git-reset">git reset<a hidden class="anchor" aria-hidden="true" href="#git-reset">#</a></h3>
<p>reset 命令的原理是根据 <code>commitId</code> 来恢复版本。因为每次提交都会生成一个 commitId，所以说 reset 可以帮你恢复到历史的任何一个版本。</p>
<blockquote>
<p>这里的版本和提交是一个意思，一个 commitId 就是一个版本</p>
</blockquote>
<p>reset 命令格式如下：</p>
<p>sh</p>
<p>代码解读</p>
<p>复制代码</p>
<p><code>$ git reset [option] [commitId]</code></p>
<p>比如，要撤回到某一次提交，命令是这样：</p>
<p>sh</p>
<p>代码解读</p>
<p>复制代码</p>
<p><code>$ git reset --hard cc7b5be</code></p>
<p>上面的命令，commitId 是如何获取的？很简单，用 <code>git log</code> 命令查看提交记录，可以看到 commitId 值，这个值很长，我们取前 7 位即可。</p>
<p>这里的 option 用的是 <code>--hard</code>，其实共有 3 个值，具体含义如下：</p>
<ul>
<li><code>--hard</code>：撤销 commit，撤销 add，删除工作区改动代码</li>
<li><code>--mixed</code>：默认参数。撤销 commit，撤销 add，还原工作区改动代码</li>
<li><code>--soft</code>：撤销 commit，不撤销 add，还原工作区改动代码</li>
</ul>
<p>这里要格外注意 <code>--hard</code>，使用这个参数恢复会删除工作区代码。也就是说，如果你的项目中有未提交的代码，使用该参数会直接删除掉，不可恢复，慎重啊！</p>
<p>除了使用 commitId 恢复，git reset 还提供了恢复到上一次提交的快捷方式：</p>
<p>sh</p>
<p>代码解读</p>
<p>复制代码</p>
<p><code>$ git reset --soft HEAD^</code></p>
<p><code>HEAD^</code> 表示上一个提交，可多次使用。</p>
<p>其实平日开发中最多的误操作是这样：刚刚提交完，突然发现了问题，比如提交信息没写好，或者代码更改有遗漏，这时需要撤回到上次提交，修改代码，然后重新提交。</p>
<p>这个流程大致是这样的：</p>
<p>sh</p>
<p>代码解读</p>
<p>复制代码</p>
<p><code># 1. 回退到上次提交 $ git reset HEAD^ # 2. 修改代码... ... # 3. 加入暂存 $ git add . # 4. 重新提交 $ git commit -m 'fix: ***'</code></p>
<p>针对这个流程，git 还提供了一个更便捷的方法：</p>
<p>sh</p>
<p>代码解读</p>
<p>复制代码</p>
<p><code>$ git commit --amend</code></p>
<p>这个命令会直接修改当前的提交信息。如果代码有更改，先执行 <code>git add</code>，然后再执行这个命令，比上述的流程更快捷更方便。</p>
<p>reset 还有一个非常重要的特性，就是<strong>真正的后退一个版本</strong>。</p>
<p>什么意思呢？比如说当前提交，你已经推送到了远程仓库；现在你用 reset 撤回了一次提交，此时本地 git 仓库要落后于远程仓库一个版本。此时你再 push，远程仓库会拒绝，要求你先 pull。</p>
<p>如果你需要远程仓库也后退版本，就需要 <code>-f</code> 参数，强制推送，这时本地代码会覆盖远程代码。</p>
<p>注意，<code>-f</code> 参数非常危险！如果你对 git 原理和命令行不是非常熟悉，切记不要用这个参数。</p>
<p>那撤回上一个版本的代码，怎么同步到远程更安全呢？</p>
<p>方案就是下面要说的第二个命令：<code>git revert</code></p>
<h3 id="git-revert">git revert<a hidden class="anchor" aria-hidden="true" href="#git-revert">#</a></h3>
<p>revert 与 reset 的作用一样，都是恢复版本，但是它们两的实现方式不同。</p>
<p>简单来说，reset 直接恢复到上一个提交，工作区代码自然也是上一个提交的代码；而 revert 是新增一个提交，但是这个提交是使用上一个提交的代码。</p>
<p>因此，它们两恢复后的代码是一致的，区别是一个新增提交（revert），一个回退提交（reset）。</p>
<p>正因为 revert 永远是在新增提交，因此本地仓库版本永远不可能落后于远程仓库，可以直接推送到远程仓库，故而解决了 reset 后推送需要加 <code>-f</code> 参数的问题，提高了安全性。</p>
<p>说完了原理，我们再看一下使用方法：</p>
<p>sh</p>
<p>代码解读</p>
<p>复制代码</p>
<p><code>$ git revert -n [commitId]</code></p>
<p>掌握了原理使用就很简单，只要一个 commitId 就可以了。</p>
<h2 id="tag-与生产环境">Tag 与生产环境<a hidden class="anchor" aria-hidden="true" href="#tag-与生产环境">#</a></h2>
<p>git 支持对于历史的某个提交，打一个 tag 标签，常用于标识重要的版本更新。</p>
<p>目前普遍的做法是，用 tag 来表示生产环境的版本。当最新的提交通过测试，准备发布之时，我们就可以创建一个 tag，表示要发布的生产环境版本。</p>
<p>比如我要发一个 <code>v1.2.4</code> 的版本：</p>
<p>sh</p>
<p>代码解读</p>
<p>复制代码</p>
<p><code>$ git tag -a v1.2.4 -m &quot;my version 1.2.4&quot;</code></p>
<p>然后可以查看：</p>
<p>sh</p>
<p>代码解读</p>
<p>复制代码</p>
<p><code>$ git show v1.2.4 &gt; tag v1.2.4 Tagger: ruims &lt;2218466341@qq.com&gt; Date:   Sun Sep 26 10:24:30 2021 +0800 my version 1.2.4</code></p>
<p>最后用 git push 将 tag 推到远程：</p>
<p>sh</p>
<p>代码解读</p>
<p>复制代码</p>
<p><code>$ git push origin v1.2.4</code></p>
<p><strong>这里注意</strong>：tag 和在哪个分支创建是没有关系的，tag 只是提交的别名。因此 commit 的能力 tag 均可使用，比如上面说的 <code>git reset</code>，<code>git revert</code> 命令。</p>
<p>当生产环境出问题，需要版本回退时，可以这样：</p>
<p>sh</p>
<p>代码解读</p>
<p>复制代码</p>
<p><code>$ git revert [pre-tag] # 若上一个版本是 v1.2.3，则： $ git revert v1.2.3</code></p>
<p>在频繁更新，commit 数量庞大的仓库里，用 tag 标识版本显然更清爽，可读性更佳。</p>
<p>再换一个角度思考 tag 的用处。</p>
<p>上面分支管理策略的部分说过，release 分支与生产环境代码同步。在 CI/CD（下面会讲到）持续部署的流程中，我们是监听 release 分支的推送然后触发自动构建。</p>
<p>那是不是也可以监听 tag 推送再触发自动构建，这样版本更新的直观性是不是更好？</p>
<p>诸多用处，还待大家思考。</p>
<h2 id="永久杜绝-443-timeout">永久杜绝 443 Timeout<a hidden class="anchor" aria-hidden="true" href="#永久杜绝-443-timeout">#</a></h2>
<p>我们团队内部的代码仓库是 GitHub，众所周知的原因，GitHub 拉取和推送的速度非常慢，甚至直接报错：443 Timeout。</p>
<p>我们开始的方案是，全员开启 VPN。虽然大多时候速度不错，但是确实有偶尔的一个小时，甚至一天，代码死活推不上去，严重影响开发进度。</p>
<p>后来突然想到，速度慢超时是因为被墙，比如 GitHub 首页打不开。再究其根源，被墙的是访问网站时的 http 或 https 协议，那么其他协议是不是就不会有墙的情况？</p>
<p>想到就做。我们发现 GitHub 除了默认的 <code>https</code> 协议，还支持 <code>ssh</code> 协议。于是准备尝试一下使用 ssh 协议克隆代码。</p>
<p>用 ssh 协议比较麻烦的一点，是要配置免密登录，否则每次 pull/push 时都要输入账号密码。</p>
<p>GitHub 配置 SSH 的官方文档在<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.github.com%2Fen%2Fauthentication%2Fconnecting-to-github-with-ssh" title="https://docs.github.com/en/authentication/connecting-to-github-with-ssh">这里</a></p>
<p>英文吃力的同学，可以看<a href="https://link.juejin.cn?target=https%3A%2F%2Fbook.ruims.top%2Fserver%2Fshell%2Fssh-nopass.html" title="https://book.ruims.top/server/shell/ssh-nopass.html">这里</a></p>
<p>总之，生成公钥后，打开 GitHub 首页，点 <strong>Account -&gt; Settings -&gt; SSH and GPG keys -&gt; Add SSH key</strong>，然后将公钥粘贴进去即可。</p>
<p>现在，我们用 ssh 协议克隆代码，例子如下：</p>
<p>sh</p>
<p>代码解读</p>
<p>复制代码</p>
<p><code>$ git clone git@github.com:[organi-name]/[project-name]</code></p>
<p>发现瞬间克隆下来了！再测几次 pull/push，速度飞起！</p>
<p>不管你用哪个代码管理平台，如果遇到 443 Timeout 问题，请试试 ssh 协议！</p>
<h2 id="hook-实现部署">hook 实现部署？<a hidden class="anchor" aria-hidden="true" href="#hook-实现部署">#</a></h2>
<p>利用 git hook 实现部署，应该是 hook 的高级应用了。</p>
<p>现在有很多工具，比如 GitHub，GitLab，都提供了持续集成功能，也就是监听某一分支推送，然后触发自动构建，并自动部署。</p>
<p>其实，不管这些工具有多少花样，核心的功能（监听和构建）还是由 git 提供。只不过在核心功能上做了与自家平台更好的融合。</p>
<p>我们今天就抛开这些工具，追本溯源，使用纯 git 实现一个 react 项目的自动部署。掌握了这套核心逻辑，其他任何平台的持续部署也就没那么神秘了。</p>
<p>由于这一部分内容较多，所以单独拆出去一篇文章，地址如下：</p>
<p><a href="https://juejin.cn/post/7012203717818580999/" title="https://juejin.cn/post/7012203717818580999/">纯 Git 实现前端 CI/CD</a></p>
<h2 id="终极应用-cicd">终极应用: CI/CD<a hidden class="anchor" aria-hidden="true" href="#终极应用-cicd">#</a></h2>
<p>上面的一些地方也提到了持续集成，持续部署这些字眼，现在，千呼万唤始出来，主角正式登场了！</p>
<p>可以这么说，上面写到的所有规范规则，都是为了更好的设计和实现这个主角 ——— CI/CD。</p>
<p>首先了解一下，什么是 CI/CD ？</p>
<p>核心概念，CI（Continuous Integration）译为持续集成，CD 包括两部分，持续交付（Continuous Delivery）和持续部署（Continuous Deployment）</p>
<p>从全局看，CI/CD 是一种通过<strong>自动化流程</strong>来频繁向客户交付应用的方法。这个流程贯穿了应用的集成，测试，交付和部署的整个生命周期，统称为 “CI/CD 管道”。</p>
<p>虽然都是像流水线一样自动化的管道，但是 CI 和 CD 各有分工。</p>
<p><strong>持续集成</strong>是频繁地将代码集成到主干分支。当新代码提交，会自动执行构建、测试，测试通过则自动合并到主干分支，实现了产品快速迭代的同时保持高质量。</p>
<p><strong>持续交付</strong>是频繁地将软件的新版本，交付给质量团队或者用户，以供评审。评审通过则可以发布生产环境。持续交付要求代码（某个分支的最新提交）是随时可发布的状态。</p>
<p><strong>持续部署</strong>是代码通过评审后，自动部署到生产环境。持续部署要求代码（某个分支的最新提交）是随时可部署的。</p>
<p>持续部署与持续交付的唯一区别，就是部署到生产环境这一步，<strong>是否是自动化</strong>。</p>
<p>部署自动化，看似是小小的一步，但是在实践过程中你会发现，这反而是 CI/CD 流水线中最难落实的一环。</p>
<p>为什么？首先，从持续集成到持续交付，这些个环节都是由开发团队实施的。我们通过团队内部协作，产出了新版本的待发布的应用。</p>
<p>然而将应用部署到服务器，这是运维团队的工作。我们要实现部署，就要与运维团队沟通，然而开发同学不了解服务器，运维同学不了解代码，沟通起来困难重重。</p>
<p>再有，运维是手动部署，我们要实现自动部署，就要有服务器权限，与服务器交互。这也是个大问题，因为运维团队一定会顾虑安全问题，因而推动起来节节受阻。</p>
<p>目前社区成熟的 CI/CD 方案有很多，比如老牌的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.jenkins.io%2F" title="https://www.jenkins.io/">jenkins</a>，react 使用的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcircleci.com%2F" title="https://circleci.com/">circleci</a>，还有我认为最好用的<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffeatures%2Factions" title="https://github.com/features/actions">GitHub Action</a>等，我们可以将这些方案接入到自己的系统当中。</p>
<p>这篇文章篇幅已经很长了，就到这里结束吧。接下来我会基于 GitHub Action 单独出一篇详细的 react 前端项目 CI/CD 实践。</p>
<p>如果这篇文章对你有帮助，请<strong>毫不犹豫的点赞</strong>，这是对我最大的鼓励。</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/%E6%9E%B6%E6%9E%84/">架构</a></li>
      <li><a href="http://localhost:1313/tags/%E5%89%8D%E7%AB%AF/">前端</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="http://localhost:1313/posts/juejin/%E5%87%A0%E6%9D%A1%E6%9C%89%E5%8A%A9%E4%BA%8E%E6%8F%90%E9%AB%98%E5%BC%80%E5%8F%91%E8%80%85%E5%AD%A6%E4%B9%A0%E6%95%88%E7%8E%87%E7%9A%84%E5%B0%8F%E5%BB%BA%E8%AE%AE/">
    <span class="title">« 上一页</span>
    <br>
    <span>几条有助于提高开发者学习效率的小建议</span>
  </a>
  <a class="next" href="http://localhost:1313/posts/juejin/%E6%96%B0%E4%B9%A6%E5%87%BA%E7%89%88%E5%A4%A7%E9%99%86%E9%A6%96%E6%9C%ACnestjs%E5%9B%BE%E4%B9%A6nestjs%E5%85%A8%E6%A0%88%E5%BC%80%E5%8F%91%E8%A7%A3%E6%9E%90%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B%E4%B8%8E%E5%AE%9E%E8%B7%B5/">
    <span class="title">下一页 »</span>
    <br>
    <span>新书出版🎉🎉🎉，大陆首本NestJS图书《NestJS全栈开发解析：快速上手与实践》</span>
  </a>
</nav>


<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 前端架构师的git功力，你有几成火候？ on x"
            href="https://x.com/intent/tweet/?text=%e5%89%8d%e7%ab%af%e6%9e%b6%e6%9e%84%e5%b8%88%e7%9a%84git%e5%8a%9f%e5%8a%9b%ef%bc%8c%e4%bd%a0%e6%9c%89%e5%87%a0%e6%88%90%e7%81%ab%e5%80%99%ef%bc%9f&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2fjuejin%2f%25E5%2589%258D%25E7%25AB%25AF%25E6%259E%25B6%25E6%259E%2584%25E5%25B8%2588%25E7%259A%2584git%25E5%258A%259F%25E5%258A%259B%25E4%25BD%25A0%25E6%259C%2589%25E5%2587%25A0%25E6%2588%2590%25E7%2581%25AB%25E5%2580%2599%2f&amp;hashtags=%e6%9e%b6%e6%9e%84%2c%e5%89%8d%e7%ab%af">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 前端架构师的git功力，你有几成火候？ on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2fjuejin%2f%25E5%2589%258D%25E7%25AB%25AF%25E6%259E%25B6%25E6%259E%2584%25E5%25B8%2588%25E7%259A%2584git%25E5%258A%259F%25E5%258A%259B%25E4%25BD%25A0%25E6%259C%2589%25E5%2587%25A0%25E6%2588%2590%25E7%2581%25AB%25E5%2580%2599%2f&amp;title=%e5%89%8d%e7%ab%af%e6%9e%b6%e6%9e%84%e5%b8%88%e7%9a%84git%e5%8a%9f%e5%8a%9b%ef%bc%8c%e4%bd%a0%e6%9c%89%e5%87%a0%e6%88%90%e7%81%ab%e5%80%99%ef%bc%9f&amp;summary=%e5%89%8d%e7%ab%af%e6%9e%b6%e6%9e%84%e5%b8%88%e7%9a%84git%e5%8a%9f%e5%8a%9b%ef%bc%8c%e4%bd%a0%e6%9c%89%e5%87%a0%e6%88%90%e7%81%ab%e5%80%99%ef%bc%9f&amp;source=http%3a%2f%2flocalhost%3a1313%2fposts%2fjuejin%2f%25E5%2589%258D%25E7%25AB%25AF%25E6%259E%25B6%25E6%259E%2584%25E5%25B8%2588%25E7%259A%2584git%25E5%258A%259F%25E5%258A%259B%25E4%25BD%25A0%25E6%259C%2589%25E5%2587%25A0%25E6%2588%2590%25E7%2581%25AB%25E5%2580%2599%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 前端架构师的git功力，你有几成火候？ on reddit"
            href="https://reddit.com/submit?url=http%3a%2f%2flocalhost%3a1313%2fposts%2fjuejin%2f%25E5%2589%258D%25E7%25AB%25AF%25E6%259E%25B6%25E6%259E%2584%25E5%25B8%2588%25E7%259A%2584git%25E5%258A%259F%25E5%258A%259B%25E4%25BD%25A0%25E6%259C%2589%25E5%2587%25A0%25E6%2588%2590%25E7%2581%25AB%25E5%2580%2599%2f&title=%e5%89%8d%e7%ab%af%e6%9e%b6%e6%9e%84%e5%b8%88%e7%9a%84git%e5%8a%9f%e5%8a%9b%ef%bc%8c%e4%bd%a0%e6%9c%89%e5%87%a0%e6%88%90%e7%81%ab%e5%80%99%ef%bc%9f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 前端架构师的git功力，你有几成火候？ on facebook"
            href="https://facebook.com/sharer/sharer.php?u=http%3a%2f%2flocalhost%3a1313%2fposts%2fjuejin%2f%25E5%2589%258D%25E7%25AB%25AF%25E6%259E%25B6%25E6%259E%2584%25E5%25B8%2588%25E7%259A%2584git%25E5%258A%259F%25E5%258A%259B%25E4%25BD%25A0%25E6%259C%2589%25E5%2587%25A0%25E6%2588%2590%25E7%2581%25AB%25E5%2580%2599%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 前端架构师的git功力，你有几成火候？ on whatsapp"
            href="https://api.whatsapp.com/send?text=%e5%89%8d%e7%ab%af%e6%9e%b6%e6%9e%84%e5%b8%88%e7%9a%84git%e5%8a%9f%e5%8a%9b%ef%bc%8c%e4%bd%a0%e6%9c%89%e5%87%a0%e6%88%90%e7%81%ab%e5%80%99%ef%bc%9f%20-%20http%3a%2f%2flocalhost%3a1313%2fposts%2fjuejin%2f%25E5%2589%258D%25E7%25AB%25AF%25E6%259E%25B6%25E6%259E%2584%25E5%25B8%2588%25E7%259A%2584git%25E5%258A%259F%25E5%258A%259B%25E4%25BD%25A0%25E6%259C%2589%25E5%2587%25A0%25E6%2588%2590%25E7%2581%25AB%25E5%2580%2599%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 前端架构师的git功力，你有几成火候？ on telegram"
            href="https://telegram.me/share/url?text=%e5%89%8d%e7%ab%af%e6%9e%b6%e6%9e%84%e5%b8%88%e7%9a%84git%e5%8a%9f%e5%8a%9b%ef%bc%8c%e4%bd%a0%e6%9c%89%e5%87%a0%e6%88%90%e7%81%ab%e5%80%99%ef%bc%9f&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2fjuejin%2f%25E5%2589%258D%25E7%25AB%25AF%25E6%259E%25B6%25E6%259E%2584%25E5%25B8%2588%25E7%259A%2584git%25E5%258A%259F%25E5%258A%259B%25E4%25BD%25A0%25E6%259C%2589%25E5%2587%25A0%25E6%2588%2590%25E7%2581%25AB%25E5%2580%2599%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 前端架构师的git功力，你有几成火候？ on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=%e5%89%8d%e7%ab%af%e6%9e%b6%e6%9e%84%e5%b8%88%e7%9a%84git%e5%8a%9f%e5%8a%9b%ef%bc%8c%e4%bd%a0%e6%9c%89%e5%87%a0%e6%88%90%e7%81%ab%e5%80%99%ef%bc%9f&u=http%3a%2f%2flocalhost%3a1313%2fposts%2fjuejin%2f%25E5%2589%258D%25E7%25AB%25AF%25E6%259E%25B6%25E6%259E%2584%25E5%25B8%2588%25E7%259A%2584git%25E5%258A%259F%25E5%258A%259B%25E4%25BD%25A0%25E6%259C%2589%25E5%2587%25A0%25E6%2588%2590%25E7%2581%25AB%25E5%2580%2599%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span><a href="https://beian.miit.gov.cn/">粤ICP备2023039897号-1</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = '复制';

        function copyingDone() {
            copybutton.innerHTML = '已复制！';
            setTimeout(() => {
                copybutton.innerHTML = '复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
