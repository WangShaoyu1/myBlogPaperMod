<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>高可用系统设计原则 | PaperMod</title>
<meta name="keywords" content="设计">
<meta name="description" content="假设一个系统一直可以提供服务，那么这个系统的可用性是100%。大部分公司的高可用目标是9999%。也就是一年的停机时间为53分钟。保证服务集群可以进行故障转移。当服务宕机后，负载请求进行转移，来达到高可用。对某一个key进行哈希或者使用一致性哈希算法进行负载均衡。H…">
<meta name="author" content="奔跑的毛球">
<link rel="canonical" href="http://localhost:1313/posts/juejin/%E9%AB%98%E5%8F%AF%E7%94%A8%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99/">
<meta name="google-site-verification" content="XYZabc">
<link crossorigin="anonymous" href="/assets/css/stylesheet.7b92bf4867c997b58ec50f63451b83777173d5bd5593376852abd85746d09d71.css" integrity="sha256-e5K/SGfJl7WOxQ9jRRuDd3Fz1b1VkzdoUqvYV0bQnXE=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/%3Clink%20/%20abs%20url%3E">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/%3Clink%20/%20abs%20url%3E">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/%3Clink%20/%20abs%20url%3E">
<link rel="apple-touch-icon" href="http://localhost:1313/%3Clink%20/%20abs%20url%3E">
<link rel="mask-icon" href="http://localhost:1313/%3Clink%20/%20abs%20url%3E">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="http://localhost:1313/posts/juejin/%E9%AB%98%E5%8F%AF%E7%94%A8%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript><meta property="og:title" content="高可用系统设计原则" />
<meta property="og:description" content="假设一个系统一直可以提供服务，那么这个系统的可用性是100%。大部分公司的高可用目标是9999%。也就是一年的停机时间为53分钟。保证服务集群可以进行故障转移。当服务宕机后，负载请求进行转移，来达到高可用。对某一个key进行哈希或者使用一致性哈希算法进行负载均衡。H…" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/posts/juejin/%E9%AB%98%E5%8F%AF%E7%94%A8%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99/" />
<meta property="og:image" content="http://localhost:1313/images/papermod-cover.png" />
<meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-01-28T00:00:00+00:00" />
<meta property="article:modified_time" content="2021-01-28T00:00:00+00:00" />


<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="http://localhost:1313/images/papermod-cover.png" />
<meta name="twitter:title" content="高可用系统设计原则"/>
<meta name="twitter:description" content="假设一个系统一直可以提供服务，那么这个系统的可用性是100%。大部分公司的高可用目标是9999%。也就是一年的停机时间为53分钟。保证服务集群可以进行故障转移。当服务宕机后，负载请求进行转移，来达到高可用。对某一个key进行哈希或者使用一致性哈希算法进行负载均衡。H…"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "http://localhost:1313/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "高可用系统设计原则",
      "item": "http://localhost:1313/posts/juejin/%E9%AB%98%E5%8F%AF%E7%94%A8%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "高可用系统设计原则",
  "name": "高可用系统设计原则",
  "description": "假设一个系统一直可以提供服务，那么这个系统的可用性是100%。大部分公司的高可用目标是9999%。也就是一年的停机时间为53分钟。保证服务集群可以进行故障转移。当服务宕机后，负载请求进行转移，来达到高可用。对某一个key进行哈希或者使用一致性哈希算法进行负载均衡。H…",
  "keywords": [
    "设计"
  ],
  "articleBody": "1、系统设计的一些原则 海恩法则\n事故的发生是量积累的结果 再好的技术、在完美的规章，在实际操作层面也无法取代人自身的素质和责任心 墨菲定律\n任何事情都没有表面看起来那么简单 所有事情的发展都会比你预计的时间长 会出错的事总会出错 如果你担心某种情况发生，那么它更有可能发生 2、软件架构中的高可用设计 2.1、什么是高可用 假设一个系统一直可以提供服务，那么这个系统的可用性是100%。\n大部分公司的高可用目标是99.99%。也就是一年的停机时间为53分钟。\n2.2、可用性度量和考核 现在业界常用N个9来量化可用性\n描述\n通俗叫法\n可用性级别\n年度停机时间\n基本可用性\n2个9\n99%\n87.6小时\n较高可用性\n3个9\n99.9%\n8.8小时\n具有故障自动恢复的可用性\n4个9\n99.99%\n53分钟\n极高可用性\n5个9\n99.999%\n5分钟\n故障的度量与考核：\n类别\n描述\n权重\n高危S级事故故障\n一旦出现故障，可能会导致服务整体不可用\n100\n严重A级故障\n客户明显感知服务异常：错误的回答\n20\n中级B级故障\n客户能够感知服务异常：响应比较慢\n5\n一般C级故障\n服务出现短时间内抖动\n1\n2.3、如何保障系统的高可用 系统设计过程中避免使用单点 高可用保证的原则是“集群化”，或者叫“冗余” 通过“自动故障转移”来实现系统的高可用 解决高可用问题具体方案:\n负载均衡 限流 降级 隔离 超时与重试 回滚 压测与预案 3、负载均衡 3.1、DNS\u0026nginx负载均衡 保证服务集群可以进行故障转移。\n当服务宕机后，负载请求进行转移，来达到高可用。\n其他的一些负载均衡：\n服务和服务RPC — RPC 框架 提供负载方案 （DUBBO，SpringCloud） 数据集群需要负载均衡（mycat,haproxy） 3.2 upstream配置 再nginx中配置upstream\nini\n代码解读\n复制代码\nupstream backend{ server 192.168.1.101:8080 weight=1; server 192.168.1.102:8080 weight=2; }\nproxy_pass来处理用户请求\narduino\n代码解读\n复制代码\nlocation / { proxy_pass http://backend; }\n3.3、负载均衡算法 3.3.1、round-robin 轮询，默认的负载均衡算法，以轮询的方式将请求转发到上游服务器，配合weight配置可以实现基于权重的轮询\n3.3.2、ip_hash 根据客户IP进行负载均衡，享同的IP将负载均衡到同一个upstream server\nnginx\n代码解读\n复制代码\nupstream backend{ ip_hash; server 192.168.1.101:8080 weight=1; server 192.168.1.102:8080 weight=2; }\n3.3.3、hash key [consistent] 对某一个key进行哈希或者使用一致性哈希算法进行负载均衡。\nHash算法存在的问题是，若添加或者删除一台服务器的时候，会导致很多key被重新负载均衡到不同的服务器，而引起后端的问题。\n若是使用一致性哈希算法，当添加/删除一台服务器时，只有少数key将被重新负载均衡到不同的服务器。\n哈希算法：\nnginx\n代码解读\n复制代码\nupstream backend{ hash $url; server 192.168.1.101:8080 weight=1; server 192.168.1.102:8080 weight=2; }\n一致性哈希算法： consistent_key动态指定。\nnginx\n代码解读\n复制代码\nupstream backend{ hash $consistent_key consistent; server 192.168.1.101:8080 weight=1; server 192.168.1.102:8080 weight=2; }\n3.4、失败重试 nginx\n代码解读\n复制代码\nupstream backend{ server 192.168.1.101:8080 max_fails=2 fail_timeout=10s weight=1; server 192.168.1.102:8080 max_fails=2 fail_timeout=10s weight=2; }\n若是fail_timeout秒内失败了max_fails次，则认为上有服务器不可用/不存活，将摘掉上游服务器，fail_timeout秒之后会再次将服务器加入到存活列表进行重试。\n3.5、健康检查 时刻关注服务的健康状态，若是服务不可用了，将会把请求转发到其他存活的服务上，以提高可用性。\nNginx可以集成nginx_upstream_check_module模块来进行主动健康检查。支持TCP心跳和HTTP心跳。\nTCP心跳：\nnginx\n代码解读\n复制代码\nupstream backend{ server 192.168.1.101:8080 weight=1; server 192.168.1.102:8080 weight=2; check interval=3000 rise=1 fall=3 timeout=2000 type=tcp; }\ninterval： 检测间隔时间，此处配置了每隔3s检测一次。 fall： 检测失败多少次后，上游服务器被标识为不存活。 rise： 检测成功多少次后，上游服务器被标识为存活，并可以处理请求。 HTTP心跳：\nnginx\n代码解读\n复制代码\nupstream backend{ server 192.168.1.101:8080 weight=1; server 192.168.1.102:8080 weight=2; check interval=3000 rise=1 fall=3 timeout=2000 type=tcp; check_http_send ”HEAD /status HTTP/1.0\\r\\n\\r\\n“ check_http_expect_alive http_2xx http_3xx; }\ncheck_http_send： 即检查时发的HTTP请求内容。 check_http_expect_alive： 当上游服务器返回匹配的响应状态码时，则认为上游服务器存活。 请勿将检查时间设置过短，以防心跳检查包过多影响上游服务器。 3.6、其他配置 备份服务器 nginx\n代码解读\n复制代码\nupstream backend{ server 192.168.1.101:8080 weight=1; server 192.168.1.102:8080 weight=2 backup; }\n此时102服务器为备服务器，当所有的主服务器不可用时，请求将转发备被服务器。\n不可用服务器 nginx\n代码解读\n复制代码\nupstream backend{ server 192.168.1.101:8080 weight=1; server 192.168.1.102:8080 weight=2 down; }\n此时102服务器永久不可用，当测试或者机器出现问题时，可通过此配置摘掉机器。\n4、隔离术 4.1、线程隔离 线程隔离指的是线程池隔离，一个请求出现问题不会影响到其他线程池。\n4.2、进程隔离 把项目拆分成一个一个的子项目，互相物理隔离，不进行相互调用。\n4.3、集群隔离 将集群隔离开，使互相不影响。\n4.4、机房隔离 分不同的机房进行部署，杭州机房；北京机房；上海机房；\n4.5、读写隔离 互联网项目中大多是读多写少，读写分离，扩展读的能力，提高性能，提高可用性。\n4.6、动静隔离 将静态资源放入nginx,CDN，从而达到动静隔离，防止页面加载大量静态资源\n4.7、热点隔离 将热点业务独立成系统或服务进行隔离，如秒杀，抢购。\n读热点一般使用多级缓存\n写热点一般使用缓存加消息队列的方式\n5、限流 若是不做限流，当突发大流量，服务可能会被冲垮。\n5.1、限流算法 5.1.1、漏桶算法 漏桶算法思路很简单，水（请求）先进入到漏桶里，漏桶以一定的速度出水，当水流入速度过大会直接溢出，可以看出漏桶算法能强行限制数据的传输速率。\n5.1.2、令牌桶算法 令牌桶算法的原理是系统会以一个恒定的速度往桶里放入令牌，而如果请求需要被处理，则需要先从桶里获取一个令牌，当桶里没有令牌可取时，则拒绝服务。\n5.2、Tomcat限流 对于一个应用系统来说，一定会有极限并发/请求数，即总有一个TPS/QPS阈值，如果超了阈值，则系统就会不响应用户请求或响应得非常慢，因此我们最好进行过载保护，以防止大量请求涌入击垮系统。\nhtml\n代码解读\n复制代码\nacceptCount：等待队列，如果Tomcat的线程都忙于响应，新来的连接会进入队列排队，如果超出排队大小，则拒绝连接；默认值为100 maxConnections：可以创建的瞬时最大连接数，超出的会排队等待； maxThreads：Tomcat能启动用来处理请求的最大线程数，即同时处理的任务个数，默认值为200，如果请求处理量一直远远大于最大线程数，则会引起响应变慢甚至会僵死。 5.3、接口限流 限制某个接口的请求频率\njava\n代码解读\n复制代码\nlong limit = 1000; while(true){ //得到当前秒 long currentSeconds = System.currentTimeMillis()/10; if (counter.get(currentSeconds).incrementAndGet()\u003elimit) { //限流了 continue; } //业务处理 }\n5.4、redis限流 实际是使用lua脚本设置参数做限流。\n5.5、nginx限流 Nginx接入层限流可以使用Nginx自带的两个模块：\n连接数限流模块ngx_http_limit_conn_module 漏桶算法实现的请求限流模块ngx_http_limit_req_module ngx_http_limit_conn_module\n针对某个key对应的总的网络连接数进行限流\n可以按照IP来限制IP维度的总连接数，或者按照服务域名来限制某个域名的总连接数。\nnginx\n代码解读\n复制代码\nhttp{ limit_conn_zone $binary_remote_addr zone=addr:10m; limit_conn_log_level error; limit_conn_status 503; ... server{ location /limit{ limit_conn addr 1; } } ... }\nlimit_conn： 要配置存放key和计数器的共享内存区域和指定key的最大连接数。此处指定的最大连接数是1，表示Nginx最多同时并发处理1个连接。 limit_conn_zone： 用来配置限流key及存放key对应信息的共享内存区域大小。此处的key是binaryremoteaddr”，表示IP地址，也可以使用binary_remote_addr”，表示IP地址，也可以使用binaryr​emotea​ddr”，表示IP地址，也可以使用server_name作为key来限制域名级别的最大连接数。 limit_conn_status： 配置被限流后返回的状态码，默认返回503。 limit_conn_log_level： 配置记录被限流后的日志级别，默认error级别。 ngx_http_limit_req_module\n漏桶算法实现，用于对指定key对应的请求进行限流，比如，按照IP维度限制请求速率。配置示例如下\nnginx\n代码解读\n复制代码\nlimit_conn_log_level error; limit_conn_status 503; ... server{ location /limit{ limit_req zone=one burst=5 nodelay; } }\nlimit_req： 配置限流区域、桶容量（突发容量，默认为0）、是否延迟模式（默认延迟）。 limit_req_zone： 配置限流key、存放key对应信息的共享内存区域大小、固定请求速率。此处指定的key是“$binary_remote_addr”，表示IP地址。固定请求速率使用rate参数配置，支持10r/s和60r/m，即每秒10个请求和每分钟60个请求。不过，最终都会转换为每秒的固定请求速率（10r/s为每100毫秒处理一个请求，60r/m为每1000毫秒处理一个请求）。 limit_conn_status： 配置被限流后返回的状态码，默认返回503。 limit_conn_log_level： 配置记录被限流后的日志级别，默认级别为error。 6、降级 当访问量剧增、服务出现问题（如响应时间长或不响应）或非核心服务影响到核心流程的性能时，仍然需要保证服务还是可用的，即使是有损服务。系统可以根据一些关键数据进行自动降级，也可以配置开关实现人工降级。\n降级的最终目的是保证核心服务可用，即使是有损的。\n6.1、降级预案 在降级前需要对系统进行梳理，判断系统是否可以丢丢卒保帅，从而整理出那些可以降级，那些不能降级。\n一般： 比如，有些服务偶尔因为网络抖动或者服务正在上线而超时，可以自动降级。 警告： 有些服务在一段时间内成功率有波动（如在95~100%之间），可以自动降级或人工降级，并发送告警。 错误： 比如，可用率低于90%，或者数据库连接池用完了，或者访问量突然猛增到系统能承受的最大阈值，此时，可以根据情况自动降级或者人工降级。 严重错误： 比如，因为特殊原因数据出现错误，此时，需要紧急人工降级。 降级按照是否自动化可分为：自动开关降级和人工开关降级。\n降级按照功能可分为：读服务降级和写服务降级。\n降级按照处于的系统层次可分为：多级降级。\n降级的功能点主要从服务器端链路考虑，即根据用户访问的服务调用链路来梳理哪里需要降级。\n6.2、页面降级 在大型促销或者抢购活动时，某些页面占用了一些稀缺服务资源，在紧急情况下可以对其整个降级。\n6.3、页面片段降级 比如，商品详情页中的商家部分因为数据错误，此时，需要对其进行降级。\n6.4、页面异步请求降级 比如，商品详情页上有推荐信息/配送至等异步加载的请求，如果这些信息响应慢或者后端服务有问题，则可以进行降级。\n6.5、服务功能降级 比如，渲染商品详情页时，需要调用一些不太重要的服务（相关分类、热销榜等），而这些服务在异常情况下直接不获取，即降级即可。\n6.6、读降级 比如，多级缓存模式，如果后端服务有问题，则可以降级为只读缓存，这种方式适用于对读一致性要求不高的场景。\n6.7、写降级 比如，秒杀抢购，我们可以只进行Cache的更新，然后异步扣减库存到DB，保证最终一致性即可，此时可以将DB降级为Cache。\n6.8、自动降级 当服务中错误出现次数到达阀值（99.99%）,对服务进行降级，发出警告。\n7、超时与重试 在访问服务之后，由于网络或其他原因迟迟没有响应而超时，此时为了用户体验度，可以默认发起第二次请求，进行尝试。\n代理层超时与重试： nginx web容器超时与重试 中间件和服务之间超时与重试 数据库连接超时与重试 nosql超时与重试 业务超时与重试 前端浏览器ajax请求超时与重试 8、压测与预案 8.1、系统压测 压测一般指性能压力测试，用来评估系统的稳定性和性能，通过压测数据进行系统容量评估，从而决定是否需要进行扩容或缩容。\n线下压测：\n通过如JMeter、Apache ab压测系统的某个接口（如查询库存接口）或者某个组件（如数据库连接池），然后进行调优（如调整JVM参数、优化代码），实现单个接口或组件的性能最优。\n线下压测的环境（比如，服务器、网络、数据量等）和线上的完全不一样，仿真度不高，很难进行全链路压测，适合组件级的压测，数据只能作为参考。\n线上压测:\n线上压测的方式非常多，按读写分为读压测、写压测和混合压测，按数据仿真度分为仿真压测和引流压测，按是否给用户提供服务分为隔离集群压测和线上集群压测。\n读压测是压测系统的读流量，比如，压测商品价格服务。写压测是压测系统的写流量，比如下单。写压测时，要注意把压测写的数据和真实数据分离，在压测完成后，删除压测数据。只进行读或写压测有时是不能发现系统瓶颈的，因为有时读和写是会相互影响的，因此，这种情况下要进行混合压测。\n仿真压测是通过模拟请求进行系统压测，模拟请求的数据可以是使用程序构造、人工构造（如提前准备一些用户和商品），或者使用Nginx访问日志，如果压测的数据量有限，则会形成请求热点。而更好的方式可以考虑引流压测，比如使用TCPCopy复制\n8.2、系统优化和容灾 拿到压测报告后，接下来会分析报告，然后进行一些有针对性的优化，如硬件升级、系统扩容、参数调优、代码优化（如代码同步改异步）、架构优化（如加缓存、读写分离、历史数据归档）等。\n不要直接复用别人的案列，一定要根据压测结果合理调整自己的案例。\n在进行系统优化时，要进行代码走查，发现不合理的参数配置，如超时时间、降级策略、缓存时间等。在系统压测中进行慢查询排查，包括Redis、MySQL等，通过优化查询解决慢查询问题。\n在应用系统扩容方面，可以根据去年流量、与运营业务方沟通促销力度、最近一段时间的流量来评估出是否需要进行扩容，需要扩容多少倍，比如，预计GMV增长100%，那么可以考虑扩容2~3倍容量。\n8.3、应急预案 在系统压测之后会发现一些系统瓶颈，在系统优化之后会提升系统吞吐量并降低响应时间，容灾之后的系统可用性得以保障，但还是会存在一些风险，如网络抖动、某台机器负载过高、某个服务变慢、数据库Load值过高等，为了防止因为这些问题而出现系统雪崩，需要针对这些情况制定应急预案，从而在出现突发情况时，有相应的措施来解决掉这些问题。\n应急预案可按照如下几步进行：首先进行系统分级，然后进行全链路分析、配置监控报警，最后制定应急预案。\n",
  "wordCount" : "454",
  "inLanguage": "zh",
  "image": "http://localhost:1313/images/papermod-cover.png","datePublished": "2021-01-28T00:00:00Z",
  "dateModified": "2021-01-28T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "奔跑的毛球"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://localhost:1313/posts/juejin/%E9%AB%98%E5%8F%AF%E7%94%A8%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "PaperMod",
    "logo": {
      "@type": "ImageObject",
      "url": "http://localhost:1313/%3Clink%20/%20abs%20url%3E"
    }
  }
}
</script>
</head>

<body class=" dark" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Home (Alt + H)">
                        
                    <img src="http://localhost:1313/images/msg_hu15231257772499651944.png" alt="" aria-label="logo"
                        height="20">Home</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/archives" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://github.com/adityatelange/hugo-PaperMod/wiki/" title="WiKi">
                    <span>WiKi</span>&nbsp;
                    <svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round"
                        stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12">
                        <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path>
                        <path d="M15 3h6v6"></path>
                        <path d="M10 14L21 3"></path>
                    </svg>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/">主页</a>&nbsp;»&nbsp;<a href="http://localhost:1313/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      高可用系统设计原则
    </h1>
    <div class="post-description">
      假设一个系统一直可以提供服务，那么这个系统的可用性是100%。大部分公司的高可用目标是9999%。也就是一年的停机时间为53分钟。保证服务集群可以进行故障转移。当服务宕机后，负载请求进行转移，来达到高可用。对某一个key进行哈希或者使用一致性哈希算法进行负载均衡。H…
    </div>
    <div class="post-meta"><span title='2021-01-28 00:00:00 +0000 UTC'>一月 28, 2021</span>&nbsp;·&nbsp;3 分钟&nbsp;·&nbsp;奔跑的毛球&nbsp;|&nbsp;<a href="https://github.com/WangShaoyu1/myBlogPaperMod/tree/master/content/posts/jueJin/%e9%ab%98%e5%8f%af%e7%94%a8%e7%b3%bb%e7%bb%9f%e8%ae%be%e8%ae%a1%e5%8e%9f%e5%88%99.md" rel="noopener noreferrer" target="_blank">Suggest Changes</a>

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">目录</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#1%e7%b3%bb%e7%bb%9f%e8%ae%be%e8%ae%a1%e7%9a%84%e4%b8%80%e4%ba%9b%e5%8e%9f%e5%88%99" aria-label="1、系统设计的一些原则">1、系统设计的一些原则</a></li>
                <li>
                    <a href="#2%e8%bd%af%e4%bb%b6%e6%9e%b6%e6%9e%84%e4%b8%ad%e7%9a%84%e9%ab%98%e5%8f%af%e7%94%a8%e8%ae%be%e8%ae%a1" aria-label="2、软件架构中的高可用设计">2、软件架构中的高可用设计</a><ul>
                        
                <li>
                    <a href="#21%e4%bb%80%e4%b9%88%e6%98%af%e9%ab%98%e5%8f%af%e7%94%a8" aria-label="2.1、什么是高可用">2.1、什么是高可用</a></li>
                <li>
                    <a href="#22%e5%8f%af%e7%94%a8%e6%80%a7%e5%ba%a6%e9%87%8f%e5%92%8c%e8%80%83%e6%a0%b8" aria-label="2.2、可用性度量和考核">2.2、可用性度量和考核</a></li>
                <li>
                    <a href="#23%e5%a6%82%e4%bd%95%e4%bf%9d%e9%9a%9c%e7%b3%bb%e7%bb%9f%e7%9a%84%e9%ab%98%e5%8f%af%e7%94%a8" aria-label="2.3、如何保障系统的高可用">2.3、如何保障系统的高可用</a></li></ul>
                </li>
                <li>
                    <a href="#3%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1" aria-label="3、负载均衡">3、负载均衡</a><ul>
                        
                <li>
                    <a href="#31dnsnginx%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1" aria-label="3.1、DNS&amp;nginx负载均衡">3.1、DNS&amp;nginx负载均衡</a></li>
                <li>
                    <a href="#32-upstream%e9%85%8d%e7%bd%ae" aria-label="3.2 upstream配置">3.2 upstream配置</a></li>
                <li>
                    <a href="#33%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1%e7%ae%97%e6%b3%95" aria-label="3.3、负载均衡算法">3.3、负载均衡算法</a><ul>
                        
                <li>
                    <a href="#331round-robin" aria-label="3.3.1、round-robin">3.3.1、round-robin</a></li>
                <li>
                    <a href="#332ip_hash" aria-label="3.3.2、ip_hash">3.3.2、ip_hash</a></li>
                <li>
                    <a href="#333hash-key-consistent" aria-label="3.3.3、hash key [consistent]">3.3.3、hash key [consistent]</a></li></ul>
                </li>
                <li>
                    <a href="#34%e5%a4%b1%e8%b4%a5%e9%87%8d%e8%af%95" aria-label="3.4、失败重试">3.4、失败重试</a></li>
                <li>
                    <a href="#35%e5%81%a5%e5%ba%b7%e6%a3%80%e6%9f%a5" aria-label="3.5、健康检查">3.5、健康检查</a></li>
                <li>
                    <a href="#36%e5%85%b6%e4%bb%96%e9%85%8d%e7%bd%ae" aria-label="3.6、其他配置">3.6、其他配置</a></li></ul>
                </li>
                <li>
                    <a href="#4%e9%9a%94%e7%a6%bb%e6%9c%af" aria-label="4、隔离术">4、隔离术</a><ul>
                        
                <li>
                    <a href="#41%e7%ba%bf%e7%a8%8b%e9%9a%94%e7%a6%bb" aria-label="4.1、线程隔离">4.1、线程隔离</a></li>
                <li>
                    <a href="#42%e8%bf%9b%e7%a8%8b%e9%9a%94%e7%a6%bb" aria-label="4.2、进程隔离">4.2、进程隔离</a></li>
                <li>
                    <a href="#43%e9%9b%86%e7%be%a4%e9%9a%94%e7%a6%bb" aria-label="4.3、集群隔离">4.3、集群隔离</a></li>
                <li>
                    <a href="#44%e6%9c%ba%e6%88%bf%e9%9a%94%e7%a6%bb" aria-label="4.4、机房隔离">4.4、机房隔离</a></li>
                <li>
                    <a href="#45%e8%af%bb%e5%86%99%e9%9a%94%e7%a6%bb" aria-label="4.5、读写隔离">4.5、读写隔离</a></li>
                <li>
                    <a href="#46%e5%8a%a8%e9%9d%99%e9%9a%94%e7%a6%bb" aria-label="4.6、动静隔离">4.6、动静隔离</a></li>
                <li>
                    <a href="#47%e7%83%ad%e7%82%b9%e9%9a%94%e7%a6%bb" aria-label="4.7、热点隔离">4.7、热点隔离</a></li></ul>
                </li>
                <li>
                    <a href="#5%e9%99%90%e6%b5%81" aria-label="5、限流">5、限流</a><ul>
                        
                <li>
                    <a href="#51%e9%99%90%e6%b5%81%e7%ae%97%e6%b3%95" aria-label="5.1、限流算法">5.1、限流算法</a><ul>
                        
                <li>
                    <a href="#511%e6%bc%8f%e6%a1%b6%e7%ae%97%e6%b3%95" aria-label="5.1.1、漏桶算法">5.1.1、漏桶算法</a></li>
                <li>
                    <a href="#512%e4%bb%a4%e7%89%8c%e6%a1%b6%e7%ae%97%e6%b3%95" aria-label="5.1.2、令牌桶算法">5.1.2、令牌桶算法</a></li></ul>
                </li>
                <li>
                    <a href="#52tomcat%e9%99%90%e6%b5%81" aria-label="5.2、Tomcat限流">5.2、Tomcat限流</a></li>
                <li>
                    <a href="#53%e6%8e%a5%e5%8f%a3%e9%99%90%e6%b5%81" aria-label="5.3、接口限流">5.3、接口限流</a></li>
                <li>
                    <a href="#54redis%e9%99%90%e6%b5%81" aria-label="5.4、redis限流">5.4、redis限流</a></li>
                <li>
                    <a href="#55nginx%e9%99%90%e6%b5%81" aria-label="5.5、nginx限流">5.5、nginx限流</a></li></ul>
                </li>
                <li>
                    <a href="#6%e9%99%8d%e7%ba%a7" aria-label="6、降级">6、降级</a><ul>
                        
                <li>
                    <a href="#61%e9%99%8d%e7%ba%a7%e9%a2%84%e6%a1%88" aria-label="6.1、降级预案">6.1、降级预案</a></li>
                <li>
                    <a href="#62%e9%a1%b5%e9%9d%a2%e9%99%8d%e7%ba%a7" aria-label="6.2、页面降级">6.2、页面降级</a></li>
                <li>
                    <a href="#63%e9%a1%b5%e9%9d%a2%e7%89%87%e6%ae%b5%e9%99%8d%e7%ba%a7" aria-label="6.3、页面片段降级">6.3、页面片段降级</a></li>
                <li>
                    <a href="#64%e9%a1%b5%e9%9d%a2%e5%bc%82%e6%ad%a5%e8%af%b7%e6%b1%82%e9%99%8d%e7%ba%a7" aria-label="6.4、页面异步请求降级">6.4、页面异步请求降级</a></li>
                <li>
                    <a href="#65%e6%9c%8d%e5%8a%a1%e5%8a%9f%e8%83%bd%e9%99%8d%e7%ba%a7" aria-label="6.5、服务功能降级">6.5、服务功能降级</a></li>
                <li>
                    <a href="#66%e8%af%bb%e9%99%8d%e7%ba%a7" aria-label="6.6、读降级">6.6、读降级</a></li>
                <li>
                    <a href="#67%e5%86%99%e9%99%8d%e7%ba%a7" aria-label="6.7、写降级">6.7、写降级</a></li>
                <li>
                    <a href="#68%e8%87%aa%e5%8a%a8%e9%99%8d%e7%ba%a7" aria-label="6.8、自动降级">6.8、自动降级</a></li></ul>
                </li>
                <li>
                    <a href="#7%e8%b6%85%e6%97%b6%e4%b8%8e%e9%87%8d%e8%af%95" aria-label="7、超时与重试">7、超时与重试</a></li>
                <li>
                    <a href="#8%e5%8e%8b%e6%b5%8b%e4%b8%8e%e9%a2%84%e6%a1%88" aria-label="8、压测与预案">8、压测与预案</a><ul>
                        
                <li>
                    <a href="#81%e7%b3%bb%e7%bb%9f%e5%8e%8b%e6%b5%8b" aria-label="8.1、系统压测">8.1、系统压测</a></li>
                <li>
                    <a href="#82%e7%b3%bb%e7%bb%9f%e4%bc%98%e5%8c%96%e5%92%8c%e5%ae%b9%e7%81%be" aria-label="8.2、系统优化和容灾">8.2、系统优化和容灾</a></li>
                <li>
                    <a href="#83%e5%ba%94%e6%80%a5%e9%a2%84%e6%a1%88" aria-label="8.3、应急预案">8.3、应急预案</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h1 id="1系统设计的一些原则">1、系统设计的一些原则<a hidden class="anchor" aria-hidden="true" href="#1系统设计的一些原则">#</a></h1>
<p><strong>海恩法则</strong></p>
<ul>
<li>事故的发生是量积累的结果</li>
<li>再好的技术、在完美的规章，在实际操作层面也无法取代人自身的素质和责任心</li>
</ul>
<p><strong>墨菲定律</strong></p>
<ul>
<li>任何事情都没有表面看起来那么简单</li>
<li>所有事情的发展都会比你预计的时间长</li>
<li>会出错的事总会出错</li>
<li>如果你担心某种情况发生，那么它更有可能发生</li>
</ul>
<h1 id="2软件架构中的高可用设计">2、软件架构中的高可用设计<a hidden class="anchor" aria-hidden="true" href="#2软件架构中的高可用设计">#</a></h1>
<h2 id="21什么是高可用">2.1、什么是高可用<a hidden class="anchor" aria-hidden="true" href="#21什么是高可用">#</a></h2>
<p>假设一个系统一直可以提供服务，那么这个系统的可用性是100%。</p>
<p>大部分公司的高可用目标是99.99%。也就是一年的停机时间为53分钟。</p>
<h2 id="22可用性度量和考核">2.2、可用性度量和考核<a hidden class="anchor" aria-hidden="true" href="#22可用性度量和考核">#</a></h2>
<p>现在业界常用N个9来量化可用性</p>
<p>描述</p>
<p>通俗叫法</p>
<p>可用性级别</p>
<p>年度停机时间</p>
<p>基本可用性</p>
<p>2个9</p>
<p>99%</p>
<p>87.6小时</p>
<p>较高可用性</p>
<p>3个9</p>
<p>99.9%</p>
<p>8.8小时</p>
<p>具有故障自动恢复的可用性</p>
<p>4个9</p>
<p>99.99%</p>
<p>53分钟</p>
<p>极高可用性</p>
<p>5个9</p>
<p>99.999%</p>
<p>5分钟</p>
<p>故障的度量与考核：</p>
<p>类别</p>
<p>描述</p>
<p>权重</p>
<p>高危S级事故故障</p>
<p>一旦出现故障，可能会导致服务整体不可用</p>
<p>100</p>
<p>严重A级故障</p>
<p>客户明显感知服务异常：错误的回答</p>
<p>20</p>
<p>中级B级故障</p>
<p>客户能够感知服务异常：响应比较慢</p>
<p>5</p>
<p>一般C级故障</p>
<p>服务出现短时间内抖动</p>
<p>1</p>
<h2 id="23如何保障系统的高可用">2.3、如何保障系统的高可用<a hidden class="anchor" aria-hidden="true" href="#23如何保障系统的高可用">#</a></h2>
<ul>
<li>系统设计过程中避免使用单点</li>
<li>高可用保证的原则是“集群化”，或者叫“冗余”</li>
<li>通过“自动故障转移”来实现系统的高可用</li>
</ul>
<p><strong>解决高可用问题具体方案</strong>:</p>
<ol>
<li>负载均衡</li>
<li>限流</li>
<li>降级</li>
<li>隔离</li>
<li>超时与重试</li>
<li>回滚</li>
<li>压测与预案</li>
</ol>
<h1 id="3负载均衡">3、负载均衡<a hidden class="anchor" aria-hidden="true" href="#3负载均衡">#</a></h1>
<h2 id="31dnsnginx负载均衡">3.1、DNS&amp;nginx负载均衡<a hidden class="anchor" aria-hidden="true" href="#31dnsnginx负载均衡">#</a></h2>
<p>保证服务集群可以进行故障转移。</p>
<p>当服务宕机后，负载请求进行转移，来达到高可用。</p>
<p>其他的一些负载均衡：</p>
<ol>
<li>服务和服务RPC &mdash; RPC 框架 提供负载方案 （DUBBO，SpringCloud）</li>
<li>数据集群需要负载均衡（mycat,haproxy）</li>
</ol>
<h2 id="32-upstream配置">3.2 upstream配置<a hidden class="anchor" aria-hidden="true" href="#32-upstream配置">#</a></h2>
<p>再nginx中配置upstream</p>
<p>ini</p>
<p>代码解读</p>
<p>复制代码</p>
<p><code>upstream backend{       server 192.168.1.101:8080 weight=1;       server 192.168.1.102:8080 weight=2; }</code></p>
<p>proxy_pass来处理用户请求</p>
<p>arduino</p>
<p>代码解读</p>
<p>复制代码</p>
<p><code>location / { 	proxy_pass http://backend; }</code></p>
<h2 id="33负载均衡算法">3.3、负载均衡算法<a hidden class="anchor" aria-hidden="true" href="#33负载均衡算法">#</a></h2>
<h3 id="331round-robin">3.3.1、round-robin<a hidden class="anchor" aria-hidden="true" href="#331round-robin">#</a></h3>
<p>轮询，默认的负载均衡算法，以轮询的方式将请求转发到上游服务器，配合weight配置可以实现基于权重的轮询</p>
<h3 id="332ip_hash">3.3.2、ip_hash<a hidden class="anchor" aria-hidden="true" href="#332ip_hash">#</a></h3>
<p>根据客户IP进行负载均衡，享同的IP将负载均衡到同一个upstream server</p>
<p>nginx</p>
<p>代码解读</p>
<p>复制代码</p>
<p><code>upstream backend{ 	ip_hash; 	server 192.168.1.101:8080 weight=1; 	server 192.168.1.102:8080 weight=2; }</code></p>
<h3 id="333hash-key-consistent">3.3.3、hash key [consistent]<a hidden class="anchor" aria-hidden="true" href="#333hash-key-consistent">#</a></h3>
<p>对某一个key进行哈希或者使用一致性哈希算法进行负载均衡。</p>
<p>Hash算法存在的问题是，若添加或者删除一台服务器的时候，会导致很多key被重新负载均衡到不同的服务器，而引起后端的问题。</p>
<p>若是使用一致性哈希算法，当添加/删除一台服务器时，只有少数key将被重新负载均衡到不同的服务器。</p>
<p><strong>哈希算法</strong>：</p>
<p>nginx</p>
<p>代码解读</p>
<p>复制代码</p>
<p><code>upstream backend{ 	hash $url; 	server 192.168.1.101:8080 weight=1; 	server 192.168.1.102:8080 weight=2; }</code></p>
<p><strong>一致性哈希算法</strong>： consistent_key动态指定。</p>
<p>nginx</p>
<p>代码解读</p>
<p>复制代码</p>
<p><code>upstream backend{ 	hash $consistent_key consistent; 	server 192.168.1.101:8080 weight=1; 	server 192.168.1.102:8080 weight=2; }</code></p>
<h2 id="34失败重试">3.4、失败重试<a hidden class="anchor" aria-hidden="true" href="#34失败重试">#</a></h2>
<p>nginx</p>
<p>代码解读</p>
<p>复制代码</p>
<p><code>upstream backend{ 	server 192.168.1.101:8080 max_fails=2 fail_timeout=10s weight=1; 	server 192.168.1.102:8080 max_fails=2 fail_timeout=10s weight=2; }</code></p>
<p>若是<code>fail_timeout</code>秒内失败了<code>max_fails</code>次，则认为上有服务器不可用/不存活，将摘掉上游服务器，<code>fail_timeout</code>秒之后会再次将服务器加入到存活列表进行重试。</p>
<h2 id="35健康检查">3.5、健康检查<a hidden class="anchor" aria-hidden="true" href="#35健康检查">#</a></h2>
<p>时刻关注服务的健康状态，若是服务不可用了，将会把请求转发到其他存活的服务上，以提高可用性。</p>
<p>Nginx可以集成<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fyaoweibin%2Fnginx_upstream_check_module" title="https://github.com/yaoweibin/nginx_upstream_check_module">nginx_upstream_check_module</a>模块来进行主动健康检查。支持TCP心跳和HTTP心跳。</p>
<p><strong>TCP心跳</strong>：</p>
<p>nginx</p>
<p>代码解读</p>
<p>复制代码</p>
<p><code>upstream backend{ 	server 192.168.1.101:8080 weight=1; 	server 192.168.1.102:8080 weight=2; 	check interval=3000 rise=1 fall=3 timeout=2000 type=tcp; }</code></p>
<ul>
<li>interval： 检测间隔时间，此处配置了每隔3s检测一次。</li>
<li>fall： 检测失败多少次后，上游服务器被标识为不存活。</li>
<li>rise： 检测成功多少次后，上游服务器被标识为存活，并可以处理请求。</li>
</ul>
<p><strong>HTTP心跳</strong>：</p>
<p>nginx</p>
<p>代码解读</p>
<p>复制代码</p>
<p><code>upstream backend{ 	server 192.168.1.101:8080 weight=1; 	server 192.168.1.102:8080 weight=2; 	check interval=3000 rise=1 fall=3 timeout=2000 type=tcp; 	check_http_send ”HEAD /status HTTP/1.0\r\n\r\n“ 	check_http_expect_alive http_2xx http_3xx; }</code></p>
<ul>
<li>check_http_send： 即检查时发的HTTP请求内容。</li>
<li>check_http_expect_alive： 当上游服务器返回匹配的响应状态码时，则认为上游服务器存活。 请勿将检查时间设置过短，以防心跳检查包过多影响上游服务器。</li>
</ul>
<h2 id="36其他配置">3.6、其他配置<a hidden class="anchor" aria-hidden="true" href="#36其他配置">#</a></h2>
<ol>
<li>备份服务器</li>
</ol>
<p>nginx</p>
<p>代码解读</p>
<p>复制代码</p>
<p><code>upstream backend{ 	server 192.168.1.101:8080 weight=1; 	server 192.168.1.102:8080 weight=2 backup; }</code></p>
<p>此时102服务器为备服务器，当所有的主服务器不可用时，请求将转发备被服务器。</p>
<ol start="2">
<li>不可用服务器</li>
</ol>
<p>nginx</p>
<p>代码解读</p>
<p>复制代码</p>
<p><code>upstream backend{ 	server 192.168.1.101:8080 weight=1; 	server 192.168.1.102:8080 weight=2 down; }</code></p>
<p>此时102服务器永久不可用，当测试或者机器出现问题时，可通过此配置摘掉机器。</p>
<h1 id="4隔离术">4、隔离术<a hidden class="anchor" aria-hidden="true" href="#4隔离术">#</a></h1>
<h2 id="41线程隔离">4.1、线程隔离<a hidden class="anchor" aria-hidden="true" href="#41线程隔离">#</a></h2>
<p>线程隔离指的是线程池隔离，一个请求出现问题不会影响到其他线程池。</p>
<h2 id="42进程隔离">4.2、进程隔离<a hidden class="anchor" aria-hidden="true" href="#42进程隔离">#</a></h2>
<p>把项目拆分成一个一个的子项目，互相物理隔离，不进行相互调用。</p>
<h2 id="43集群隔离">4.3、集群隔离<a hidden class="anchor" aria-hidden="true" href="#43集群隔离">#</a></h2>
<p>将集群隔离开，使互相不影响。</p>
<h2 id="44机房隔离">4.4、机房隔离<a hidden class="anchor" aria-hidden="true" href="#44机房隔离">#</a></h2>
<p>分不同的机房进行部署，杭州机房；北京机房；上海机房；</p>
<h2 id="45读写隔离">4.5、读写隔离<a hidden class="anchor" aria-hidden="true" href="#45读写隔离">#</a></h2>
<p>互联网项目中大多是读多写少，读写分离，扩展读的能力，提高性能，提高可用性。</p>
<h2 id="46动静隔离">4.6、动静隔离<a hidden class="anchor" aria-hidden="true" href="#46动静隔离">#</a></h2>
<p>将静态资源放入nginx,CDN，从而达到动静隔离，防止页面加载大量静态资源</p>
<h2 id="47热点隔离">4.7、热点隔离<a hidden class="anchor" aria-hidden="true" href="#47热点隔离">#</a></h2>
<p>将热点业务独立成系统或服务进行隔离，如秒杀，抢购。</p>
<p>读热点一般使用多级缓存</p>
<p>写热点一般使用缓存加消息队列的方式</p>
<h1 id="5限流">5、限流<a hidden class="anchor" aria-hidden="true" href="#5限流">#</a></h1>
<p>若是不做限流，当突发大流量，服务可能会被冲垮。</p>
<h2 id="51限流算法">5.1、限流算法<a hidden class="anchor" aria-hidden="true" href="#51限流算法">#</a></h2>
<h3 id="511漏桶算法">5.1.1、漏桶算法<a hidden class="anchor" aria-hidden="true" href="#511漏桶算法">#</a></h3>
<p><img loading="lazy" src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/41baabecc6914933ba5312f4108ea76b~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp" alt=""  />
 漏桶算法思路很简单，水（请求）先进入到漏桶里，漏桶以一定的速度出水，当水流入速度过大会直接溢出，可以看出漏桶算法能强行限制数据的传输速率。</p>
<h3 id="512令牌桶算法">5.1.2、令牌桶算法<a hidden class="anchor" aria-hidden="true" href="#512令牌桶算法">#</a></h3>
<p><img loading="lazy" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/faf6b61dbd4c4d4ea141adb020e19cc6~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp" alt=""  />
 令牌桶算法的原理是系统会以一个恒定的速度往桶里放入令牌，而如果请求需要被处理，则需要先从桶里获取一个令牌，当桶里没有令牌可取时，则拒绝服务。</p>
<h2 id="52tomcat限流">5.2、Tomcat限流<a hidden class="anchor" aria-hidden="true" href="#52tomcat限流">#</a></h2>
<p>对于一个应用系统来说，一定会有极限并发/请求数，即总有一个TPS/QPS阈值，如果超了阈值，则系统就会不响应用户请求或响应得非常慢，因此我们最好进行过载保护，以防止大量请求涌入击垮系统。</p>
<p>html</p>
<p>代码解读</p>
<p>复制代码</p>
<p><code>&lt;Connector port=&quot;8080&quot; protocol=&quot;HTTP/1.1&quot; 	connectionTimeout=&quot;20000&quot; 	redirectPort=&quot;8443&quot; maxThreads=&quot;800&quot; maxConnections=&quot;2000&quot; acceptCount=&quot;1000&quot;/&gt;</code></p>
<ul>
<li><code>acceptCount</code>：等待队列，如果Tomcat的线程都忙于响应，新来的连接会进入队列排队，如果超出排队大小，则拒绝连接；默认值为100</li>
<li><code>maxConnections</code>：可以创建的瞬时最大连接数，超出的会排队等待；</li>
<li><code>maxThreads</code>：Tomcat能启动用来处理请求的最大线程数，即同时处理的任务个数，默认值为200，如果请求处理量一直远远大于最大线程数，则会引起响应变慢甚至会僵死。</li>
</ul>
<h2 id="53接口限流">5.3、接口限流<a hidden class="anchor" aria-hidden="true" href="#53接口限流">#</a></h2>
<p>限制某个接口的请求频率</p>
<p>java</p>
<p>代码解读</p>
<p>复制代码</p>
<p><code>long limit = 1000; while(true){ 	//得到当前秒 	long currentSeconds = System.currentTimeMillis()/10; 	if (counter.get(currentSeconds).incrementAndGet()&gt;limit) { 	//限流了 	continue;     }     //业务处理 }</code></p>
<h2 id="54redis限流">5.4、redis限流<a hidden class="anchor" aria-hidden="true" href="#54redis限流">#</a></h2>
<p>实际是使用lua脚本设置参数做限流。</p>
<h2 id="55nginx限流">5.5、nginx限流<a hidden class="anchor" aria-hidden="true" href="#55nginx限流">#</a></h2>
<p>Nginx接入层限流可以使用Nginx自带的两个模块：</p>
<ol>
<li>连接数限流模块ngx_http_limit_conn_module</li>
<li>漏桶算法实现的请求限流模块ngx_http_limit_req_module</li>
</ol>
<p><strong>ngx_http_limit_conn_module</strong></p>
<p>针对某个key对应的总的网络连接数进行限流</p>
<p>可以按照IP来限制IP维度的总连接数，或者按照服务域名来限制某个域名的总连接数。</p>
<p>nginx</p>
<p>代码解读</p>
<p>复制代码</p>
<p><code>http{ 	limit_conn_zone $binary_remote_addr zone=addr:10m; 	limit_conn_log_level error; 	limit_conn_status 503;     ...     server{ 		location /limit{ 			limit_conn addr 1; 		}     }     ... }</code></p>
<ul>
<li><code>limit_conn</code>： 要配置存放key和计数器的共享内存区域和指定key的最大连接数。此处指定的最大连接数是1，表示Nginx最多同时并发处理1个连接。</li>
<li><code>limit_conn_zone</code>： 用来配置限流key及存放key对应信息的共享内存区域大小。此处的key是binaryremoteaddr”，表示IP地址，也可以使用binary_remote_addr”，表示IP地址，也可以使用binaryr​emotea​ddr”，表示IP地址，也可以使用server_name作为key来限制域名级别的最大连接数。</li>
<li><code>limit_conn_status</code>： 配置被限流后返回的状态码，默认返回503。</li>
<li><code>limit_conn_log_level</code>： 配置记录被限流后的日志级别，默认error级别。</li>
</ul>
<p><strong>ngx_http_limit_req_module</strong></p>
<p>漏桶算法实现，用于对指定key对应的请求进行限流，比如，按照IP维度限制请求速率。配置示例如下</p>
<p>nginx</p>
<p>代码解读</p>
<p>复制代码</p>
<p><code>limit_conn_log_level error; limit_conn_status 503; ... server{ 	location /limit{ 		limit_req zone=one burst=5 nodelay;     } }</code></p>
<ul>
<li><code>limit_req</code>： 配置限流区域、桶容量（突发容量，默认为0）、是否延迟模式（默认延迟）。</li>
<li><code>limit_req_zone</code>： 配置限流key、存放key对应信息的共享内存区域大小、固定请求速率。此处指定的key是“$binary_remote_addr”，表示IP地址。固定请求速率使用rate参数配置，支持10r/s和60r/m，即每秒10个请求和每分钟60个请求。不过，最终都会转换为每秒的固定请求速率（10r/s为每100毫秒处理一个请求，60r/m为每1000毫秒处理一个请求）。</li>
<li><code>limit_conn_status</code>： 配置被限流后返回的状态码，默认返回503。</li>
<li><code>limit_conn_log_level</code>： 配置记录被限流后的日志级别，默认级别为error。</li>
</ul>
<h1 id="6降级">6、降级<a hidden class="anchor" aria-hidden="true" href="#6降级">#</a></h1>
<p>当访问量剧增、服务出现问题（如响应时间长或不响应）或非核心服务影响到核心流程的性能时，仍然需要保证服务还是可用的，即使是有损服务。系统可以根据一些关键数据进行自动降级，也可以配置开关实现人工降级。</p>
<p><strong>降级的最终目的是保证核心服务可用，即使是有损的。</strong></p>
<h2 id="61降级预案">6.1、降级预案<a hidden class="anchor" aria-hidden="true" href="#61降级预案">#</a></h2>
<p>在降级前需要对系统进行梳理，判断系统是否可以丢丢卒保帅，从而整理出那些可以降级，那些不能降级。</p>
<ul>
<li><code>一般</code>： 比如，有些服务偶尔因为网络抖动或者服务正在上线而超时，可以自动降级。</li>
<li><code>警告</code>： 有些服务在一段时间内成功率有波动（如在95~100%之间），可以自动降级或人工降级，并发送告警。</li>
<li><code>错误</code>： 比如，可用率低于90%，或者数据库连接池用完了，或者访问量突然猛增到系统能承受的最大阈值，此时，可以根据情况自动降级或者人工降级。</li>
<li><code>严重错误</code>： 比如，因为特殊原因数据出现错误，此时，需要紧急人工降级。</li>
</ul>
<p>降级按照<strong>是否自动化</strong>可分为：<strong>自动开关降级</strong>和<strong>人工开关降级</strong>。<br>
降级按照<strong>功能</strong>可分为：<strong>读服务降级</strong>和<strong>写服务降级</strong>。<br>
降级按照<strong>处于的系统层次</strong>可分为：<strong>多级降级</strong>。</p>
<p>降级的功能点主要从服务器端链路考虑，即根据用户访问的服务调用链路来梳理哪里需要降级。</p>
<h2 id="62页面降级">6.2、页面降级<a hidden class="anchor" aria-hidden="true" href="#62页面降级">#</a></h2>
<p>在大型促销或者抢购活动时，某些页面占用了一些稀缺服务资源，在紧急情况下可以对其整个降级。</p>
<h2 id="63页面片段降级">6.3、页面片段降级<a hidden class="anchor" aria-hidden="true" href="#63页面片段降级">#</a></h2>
<p>比如，商品详情页中的商家部分因为数据错误，此时，需要对其进行降级。</p>
<h2 id="64页面异步请求降级">6.4、页面异步请求降级<a hidden class="anchor" aria-hidden="true" href="#64页面异步请求降级">#</a></h2>
<p>比如，商品详情页上有推荐信息/配送至等异步加载的请求，如果这些信息响应慢或者后端服务有问题，则可以进行降级。</p>
<h2 id="65服务功能降级">6.5、服务功能降级<a hidden class="anchor" aria-hidden="true" href="#65服务功能降级">#</a></h2>
<p>比如，渲染商品详情页时，需要调用一些不太重要的服务（相关分类、热销榜等），而这些服务在异常情况下直接不获取，即降级即可。</p>
<h2 id="66读降级">6.6、读降级<a hidden class="anchor" aria-hidden="true" href="#66读降级">#</a></h2>
<p>比如，多级缓存模式，如果后端服务有问题，则可以降级为只读缓存，这种方式适用于对读一致性要求不高的场景。</p>
<h2 id="67写降级">6.7、写降级<a hidden class="anchor" aria-hidden="true" href="#67写降级">#</a></h2>
<p>比如，秒杀抢购，我们可以只进行Cache的更新，然后异步扣减库存到DB，保证最终一致性即可，此时可以将DB降级为Cache。</p>
<h2 id="68自动降级">6.8、自动降级<a hidden class="anchor" aria-hidden="true" href="#68自动降级">#</a></h2>
<p>当服务中错误出现次数到达阀值（99.99%）,对服务进行降级，发出警告。</p>
<h1 id="7超时与重试">7、超时与重试<a hidden class="anchor" aria-hidden="true" href="#7超时与重试">#</a></h1>
<p>在访问服务之后，由于网络或其他原因迟迟没有响应而超时，此时为了用户体验度，可以默认发起第二次请求，进行尝试。</p>
<ol>
<li>代理层超时与重试： nginx</li>
<li>web容器超时与重试</li>
<li>中间件和服务之间超时与重试</li>
<li>数据库连接超时与重试</li>
<li>nosql超时与重试</li>
<li>业务超时与重试</li>
<li>前端浏览器ajax请求超时与重试</li>
</ol>
<h1 id="8压测与预案">8、压测与预案<a hidden class="anchor" aria-hidden="true" href="#8压测与预案">#</a></h1>
<h2 id="81系统压测">8.1、系统压测<a hidden class="anchor" aria-hidden="true" href="#81系统压测">#</a></h2>
<p>压测一般指<strong>性能压力测试</strong>，用来评估系统的<strong>稳定性</strong>和<strong>性能</strong>，通过压测数据进行系统容量评估，从而决定是否需要进行<strong>扩容</strong>或<strong>缩容</strong>。</p>
<p><strong>线下压测</strong>：<br>
通过如JMeter、Apache ab压测系统的某个接口（如查询库存接口）或者某个组件（如数据库连接池），然后进行调优（如调整JVM参数、优化代码），实现单个接口或组件的性能最优。<br>
线下压测的环境（比如，服务器、网络、数据量等）和线上的完全不一样，仿真度不高，很难进行全链路压测，适合组件级的压测，数据只能作为参考。</p>
<p><strong>线上压测</strong>:<br>
线上压测的方式非常多，按读写分为读压测、写压测和混合压测，按数据仿真度分为仿真压测和引流压测，按是否给用户提供服务分为隔离集群压测和线上集群压测。<br>
读压测是压测系统的读流量，比如，压测商品价格服务。写压测是压测系统的写流量，比如下单。写压测时，要注意把压测写的数据和真实数据分离，在压测完成后，删除压测数据。只进行读或写压测有时是不能发现系统瓶颈的，因为有时读和写是会相互影响的，因此，这种情况下要进行混合压测。<br>
仿真压测是通过模拟请求进行系统压测，模拟请求的数据可以是使用程序构造、人工构造（如提前准备一些用户和商品），或者使用Nginx访问日志，如果压测的数据量有限，则会形成请求热点。而更好的方式可以考虑引流压测，比如使用TCPCopy复制</p>
<h2 id="82系统优化和容灾">8.2、系统优化和容灾<a hidden class="anchor" aria-hidden="true" href="#82系统优化和容灾">#</a></h2>
<p>拿到压测报告后，接下来会分析报告，然后进行一些有针对性的优化，如硬件升级、系统扩容、参数调优、代码优化（如代码同步改异步）、架构优化（如加缓存、读写分离、历史数据归档）等。</p>
<p><strong>不要直接复用别人的案列，一定要根据压测结果合理调整自己的案例。</strong></p>
<p>在进行系统优化时，要进行代码走查，发现不合理的参数配置，如超时时间、降级策略、缓存时间等。在系统压测中进行慢查询排查，包括Redis、MySQL等，通过优化查询解决慢查询问题。</p>
<p>在应用系统扩容方面，可以根据去年流量、与运营业务方沟通促销力度、最近一段时间的流量来评估出是否需要进行扩容，需要扩容多少倍，比如，预计GMV增长100%，那么可以考虑扩容2~3倍容量。</p>
<h2 id="83应急预案">8.3、应急预案<a hidden class="anchor" aria-hidden="true" href="#83应急预案">#</a></h2>
<p>在系统压测之后会发现一些系统瓶颈，在系统优化之后会提升系统吞吐量并降低响应时间，容灾之后的系统可用性得以保障，但还是会存在一些风险，如网络抖动、某台机器负载过高、某个服务变慢、数据库Load值过高等，为了防止因为这些问题而出现系统雪崩，需要针对这些情况制定应急预案，从而在出现突发情况时，有相应的措施来解决掉这些问题。</p>
<p>应急预案可按照如下几步进行：首先进行系统分级，然后进行全链路分析、配置监控报警，最后制定应急预案。</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/%E8%AE%BE%E8%AE%A1/">设计</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="http://localhost:1313/posts/wiki/%E5%86%AF%E5%A4%A9%E5%87%A4/">
    <span class="title">« 上一页</span>
    <br>
    <span>冯天凤</span>
  </a>
  <a class="next" href="http://localhost:1313/posts/juejin/%E5%8D%8E%E4%B8%BA%E8%87%AA%E7%A0%94%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80%E4%BB%93%E9%A2%89%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97/">
    <span class="title">下一页 »</span>
    <br>
    <span>华为自研编程语言“仓颉”开发指南</span>
  </a>
</nav>


<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 高可用系统设计原则 on x"
            href="https://x.com/intent/tweet/?text=%e9%ab%98%e5%8f%af%e7%94%a8%e7%b3%bb%e7%bb%9f%e8%ae%be%e8%ae%a1%e5%8e%9f%e5%88%99&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2fjuejin%2f%25E9%25AB%2598%25E5%258F%25AF%25E7%2594%25A8%25E7%25B3%25BB%25E7%25BB%259F%25E8%25AE%25BE%25E8%25AE%25A1%25E5%258E%259F%25E5%2588%2599%2f&amp;hashtags=%e8%ae%be%e8%ae%a1">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 高可用系统设计原则 on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2fjuejin%2f%25E9%25AB%2598%25E5%258F%25AF%25E7%2594%25A8%25E7%25B3%25BB%25E7%25BB%259F%25E8%25AE%25BE%25E8%25AE%25A1%25E5%258E%259F%25E5%2588%2599%2f&amp;title=%e9%ab%98%e5%8f%af%e7%94%a8%e7%b3%bb%e7%bb%9f%e8%ae%be%e8%ae%a1%e5%8e%9f%e5%88%99&amp;summary=%e9%ab%98%e5%8f%af%e7%94%a8%e7%b3%bb%e7%bb%9f%e8%ae%be%e8%ae%a1%e5%8e%9f%e5%88%99&amp;source=http%3a%2f%2flocalhost%3a1313%2fposts%2fjuejin%2f%25E9%25AB%2598%25E5%258F%25AF%25E7%2594%25A8%25E7%25B3%25BB%25E7%25BB%259F%25E8%25AE%25BE%25E8%25AE%25A1%25E5%258E%259F%25E5%2588%2599%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 高可用系统设计原则 on reddit"
            href="https://reddit.com/submit?url=http%3a%2f%2flocalhost%3a1313%2fposts%2fjuejin%2f%25E9%25AB%2598%25E5%258F%25AF%25E7%2594%25A8%25E7%25B3%25BB%25E7%25BB%259F%25E8%25AE%25BE%25E8%25AE%25A1%25E5%258E%259F%25E5%2588%2599%2f&title=%e9%ab%98%e5%8f%af%e7%94%a8%e7%b3%bb%e7%bb%9f%e8%ae%be%e8%ae%a1%e5%8e%9f%e5%88%99">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 高可用系统设计原则 on facebook"
            href="https://facebook.com/sharer/sharer.php?u=http%3a%2f%2flocalhost%3a1313%2fposts%2fjuejin%2f%25E9%25AB%2598%25E5%258F%25AF%25E7%2594%25A8%25E7%25B3%25BB%25E7%25BB%259F%25E8%25AE%25BE%25E8%25AE%25A1%25E5%258E%259F%25E5%2588%2599%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 高可用系统设计原则 on whatsapp"
            href="https://api.whatsapp.com/send?text=%e9%ab%98%e5%8f%af%e7%94%a8%e7%b3%bb%e7%bb%9f%e8%ae%be%e8%ae%a1%e5%8e%9f%e5%88%99%20-%20http%3a%2f%2flocalhost%3a1313%2fposts%2fjuejin%2f%25E9%25AB%2598%25E5%258F%25AF%25E7%2594%25A8%25E7%25B3%25BB%25E7%25BB%259F%25E8%25AE%25BE%25E8%25AE%25A1%25E5%258E%259F%25E5%2588%2599%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 高可用系统设计原则 on telegram"
            href="https://telegram.me/share/url?text=%e9%ab%98%e5%8f%af%e7%94%a8%e7%b3%bb%e7%bb%9f%e8%ae%be%e8%ae%a1%e5%8e%9f%e5%88%99&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2fjuejin%2f%25E9%25AB%2598%25E5%258F%25AF%25E7%2594%25A8%25E7%25B3%25BB%25E7%25BB%259F%25E8%25AE%25BE%25E8%25AE%25A1%25E5%258E%259F%25E5%2588%2599%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 高可用系统设计原则 on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=%e9%ab%98%e5%8f%af%e7%94%a8%e7%b3%bb%e7%bb%9f%e8%ae%be%e8%ae%a1%e5%8e%9f%e5%88%99&u=http%3a%2f%2flocalhost%3a1313%2fposts%2fjuejin%2f%25E9%25AB%2598%25E5%258F%25AF%25E7%2594%25A8%25E7%25B3%25BB%25E7%25BB%259F%25E8%25AE%25BE%25E8%25AE%25A1%25E5%258E%259F%25E5%2588%2599%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span><a href="https://beian.miit.gov.cn/">粤ICP备2023039897号-1</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = '复制';

        function copyingDone() {
            copybutton.innerHTML = '已复制！';
            setTimeout(() => {
                copybutton.innerHTML = '复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
