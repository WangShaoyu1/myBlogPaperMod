<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>统一观测｜借助Prometheus监控ClickHouse数据库 | PaperMod</title>
<meta name="keywords" content="云原生">
<meta name="description" content="本文旨在分享阿里云可观测监控Prometheus版对开源ClickHouse的监控实践。。。">
<meta name="author" content="阿里云云原生">
<link rel="canonical" href="http://localhost:1313/posts/juejin/%E7%BB%9F%E4%B8%80%E8%A7%82%E6%B5%8B%E5%80%9F%E5%8A%A9prometheus%E7%9B%91%E6%8E%A7clickhouse%E6%95%B0%E6%8D%AE%E5%BA%93/">
<meta name="google-site-verification" content="XYZabc">
<link crossorigin="anonymous" href="/assets/css/stylesheet.7b92bf4867c997b58ec50f63451b83777173d5bd5593376852abd85746d09d71.css" integrity="sha256-e5K/SGfJl7WOxQ9jRRuDd3Fz1b1VkzdoUqvYV0bQnXE=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/%3Clink%20/%20abs%20url%3E">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/%3Clink%20/%20abs%20url%3E">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/%3Clink%20/%20abs%20url%3E">
<link rel="apple-touch-icon" href="http://localhost:1313/%3Clink%20/%20abs%20url%3E">
<link rel="mask-icon" href="http://localhost:1313/%3Clink%20/%20abs%20url%3E">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="http://localhost:1313/posts/juejin/%E7%BB%9F%E4%B8%80%E8%A7%82%E6%B5%8B%E5%80%9F%E5%8A%A9prometheus%E7%9B%91%E6%8E%A7clickhouse%E6%95%B0%E6%8D%AE%E5%BA%93/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript><meta property="og:title" content="统一观测｜借助Prometheus监控ClickHouse数据库" />
<meta property="og:description" content="本文旨在分享阿里云可观测监控Prometheus版对开源ClickHouse的监控实践。。。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/posts/juejin/%E7%BB%9F%E4%B8%80%E8%A7%82%E6%B5%8B%E5%80%9F%E5%8A%A9prometheus%E7%9B%91%E6%8E%A7clickhouse%E6%95%B0%E6%8D%AE%E5%BA%93/" />
<meta property="og:image" content="http://localhost:1313/images/papermod-cover.png" />
<meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-08-01T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-08-01T00:00:00+00:00" />


<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="http://localhost:1313/images/papermod-cover.png" />
<meta name="twitter:title" content="统一观测｜借助Prometheus监控ClickHouse数据库"/>
<meta name="twitter:description" content="本文旨在分享阿里云可观测监控Prometheus版对开源ClickHouse的监控实践。。。"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "http://localhost:1313/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "统一观测｜借助Prometheus监控ClickHouse数据库",
      "item": "http://localhost:1313/posts/juejin/%E7%BB%9F%E4%B8%80%E8%A7%82%E6%B5%8B%E5%80%9F%E5%8A%A9prometheus%E7%9B%91%E6%8E%A7clickhouse%E6%95%B0%E6%8D%AE%E5%BA%93/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "统一观测｜借助Prometheus监控ClickHouse数据库",
  "name": "统一观测｜借助Prometheus监控ClickHouse数据库",
  "description": "本文旨在分享阿里云可观测监控Prometheus版对开源ClickHouse的监控实践。。。",
  "keywords": [
    "云原生"
  ],
  "articleBody": "引言 ClickHouse 作为用于联机分析(OLAP)的列式数据库管理系统(DBMS), 最核心的特点是极致压缩率和极速查询性能。同时，ClickHouse 支持 SQL 查询，在基于大宽表的聚合分析查询场景下展现出优异的性能。因此，获得了广泛的应用。本文旨在分享阿里云可观测监控 Prometheus 版对开源 ClickHouse 的监控实践。\n一、ClickHouse 简介 （一）技术特点 列式存储与数据压缩： 在执行数据查询时，列式存储可以减少数据扫描范围和数据传输大小，提高数据查询的效率。\n完备的 DBMS 功能\nDDL （数据定义语言）：可以动态地创建、修改或删除数据库、表和视图，而无须重启服务； DML（数据操作语言）：可以动态查询、插入、修改或删除数据。 权限控制：\n可按照用户粒度设置数据库或表的操作权限，保障数据安全性。\n数据备份与恢复 提供数据备份导出与导入恢复机制，满足生产环境要求。\n分布式管理 提供集群模式，自动管理多个数据库节点。\n（二）ClickHouse 典型适用场景 复杂查询聚合的 OLAP 场景； 需要支持稳定大量数据写入； 不需要高频查询； 不需要高级 DBMS 功能，如事务性；不需要经常很复杂的表间操作，比如 join 操作。 （三）ClickHouse 核心概念 ClickHouse 集群（Cluster） 在物理构成上，ClickHouse 集群是由多个 ClickHouse Server 实例组成的分布式数据库。这些 ClickHouse Server 根据规格的不同可以包含 1 个或多个副本（Replica）、1 个或多个分片（Shard）。在逻辑构成上，一个ClickHouse 集群可以包含多个数据库（Database）对象。\n分片（Shard） 在超大规模海量数据处理场景下，单台服务器的存储、计算资源会成为瓶颈。为了进一步提高效率，ClickHouse 将海量数据分散存储到多台服务器上，每台服务器只存储和处理海量数据的一部分，在这种架构下，每台服务器被称为一个分片（Shard）。\n副本（Replica） 为了在异常情况下保证数据的安全性和服务的高可用性，ClickHouse 提供副本机制，将单台服务器的数据冗余存储在2台或多台服务器上。\n数据库（Database） 数据库是云数据库 ClickHouse 集群中的最高级别对象，内部包含表（Table）、列（Column）、视图（View）、函数、数据类型等。\n表（Table） 表是数据的组织形式，由多行、多列构成。\n二、ClickHouse Metrics 监控参考模型 我们从 Metrics 采集、监控大盘、告警规则等三个方面定义 ClickHouse Metrics 监控的参考模型，以便实现监控闭环。\n（一）Metrics 采集 主机节点监控即硬件资源（Node-Exporter）\n处理器、内存负载； 磁盘存储； ClickHouse 服务指标监控（集成进 ClickHouse-Exporter）\n系统指标（metrics）: system.metrics 表用于统计 ClickHouse 服务在运行时，当前正在执行的高层次的概要信息，包括了正在执行的查询总次数、正在发生的合并操作总次数等。具体指标通过执行select * from system.metrics； 系统事件（events）：system.events 用于统计 ClickHouse 服务在运行过程中已经执行过的高层次的 累积概要信息，包括查询总次数、 SELECT 查询总次数等，具体指标通过执行查询select * from system.events--\u003e 64个指标； 系统异步指标（asynchronous_ metrics）：asynchronous_metrics 用于统计 ClickHouse 服务运行过程时，当前正在后台 异步运行的高层次的概要信息，包括当前分配的内存、执行队列中的任务数量等。 具体指标通过执行查询select * from system.asynchronous_metrics –\u003e 500个指标； 查询日志：查询日志目前主要有6种类型，所有查询日志在默认配置下都是关闭状态，需要在 config.xml文件配置，开启日志后可以到对应的日志表进行日志查询system.query_log。 （1）主机节点监控 该部分指标主要来源于 Node-Exporter , 提供集群/ ECS 节点 CPU、内存、磁盘、inode 等监控指标。\n（2）ClikcHouse 服务指标 ClikckHouse 内置 Metrics、events 和 asynchronous_metrics 三张系统表用于存放其监控指标，通过预先安装 clickhouse-exporter 将这三张系统表中的数据转化、发送给阿里云可观测监控 Prometheus 版。\n⚠️注意: 以上列出的为关键指标，更多详细指标详见: 应用实时监控服务ARMS控制台-Prometheus监控-Prometheus实例列表-选择实例-集成中心-ClickHouse\n（二）ClickHouse 监控大盘 我们默认提供了arms-clickhouse-ecs和arms-clickhouse-k8s两个大盘，分别针对 ClickHouse 安装在ACK 集群/ ECS 中两个场景，这两个大盘中图标均来自于上述 Metrics 指标。\n⚠️注意: 主机节点监控需提前安装 Node-Exporter，以下大盘图示数值仅为展示作用，不具备参考价值，实际数值依 ClickHouse 环境而定\n（1）主机节点指标\n（2）ClickHouse Server指标\n（3）MergeTree 指标\n（4）消息队列指标\n（三）告警规则 参考前面对各项主要指标介绍，针对 ClickHouse 可以重点配置以下告警项，这些告警项已内置到arms-clickhouse告警规则中，可依据自身业务情况及经验调整告警阈值:\n【L0】CPU 超过 90% 【L0】Mem 超过 90% 【L0】Disk 超过 90% 【L0】Inode 使用率超过 90% 【L0】写入失败率超过 5% 【L1】运行 Query 个数超过 95 【L1】连接数超过 4k 【L1】失败 Query 个数超过 10 （四）相关实践示例 （1）CPU 过高 确认 CPU 占用过高是由 ClickHouse 引起的。可以通过 top 命令top -H -p xxx查看系统的 CPU 占用率，找出占用 CPU 比较高的进程。如果发现 ClickHouse 进程占用了大量 CPU 资源，那么就需要进一步排查。 使用 ClickHouse 内置查询来查看系统的状态。可以使用以下查询： sql\n代码解读\n复制代码\nSHOW PROCESSLIST query WHERE query NOT LIKE '%SYSTEM%' ORDER BY elapsed DESC LIMIT 10\n这个查询可以列出最耗时的查询，找到可能引起 CPU 占用过高的查询语句。\n检查 ClickHouse 配置。一些配置参数可能导致 ClickHouse 占用大量 CPU 资源。可以查看 ClickHouse 配置文件，确认配置是否合理，是否需要调整。 检查 ClickHouse 日志。ClickHouse 日志中可能包含错误信息或警告信息，可以帮助找出问题所在。 检查硬件资源是否充足。如果系统 CPU、内存等硬件资源不足，那么 ClickHouse 可能会出现 CPU 占用过高的情况。可以检查系统的硬件资源使用情况，确认是否需要升级硬件。 升级 ClickHouse 版本。如果是 ClickHouse 版本的问题，可以考虑升级到更稳定的版本。 （2）内存过高 使用内置查询查看内存占用情况。可以使用以下查询来查看 ClickHouse 系统的内存占用情况： sql\n代码解读\n复制代码\nSELECT * FROM system.metrics WHERE metric LIKE '%memory%';\n这个查询会列出 ClickHouse 的各个内存指标，包括总内存、已用内存、缓存内存等。可以根据这些指标来判断内存占用是否过高。\n检查 ClickHouse 的配置。一些配置参数可能会导致 ClickHouse 占用大量的内存资源。可以查看 ClickHouse 的配置文件，确认配置是否合理，是否需要调整。 检查系统的内存资源使用情况。如果系统的内存资源不足，那么 ClickHouse 可能会出现内存占用过高的情况。可以使用命令free -m查看系统的内存使用情况。 检查 ClickHouse 的日志。ClickHouse 的日志中可能包含错误信息或警告信息，可以帮助找出问题所在。 升级 ClickHouse 版本。如果是 ClickHouse 版本的问题，可以考虑升级到更稳定的版本。 减少查询语句的数据量和计算量。如果查询语句的数据量和计算量过大，那么 ClickHouse 可能会占用大量的内存资源。可以考虑优化查询语句，减少数据量和计算量。 （3）Disk 占用过高 使用系统工具查看磁盘占用情况。可以使用命令 df -h 来查看系统的磁盘使用情况，查看是否有磁盘空间不足的情况。 检查 ClickHouse 的配置。一些配置参数可能会导致 ClickHouse 占用大量的磁盘资源。可以查看 ClickHouse 的配置文件，确认配置是否合理，是否需要调整。 使用 ClickHouse 内置的查询来查看磁盘占用情况。可以使用以下查询来查看 ClickHouse 的磁盘占用情况： sql\n代码解读\n复制代码\nSELECT database, table, sum(bytes) AS total_size FROM system.parts WHERE active GROUP BY database, table ORDER BY total_size DESC\n这个查询会列出 ClickHouse 的各个表的占用磁盘空间情况，可以根据这个查询来判断磁盘占用是否过高。\n检查 ClickHouse 的日志。ClickHouse 的日志中可能包含错误信息或警告信息，可以帮助找出问题所在。 清理不必要的数据。如果 ClickHouse 中存在不必要的数据，可以考虑进行清理，释放磁盘空间。 三、如何使用阿里云可观测监控 Prometheus 版监控ClickHouse 服务 （一）安装 Prometheus 监控 （1）前序条件：已根据安装ClickHouse 安装环境，创建对应Prometheus 实例。 根据 ClickHouse 安装方式：\n如果 ClickHouse 部署在 ACK 中, 并创建了Prometheus for 容器实例，创建请参考Prometheus for 容器服务； 如果 ClickHouse 部署在 ECS 中, 并创建了Prometheus for ECS 实例，创建请参考Prometheus for ECS。 （2）安装方式一：Prometheus for 容器服务 在Prometheus for 容器服务实例中，ClickHouse 已经默认在集成中心中展示，用户可以在应用实时监控服务ARMS控制台-Prometheus监控-Prometheus实例列表-选择Prometheus for 容器服务实例-集成中心中找到入口，点击 ClickHouse 图标，可以看到常见的指标列表和大盘缩略图。点击+安装可以接入 ClickHouse 监控，配置如下图：\nExporter 名称: 自定义 Exporter 名称； ClickHouse Scrape 地址: IP + Port, Exporter 能够访问的 ClickHouse 地址 ； ClickHouse 用户名: 登陆用户名； ClickHouse 密码: 登陆密码； Metrics 采集间隔(秒): 默认 30s 采集一次, 一般不需要更改。 点击确定后, clickhouse-exporter-填入的名称的 Exporter 会被安装到 arms-prom 命名空间下，并自动完成采集 job 的配置。\n可以在应用实时监控服务ARMS控制台-Prometheus监控-Prometheus实例列表-选择Prometheus for 容器服务实例-集成中心-已安装-ClikckHouse中快速浏览相关的 Target/指标/大盘/告警/服务发现/ Exporter 等信息。\n（3）安装方式二：Prometheus for ECS 安装 ClickHouse 相同 VPC 的Prometheus for ECS实例，由于Prometheus for ECS实例中 ClickHouse 的主机节点监控来自于Node-Exportor，所以先安装 Node-Exportor。用户可以在\n应用实时监控服务ARMS控制台-Prometheus监控-Prometheus实例列表-选择Prometheus for ECS实例-集成中心中找到入口，点击Node-Exporter图标，点击+安装可以接入 Node-Exporter 监控，然后选择对应 ECS 实例安装即可。\n用户可以在应用实时监控服务ARMS控制台-Prometheus监控-Prometheus实例列表-选择Prometheus for ECS实例-集成中心中找到入口，点击 ClickHouse 图标，点击+安装可以接入 ClickHouse 监控，配置与上述Prometheus for 容器服务相同。\n（4）指标未采集的排查方法 ⚠️注意: 下面是Prometheus for 容器实例的排查方法，Prometheus for ECS实例请联系Prometheus值班-美娜\nClickHouse-Exporter 本身的主要工作是指标映射，需要填入正确 ClickHouse 抓取 URL及登陆用户名、密码。如果出现指标采集不到的问题，可以参考如下的排查思路。\n检查 Prometheus Target 状态，如果 Target 显示为Unhealthy状态，请排查clickhouse-exporter Pod 运行状态；如果 Target 状态正常，继续下一步。 若 Target 状态正常，但抓取指标量很少且指标全为go_相关查看clickhouse-exporter Pod 日志，确认日志中是否有报错信息。 查看clickhouse-exporter Pod 日志，确定 Exporter 抓取目标 URL 是否正常。 （二）查看大盘 如需要查看 ClickHouse 相关大盘，可以从应用实时监控服务ARMS控制台-Prometheus监控-Prometheus实例列表-实例详情页-集成中心-已安装-ClikckHouse中点选大盘，列出两类大盘arms-clickhouse-ecs和arms-clickhouse-k8s，根据环境选择对应的大盘模板。\n以下是arms-clickhouse-k8sVariables 参数说明:\ndatasource : 数据源，选择对应的实例名称； job: 新建 clickhouse-exporter 对应 job 名称，与 clickhouse-exporter 名称一致，用于展示ClickHouseServer 指标、MergeTree 指标、消息队列指标； namespace: ClickHouse Pod 所在的命名空间，用于主机节点指标筛选； Pod: 可根据需要选择对应的 ClickHouse Pod，用于主机节点指标筛选。 以下是arms-clickhouse-ecsVariables参数说明:\ndatasource: 数据源，选择对应的实例名称； job: 新建的 clickhouse-exporter 对应 job 名称，与clickhouse-exporter 名称一致，用于展示ClickHouseServer 指标、MergeTree 指标、消息队列指标； instance: ecs 实例 IP，用于主机节点筛选。 （三）配置告警 在集成中心安装 ClickHouse 监控时，已经默认增加了arms-clickhouse告警分组的相关规则，但未启用，您只需要简单修改参数并确认启用即可。\n可以从应用实时监控服务ARMS控制台-Prometheus监控-Prometheus实例列表-实例详情页-集成中心-已安装-ClikckHouse中选择告警-创建告警规则进入规则新增页面，在其中告警分组选择arms-clickhouse告警分组并根据环境选择您需要启用的告警指标，确认参数阈值并保存，即可完成告警规则的创建。\n四、自建 Prometheus 与阿里云可观测监控 Prometheus 版监控 ClickHouse 优劣对比 Prometheus 作为目前主流可观测开源项目之一，已被众多企业所广泛应用，但还会遇到不少困难与挑战:\n每套完整的自建观测系统都需要安装并配置 Prometheus、Grafana、AlertManager 等组件，部署过程复杂、实施周期长，并且每次升级都需要对每个组件进行维护； 开源分享的相关大盘不够专业，更新速度慢，缺少开箱即用的丰富指标； 由于安全、组织管理等因素，用户业务通常部署在多个相互隔离的 VPC，需要在多个 VPC 内都重复、独立部署 Prometheus，导致部署和运维成本高。 针对以上问题，阿里云可观测监控 Prometheus 版进行了以下优化：\n结束语 阿里云可观测监控 Prometheus 版与阿里云容器服务无缝集成，提供了开源 ClickHouse 的指标采集、用户大盘、告警规则等项目的一键集成，用户免运维，开箱即用，目前 ClickHouse 指标采集功能仍在不断演进中，欢迎大家试用和提出改进意见。\n",
  "wordCount" : "580",
  "inLanguage": "zh",
  "image": "http://localhost:1313/images/papermod-cover.png","datePublished": "2023-08-01T00:00:00Z",
  "dateModified": "2023-08-01T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "阿里云云原生"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://localhost:1313/posts/juejin/%E7%BB%9F%E4%B8%80%E8%A7%82%E6%B5%8B%E5%80%9F%E5%8A%A9prometheus%E7%9B%91%E6%8E%A7clickhouse%E6%95%B0%E6%8D%AE%E5%BA%93/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "PaperMod",
    "logo": {
      "@type": "ImageObject",
      "url": "http://localhost:1313/%3Clink%20/%20abs%20url%3E"
    }
  }
}
</script>
</head>

<body class=" dark" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Home (Alt + H)">
                        
                    <img src="http://localhost:1313/images/msg_hu15231257772499651944.png" alt="" aria-label="logo"
                        height="20">Home</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/archives" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://github.com/adityatelange/hugo-PaperMod/wiki/" title="WiKi">
                    <span>WiKi</span>&nbsp;
                    <svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round"
                        stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12">
                        <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path>
                        <path d="M15 3h6v6"></path>
                        <path d="M10 14L21 3"></path>
                    </svg>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/">主页</a>&nbsp;»&nbsp;<a href="http://localhost:1313/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      统一观测｜借助Prometheus监控ClickHouse数据库
    </h1>
    <div class="post-description">
      本文旨在分享阿里云可观测监控Prometheus版对开源ClickHouse的监控实践。。。
    </div>
    <div class="post-meta"><span title='2023-08-01 00:00:00 +0000 UTC'>八月 1, 2023</span>&nbsp;·&nbsp;3 分钟&nbsp;·&nbsp;阿里云云原生&nbsp;|&nbsp;<a href="https://github.com/WangShaoyu1/myBlogPaperMod/tree/master/content/posts/jueJin/%e7%bb%9f%e4%b8%80%e8%a7%82%e6%b5%8b%ef%bd%9c%e5%80%9f%e5%8a%a9Prometheus%e7%9b%91%e6%8e%a7ClickHouse%e6%95%b0%e6%8d%ae%e5%ba%93.md" rel="noopener noreferrer" target="_blank">Suggest Changes</a>

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">目录</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e5%bc%95%e8%a8%80" aria-label="引言">引言</a></li>
                <li>
                    <a href="#%e4%b8%80clickhouse-%e7%ae%80%e4%bb%8b" aria-label="一、ClickHouse 简介">一、ClickHouse 简介</a><ul>
                        
                <li>
                    <a href="#%e4%b8%80%e6%8a%80%e6%9c%af%e7%89%b9%e7%82%b9" aria-label="（一）技术特点">（一）技术特点</a></li>
                <li>
                    <a href="#%e4%ba%8cclickhouse-%e5%85%b8%e5%9e%8b%e9%80%82%e7%94%a8%e5%9c%ba%e6%99%af" aria-label="（二）ClickHouse 典型适用场景">（二）ClickHouse 典型适用场景</a></li>
                <li>
                    <a href="#%e4%b8%89clickhouse-%e6%a0%b8%e5%bf%83%e6%a6%82%e5%bf%b5" aria-label="（三）ClickHouse 核心概念">（三）ClickHouse 核心概念</a></li></ul>
                </li>
                <li>
                    <a href="#%e4%ba%8cclickhouse-metrics-%e7%9b%91%e6%8e%a7%e5%8f%82%e8%80%83%e6%a8%a1%e5%9e%8b" aria-label="二、ClickHouse Metrics 监控参考模型">二、ClickHouse Metrics 监控参考模型</a><ul>
                        <ul>
                        
                <li>
                    <a href="#%e4%b8%80metrics-%e9%87%87%e9%9b%86" aria-label="（一）Metrics 采集">（一）Metrics 采集</a><ul>
                        
                <li>
                    <a href="#1%e4%b8%bb%e6%9c%ba%e8%8a%82%e7%82%b9%e7%9b%91%e6%8e%a7" aria-label="（1）主机节点监控">（1）主机节点监控</a></li>
                <li>
                    <a href="#2clikchouse-%e6%9c%8d%e5%8a%a1%e6%8c%87%e6%a0%87" aria-label="（2）ClikcHouse 服务指标">（2）ClikcHouse 服务指标</a></li></ul>
                </li>
                <li>
                    <a href="#%e4%ba%8cclickhouse-%e7%9b%91%e6%8e%a7%e5%a4%a7%e7%9b%98" aria-label="（二）ClickHouse 监控大盘">（二）ClickHouse 监控大盘</a></li>
                <li>
                    <a href="#%e4%b8%89%e5%91%8a%e8%ad%a6%e8%a7%84%e5%88%99" aria-label="（三）告警规则">（三）告警规则</a></li>
                <li>
                    <a href="#%e5%9b%9b%e7%9b%b8%e5%85%b3%e5%ae%9e%e8%b7%b5%e7%a4%ba%e4%be%8b" aria-label="（四）相关实践示例">（四）相关实践示例</a><ul>
                        
                <li>
                    <a href="#1cpu-%e8%bf%87%e9%ab%98" aria-label="（1）CPU 过高">（1）CPU 过高</a></li>
                <li>
                    <a href="#2%e5%86%85%e5%ad%98%e8%bf%87%e9%ab%98" aria-label="（2）内存过高">（2）内存过高</a></li>
                <li>
                    <a href="#3disk-%e5%8d%a0%e7%94%a8%e8%bf%87%e9%ab%98" aria-label="（3）Disk 占用过高">（3）Disk 占用过高</a></li></ul>
                </li></ul>
                    </ul>
                </li>
                <li>
                    <a href="#%e4%b8%89%e5%a6%82%e4%bd%95%e4%bd%bf%e7%94%a8%e9%98%bf%e9%87%8c%e4%ba%91%e5%8f%af%e8%a7%82%e6%b5%8b%e7%9b%91%e6%8e%a7-prometheus-%e7%89%88%e7%9b%91%e6%8e%a7clickhouse-%e6%9c%8d%e5%8a%a1" aria-label="三、如何使用阿里云可观测监控 Prometheus 版监控ClickHouse 服务">三、如何使用阿里云可观测监控 Prometheus 版监控ClickHouse 服务</a><ul>
                        
                <li>
                    <a href="#%e4%b8%80%e5%ae%89%e8%a3%85-prometheus-%e7%9b%91%e6%8e%a7" aria-label="（一）安装 Prometheus 监控">（一）安装 Prometheus 监控</a><ul>
                        
                <li>
                    <a href="#1%e5%89%8d%e5%ba%8f%e6%9d%a1%e4%bb%b6%e5%b7%b2%e6%a0%b9%e6%8d%ae%e5%ae%89%e8%a3%85clickhouse-%e5%ae%89%e8%a3%85%e7%8e%af%e5%a2%83%e5%88%9b%e5%bb%ba%e5%af%b9%e5%ba%94prometheus-%e5%ae%9e%e4%be%8b" aria-label="（1）前序条件：已根据安装ClickHouse 安装环境，创建对应Prometheus 实例。">（1）前序条件：已根据安装ClickHouse 安装环境，创建对应Prometheus 实例。</a></li>
                <li>
                    <a href="#2%e5%ae%89%e8%a3%85%e6%96%b9%e5%bc%8f%e4%b8%80prometheus-for-%e5%ae%b9%e5%99%a8%e6%9c%8d%e5%8a%a1" aria-label="（2）安装方式一：Prometheus for 容器服务">（2）安装方式一：Prometheus for 容器服务</a></li>
                <li>
                    <a href="#3%e5%ae%89%e8%a3%85%e6%96%b9%e5%bc%8f%e4%ba%8cprometheus-for-ecs" aria-label="（3）安装方式二：Prometheus for ECS">（3）安装方式二：Prometheus for ECS</a></li>
                <li>
                    <a href="#4%e6%8c%87%e6%a0%87%e6%9c%aa%e9%87%87%e9%9b%86%e7%9a%84%e6%8e%92%e6%9f%a5%e6%96%b9%e6%b3%95" aria-label="（4）指标未采集的排查方法">（4）指标未采集的排查方法</a></li></ul>
                </li>
                <li>
                    <a href="#%e4%ba%8c%e6%9f%a5%e7%9c%8b%e5%a4%a7%e7%9b%98" aria-label="（二）查看大盘">（二）查看大盘</a></li>
                <li>
                    <a href="#%e4%b8%89%e9%85%8d%e7%bd%ae%e5%91%8a%e8%ad%a6" aria-label="（三）配置告警">（三）配置告警</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%9b%9b%e8%87%aa%e5%bb%ba-prometheus-%e4%b8%8e%e9%98%bf%e9%87%8c%e4%ba%91%e5%8f%af%e8%a7%82%e6%b5%8b%e7%9b%91%e6%8e%a7-prometheus-%e7%89%88%e7%9b%91%e6%8e%a7-clickhouse-%e4%bc%98%e5%8a%a3%e5%af%b9%e6%af%94" aria-label="四、自建 Prometheus 与阿里云可观测监控 Prometheus 版监控 ClickHouse 优劣对比">四、自建 Prometheus 与阿里云可观测监控 Prometheus 版监控 ClickHouse 优劣对比</a></li>
                <li>
                    <a href="#%e7%bb%93%e6%9d%9f%e8%af%ad" aria-label="结束语">结束语</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h1 id="引言">引言<a hidden class="anchor" aria-hidden="true" href="#引言">#</a></h1>
<p>ClickHouse 作为用于联机分析(OLAP)的列式数据库管理系统(DBMS), 最核心的特点是极致压缩率和极速查询性能。同时，ClickHouse 支持 SQL 查询，在基于大宽表的聚合分析查询场景下展现出优异的性能。因此，获得了广泛的应用。本文旨在分享阿里云可观测监控 Prometheus 版对开源 ClickHouse 的监控实践。</p>
<h1 id="一clickhouse-简介">一、ClickHouse 简介<a hidden class="anchor" aria-hidden="true" href="#一clickhouse-简介">#</a></h1>
<h2 id="一技术特点">（一）技术特点<a hidden class="anchor" aria-hidden="true" href="#一技术特点">#</a></h2>
<ul>
<li>列式存储与数据压缩：</li>
</ul>
<p>在执行数据查询时，列式存储可以减少数据扫描范围和数据传输大小，提高数据查询的效率。</p>
<ul>
<li>
<p>完备的 DBMS 功能</p>
</li>
<li>
<ul>
<li>DDL （数据定义语言）：可以动态地创建、修改或删除数据库、表和视图，而无须重启服务；</li>
<li>DML（数据操作语言）：可以动态查询、插入、修改或删除数据。</li>
</ul>
</li>
<li>
<p>权限控制：</p>
</li>
</ul>
<p>可按照用户粒度设置数据库或表的操作权限，保障数据安全性。</p>
<ul>
<li>数据备份与恢复</li>
</ul>
<p>提供数据备份导出与导入恢复机制，满足生产环境要求。</p>
<ul>
<li>分布式管理</li>
</ul>
<p>提供集群模式，自动管理多个数据库节点。</p>
<h2 id="二clickhouse-典型适用场景">（二）ClickHouse 典型适用场景<a hidden class="anchor" aria-hidden="true" href="#二clickhouse-典型适用场景">#</a></h2>
<ul>
<li>复杂查询聚合的 OLAP 场景；</li>
<li>需要支持稳定大量数据写入；</li>
<li>不需要高频查询；</li>
<li>不需要高级 DBMS 功能，如事务性；不需要经常很复杂的表间操作，比如 join 操作。</li>
</ul>
<h2 id="三clickhouse-核心概念">（三）ClickHouse 核心概念<a hidden class="anchor" aria-hidden="true" href="#三clickhouse-核心概念">#</a></h2>
<ul>
<li>ClickHouse 集群（Cluster）</li>
</ul>
<p>在物理构成上，ClickHouse 集群是由多个 ClickHouse Server 实例组成的分布式数据库。这些 ClickHouse Server 根据规格的不同可以包含 1 个或多个副本（Replica）、1 个或多个分片（Shard）。在逻辑构成上，一个ClickHouse 集群可以包含多个数据库（Database）对象。</p>
<ul>
<li>分片（Shard）</li>
</ul>
<p>在超大规模海量数据处理场景下，单台服务器的存储、计算资源会成为瓶颈。为了进一步提高效率，ClickHouse 将海量数据分散存储到多台服务器上，每台服务器只存储和处理海量数据的一部分，在这种架构下，每台服务器被称为一个分片（Shard）。</p>
<ul>
<li>副本（Replica）</li>
</ul>
<p>为了在异常情况下保证数据的安全性和服务的高可用性，ClickHouse 提供副本机制，将单台服务器的数据冗余存储在2台或多台服务器上。</p>
<ul>
<li>数据库（Database）</li>
</ul>
<p>数据库是云数据库 ClickHouse 集群中的最高级别对象，内部包含表（Table）、列（Column）、视图（View）、函数、数据类型等。</p>
<ul>
<li>表（Table）</li>
</ul>
<p>表是数据的组织形式，由多行、多列构成。</p>
<h1 id="二clickhouse-metrics-监控参考模型">二、ClickHouse Metrics 监控参考模型<a hidden class="anchor" aria-hidden="true" href="#二clickhouse-metrics-监控参考模型">#</a></h1>
<p>我们从 Metrics 采集、监控大盘、告警规则等三个方面定义 ClickHouse Metrics 监控的参考模型，以便实现监控闭环。</p>
<h3 id="一metrics-采集">（一）Metrics 采集<a hidden class="anchor" aria-hidden="true" href="#一metrics-采集">#</a></h3>
<ul>
<li>
<p>主机节点监控即硬件资源（Node-Exporter）</p>
</li>
<li>
<ul>
<li>处理器、内存负载；</li>
<li>磁盘存储；</li>
</ul>
</li>
<li>
<p>ClickHouse 服务指标监控（集成进 ClickHouse-Exporter）</p>
</li>
<li>
<ul>
<li>系统指标（metrics）: system.metrics 表用于统计 ClickHouse 服务在运行时，当前正在执行的高层次的概要信息，包括了正在执行的查询总次数、正在发生的合并操作总次数等。具体指标通过执行<code>select * from system.metrics</code>；</li>
<li>系统事件（events）：system.events 用于统计 ClickHouse 服务在运行过程中已经执行过的高层次的 累积概要信息，包括查询总次数、 SELECT 查询总次数等，具体指标通过执行查询<code>select * from system.events</code>--&gt; 64个指标；</li>
<li>系统异步指标（asynchronous_ metrics）：asynchronous_metrics 用于统计 ClickHouse 服务运行过程时，当前正在后台 异步运行的高层次的概要信息，包括当前分配的内存、执行队列中的任务数量等。 具体指标通过执行查询<code>select * from system.asynchronous_metrics</code> &ndash;&gt; 500个指标；</li>
<li>查询日志：查询日志目前主要有6种类型，所有查询日志在默认配置下都是关闭状态，需要在 config.xml文件配置，开启日志后可以到对应的日志表进行日志查询<code>system.query_log</code>。</li>
</ul>
</li>
</ul>
<h4 id="1主机节点监控">（1）主机节点监控<a hidden class="anchor" aria-hidden="true" href="#1主机节点监控">#</a></h4>
<p>该部分指标主要来源于 Node-Exporter , 提供集群/ ECS 节点 CPU、内存、磁盘、inode 等监控指标。</p>
<p><img loading="lazy" src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/171b71170d5546eaa1a257ca86d1ab15~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?" alt="image.png"  />
</p>
<h4 id="2clikchouse-服务指标">（2）ClikcHouse 服务指标<a hidden class="anchor" aria-hidden="true" href="#2clikchouse-服务指标">#</a></h4>
<p>ClikckHouse 内置 Metrics、events 和 asynchronous_metrics 三张系统表用于存放其监控指标，通过预先安装 clickhouse-exporter 将这三张系统表中的数据转化、发送给阿里云可观测监控 Prometheus 版。</p>
<p><img loading="lazy" src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4aed18ad69cc466c963a2c6d9dc63b23~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?" alt="image.png"  />
</p>
<p><img loading="lazy" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4751cbf35ce647358882850f99c9107c~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?" alt="image.png"  />
</p>
<p><img loading="lazy" src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9da18669a18c4a7d94daec350252687c~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?" alt="image.png"  />
</p>
<p><img loading="lazy" src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ae9356d6b9724ab9b94859dcdf5b32b4~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?" alt="image.png"  />
</p>
<p>⚠️注意: 以上列出的为关键指标，更多详细指标详见: <code>应用实时监控服务ARMS控制台</code>-<code>Prometheus监控</code>-<code>Prometheus实例列表</code>-<code>选择实例</code>-<code>集成中心</code>-<code>ClickHouse</code></p>
<p><img loading="lazy" src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d8ff3a8873ab472d8643e9e6ef6f88c5~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?" alt="image.png"  />
</p>
<h3 id="二clickhouse-监控大盘">（二）ClickHouse 监控大盘<a hidden class="anchor" aria-hidden="true" href="#二clickhouse-监控大盘">#</a></h3>
<p>我们默认提供了<code>arms-clickhouse-ecs</code>和<code>arms-clickhouse-k8s</code>两个大盘，分别针对 ClickHouse 安装在ACK 集群/ ECS 中两个场景，这两个大盘中图标均来自于上述 Metrics 指标。</p>
<p>⚠️注意: 主机节点监控需提前安装 Node-Exporter，以下大盘图示数值仅为展示作用，不具备参考价值，实际数值依 ClickHouse 环境而定</p>
<p><strong>（1）主机节点指标</strong></p>
<p><img loading="lazy" src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f523bff639344a839e409f609e6526bc~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?" alt="image.png"  />
</p>
<p><strong>（2）ClickHouse Server指标</strong></p>
<p><img loading="lazy" src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d176daf51b634df488ed34c9473a92a6~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?" alt="image.png"  />
</p>
<p><strong>（3）MergeTree 指标</strong></p>
<p><img loading="lazy" src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b6bffa868d60405582538449250831a6~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?" alt="image.png"  />
</p>
<p><strong>（4）消息队列指标</strong></p>
<p><img loading="lazy" src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4e47038de691423bbe4df102d1631b09~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?" alt="image.png"  />
</p>
<h3 id="三告警规则">（三）告警规则<a hidden class="anchor" aria-hidden="true" href="#三告警规则">#</a></h3>
<p>参考前面对各项主要指标介绍，针对 ClickHouse 可以重点配置以下告警项，这些告警项已内置到<code>arms-clickhouse</code>告警规则中，可依据自身业务情况及经验调整告警阈值:</p>
<ul>
<li>【L0】CPU 超过 90%</li>
<li>【L0】Mem 超过 90%</li>
<li>【L0】Disk 超过 90%</li>
<li>【L0】Inode 使用率超过 90%</li>
<li>【L0】写入失败率超过 5%</li>
<li>【L1】运行 Query 个数超过 95</li>
<li>【L1】连接数超过 4k</li>
<li>【L1】失败 Query 个数超过 10</li>
</ul>
<h3 id="四相关实践示例">（四）相关实践示例<a hidden class="anchor" aria-hidden="true" href="#四相关实践示例">#</a></h3>
<h4 id="1cpu-过高">（1）CPU 过高<a hidden class="anchor" aria-hidden="true" href="#1cpu-过高">#</a></h4>
<ul>
<li>确认 CPU 占用过高是由 ClickHouse 引起的。可以通过 top 命令<code>top -H -p xxx</code>查看系统的 CPU 占用率，找出占用 CPU 比较高的进程。如果发现 ClickHouse 进程占用了大量 CPU 资源，那么就需要进一步排查。</li>
<li>使用 ClickHouse 内置查询来查看系统的状态。可以使用以下查询：</li>
</ul>
<p>sql</p>
<p>代码解读</p>
<p>复制代码</p>
<p><code>SHOW PROCESSLIST query WHERE query NOT LIKE '%SYSTEM%' ORDER BY elapsed DESC LIMIT 10</code></p>
<p>这个查询可以列出最耗时的查询，找到可能引起 CPU 占用过高的查询语句。</p>
<ul>
<li>检查 ClickHouse 配置。一些配置参数可能导致 ClickHouse 占用大量 CPU 资源。可以查看 ClickHouse 配置文件，确认配置是否合理，是否需要调整。</li>
<li>检查 ClickHouse 日志。ClickHouse 日志中可能包含错误信息或警告信息，可以帮助找出问题所在。</li>
<li>检查硬件资源是否充足。如果系统 CPU、内存等硬件资源不足，那么 ClickHouse 可能会出现 CPU 占用过高的情况。可以检查系统的硬件资源使用情况，确认是否需要升级硬件。</li>
<li>升级 ClickHouse 版本。如果是 ClickHouse 版本的问题，可以考虑升级到更稳定的版本。</li>
</ul>
<h4 id="2内存过高">（2）内存过高<a hidden class="anchor" aria-hidden="true" href="#2内存过高">#</a></h4>
<ul>
<li>使用内置查询查看内存占用情况。可以使用以下查询来查看 ClickHouse 系统的内存占用情况：</li>
</ul>
<p>sql</p>
<p>代码解读</p>
<p>复制代码</p>
<p><code>SELECT * FROM system.metrics WHERE metric LIKE '%memory%';</code></p>
<p>这个查询会列出 ClickHouse 的各个内存指标，包括总内存、已用内存、缓存内存等。可以根据这些指标来判断内存占用是否过高。</p>
<ul>
<li>检查 ClickHouse 的配置。一些配置参数可能会导致 ClickHouse 占用大量的内存资源。可以查看 ClickHouse 的配置文件，确认配置是否合理，是否需要调整。</li>
<li>检查系统的内存资源使用情况。如果系统的内存资源不足，那么 ClickHouse 可能会出现内存占用过高的情况。可以使用命令<code>free -m</code>查看系统的内存使用情况。</li>
<li>检查 ClickHouse 的日志。ClickHouse 的日志中可能包含错误信息或警告信息，可以帮助找出问题所在。</li>
<li>升级 ClickHouse 版本。如果是 ClickHouse 版本的问题，可以考虑升级到更稳定的版本。</li>
<li>减少查询语句的数据量和计算量。如果查询语句的数据量和计算量过大，那么 ClickHouse 可能会占用大量的内存资源。可以考虑优化查询语句，减少数据量和计算量。</li>
</ul>
<h4 id="3disk-占用过高">（3）Disk 占用过高<a hidden class="anchor" aria-hidden="true" href="#3disk-占用过高">#</a></h4>
<ul>
<li>使用系统工具查看磁盘占用情况。可以使用命令 <code>df -h</code> 来查看系统的磁盘使用情况，查看是否有磁盘空间不足的情况。</li>
<li>检查 ClickHouse 的配置。一些配置参数可能会导致 ClickHouse 占用大量的磁盘资源。可以查看 ClickHouse 的配置文件，确认配置是否合理，是否需要调整。</li>
<li>使用 ClickHouse 内置的查询来查看磁盘占用情况。可以使用以下查询来查看 ClickHouse 的磁盘占用情况：</li>
</ul>
<p>sql</p>
<p>代码解读</p>
<p>复制代码</p>
<p><code>SELECT database, table, sum(bytes) AS total_size FROM system.parts WHERE active GROUP BY database, table ORDER BY total_size DESC</code></p>
<p>这个查询会列出 ClickHouse 的各个表的占用磁盘空间情况，可以根据这个查询来判断磁盘占用是否过高。</p>
<ul>
<li>检查 ClickHouse 的日志。ClickHouse 的日志中可能包含错误信息或警告信息，可以帮助找出问题所在。</li>
<li>清理不必要的数据。如果 ClickHouse 中存在不必要的数据，可以考虑进行清理，释放磁盘空间。</li>
</ul>
<h1 id="三如何使用阿里云可观测监控-prometheus-版监控clickhouse-服务">三、如何使用阿里云可观测监控 Prometheus 版监控ClickHouse 服务<a hidden class="anchor" aria-hidden="true" href="#三如何使用阿里云可观测监控-prometheus-版监控clickhouse-服务">#</a></h1>
<h2 id="一安装-prometheus-监控">（一）安装 Prometheus 监控<a hidden class="anchor" aria-hidden="true" href="#一安装-prometheus-监控">#</a></h2>
<h3 id="1前序条件已根据安装clickhouse-安装环境创建对应prometheus-实例">（1）前序条件：已根据安装ClickHouse 安装环境，创建对应Prometheus 实例。<a hidden class="anchor" aria-hidden="true" href="#1前序条件已根据安装clickhouse-安装环境创建对应prometheus-实例">#</a></h3>
<p>根据 ClickHouse 安装方式：</p>
<ul>
<li>如果 ClickHouse 部署在 ACK 中, 并创建了Prometheus for 容器实例，创建请参考<code>Prometheus for 容器服务</code>；</li>
<li>如果 ClickHouse 部署在 ECS 中, 并创建了Prometheus for ECS 实例，创建请参考<code>Prometheus for ECS</code>。</li>
</ul>
<h3 id="2安装方式一prometheus-for-容器服务">（2）安装方式一：Prometheus for 容器服务<a hidden class="anchor" aria-hidden="true" href="#2安装方式一prometheus-for-容器服务">#</a></h3>
<p>在<code>Prometheus for 容器服务</code>实例中，ClickHouse 已经默认在集成中心中展示，用户可以在<code>应用实时监控服务ARMS控制台</code>-<code>Prometheus监控</code>-<code>Prometheus实例列表</code>-<code>选择Prometheus for 容器服务实例</code>-<code>集成中心</code>中找到入口，点击 ClickHouse 图标，可以看到常见的指标列表和大盘缩略图。点击<code>+安装</code>可以接入 ClickHouse 监控，配置如下图：</p>
<ul>
<li>Exporter 名称: 自定义 Exporter 名称；</li>
<li>ClickHouse Scrape 地址: IP + Port, Exporter 能够访问的 ClickHouse 地址 ；</li>
<li>ClickHouse 用户名: 登陆用户名；</li>
<li>ClickHouse 密码: 登陆密码；</li>
<li>Metrics 采集间隔(秒): 默认 30s 采集一次, 一般不需要更改。</li>
</ul>
<p><img loading="lazy" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/268d8b31fddd434a999012c44c0b624b~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?" alt="image.png"  />
</p>
<p>点击确定后, <code>clickhouse-exporter-填入的名称</code>的 Exporter 会被安装到 arms-prom 命名空间下，并自动完成采集 job 的配置。</p>
<p><img loading="lazy" src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f786418e6ef34e38bf36b235c00919c2~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?" alt="image.png"  />
</p>
<p>可以在<code>应用实时监控服务ARMS控制台</code>-<code>Prometheus监控</code>-<code>Prometheus实例列表</code>-<code>选择Prometheus for 容器服务实例</code>-<code>集成中心</code>-<code>已安装</code>-<code>ClikckHouse</code>中快速浏览相关的 Target/指标/大盘/告警/服务发现/ Exporter 等信息。</p>
<p><img loading="lazy" src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/19151467be0c4cfcb05491b42c772f70~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?" alt="image.png"  />
</p>
<h3 id="3安装方式二prometheus-for-ecs">（3）安装方式二：Prometheus for ECS<a hidden class="anchor" aria-hidden="true" href="#3安装方式二prometheus-for-ecs">#</a></h3>
<p>安装 ClickHouse 相同 VPC 的<code>Prometheus for ECS</code>实例，由于<code>Prometheus for ECS</code>实例中 ClickHouse 的主机节点监控来自于<code>Node-Exportor</code>，所以先安装 <code>Node-Exportor</code>。用户可以在</p>
<p><code>应用实时监控服务ARMS控制台</code>-<code>Prometheus监控</code>-<code>Prometheus实例列表</code>-<code>选择Prometheus for ECS实例</code>-<code>集成中心</code>中找到入口，点击<code>Node-Exporter</code>图标，点击<code>+安装</code>可以接入 Node-Exporter 监控，然后选择对应 ECS 实例安装即可。</p>
<p><img loading="lazy" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/94f139bc30e348fdbbee9d46adada401~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?" alt="image.png"  />
</p>
<p>用户可以在<code>应用实时监控服务ARMS控制台</code>-<code>Prometheus监控</code>-<code>Prometheus实例列表</code>-<code>选择Prometheus for ECS实例</code>-<code>集成中心</code>中找到入口，点击 ClickHouse 图标，点击<code>+安装</code>可以接入 ClickHouse 监控，配置与上述<code>Prometheus for 容器服务</code>相同。</p>
<h3 id="4指标未采集的排查方法">（4）指标未采集的排查方法<a hidden class="anchor" aria-hidden="true" href="#4指标未采集的排查方法">#</a></h3>
<p>⚠️注意: 下面是<code>Prometheus for 容器</code>实例的排查方法，<code>Prometheus for ECS</code>实例请联系Prometheus值班-美娜</p>
<p>ClickHouse-Exporter 本身的主要工作是指标映射，需要填入正确 ClickHouse 抓取 URL及登陆用户名、密码。如果出现指标采集不到的问题，可以参考如下的排查思路。</p>
<ol>
<li>检查 Prometheus Target 状态，如果 Target 显示为<code>Unhealthy</code>状态，请排查<code>clickhouse-exporter</code> Pod 运行状态；如果 Target 状态正常，继续下一步。</li>
</ol>
<p><img loading="lazy" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9af221c0a4774cf1a2df2d8bace49a19~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?" alt="image.png"  />
</p>
<ol start="2">
<li>若 Target 状态正常，但抓取指标量很少且指标全为<code>go_</code>相关查看<code>clickhouse-exporter</code> Pod 日志，确认日志中是否有报错信息。</li>
</ol>
<p><img loading="lazy" src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c60bd8b642eb48f19202b9e3311ab5c0~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?" alt="image.png"  />
</p>
<p><img loading="lazy" src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ff6a29fa2e1d434c948a7a520c4bad87~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?" alt="image.png"  />
</p>
<ol start="3">
<li>查看<code>clickhouse-exporter</code> Pod 日志，确定 Exporter 抓取目标 URL 是否正常。</li>
</ol>
<p><img loading="lazy" src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/33eaa7f75e054baa811acbde86f22356~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?" alt="image.png"  />
</p>
<h2 id="二查看大盘">（二）查看大盘<a hidden class="anchor" aria-hidden="true" href="#二查看大盘">#</a></h2>
<p>如需要查看 ClickHouse 相关大盘，可以从<code>应用实时监控服务ARMS控制台</code>-<code>Prometheus监控</code>-<code>Prometheus实例列表</code>-<code>实例详情页</code>-<code>集成中心</code>-<code>已安装</code>-<code>ClikckHouse</code>中点选<code>大盘</code>，列出两类大盘<code>arms-clickhouse-ecs</code>和<code>arms-clickhouse-k8s</code>，根据环境选择对应的大盘模板。</p>
<p>以下是<code>arms-clickhouse-k8s</code>Variables 参数说明:</p>
<ul>
<li>datasource : 数据源，选择对应的实例名称；</li>
<li>job: 新建 clickhouse-exporter 对应 job 名称，与 clickhouse-exporter 名称一致，用于展示ClickHouseServer 指标、MergeTree 指标、消息队列指标；</li>
<li>namespace: ClickHouse Pod 所在的命名空间，用于主机节点指标筛选；</li>
<li>Pod: 可根据需要选择对应的 ClickHouse Pod，用于主机节点指标筛选。</li>
</ul>
<p><img loading="lazy" src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7510817d03464bebb623c7cd4992ad62~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?" alt="image.png"  />
</p>
<p>以下是<code>arms-clickhouse-ecs</code>Variables参数说明:</p>
<ul>
<li>datasource: 数据源，选择对应的实例名称；</li>
<li>job: 新建的 clickhouse-exporter 对应 job 名称，与clickhouse-exporter 名称一致，用于展示ClickHouseServer 指标、MergeTree 指标、消息队列指标；</li>
<li>instance: ecs 实例 IP，用于主机节点筛选。</li>
</ul>
<p><img loading="lazy" src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fdc1e6780dac4c73b3ea09bf1250208e~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?" alt="image.png"  />
</p>
<h2 id="三配置告警">（三）配置告警<a hidden class="anchor" aria-hidden="true" href="#三配置告警">#</a></h2>
<p>在集成中心安装 ClickHouse 监控时，已经默认增加了<code>arms-clickhouse告警分组</code>的相关规则，但未启用，您只需要简单修改参数并确认启用即可。</p>
<p>可以从<code>应用实时监控服务ARMS控制台</code>-<code>Prometheus监控</code>-<code>Prometheus实例列表</code>-<code>实例详情页</code>-<code>集成中心</code>-<code>已安装</code>-<code>ClikckHouse</code>中选择<code>告警</code>-<code>创建告警规则</code>进入规则新增页面，在其中告警分组选择<code>arms-clickhouse告警分组</code>并根据环境选择您需要启用的<code>告警指标</code>，确认参数阈值并保存，即可完成告警规则的创建。</p>
<p><img loading="lazy" src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/239f1007eb584de88fe8f633db3753c9~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?" alt="image.png"  />
</p>
<h1 id="四自建-prometheus-与阿里云可观测监控-prometheus-版监控-clickhouse-优劣对比">四、自建 Prometheus 与阿里云可观测监控 Prometheus 版监控 ClickHouse 优劣对比<a hidden class="anchor" aria-hidden="true" href="#四自建-prometheus-与阿里云可观测监控-prometheus-版监控-clickhouse-优劣对比">#</a></h1>
<p>Prometheus 作为目前主流可观测开源项目之一，已被众多企业所广泛应用，但还会遇到不少困难与挑战:</p>
<ul>
<li>每套完整的自建观测系统都需要安装并配置 Prometheus、Grafana、AlertManager 等组件，部署过程复杂、实施周期长，并且每次升级都需要对每个组件进行维护；</li>
<li>开源分享的相关大盘不够专业，更新速度慢，缺少开箱即用的丰富指标；</li>
<li>由于安全、组织管理等因素，用户业务通常部署在多个相互隔离的 VPC，需要在多个 VPC 内都重复、独立部署 Prometheus，导致部署和运维成本高。</li>
</ul>
<p>针对以上问题，阿里云可观测监控 Prometheus 版进行了以下优化：</p>
<p><img loading="lazy" src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e9e4aa28a9284725a73a048ce209d91d~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?" alt="image.png"  />
</p>
<h1 id="结束语">结束语<a hidden class="anchor" aria-hidden="true" href="#结束语">#</a></h1>
<p>阿里云可观测监控 Prometheus 版与阿里云容器服务无缝集成，提供了开源 ClickHouse 的指标采集、用户大盘、告警规则等项目的一键集成，用户免运维，开箱即用，目前 ClickHouse 指标采集功能仍在不断演进中，欢迎大家试用和提出改进意见。</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/%E4%BA%91%E5%8E%9F%E7%94%9F/">云原生</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="http://localhost:1313/posts/juejin/%E8%BF%99%E5%BA%94%E8%AF%A5%E6%98%AF%E5%85%A8%E7%BD%91%E6%9C%80%E8%AF%A6%E7%BB%86%E7%9A%84vue3.5%E7%89%88%E6%9C%AC%E8%A7%A3%E8%AF%BB/">
    <span class="title">« 上一页</span>
    <br>
    <span>这应该是全网最详细的Vue3.5版本解读</span>
  </a>
  <a class="next" href="http://localhost:1313/posts/juejin/javascript%E7%9A%84%E9%A1%B6%E5%B1%82await%E5%BC%82%E6%AD%A5%E4%BB%A3%E7%A0%81%E7%9A%84%E5%85%A8%E6%96%B0%E4%BD%93%E9%AA%8C/">
    <span class="title">下一页 »</span>
    <br>
    <span>JavaScript的顶层await：异步代码的全新体验</span>
  </a>
</nav>


<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 统一观测｜借助Prometheus监控ClickHouse数据库 on x"
            href="https://x.com/intent/tweet/?text=%e7%bb%9f%e4%b8%80%e8%a7%82%e6%b5%8b%ef%bd%9c%e5%80%9f%e5%8a%a9Prometheus%e7%9b%91%e6%8e%a7ClickHouse%e6%95%b0%e6%8d%ae%e5%ba%93&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2fjuejin%2f%25E7%25BB%259F%25E4%25B8%2580%25E8%25A7%2582%25E6%25B5%258B%25E5%2580%259F%25E5%258A%25A9prometheus%25E7%259B%2591%25E6%258E%25A7clickhouse%25E6%2595%25B0%25E6%258D%25AE%25E5%25BA%2593%2f&amp;hashtags=%e4%ba%91%e5%8e%9f%e7%94%9f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 统一观测｜借助Prometheus监控ClickHouse数据库 on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2fjuejin%2f%25E7%25BB%259F%25E4%25B8%2580%25E8%25A7%2582%25E6%25B5%258B%25E5%2580%259F%25E5%258A%25A9prometheus%25E7%259B%2591%25E6%258E%25A7clickhouse%25E6%2595%25B0%25E6%258D%25AE%25E5%25BA%2593%2f&amp;title=%e7%bb%9f%e4%b8%80%e8%a7%82%e6%b5%8b%ef%bd%9c%e5%80%9f%e5%8a%a9Prometheus%e7%9b%91%e6%8e%a7ClickHouse%e6%95%b0%e6%8d%ae%e5%ba%93&amp;summary=%e7%bb%9f%e4%b8%80%e8%a7%82%e6%b5%8b%ef%bd%9c%e5%80%9f%e5%8a%a9Prometheus%e7%9b%91%e6%8e%a7ClickHouse%e6%95%b0%e6%8d%ae%e5%ba%93&amp;source=http%3a%2f%2flocalhost%3a1313%2fposts%2fjuejin%2f%25E7%25BB%259F%25E4%25B8%2580%25E8%25A7%2582%25E6%25B5%258B%25E5%2580%259F%25E5%258A%25A9prometheus%25E7%259B%2591%25E6%258E%25A7clickhouse%25E6%2595%25B0%25E6%258D%25AE%25E5%25BA%2593%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 统一观测｜借助Prometheus监控ClickHouse数据库 on reddit"
            href="https://reddit.com/submit?url=http%3a%2f%2flocalhost%3a1313%2fposts%2fjuejin%2f%25E7%25BB%259F%25E4%25B8%2580%25E8%25A7%2582%25E6%25B5%258B%25E5%2580%259F%25E5%258A%25A9prometheus%25E7%259B%2591%25E6%258E%25A7clickhouse%25E6%2595%25B0%25E6%258D%25AE%25E5%25BA%2593%2f&title=%e7%bb%9f%e4%b8%80%e8%a7%82%e6%b5%8b%ef%bd%9c%e5%80%9f%e5%8a%a9Prometheus%e7%9b%91%e6%8e%a7ClickHouse%e6%95%b0%e6%8d%ae%e5%ba%93">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 统一观测｜借助Prometheus监控ClickHouse数据库 on facebook"
            href="https://facebook.com/sharer/sharer.php?u=http%3a%2f%2flocalhost%3a1313%2fposts%2fjuejin%2f%25E7%25BB%259F%25E4%25B8%2580%25E8%25A7%2582%25E6%25B5%258B%25E5%2580%259F%25E5%258A%25A9prometheus%25E7%259B%2591%25E6%258E%25A7clickhouse%25E6%2595%25B0%25E6%258D%25AE%25E5%25BA%2593%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 统一观测｜借助Prometheus监控ClickHouse数据库 on whatsapp"
            href="https://api.whatsapp.com/send?text=%e7%bb%9f%e4%b8%80%e8%a7%82%e6%b5%8b%ef%bd%9c%e5%80%9f%e5%8a%a9Prometheus%e7%9b%91%e6%8e%a7ClickHouse%e6%95%b0%e6%8d%ae%e5%ba%93%20-%20http%3a%2f%2flocalhost%3a1313%2fposts%2fjuejin%2f%25E7%25BB%259F%25E4%25B8%2580%25E8%25A7%2582%25E6%25B5%258B%25E5%2580%259F%25E5%258A%25A9prometheus%25E7%259B%2591%25E6%258E%25A7clickhouse%25E6%2595%25B0%25E6%258D%25AE%25E5%25BA%2593%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 统一观测｜借助Prometheus监控ClickHouse数据库 on telegram"
            href="https://telegram.me/share/url?text=%e7%bb%9f%e4%b8%80%e8%a7%82%e6%b5%8b%ef%bd%9c%e5%80%9f%e5%8a%a9Prometheus%e7%9b%91%e6%8e%a7ClickHouse%e6%95%b0%e6%8d%ae%e5%ba%93&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2fjuejin%2f%25E7%25BB%259F%25E4%25B8%2580%25E8%25A7%2582%25E6%25B5%258B%25E5%2580%259F%25E5%258A%25A9prometheus%25E7%259B%2591%25E6%258E%25A7clickhouse%25E6%2595%25B0%25E6%258D%25AE%25E5%25BA%2593%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 统一观测｜借助Prometheus监控ClickHouse数据库 on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=%e7%bb%9f%e4%b8%80%e8%a7%82%e6%b5%8b%ef%bd%9c%e5%80%9f%e5%8a%a9Prometheus%e7%9b%91%e6%8e%a7ClickHouse%e6%95%b0%e6%8d%ae%e5%ba%93&u=http%3a%2f%2flocalhost%3a1313%2fposts%2fjuejin%2f%25E7%25BB%259F%25E4%25B8%2580%25E8%25A7%2582%25E6%25B5%258B%25E5%2580%259F%25E5%258A%25A9prometheus%25E7%259B%2591%25E6%258E%25A7clickhouse%25E6%2595%25B0%25E6%258D%25AE%25E5%25BA%2593%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span><a href="https://beian.miit.gov.cn/">粤ICP备2023039897号-1</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = '复制';

        function copyingDone() {
            copybutton.innerHTML = '已复制！';
            setTimeout(() => {
                copybutton.innerHTML = '复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
