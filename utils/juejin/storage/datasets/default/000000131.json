{
	"title": "逮到一个爬我们网站的用户，手法拙劣到我想笑",
	"author": "程序员鱼皮",
	"publishTime": "2024-09-14",
	"readTime": "阅读4分钟",
	"tags": "[\"程序员\",\"编程语言\",\"爬虫\"]",
	"description": "借这个事情，给大家分享一下如何快速定位爬虫和攻击者的方法。像我是怎么发现网站被爬了呢？首先我们系统内部有一套识别爬虫的策略，其次我们每天都会关注网站的流量情况，有些异常情况一眼便可看出。",
	"article": "大家好，我是程序员鱼皮。昨天逮到一个爬取我们 [程序员面试刷题网站 - 面试鸭](https://link.juejin.cn?target=https%3A%2F%2Fwww.mianshiya.com%2F \"https://www.mianshiya.com/\") 的题目的用户，小伙子可能自以为很聪明，实际上手法非常拙劣！我一分钟不到就把他揪出来了。\n\n![](https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ed2309fa96248f3ac91da2b3b2de370~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&x-expires=1728092336&x-signature=%2FpyS0Pxqb0pyTO7v1rBqe85n6fg%3D)\n\n下面聊一聊我是怎么做的，也借这个事情，给大家分享一下如何快速定位爬虫和攻击者的方法。\n\n### 如何纠出攻击者？\n\n#### 发现猫腻\n\n生活中有人偷了你的东西，肯定要看监控。抓爬虫用户也是一样，先看监控。\n\n像我是怎么发现网站被爬了呢？首先我们系统内部有一套识别爬虫的策略，其次我们每天都会关注网站的流量情况，有些异常情况一眼便可看出。\n\n比如这次事件当天，我先通过系统云服务的监控看了下近 6 个小时向我们发送请求的客户端 IP，除去第一个是我们自己的 IP 外，其他几个 IP 的请求数都远超我们的业务平均值，显然这些 IP 不对劲！\n\n![](https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fee4c49244db4e60a6b566a0a86b0d5d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&x-expires=1728092336&x-signature=9pnbD9FtcOqR%2BaYLV%2BLQg7EmVqs%3D)\n\n那这些 IP 都在请求什么资源呢？通过监控查看 URL 路径访问排行，发现获取题目信息的接口被调用了 10 万多次！\n\n![](https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/892196754f844697af51462a92f77772~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&x-expires=1728092336&x-signature=XpaJY%2BNZ70roXN8987MruEy1qUo%3D)\n\n然后我就根据这个路径进行筛选，查看访问它的客户端 IP 排行，除去第一个是我们自己的 IP 外，第二个 IP 的请求数显然有问题！\n\n![](https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a799a4e0c4c84479ae29a1059f496474~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&x-expires=1728092336&x-signature=YYGjw1%2BAA%2B0WRR13kTBg0sebPqM%3D)\n\n然后根据这个 IP 进行筛选，分析他的请求情况：\n\n![](https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/534b9817952a427996f4955535a194ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&x-expires=1728092336&x-signature=VyOdyg%2BL%2FvTCnYBkrnTJq7LVln4%3D)\n\n看到这个请求图，一眼就知道是爬虫了！我反正不信有正常用户半夜连续刷题 6 个多小时，你见过凌晨四点的面试鸭么？\n\n看到这个 “纵享丝滑” 的曲线，我有点哭笑不得。虽然小伙子应该是在爬取的时候加了一些随机数导致每分钟的请求有一些细微的区别，但在监控面前，显得过于拙劣了。\n\n**识别爬虫的基本方法，就是看爬虫的特征、请求频率和模式。** 哪怕你自以为很聪明，每天只爬一点题目，只要筛选系统一段时间的访问情况、或者用系统自动分析一波访问记录，是否为正常用户还是一目了然。\n\n不过其实我有点小感动的，选择在半夜这个时间段下手，你人还怪好哩，这是不想给我们系统施加压力吧。\n\n![](https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d345a6b2882f4c88b23b08b45be10d42~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&x-expires=1728092336&x-signature=XZaJrHd6afMrwkSHixz4Y1XE1CI%3D)\n\n#### 找到真凶\n\n发现这个 IP 不对劲后，怎么知道他是我们面试鸭的哪个用户呢？\n\n当然是看日志了！开发线上系统，肯定要有 IP 访问请求的日志记录。我直接在业务服务器的日志中根据 IP 和时间段进行筛选，就看到了该用户发送的请求和参数，什么时间访问了哪道题目都很清楚：\n\n![](https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c8af0ca38f94e98b65eabd99914d4b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&x-expires=1728092336&x-signature=D95lusmdzFe4MjdmJaWHQQSYgYg%3D)\n\n这个时候，再去业务系统里看下是哪个 id 的用户在这些时间段访问了这些题目，就能查出来了。\n\n还有一种方法，他想要获取到题目信息，一定要先登录，在日志中搜索该 IP 请求 “登录接口” 或者 “获取登录用户信息接口” 的记录，查看接口的返回值，就知道是哪个用户了。\n\n![](https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8af541dbd2214d16a5e256d7895f5213~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&x-expires=1728092336&x-signature=MWfBQbvD6bVb6FkHIkiiEj2rkcQ%3D)\n\n豁，竟然还是个永久会员用户！何必呢？\n\n![](https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a367294728ab42fd8873cf7cbf84a5c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&x-expires=1728092336&x-signature=vIeFXiiJdSwLWRnYs1tLGIyFHJ0%3D)\n\n* * *\n\n通过本次事件，再给大家一些系统开发时的建议：\n\n0.  一定要做好请求的日志记录，不要嫌麻烦、不要嫌占用空间，关键时刻它是帮你定位业务异常的核心线索。\n1.  要对请求经过的每个环节（比如 CDN、网关、业务服务器）进行监控，如果没有监控，除了问题时你会毫无头绪，只能从海量日志中去大海捞针找线索。一般第三方云服务的监控都比较成熟，直接接入就好了。\n2.  要养成看监控的习惯，不是说系统挂了才要看监控，很多潜在的风险只有通过监控（或者告警）才能发现。\n3.  可以给获取重要数据的接口增加更多的信息记录，最好跟系统的某个用户关联起来，便于定位非法用户。\n\n最后，弱弱地呼吁一下，不要再爬我们的[刷题网站](https://link.juejin.cn?target=https%3A%2F%2Fwww.mianshiya.com%2F \"https://www.mianshiya.com/\")了，本来小程序和网页端就都是支持刷题的，很快我们还会上线 IDEA 摸鱼刷题插件，尽力保证大家的刷题体验！\n\n![](https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/59e655eee07047d9b332fdff287f3ef4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&x-expires=1728092336&x-signature=gtjmqDr6jav6V35Eg8veZIY7KUY%3D)\n\n### 更多\n\n💻 编程学习交流：[编程导航](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyupi%2Fcode-nav \"https://github.com/liyupi/code-nav\")  \n📃 简历快速制作：[老鱼简历](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyupi%2Flaoyujianli \"https://github.com/liyupi/laoyujianli\")  \n✏️ 面试刷题神器：[面试鸭](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyupi%2Fmianshiya \"https://github.com/liyupi/mianshiya\")"
}