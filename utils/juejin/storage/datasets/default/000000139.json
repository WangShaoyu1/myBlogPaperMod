{
	"title": "mini.vueå“åº”å¼æ¡†æ¶çš„ç®€å•å®ç°",
	"author": "å‰ç«¯æ‰‹æœ¯åˆ€",
	"publishTime": "2021-04-23",
	"readTime": "é˜…è¯»2åˆ†é’Ÿ",
	"tags": "[\"Vue.js\"]",
	"description": "è‡ªå·±æ‰‹æ’¸çš„ä¸€å¥—ç®€æ˜“çš„vueæ¡†æ¶,ç®€å•å®ç°äº†clickmodelæ–‡å­—æ¨¡æ¿ç¼–è¯‘åŠŸèƒ½.å¯ä»¥ç›´æ¥æµ‹è¯•æ¬¢è¿æŒ‡æ­£,åæœŸä¼šåŠ ä¸Šæ•™å­¦æ³¨é‡Š",
	"article": "æ›´æ–°è®°å½•\n----\n\n> 4.27 æ–°å¢ computed å±æ€§åµŒå¥—è°ƒç”¨\n\n> 4.26 æ›´æ–°äº†ç•Œé¢å¸ƒå±€ æ–°å¢åˆ©ç”¨ promise å®ç° $nextTick\n\n> 4.25 æ–°å¢äº†v-if çš„ç®€å•å®ç°\n\næ€»ä½“æ¶æ„\n----\n\n![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9cf20c20f10f4e06b4f36cff8de4b0c2~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp)\n\nå®Œæ•´ä»£ç \n----\n\n**å…ˆ copy æµ‹è¯• æ¬¢è¿çº é”™ åæ§½~ğŸ°**\n\nhtml\n\n ä»£ç è§£è¯»\n\nå¤åˆ¶ä»£ç \n\n``<!DOCTYPE html> <html lang=\"en\">   <head>     <meta charset=\"UTF-8\" />     <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\" />     <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\" />     <title>Document</title>   </head>   <body>     <style></style>     <div       id=\"app\"       style=\"width:100vw;border:1px solid red;position:relative\"     >       <h1>{{msg}}</h1>       <h2>         <h3>æˆ‘æ˜¯æ™®é€šæ¨¡æ¿ç¼–è¯‘:</h3>         <h4>æˆ‘çš„æœ€å¤§å¹´é¾„æ˜¯<span style=\"color:red\">{{age.max}}</span></h4>         <h4>æˆ‘çš„æœ€å°å¹´é¾„æ˜¯<span style=\"color:red\">{{age.min}}</span></h4>       </h2>       <h2>         <span>æˆ‘æ˜¯è®¡ç®—å±æ€§:</span>         <span style=\"color: aqua;\">{{doubleAge}}</span>       </h2>       <h2>         <span>æˆ‘æ˜¯v-ifçš„å®ç°:</span>         <span v-if=\"alive\" style=\"color:red\">æˆ‘è¿˜æ´»ç€!!!....</span>         <hr />         <span v-if=\"dead\" style=\"color:red\">æˆ‘æŒ‚äº†!!!....</span>       </h2>       <h2>         <span>æˆ‘æ˜¯clickäº‹ä»¶çš„å®ç°,ç‚¹å‡»å¯ä»¥ä¿®æ”¹æœ€å¤§å¹´é¾„ä¸º 200 å²:</span>         <button @click=\"beBiggerAge\">ä¿®æ”¹æœ€å¤§å¹´é¾„</button>       </h2>       <h2>         <span>æˆ‘æ˜¯clickäº‹ä»¶çš„å®ç°,ç‚¹å‡»å¯ä»¥ä¿®æ”¹æœ€å°å¹´é¾„ä¸º 0 å² å°±æŒ‚äº†....</span>         <button @click=\"beMinnerAge\">ä¿®æ”¹æœ€å°å¹´é¾„</button>       </h2>       <h2>         <span           >æˆ‘æ˜¯v-model çš„å®ç°,å¯ä»¥ä¿®æ”¹æœ€å°å¹´é¾„,å¦‚æœè¾“å…¥åˆ° 0 å²           æˆ‘å°±æŒ‚äº†...</span         >         <input type=\"text\" v-model=\"age.min\" />       </h2>     </div>   </body> </html> <script>   const PENDGING = 'PENDGING';   const FULFILLED = 'FULFILLED';   class Vue {     constructor(options) {       this.$options = options;       this.callbacks = [];       this.status = PENDGING;       this._init();     }     _init() {       this.$data = this.initData();       this.$methods = this.$options.methods;       this.$computed = this.$options.computed;       this.$watch = this.$options.watch;       new Observer(this.$data);       this.proxyData(this.$data);       this.proxyData(this.$methods);       this.proxyComputed(this.$computed);       this._watch();       this.$options.created.apply(this);       if (this.el) this.$options.$mount(this.el);       this.$options.mounted.apply(this);     }     //å€Ÿé‰´ promise å®ç° nextTick æš‚æ—¶æ²¡æœ‰åšé™çº§å¤„ç†     $nextTick(cb) {       this.callbacks.push(cb);       //ä¿è¯åªèƒ½æ‰§è¡Œä¸€æ¬¡å›è°ƒæ•°ç»„       if (this.status === PENDGING) {         executor.call(this);         this.status = FULFILLED;       }       const executor = () => {         Promise.resolve().then(() => {           this.status = PENDGING;           this.callbacks.forEach((cb) => cb());         });       };     }     _watch() {       Object.keys(this.$watch).forEach((key) => {         new Watcher(key, this, (newValue, oldValue) => {           this.$watch[key].call(this, newValue, oldValue);         });       });     }     //ä»£ç† computed å±æ€§     proxyComputed(proxy) {       Object.keys(proxy).forEach((key) => {         Object.defineProperty(this, key, {           get() {             return proxy[key].call(this);           },           set(newValue) {             throw new Error('computed å±æ€§ä¸å…è®¸æ”¹å˜');           },         });       });     }     //ä»£ç†this ä½¿å¾—å¯ä»¥ç›´æ¥è®¿é—® this.data this.method     proxyData(proxy) {       Object.keys(proxy).forEach((key) => {         Object.defineProperty(this, key, {           get() {             return proxy[key];           },           set(newValue) {             if (newValue !== proxy[key]) proxy[key] = newValue;           },         });       });     }     //åˆå§‹åŒ– data     initData() {       const type = typeof this.$options.data;       return type === 'function' ? this.$options.data() : this.$options.data;     }     //æŒ‚è½½ element     $mount(el) {       if (typeof el === 'string') this.$el = document.querySelector(el);       else if (el.nodeType === 1) this.$el = el;       else throw new Error('èŠ‚ç‚¹é”™è¯¯');       new Compiler(this.$el, this);     }   }   class Compiler {     constructor(el, vm) {       this.$vm = vm;       this.$el = el;       let fragment = this.vNodeFragment(el);       this.compilerFragment(fragment);       this.$el.appendChild(fragment);     }     vNodeFragment(el) {       let fragment = document.createDocumentFragment(); //åˆ›å»ºæ–‡æ¡£ç¢ç‰‡       while (el.firstChild) fragment.appendChild(el.firstChild);       return fragment;     }     compilerFragment(fragment) {       const childNodes = fragment.childNodes;       childNodes.forEach((node) => {         if (node.nodeType === 1) {           this.compileElement(node);           this.compilerFragment(node);         } else {           this.compileText(node);         }       });     }     compileText(node) {       let reg = /\\{\\{(.+?)\\}\\}/g;       let text = node.textContent;       if (reg.test(text)) {         let variable = CompilerUtils.getTextVariable(text);         const isComputed = this.$vm.$computed[variable];         //ç¼–è¾‘ computed å±æ€§         if (isComputed) {           CompilerUtils.computed(variable, node, this.$vm);           // console.log(isComputed, variable)         } else {           CompilerUtils.text(variable, node, this.$vm);         }       }     }     compileElement(node) {       const attrs = [...node.attributes];       attrs.forEach((attr) => {         const name = attr.name;         if (name.includes('v-')) {           //å¤„ç†æŒ‡ä»¤           const value = attr.value;           const [, type] = name.split('v-');           CompilerUtils[type](value, node, this.$vm);         } else if (name.includes('@')) {           //å¤„ç†äº‹ä»¶           const [, event] = name.split('@');           const method = attr.value;           // console.log(method, event, node)           CompilerUtils['addEvent'](method, event, node, this.$vm);         }       });     }   }   //è®¡ç®—å±æ€§   class ComputedWathcer {     constructor(variable, vm, cb) {       this.variable = variable;       this.vm = vm;       this.cb = cb;       this.value = this.getValue();     }     getValue() {       Dep.target = this;       let value = this.vm.$computed[this.variable].call(this.vm);       Dep.target = null;       return value;     }     update() {       let newValue = this.vm.$computed[this.variable].call(this.vm);       if (newValue !== this.value) {         this.value = newValue;         this.cb(newValue, this.value);       }     }   }   //æ¨¡æ¿ç¼–è¯‘å·¥å…·   const CompilerUtils = {     domUpdater(node, { nextNode, newNode, parentNode }, exist, fromWatch) {       if (exist) {         fromWatch && parentNode.insertBefore(newNode, nextNode);       } else {         node.remove();       }     },     //æš‚æ—¶åªå®ç°äº†è®¡ç®—å±æ€§     if(variable, node, vm) {       //æ­¤æ—¶è¿˜æ²¡æœ‰æ¨¡æ¿ç¼–è¯‘å®Œ ä¾èµ–äº parentNode æ‰€ä»¥éœ€è¦æ‰§è¡Œä¸€ä¸ªå¼‚æ­¥       setTimeout(() => {         const fn = this.domUpdater;         const nextNode = node.nextElementSibling;         const newNode = node.cloneNode(true);         const parentNode = node.parentElement;         let otherNode = { nextNode, newNode, parentNode };         let computedIns = new ComputedWathcer(variable, vm, (nv, ov) => {           fn && fn(node, otherNode, nv, true);           if (nv) node = otherNode.newNode; //éœ€è¦æ‰‹åŠ¨æ›´æ–° node         });         fn && fn(node, otherNode, computedIns.value);       });     },     addEvent(method, event, node, vm) {       node.addEventListener(event, (...args) => {         vm[method].apply(vm, args);       });     },     textUpdater(node, value) {       node.textContent = value;     },     computed(variable, node, vm) {       let fn = this.textUpdater;       let computedIns = new ComputedWathcer(variable, vm, (nv, ov) => {         fn && fn(node, nv);       });       fn && fn(node, computedIns.value);     },     text(variable, node, vm) {       let fn = this.textUpdater;       let value = this.getValue(variable, vm);       new Watcher(variable, vm, (newValue) => {         fn && fn(node, newValue);       });       fn && fn(node, value);     },     getTextVariable(variable) {       let reg = /\\{\\{(.+?)\\}\\}/g;       let res = variable.replace(reg, ($0, $1) => $1);       return res;     },     getValue(variable, vm) {       return variable.split('.').reduce((prev, next) => {         return prev[next];       }, vm.$data);     },     setValue(variable, vm, newValue) {       const keys = variable.split('.');       const len = keys.length;       keys.reduce((prev, next, index) => {         if (index === len - 1) prev[next] = newValue;         return prev[next];       }, vm.$data);     },     inputUpdater(node, value) {       node.value = value;     },     model(variable, node, vm) {       const value = this.getValue(variable, vm);       const fn = this.inputUpdater;       fn && fn(node, value);       node.addEventListener('input', (event) => {         const newValue = event.target.value;         if (newValue !== value) this.setValue(variable, vm, newValue);       });       new Watcher(variable, vm, (newValue) => {         fn && fn(node, newValue);       });     },   };   //åŠ«æŒæ•°æ® åŒå‘ç»‘å®š   class Observer {     constructor(data) {       this.observe(data);     }     observe(data) {       if (!data || typeof data !== 'object') return;       Object.keys(data).forEach((key) => {         this.defineReactive(key, data[key], data);         if (typeof data[key] === 'object') this.observe(data[key]);       });     }     defineReactive(key, value, data) {       let dep = new Dep();       let _this = this;       Object.defineProperty(data, key, {         get() {           Dep.target && dep.addSub(Dep.target);           return value;         },         set(newValue) {           if (newValue !== value) {             value = newValue;             _this.observe(newValue);             dep.notify();           }         },       });     }   }   class Dep {     constructor() {       this.subs = [];     }     addSub(wathcer) {       this.subs.push(wathcer);     }     notify() {       this.subs.forEach((w) => w.update());     }   }   class Watcher {     constructor(variable, vm, cb) {       this.variable = variable;       this.vm = vm;       this.cb = cb;       this.value = this.get();     }     get() {       Dep.target = this;       const value = CompilerUtils.getValue(this.variable, this.vm);       Dep.target = null;       return value;     }     update() {       let newValue = CompilerUtils.getValue(this.variable, this.vm);       let oldValue = this.value;       if (newValue !== oldValue) {         this.value = newValue;         this.cb(newValue, oldValue);       }     }   }   new Vue({     data() {       return {         msg: 'ç¬¬ä¸€æ¬¡æµ‹è¯•',         name: 'mike',         age: {           max: 100,           min: 10,         },       };     },     watch: {       msg(newV, oldV) {         console.log(newV, oldV);       },     },     computed: {       dead() {         return !this.alive;       },       alive() {         return +this.age.min > 0;       },       doubleAge() {         return `ä½ å¥½æˆ‘æ˜¯mike,å…·å¤‡åŒå€å¹´é¾„, ä»Šå¹´${this.age.max * 2}å²ã€‚`;       },     },     methods: {       beMinnerAge() {         this.age.min = 0;       },       beBiggerAge() {         this.age.max = 200;       },     },     created() {       this.msg = 'created å·²åˆ›å»º';       console.log('created');     },     mounted() {       console.log('mounted');     },   }).$mount('#app'); </script>``\n\næ•ˆæœå›¾\n---\n\n![vue.gif](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4e405b10c8454073912b73c6e1dd754a~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp)"
}