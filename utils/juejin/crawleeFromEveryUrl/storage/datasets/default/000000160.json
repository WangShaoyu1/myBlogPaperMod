{
	"title": "ã€ŒVueæºç å­¦ä¹ (å››)ã€ç«‹å¿—å†™ä¸€ç¯‡äººäººéƒ½çœ‹çš„æ‡‚çš„computedï¼ŒwatchåŸç†",
	"author": "Sunshine_Lin",
	"publishTime": "2021-06-16",
	"readTime": "é˜…è¯»8åˆ†é’Ÿ",
	"tags": "[\"Vue.js\",\"å‰ç«¯ä¸­æ–‡æŠ€æœ¯ç¤¾åŒº\",\"å‰ç«¯å¼€å‘ç¤¾åŒº\",\"å‰ç«¯æŠ€æœ¯äº¤æµ\",\"å‰ç«¯æ¡†æ¶æ•™ç¨‹\",\"JavaScript å­¦ä¹ èµ„æº\",\"CSS æŠ€å·§ä¸æœ€ä½³å®è·µ\",\"HTML5 æœ€æ–°åŠ¨æ€\",\"å‰ç«¯å·¥ç¨‹å¸ˆèŒä¸šå‘å±•\",\"å¼€æºå‰ç«¯é¡¹ç›®\",\"å‰ç«¯æŠ€æœ¯è¶‹åŠ¿\"]",
	"description": "å‰è¨€ æœ‹å‹ä»¬å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯æ—ä¸‰å¿ƒï¼Œè¿˜æ˜¯é‚£å¥è¯ï¼šæ”¹å˜ä¸äº†ï¼Œé‚£å°±é€‚åº”å®ƒï¼Œæºç çš„ç†è§£åœ¨å½“ä»Šå‰ç«¯å¸‚åœºè¶Šæ¥è¶Šé‡è¦äº†ï¼Œç†è§£æºç ï¼Œå¯ä»¥ä½¿æˆ‘ä»¬åœ¨å¼€å‘ä¸­æ›´å¿«åœ°æ•æ‰åˆ°é—®é¢˜æ‰€åœ¨ï¼Œä»Šå¤©è®²åˆ°computedï¼Œwatchçš„åŸç†ï¼Œä¸ª",
	"article": "å‰è¨€\n--\n\næœ‹å‹ä»¬å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯æ—ä¸‰å¿ƒï¼Œè¿˜æ˜¯é‚£å¥è¯ï¼š`æ”¹å˜ä¸äº†ï¼Œé‚£å°±é€‚åº”å®ƒ`ï¼Œæºç çš„ç†è§£åœ¨å½“ä»Šå‰ç«¯å¸‚åœºè¶Šæ¥è¶Šé‡è¦äº†ï¼Œç†è§£æºç ï¼Œå¯ä»¥ä½¿æˆ‘ä»¬åœ¨å¼€å‘ä¸­æ›´å¿«åœ°æ•æ‰åˆ°é—®é¢˜æ‰€åœ¨ï¼Œä»Šå¤©è®²åˆ°`computedï¼Œwatchçš„åŸç†`ï¼Œä¸ªäººå»ºè®®æœ‹å‹ä»¬å…ˆçœ‹è¿™ä¸ªç³»åˆ—çš„å‰å‡ ç¯‡æ–‡ç« ï¼Œæˆ–è®¸èƒ½æ›´å¥½åœ°ç†è§£æœ¬ç« å†…å®¹ï¼Œå½“ç„¶ï¼Œæˆ‘ä¼šå°½æˆ‘æ‰€èƒ½è®©å¤§å®¶èƒ½æ›´å¥½åœ°ç†è§£`computedï¼ŒwatchåŸç†`ï¼Œæˆ‘å°½é‡è®²çš„é€šä¿—æ˜“æ‡‚ä¸€äº›ã€‚ä½ ä»¬ä¸è¦å«Œæˆ‘å•°å—¦å“¦ã€‚  \nğŸ˜‚ğŸ˜‚ğŸ˜‚  \n`ã€ŒVueæºç å­¦ä¹ ã€`æ–‡ç« ï¼š\n\n*   [ã€ŒVueæºç å­¦ä¹ (ä¸€)ã€ä½ ä¸çŸ¥é“çš„-æ•°æ®å“åº”å¼åŸç†](https://juejin.cn/post/6968732684247892005 \"https://juejin.cn/post/6968732684247892005\")\n*   [ã€ŒVueæºç å­¦ä¹ (äºŒ)ã€ä½ ä¸çŸ¥é“çš„-æ¨¡æ¿ç¼–è¯‘åŸç†](https://juejin.cn/post/6969563640416436232 \"https://juejin.cn/post/6969563640416436232\")\n*   [ã€ŒVueæºç å­¦ä¹ (ä¸‰)ã€ä½ ä¸çŸ¥é“çš„-åˆæ¬¡æ¸²æŸ“åŸç†](https://juejin.cn/post/6970209585671979044 \"https://juejin.cn/post/6970209585671979044\")\n*   [ã€ŒVueæºç å­¦ä¹ (å››)ã€ç«‹å¿—å†™ä¸€ç¯‡äººäººéƒ½çœ‹çš„æ‡‚çš„computedï¼ŒwatchåŸç†](https://juejin.cn/post/6970209585671979044 \"https://juejin.cn/post/6970209585671979044\")\n*   [ã€ŒVueæºç å­¦ä¹ (äº”)ã€é¢è¯•å®˜å–œæ¬¢é—®çš„â€”â€”Vueå¸¸ç”¨æ–¹æ³•æºç è§£æ](https://juejin.cn/post/6970209585671979044 \"https://juejin.cn/post/6970209585671979044\") æˆ–è€…å¯¹æˆ‘çš„å…¶ä»–`vueæºç æ–‡ç« `æ„Ÿå…´è¶£çš„å¯ä»¥çœ‹æˆ‘çš„è¿™äº›æ–‡ç« ï¼š\n*   [ä¸€å‘¨ä¸€ä¸ªVueå°çŸ¥è¯†ï¼šä½ æƒ³çŸ¥é“Vuexçš„å®ç°åŸç†å—ï¼Ÿ](https://juejin.cn/post/6952473110377414686 \"https://juejin.cn/post/6952473110377414686\")\n*   [ä¸€å‘¨ä¸€ä¸ªVueå°çŸ¥è¯†ï¼šä½ çœŸçš„çŸ¥é“æ’æ§½Slotæ˜¯æ€ä¹ˆâ€œæ’â€çš„å—](https://juejin.cn/post/6949848530781470733 \"https://juejin.cn/post/6949848530781470733\")\n\né¢„è®¡å®ç°æ•ˆæœ\n------\n\n![20210615_220340.gif](/images/jueJin/f86711bcd2b3493.png)\n\nçŸ¥è¯†å‰æ\n----\n\néœ€è¦æ‡‚åŸºæœ¬çš„npmå‘½ä»¤ï¼ŒES6è¯­æ³•ï¼Œä»¥åŠwebpackåŸºæœ¬æ‰“åŒ…\n\nå‡†å¤‡å·¥ä½œ\n----\n\n### 1.åˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¤¹\n\n```js\nnpm init\n\nnpm i @babel/core @babel/preset-env babel-loader clean-webpack-plugin html-webpack-plugin webpack webpack-cli webpack-dev-server -D\n```\n\n### 2.åˆ›å»º`webpack.config.js`æ–‡ä»¶\n\n> ç›®çš„ï¼šé…ç½®çƒ­æ›´æ–°æ‰“åŒ…\n\n```js\n// webpack.config.js\n\nconst path = require('path')\n// å¼•å…¥html-webpack-pluginæ’ä»¶\nconst HtmlWebpackPlugin = require('html-webpack-plugin');\n// å¼•å…¥clean-webpack-plugin\nconst { CleanWebpackPlugin } = require('clean-webpack-plugin');\n// å¼•å…¥webpackæ’ä»¶\nconst webpack = require('webpack');\n    module.exports = {\n    mode: 'development',\n    devtool: 'eval',\n        devServer: {\n        contentBase: './dist',\n        open: true,\n        hot: true\n        },\n        entry: './src/index.js',\n            output: {\n            filename: 'bundle.js',\n            path: path.resolve(__dirname, '../dist')\n            },\n                module: {\n                    rules: [\n                        {\n                        test: /\\.js$/,\n                        loader: 'babel-loader',\n                        exclude: /node_modules/\n                        },\n                    ]\n                    },\n                        plugins: [\n                        new HtmlWebpackPlugin({ // å¾€disté‡Œå¡htmlå¹¶ä¸”æŠŠbundleæè¿›å»\n                        template: './src/index.html'\n                        }),\n                        new CleanWebpackPlugin(), // æ‰§è¡Œæ—¶é—´ï¼Œåœ¨æ‰“åŒ…ä¹‹å‰æ‰§è¡Œ,æ”¹å˜è¾“å‡ºæ–‡ä»¶åï¼Œä¸‹ä¸€æ¬¡æ‰“åŒ…å¯ä»¥æ¸…é™¤è€æ–‡ä»¶\n                        new webpack.HotModuleReplacementPlugin() // æ›´æ–°åä¸ä¼šåˆ·æ–°ï¼Œä¿ç•™ååŠ çš„æ•°æ®\n                    ]\n                }\n```\n\n### 3.packageå‘½ä»¤è¡Œä¿®æ”¹\n\n```js\n    \"scripts\": {\n    \"dev\": \"webpack-dev-server --config ./webpack.config.js\"\n    },\n```\n\n### 4.åˆ›å»º`.babelrc`æ–‡ä»¶\n\n```js\n// .babelrc\n\n    {\n\"presets\":[\"@babel/preset-env\"]\n}\n```\n\n### 5.åˆ›å»ºsrcæ–‡ä»¶å¤¹\n\n> ç›®çš„ï¼šå­˜æ”¾æœ¬ç« åŸç†ä»£ç \n\n### 6.æœ€ç»ˆç›®å½•\n\n![image.png](/images/jueJin/768f6e3ad98f409.png)\n\n### 7.Vueå®ä¾‹\n\n```js\n// src/index.html\n\n<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n<meta charset=\"UTF-8\">\n<meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\">\n<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n<title>æ—ä¸‰å¿ƒVueæºç </title>\n</head>\n\n<body>\n<div id=\"root\"></div>\n</body>\n</html>\n``````js\n// src/index.js\n\nimport Vue from './init.js'\n\nconst root = document.querySelector('#root')\n    var vue = new Vue({\n        data() {\n            return {\n            name: 'æ—ä¸‰å¿ƒ',\n            age: 18\n        }\n        },\n            render() {\n            root.innerHTML = `${this.name}ä»Šå¹´${this.age}å²äº†\n        }\n        })\n        \n        \n```\n\n### 8\\. å¦‚ä½•è°ƒè¯•\n\n```js\nnpm run dev\nç„¶åå°†index.htmlåœ¨è°·æ­Œæµè§ˆå™¨é‡Œæ‰“å¼€ï¼ˆlive serverï¼‰\n```\n\nWatcheræ˜¯ä»€ä¹ˆï¼ŸWatcherçš„ç§ç±»æœ‰å“ªäº›ï¼Ÿ\n-------------------------\n\n> å¤§å®¶è¦æ³¨æ„ï¼Œè¿™é‡Œè¯´çš„æ˜¯`Watcher`ï¼Œè¦è·Ÿvueé‡Œä½¿ç”¨çš„`watch`å±æ€§åŒºåˆ†ä¸€ä¸‹å“¦\n\n### 1.ä»€ä¹ˆæ˜¯Watcherå‘¢ï¼Ÿ\n\n> ä¸¾ä¸ªä¾‹å­ï¼Œè¯·çœ‹ä¸‹é¢ä»£ç ï¼š\n\n```js\n// ä¾‹å­ä»£ç ï¼Œä¸æœ¬ç« ä»£ç æ— å…³\n\n<div>{{name}}</div>\n\n    data() {\n        return {\n        name: 'æ—ä¸‰å¿ƒ'\n    }\n    },\n        computed: {\n            info () {\n            return this.name\n        }\n        },\n            watch: {\n                name(newVal) {\n                console.log(newVal)\n            }\n        }\n```\n\nä¸Šæ–¹ä»£ç å¯çŸ¥ï¼Œ`name`å˜é‡è¢«ä¸‰å¤„åœ°æ–¹æ‰€ä¾èµ–ï¼Œåˆ†åˆ«æ˜¯`htmlé‡Œï¼Œcomputedé‡Œï¼Œwatché‡Œ`ã€‚åªè¦`name`ä¸€æ”¹å˜ï¼Œhtmlé‡Œå°±ä¼šé‡æ–°æ¸²æŸ“ï¼Œcomputedé‡Œå°±ä¼šé‡æ–°è®¡ç®—ï¼Œwatché‡Œå°±ä¼šé‡æ–°æ‰§è¡Œã€‚é‚£ä¹ˆæ˜¯è°å»é€šçŸ¥è¿™ä¸‰ä¸ªåœ°æ–¹`name`ä¿®æ”¹äº†å‘¢ï¼Ÿé‚£å°±æ˜¯`Watcher`äº†\n\n### 2.Watcherçš„ç§ç±»æœ‰å“ªäº›å‘¢ï¼Ÿ\n\nä¸Šé¢æ‰€è¯´çš„ä¸‰å¤„åœ°æ–¹å°±åˆšåˆšå¥½ä»£è¡¨äº†ä¸‰ç§`Watcher`ï¼Œåˆ†åˆ«æ˜¯ï¼š\n\n*   `æ¸²æŸ“Watcher`ï¼šå˜é‡ä¿®æ”¹æ—¶ï¼Œè´Ÿè´£é€šçŸ¥HTMLé‡Œçš„é‡æ–°æ¸²æŸ“\n*   `computed Watcher`ï¼šå˜é‡ä¿®æ”¹æ—¶ï¼Œè´Ÿè´£é€šçŸ¥computedé‡Œä¾èµ–æ­¤å˜é‡çš„computedå±æ€§å˜é‡çš„ä¿®æ”¹\n*   `user Watcher`ï¼šå˜é‡ä¿®æ”¹æ—¶ï¼Œè´Ÿè´£é€šçŸ¥watchå±æ€§é‡Œæ‰€å¯¹åº”çš„å˜é‡å‡½æ•°çš„æ‰§è¡Œ\n\nå®ç°æ•°æ®å“åº”å¼\n-------\n\n> ä»»ä½•ç±»å‹çš„`Watcher`éƒ½æ˜¯åŸºäº`æ•°æ®å“åº”å¼`çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè¦æƒ³å®ç°`Watcher`ï¼Œå°±éœ€è¦å…ˆå®ç°`æ•°æ®å“åº”å¼`ï¼Œè€Œ`æ•°æ®å“åº”å¼`çš„åŸç†å°±æ˜¯é€šè¿‡`Object.defineProperty`å»åŠ«æŒå˜é‡çš„`get`å’Œ`set`å±æ€§\n\n> è¿™é‡Œçš„å“åº”å¼åªåšäº†ç®€å•çš„å“åº”å¼å¤„ç†ï¼Œå¦‚æœæƒ³çœ‹è¯¦ç»†çš„ï¼Œè¯·ç§»æ­¥[ã€ŒVueæºç å­¦ä¹ (ä¸€)ã€ä½ ä¸çŸ¥é“çš„-æ•°æ®å“åº”å¼åŸç†](https://juejin.cn/post/6968732684247892005 \"https://juejin.cn/post/6968732684247892005\")ï¼Œä¹Ÿå°±æ˜¯æ­¤ç³»åˆ—çš„ç¬¬ä¸€ç¯‡ã€‚\n\n### 1.åˆå§‹åŒ–Vue\n\n```js\n// src/init.js\n\nimport initState from './initState.js'\nimport initComputed from './initComputed.js'\nimport initWatch from './initWatch'\nimport Watcher from './Watcher.js'\n\n    export default function Vue(options) {\n    \n    // åˆå§‹åŒ–å‡½æ•°\n    this._init(options)\n}\n\n    Vue.prototype._init = function (options) {\n    const vm = this\n    vm.$options = options\n        if (options.data) {\n        // åˆå§‹åŒ–æ•°æ®\n        initState(vm)\n    }\n}\n```\n\n### 2.ä»€ä¹ˆæ˜¯Depï¼Ÿ\n\nDepæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿä¸¾ä¸ªä¾‹å­ï¼Œè¿˜æ˜¯ä¹‹å‰çš„ä¾‹å­ä»£ç ï¼š\n\n```js\n// ä¾‹å­ä»£ç ï¼Œä¸æœ¬ç« ä»£ç æ— å…³\n\n<div>{{name}}</div>\n\n    data() {\n        return {\n        name: 'æ—ä¸‰å¿ƒ'\n    }\n    },\n        computed: {\n            info () {\n            return this.name\n        }\n        },\n            watch: {\n                name(newVal) {\n                console.log(newVal)\n            }\n        }\n```\n\nè¿™é‡Œ`name`å˜é‡è¢«ä¸‰ä¸ªåœ°æ–¹æ‰€ä¾èµ–ï¼Œä¸‰ä¸ªåœ°æ–¹ä»£è¡¨äº†ä¸‰ç§`Watcher`ï¼Œé‚£ä¹ˆ`name`ä¼šç›´æ¥è‡ªå·±ç®¡è¿™ä¸‰ä¸ª`Watcher`å—ï¼Ÿç­”æ¡ˆæ˜¯ä¸ä¼šçš„ï¼Œ`name`ä¼šå®ä¾‹ä¸€ä¸ªDepï¼Œæ¥å¸®è‡ªå·±ç®¡è¿™å‡ ä¸ª`Wacther`ï¼Œç±»ä¼¼äºç®¡å®¶ï¼Œå½“`name`æ›´æ”¹çš„æ—¶å€™ï¼Œä¼šé€šçŸ¥depï¼Œè€Œdepåˆ™ä¼šå¸¦ç€ä¸»äººçš„å‘½ä»¤å»é€šçŸ¥è¿™äº›`Wacther`å»å®Œæˆè‡ªå·±è¯¥åšçš„äº‹\n\n### 3.å“åº”å¼å®ç°\n\n```js\n// src/initState.js\n\nimport { Dep } from \"./Dep\"\n\n    export default function initState(vm) {\n    let data = vm.$options.data\n    \n    // dataä¸ºå‡½æ•°åˆ™æ‰§è¡Œ\n    // å»ºè®®dataä¸ºå‡½æ•°ï¼Œé˜²æ­¢å˜é‡äº’ç›¸æ±¡æŸ“\ndata = vm._data = typeof data === 'function' ? data.call(vm, vm) : data || {}\n\nconst keys = Object.keys(data)\n\nlet i = keys.length\n    while (i--) {\n    // å˜é‡ä»£ç†\n    // è¿™æ ·åšçš„å¥½å¤„å°±æ˜¯æ“ä½œdataé‡Œçš„å˜é‡æ—¶ï¼Œåªéœ€è¦this.xxxè€Œä¸ç”¨this.data.xxx\n    proxy(vm, '_data', keys[i])\n}\nobserve(data)\n}\n\n    class Observer {\n        constructor(value) {\n        this.walk(value)\n    }\n    \n        walk(data) {\n        let keys = Object.keys(data)\n        // éå†dataçš„keyï¼Œå¹¶è¿›è¡Œå“åº”å¼åˆ¤æ–­å¤„ç†\n            for (let i = 0; i < keys.length; i++) {\n            defineReactive(data, keys[i], data[keys[i]])\n        }\n    }\n}\n\n    function defineReactive(data, key, value) {\n    // æ¯ä¸ªå¯¹è±¡éƒ½æœ‰è‡ªå·±dep\n    const dep = new Dep()\n        Object.defineProperty(data, key, {\n            get() {\n                if (Dep.target) {\n                // å¦‚æœDep.targetæŒ‡å‘æŸä¸ªWatcherï¼Œåˆ™æŠŠæ­¤Watcheræ”¶å…¥æ­¤depçš„é˜Ÿåˆ—é‡Œ\n                dep.depend()\n            }\n            return value\n            },\n                set(newVal) {\n                // è®¾ç½®å€¼æ—¶ï¼Œå¦‚æœç›¸ç­‰åˆ™è¿”å›\n                if (newVal === value) return\n                value = newVal\n                // æ–°è®¾ç½®çš„å€¼ä¹Ÿéœ€è¦å“åº”å¼åˆ¤æ–­å¤„ç†\n                observe(newVal)\n                \n                // é€šçŸ¥depé‡Œçš„æ‰€æœ‰Wactherè¿›è¡Œä¼ è¾¾æ›´æ–°\n                dep.notify()\n            }\n            })\n            \n            // é€’å½’ï¼Œå› ä¸ºå¯èƒ½å¯¹è±¡é‡Œæœ‰å¯¹è±¡\n            observe(value)\n        }\n        \n            function observe(data) {\n            // åªæœ‰å½“dataä¸ºæ•°ç»„æˆ–è€…å¯¹è±¡æ—¶æ‰è¿›è¡Œå“åº”å¼å¤„ç†\n                if (typeof data === 'object' && data !== null) {\n                return new Observer(data)\n            }\n        }\n        \n        // ä»£ç†å‡½æ•°\n            function proxy(vm, source, key) {\n                Object.defineProperty(vm, key, {\n                    get() {\n                return vm[source][key]\n                },\n                    set(newVal) {\n                    return vm[source][key] = newVal\n                }\n                })\n            }\n``````js\n// src/Dep.js\nlet dId = 0\n\n    export class Dep {\n        constructor() {\n        // æ¯ä¸ªdepçš„idéƒ½æ˜¯ç‹¬ä¸€æ— äºŒçš„\n        this.id = dId++\n        // ç”¨æ¥å­˜å‚¨Watcherçš„æ•°ç»„\n    this.subs = []\n}\n\n    depend() {\n        if (Dep.target) {\n        // æ­¤æ—¶Dep.targetæŒ‡å‘çš„æ˜¯æŸä¸ªWactherï¼ŒWactherä¹Ÿè¦æŠŠæ­¤depç»™æ”¶é›†èµ·æ¥\n        Dep.target.addDep(this)\n    }\n}\n\n    notify() {\n    // é€šçŸ¥subsé‡Œçš„æ¯ä¸ªWactheréƒ½å»é€šçŸ¥æ›´æ–°\n    const tempSubs = this.subs.slice()\n    tempSubs.reverse().forEach(watcher => watcher.update())\n}\n\n    addSub(watcher) {\n    // å°†Watcheræ”¶è¿›subsé‡Œ\n    this.subs.push(watcher)\n}\n}\n\nlet stack = []\n    export function pushTarget(watcher) {\n    // æ”¹å˜targetçš„æŒ‡å‘\n    Dep.target = watcher\n    stack.push(watcher)\n}\n\n    export function popTarget() {\n    stack.pop()\nDep.target = stack[stack.length - 1]\n}\n\n```\n\n### 4.Watcherä¸ºä½•ä¹Ÿè¦åè¿‡æ¥æ”¶é›†Depï¼Ÿ\n\nä¸Šé¢è¯´åˆ°äº†ï¼Œdepæ˜¯`name`çš„ç®¡å®¶ï¼Œä»–çš„èŒè´£æ˜¯ï¼š`name`æ›´æ–°æ—¶ï¼Œdepä¼šå¸¦ç€ä¸»äººçš„å‘½ä»¤å»é€šçŸ¥subsé‡Œçš„`Watcher`å»åšè¯¥åšçš„äº‹ï¼Œé‚£ä¹ˆï¼Œdepæ”¶é›†`Watcher`å¾ˆåˆç†ã€‚é‚£ä¸ºä»€ä¹ˆwatcherä¹Ÿéœ€è¦åè¿‡æ¥æ”¶é›†depå‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºcomputedå±æ€§é‡Œçš„å˜é‡æ²¡æœ‰è‡ªå·±çš„depï¼Œä¹Ÿå°±æ˜¯ä»–æ²¡æœ‰è‡ªå·±çš„ç®¡å®¶ï¼Œçœ‹ä»¥ä¸‹ä¾‹å­ï¼š\n\n> è¿™é‡Œå…ˆè¯´ä¸€ä¸ªçŸ¥è¯†ç‚¹ï¼šå¦‚æœhtmlé‡Œä¸ä¾èµ–`name`è¿™ä¸ªå˜é‡ï¼Œé‚£ä¹ˆæ— è®º`name`å†æ€ä¹ˆå˜ï¼Œä»–éƒ½`ä¸ä¼šä¸»åŠ¨`å»åˆ·æ–°è§†å›¾ï¼Œå› ä¸ºhtmlæ²¡å¼•ç”¨ä»–ï¼ˆè¯´ä¸“ä¸šç‚¹å°±æ˜¯ï¼š`name`çš„`dep`é‡Œæ²¡æœ‰`æ¸²æŸ“Watcher`ï¼‰ï¼Œæ³¨æ„ï¼Œè¿™é‡Œè¯´çš„æ˜¯`ä¸ä¼šä¸»åŠ¨`ï¼Œä½†è¿™å¹¶ä¸ä»£è¡¨ä»–ä¸ä¼š`è¢«åŠ¨`å»æ›´æ–°ã€‚ä»€ä¹ˆæƒ…å†µä¸‹ä»–ä¼šè¢«åŠ¨å»æ›´æ–°å‘¢ï¼Ÿé‚£å°±æ˜¯computedæœ‰ä¾èµ–ä»–çš„å±æ€§å˜é‡ã€‚\n\n```js\n// ä¾‹å­ä»£ç ï¼Œä¸æœ¬ç« ä»£ç æ— å…³\n\n<div>{{person}}</div>\n\n    computed: {\n        person {\n        return `åç§°ï¼š${this.name}`\n    }\n}\n```\n\nè¿™é‡Œçš„`person`äº‹ä¾èµ–äº`name`çš„ï¼Œä½†æ˜¯`person`æ˜¯æ²¡æœ‰è‡ªå·±çš„`dep`çš„ï¼ˆå› ä¸ºä»–æ˜¯computedå±æ€§å˜é‡ï¼‰ï¼Œè€Œ`name`æ˜¯æœ‰çš„ã€‚å¥½äº†ï¼Œç»§ç»­çœ‹ï¼Œè¯·æ³¨æ„ï¼Œæ­¤ä¾‹å­htmlé‡Œåªæœ‰`person`çš„å¼•ç”¨æ²¡æœ‰`name`çš„å¼•ç”¨ï¼Œæ‰€ä»¥`name`ä¸€æ”¹å˜ï¼ŒæŒ‰ç†è¯´è™½ç„¶`person`è·Ÿç€å˜äº†ï¼Œä½†æ˜¯htmlä¸ä¼šé‡æ–°æ¸²æŸ“ï¼Œå› ä¸º`name`è™½ç„¶æœ‰`dep`ï¼Œæœ‰æ›´æ–°è§†å›¾çš„èƒ½åŠ›ï¼Œä½†æ˜¯å¥ˆä½•äººå®¶htmlä¸å¼•ç”¨ä»–å•Šï¼`person`æƒ³è¦è‡ªå·±å»æ›´æ–°è§†å›¾ï¼Œä½†ä»–å´æ²¡è¿™ä¸ªèƒ½åŠ›å•Šï¼Œæ¯•ç«Ÿä»–æ²¡æœ‰`dep`è¿™ä¸ªç®¡å®¶ï¼è¿™ä¸ªæ—¶å€™`computed Watcher`é‡Œæ”¶é›†çš„`name`çš„`dep`å°±æ´¾ä¸Šç”¨åœºäº†ï¼Œå¯ä»¥å€ŸåŠ©è¿™äº›`dep`å»æ›´æ–°è§†å›¾ï¼Œè¾¾åˆ°æ›´æ–°htmlé‡Œçš„`person`çš„æ•ˆæœã€‚å…·ä½“ä¼šåœ¨ä¸‹é¢computedé‡Œå®ç°ã€‚\n\n### 5.é€»è¾‘æœ‰ç‚¹ç»•\n\nè¿™é‡Œé€»è¾‘ç¡®å®æœ‰ç‚¹ç»•ï¼Œå› ä¸ºdepå’Œwatcheräº’ç›¸é‡‡é›†ï¼Œå¤§å®¶åœ¨è°ƒè¯•è¿‡ç¨‹ä¸­å¯ä»¥è‡ªå·±`console.log`ä¸€ä¸‹`dep`çš„`subs`çœ‹çœ‹ï¼Œè¿™æ ·ä¼šæ›´èƒ½çœ‹æ¸…é€»è¾‘ã€‚è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œ`dep`æ”¶é›†`watcher`ï¼Œè€Œ`watcher`ä¹Ÿä¼šåè¿‡æ¥æ”¶é›†`dep`ã€‚ æ­¤æ—¶è¾“å‡ºäº†ä¸¤ä¸ª`dep`ï¼Œå› ä¸ºæœ‰`name`å’Œ`age`ï¼Œä¸€ä¸ªå˜é‡æœ‰ä¸€ä¸ª`dep`æ‰€ä»¥æ€»å…±ä¸¤ä¸ª`dep`ï¼Œç”±äºè¿™ä¸¤ä¸ªå˜é‡éƒ½è¢«htmlæ‰€ä¾èµ–ï¼Œæ‰€ä»¥æ¯ä¸ª`dep`çš„`subs`é‡Œéƒ½æ”¶é›†äº†`æ¸²æŸ“Watcher`ï¼Œåè¿‡æ¥ï¼Œ`æ¸²æŸ“Watcher`ä¹Ÿè¦æ”¶é›†è¿™ä¸¤ä¸ª`dep`ï¼Œå¦‚å›¾ï¼š\n\n![image.png](/images/jueJin/b3dcb9dbfcb64b0.png)\n\nå®ç°Watcher\n---------\n\n```js\n// src/Watcher.js\n\nlet wid = 0\n    class Watcher {\n        constructor(vm, exprOrFn, cb, options) {\n        this.vm = vm // æŠŠvmæŒ‚è½½åˆ°å½“å‰çš„thisä¸Š\n            if (typeof exprOrFn === 'function') {\n            this.getter = exprOrFn // æŠŠexprOrFnæŒ‚è½½åˆ°å½“å‰çš„thisä¸Šï¼Œè¿™é‡ŒexprOrFn ç­‰äº vm.$options.render\n        }\n        this.cb = cb // æŠŠcbæŒ‚è½½åˆ°å½“å‰çš„thisä¸Š\n        this.options = options // æŠŠoptionsæŒ‚è½½åˆ°å½“å‰çš„thisä¸Š\n        this.id = wid++\n        this.value = this.get() // ç›¸å½“äºè¿è¡Œ vm.$options.render()\n    }\n        get() {\n        const vm = this.vm\n        let value = this.getter.call(vm, vm) // æŠŠthis æŒ‡å‘åˆ°vm\n        return value\n    }\n}\n```\n\né¦–æ¬¡æ¸²æŸ“ï¼ˆæ¸²æŸ“Watcherï¼‰\n---------------\n\nä¸Šé¢è¯´è¿‡ï¼Œåªè¦æŠŠ`render`å‡½æ•°ä¼ è¿›`Wacther`ï¼Œé‚£ä¹ˆæ­¤`Watcher`ä¸º`æ¸²æŸ“Watcher`ï¼Œ`æ¸²æŸ“Watcher`çš„ä½œç”¨æ˜¯ï¼šé¦–æ¬¡æ¸²æŸ“ï¼Œå¹¶ä¸”HTMLæ¨¡æ¿æ‰€ä¾èµ–çš„å˜é‡æ”¹å˜æ—¶ä¹Ÿä¼šé‡æ–°æ¸²æŸ“ã€‚\n\n```js\n    export default function Vue(options) {\n    \n    // åˆå§‹åŒ–å‡½æ•°\n    this._init(options)\n    \n    // æ¸²æŸ“å‡½æ•°\n    this.$mount()\n}\n\n    Vue.prototype.$mount = function() {\n    const vm = this\n    // åˆ›å»ºæ¸²æŸ“Watcher\n    // è¿™é‡Œç¬¬äºŒä¸ªå‚æ•°ä¼ renderå‡½æ•°è¿›å»ï¼Œåˆ™æ­¤Watcherä¸ºæ¸²æŸ“Watcher\n    // å› ä¸ºåœ¨æ­¤ä¾‹å­é‡Œrenderä¸ºæ¸²æŸ“domçš„å‡½æ•°\n    new Watcher(vm, vm.$options.render, () => {}, true)\n}\n```\n\næ­¤æ—¶åœ¨ç»ˆç«¯é‡Œè¿è¡Œ`npm run dev`ï¼Œå¹¶`live server`æ‰“å¼€index.htmlæ–‡ä»¶ï¼Œçœ‹åˆ°ä»¥ä¸‹æ•ˆæœï¼Œåˆ™è¯æ˜é¦–æ¬¡æ¸²æŸ“æˆåŠŸï¼š\n\n![image.png](/images/jueJin/af1654bce4324e2.png)\n\næ›´æ–°æ•°æ®\n----\n\nç°åœ¨çš„æ•°æ®æ˜¯æ­»çš„ï¼Œé‚£æˆ‘ä»¬å¦‚ä½•æ”¹å˜å‘¢ï¼Ÿ\n\n```js\n// src/index.html\n<body>\n<div id=\"root\"></div>\n<button id=\"btn1\">æ”¹å˜name</button>\n<button id=\"btn2\">æ”¹å˜age</button>\n</body>\n\n// src/index.js\nconst root = document.querySelector('#root')\n    var vue = new Vue({\n        data() {\n            return {\n            name: 'æ—ä¸‰å¿ƒ',\n            age: 18\n        }\n        },\n            render() {\n            root.innerHTML = `${this.name}ä»Šå¹´${this.age}å²äº†`\n        }\n        })\n        \n            document.getElementById('btn1').onclick = () => {\n            vue.name = 'sunshine_Lin'\n        }\n            document.getElementById('btn2').onclick = () => {\n            vue.age = 20\n        }\n```\n\nç”±æœ¬ç« ä¹‹å‰å†…å®¹ä»£ç å¯çŸ¥ï¼Œå½“dataé‡Œçš„å˜é‡è¢«æ”¹å˜æ—¶ï¼Œä¼šè§¦å‘`Object.defineProperty`çš„`set`å±æ€§ï¼Œç›´æ¥æ”¹å˜æ•°æ®å±‚çš„çš„æ•°æ®ï¼Œä½†æ˜¯é—®é¢˜æ¥äº†ï¼Œæ•°æ®æ˜¯ä¿®æ”¹äº†ï¼Œé‚£è§†å›¾è¯¥æ€ä¹ˆæ›´æ–°å‘¢ï¼Ÿè¿™æ—¶å€™`dep`å°±æ’ä¸Šç”¨åœºäº†ï¼Œdepä¼šè§¦å‘`notify`æ–¹æ³•ï¼Œé€šçŸ¥`æ¸²æŸ“Watcher`å»æ›´æ–°è§†å›¾ï¼ˆæ­¤æ—¶depé‡Œåªæœ‰ä¸€ä¸ª`Watcher`ï¼Œåç»­ä¼šæ›´å¤šï¼‰ï¼Œæ•ˆæœå¦‚å›¾ï¼š\n\n![845bd71610cbe1c567506c62e64b2245 (1).gif](/images/jueJin/cf8bcf86b9a0447.png)\n\nå®ç°computed\n----------\n\n### 1.ä»£ç å®ç°\n\nä¿®æ”¹ä¸€ä¸‹ä»£ç ï¼š\n\n```js\n// src/index.js\nconst root = document.querySelector('#root')\n    var vue = new Vue({\n        data() {\n            return {\n            name: 'æ—ä¸‰å¿ƒ',\n            age: 18\n        }\n        },\n        computed: { // æ–°å¢\n            info() {\n            return this.name + this.age\n        }\n        \n        },\n            render() {\n            root.innerHTML = `${this.name}ä»Šå¹´${this.age}å²äº†-----${this.info}` // æ–°å¢info\n        }\n        })\n``````js\n// src/init.js\n\nimport initState from './initState.js'\nimport initComputed from './initComputed.js'\n\n    Vue.prototype._init = function (options) {\n    const vm = this\n    vm.$options = options\n        if (options.data) {\n        // åˆå§‹åŒ–æ•°æ®\n        initState(vm)\n    }\n    if (options.computed) { // æ–°å¢\n    // åˆå§‹åŒ–computed\n    initComputed(vm)\n}\n}\n```\n\næˆ‘ä»¬éœ€è¦åœ¨è¿™ä¸ª`initComputed`æ–¹æ³•é‡Œå®ç°`computed`çš„é€»è¾‘\n\n```js\n// src/initComputed.js\n\nimport { Dep } from \"./Dep\"\nimport Watcher from \"./Watcher\"\n\n    export default function initComputed(vm) {\n    const computed = vm.$options.computed // æ‹¿åˆ°computedé…ç½®\n    const watchers = vm._computedWatchers = Object.create(null) // ç»™å½“å‰çš„vmæŒ‚è½½_computedWatcherså±æ€§ï¼Œåé¢ä¼šç”¨åˆ°\n    // å¾ªç¯computedæ¯ä¸ªå±æ€§\n        for (const key in computed) {\n    const userDef = computed[key]\n    // åˆ¤æ–­æ˜¯å‡½æ•°è¿˜æ˜¯å¯¹è±¡\n    const getter = typeof userDef === 'function' ? userDef : userDef.get\n// ç»™æ¯ä¸€ä¸ªcomputedåˆ›å»ºä¸€ä¸ªcomputed watcher æ³¨æ„{ lazy: true }\n// ç„¶åæŒ‚è½½åˆ°vm._computedWatcherså¯¹è±¡ä¸Š\nwatchers[key] = new Watcher(vm, getter, () => {}, { lazy: true })\n    if (!(key in vm)) {\n    defineComputed(vm, key, userDef)\n}\n}\n}\n\n```\n\nå¤§å®¶éƒ½çŸ¥é“`computed`æ˜¯æœ‰ç¼“å­˜çš„ï¼Œæ‰€ä»¥åˆ›å»º`watcher`çš„æ—¶å€™ï¼Œä¼šä¼ ä¸€ä¸ªé…ç½®{ lazy: true }ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥åŒºåˆ†è¿™æ˜¯`computed watcher`ï¼Œç„¶ååˆ°`watcher`é‡Œé¢æ¥æ”¶åˆ°è¿™ä¸ªå¯¹è±¡\n\n```js\n// src/Watcher.js\n\n\n    class Watcher {\n        constructor(vm, exprOrFn, cb, options) {\n        this.vm = vm\n            if (typeof exprOrFn === 'function') {\n            this.getter = exprOrFn\n        }\n            if (options) {\n            this.lazy = !!options.lazy // ä¸ºcomputed è®¾è®¡çš„\n                } else {\n                this.lazy = false\n            }\n            this.dirty = this.lazy\n            this.cb = cb\n            this.options = options\n            this.id = wId++\n        this.deps = []\n        this.depsId = new Set()\n        this.value = this.lazy ? undefined : this.get()\n    }\n    // çœç•¥å¾ˆå¤šä»£ç \n}\n```\n\nä»ä¸Šé¢è¿™å¥`this.value = this.lazy ? undefined : this.get()`ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œ`computed`åˆ›å»º`watcher`çš„æ—¶å€™æ˜¯ä¸ä¼šæŒ‡å‘`this.get`çš„ã€‚åªæœ‰åœ¨`render`å‡½æ•°é‡Œé¢æœ‰æ‰æ‰§è¡Œã€‚ ç°åœ¨åœ¨`render`å‡½æ•°é€šè¿‡`this.info`è¿˜ä¸èƒ½è¯»å–åˆ°å€¼ï¼Œå› ä¸ºæˆ‘ä»¬è¿˜æ²¡æœ‰æŒ‚è½½åˆ°vmä¸Šé¢ï¼Œä¸Šé¢`defineComputed(vm, key, userDef)`è¿™ä¸ªå‡½æ•°åŠŸèƒ½å°±æ˜¯è®©`computed`æŒ‚è½½åˆ°vmä¸Šé¢ã€‚ä¸‹é¢æˆ‘ä»¬å®ç°ä¸€ä¸‹ã€‚\n\n```js\n// src/initComputed.js\n\n\n    function defineComputed(vm, key, userDef) {\n    let getter = null\n    // åˆ¤æ–­æ˜¯å‡½æ•°è¿˜æ˜¯å¯¹è±¡\n        if (typeof userDef === 'function') {\n        getter = createComputedGetter(key)\n            } else {\n            getter = userDef.get\n        }\n            Object.defineProperty(vm, key, {\n            enumerable: true,\n            configurable: true,\n            get: getter,\n            set: function() {} // åˆå·æ‡’ï¼Œå…ˆä¸è€ƒè™‘setæƒ…å†µå“ˆï¼Œè‡ªå·±å»çœ‹æºç å®ç°ä¸€ç•ªä¹Ÿæ˜¯å¯ä»¥çš„\n            })\n        }\n        // åˆ›å»ºcomputedå‡½æ•°\n            function createComputedGetter(key) {\n                return function computedGetter() {\n            const watcher = this._computedWatchers[key]\n                if (watcher) {\n                if (watcher.dirty) {// ç»™computedçš„å±æ€§æ·»åŠ è®¢é˜…watchers\n                watcher.evaluate()\n            }\n            // æŠŠæ¸²æŸ“watcher æ·»åŠ åˆ°å±æ€§çš„è®¢é˜…é‡Œé¢å»ï¼Œè¿™å¾ˆå…³é”®\n                if (Dep.target) {\n                watcher.depend()\n            }\n            return watcher.value\n        }\n    }\n}\n```\n\nç”±ä¸Šé¢ä»£ç çœ‹å‡ºï¼Œ`watcher`å¤šäº†`evaluate`å’Œ`depend`ä¸¤ä¸ªæ–¹æ³•ï¼Œè®©æˆ‘ä»¬å»å®ç°ä¸€ä¸‹å§ï¼Œä»¥ä¸‹æ˜¯æ­¤æ—¶`Watcher`çš„å®Œæ•´ä»£ç ï¼š\n\n```js\n\nimport { pushTarget, popTarget } from './Dep'\n\n    class Watcher {\n        constructor(vm, exprOrFn, cb, options) {\n        this.vm = vm\n            if (typeof exprOrFn === 'function') {\n            this.getter = exprOrFn\n        }\n            if (options) {\n            this.lazy = !!options.lazy // ä¸ºcomputed è®¾è®¡çš„\n                } else {\n                this.lazy = false\n            }\n            this.dirty = this.lazy\n            this.cb = cb\n            this.options = options\n            this.id = wId++\n        this.deps = []\n        this.depsId = new Set() // dep å·²ç»æ”¶é›†è¿‡ç›¸åŒçš„watcher å°±ä¸è¦é‡å¤æ”¶é›†äº†\n        this.value = this.lazy ? undefined : this.get()\n    }\n        get() {\n        const vm = this.vm\n        pushTarget(this)\n        // æ‰§è¡Œå‡½æ•°\n        let value = this.getter.call(vm, vm)\n        popTarget()\n        return value\n    }\n        addDep(dep) {\n        let id = dep.id\n            if (!this.depsId.has(id)) {\n            this.depsId.add(id)\n            this.deps.push(dep)\n            dep.addSub(this);\n        }\n    }\n        update(){\n            if (this.lazy) {\n            this.dirty = true\n                } else {\n                this.get()\n            }\n        }\n        // æ‰§è¡Œgetï¼Œå¹¶ä¸” this.dirty = false\n            evaluate() {\n            this.value = this.get()\n            this.dirty = false\n        }\n        // æ‰€æœ‰çš„å±æ€§æ”¶é›†å½“å‰çš„watcer\n            depend() {\n            let i = this.deps.length\n                while(i--) {\n                this.deps[i].depend()\n            }\n        }\n    }\n```\n\n### 2.æµç¨‹è®²è§£\n\n*   1.é¦–æ¬¡æ¸²æŸ“ä¼šæ‰§è¡Œ`render`å‡½æ•°ï¼Œ`render`å‡½æ•°é‡Œä¼šè¯»å–`info`å˜é‡ï¼Œè¿™ä¸ªä¼šè§¦å‘`createComputedGetter(key)`ä¸­çš„`computedGetter(key)`ï¼›\n*   2.ç„¶åä¼šåˆ¤æ–­`dirty`è¿™ä¸ªå˜é‡ï¼Œçœ‹æ˜¯å¦éœ€è¦é‡æ–°è®¡ç®—ï¼Œå¦‚éœ€é‡æ–°è®¡ç®—åˆ™æ‰§è¡Œ`watcher.evaluate`\n*   3.åœ¨`watcher.evaluate`æ–¹æ³•ä¸­ï¼Œæ‰§è¡Œäº†`this.get`æ–¹æ³•ï¼Œè¿™æ—¶å€™ä¼šæ‰§è¡Œ`pushTarget(this)`æŠŠå½“å‰çš„`computed watcher` pushåˆ°`stack`é‡Œé¢å»ï¼Œå¹¶ä¸”æŠŠ`Dep.target` è®¾ç½®æˆå½“å‰çš„`computed watcher`\n*   4.è¿è¡Œ`this.getter.call(vm, vm)`ï¼Œä¹Ÿå°±æ˜¯è¿è¡Œäº†`info() {return this.name + this.age}`è¿™ä¸ªå‡½æ•°\n*   5.æ‰§è¡Œ`infoå‡½æ•°`åï¼Œå‡½æ•°é‡Œä¼šè¯»å–`name`å’Œ`age`ä¸¤ä¸ªå˜é‡ï¼Œé‚£ä¹ˆå°±ä¼šè§¦å‘ä¸¤æ¬¡`Object.defineProperty.get`çš„æ–¹æ³•ï¼Œé‚£ä¹ˆ`name`å’Œ`age`ä¸¤è€…çš„depéƒ½ä¼šæŠŠæ­¤`computed Watcher`æ”¶é›†èµ·æ¥\n*   6.ä¾èµ–æ”¶é›†å®Œæ¯•ä¹‹åæ‰§è¡Œ`popTarget()`ï¼ŒæŠŠå½“å‰çš„`computed watcher`ä»æ ˆæ¸…é™¤ï¼Œè¿”å›è®¡ç®—åçš„å€¼('æ—ä¸‰å¿ƒ' + '18')ï¼Œå¹¶ä¸”`this.dirty = false`\n*   7.`watcher.evaluate()`æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œå°±ä¼šåˆ¤æ–­`Dep.target` æ˜¯ä¸æ˜¯`true`ï¼Œå¦‚æœæœ‰å°±ä»£è¡¨è¿˜æœ‰æ¸²æŸ“`watcher`ï¼Œå°±æ‰§è¡Œ`watcher.depend()`ï¼Œç„¶åè®©`watcher`é‡Œé¢çš„`deps`éƒ½æ”¶é›†æ¸²æŸ“`watcher`ï¼Œè¿™å°±æ˜¯åŒå‘ä¿å­˜çš„ä¼˜åŠ¿ã€‚\n*   8.æ­¤æ—¶`name`å’Œ`age`éƒ½æ”¶é›†äº†`computed watcher` å’Œ `æ¸²æŸ“watcher`ã€‚é‚£ä¹ˆè®¾ç½®`name`çš„æ—¶å€™éƒ½ä¼šå»æ›´æ–°æ‰§è¡Œwatcher.update()ï¼Œ`age`ä¹ŸåŒç†\n*   9.å¦‚æœæ˜¯`computed watcher`çš„è¯ä¸ä¼šé‡æ–°æ‰§è¡Œä¸€éåªä¼šæŠŠ`this.dirty` è®¾ç½®æˆ `true`ï¼Œå¦‚æœæ•°æ®å˜åŒ–çš„æ—¶å€™å†æ‰§è¡Œ`watcher.evaluate()`è¿›è¡Œ`info`æ›´æ–°ï¼Œæ²¡æœ‰å˜åŒ–çš„çš„è¯`this.dirty` å°±æ˜¯`false`ï¼Œä¸ä¼šæ‰§è¡Œinfoæ–¹æ³•ã€‚è¿™å°±æ˜¯`computedç¼“å­˜æœºåˆ¶`ã€‚ çœ‹çœ‹æ­¤æ—¶çš„æ•ˆæœï¼š\n\n![38980e0ca8c5f6ee438aa4981c01ac21.gif](/images/jueJin/50550f000c2d477.png)\n\nwatchçš„å®ç°\n--------\n\nä¿®æ”¹ä¸€ä¸‹ä»£ç ï¼š\n\n```js\n// src/index.js\n\nconst root = document.querySelector('#root')\n    var vue = new Vue({\n        data() {\n            return {\n            name: 'æ—ä¸‰å¿ƒ',\n            age: 18\n        }\n        },\n            computed: {\n                info() {\n                return this.name + this.age\n            }\n            \n            },\n                watch: {\n                    name(oldValue, newValue) {\n                    console.log('è§¦å‘watch', oldValue, newValue)\n                    },\n                        age(oldValue, newValue) {\n                        console.log('è§¦å‘watch', oldValue, newValue)\n                    }\n                    },\n                        render() {\n                        root.innerHTML = `${this.name}ä»Šå¹´${this.age}å²äº†-----${this.info}`\n                    }\n                    })\n``````js\n// src/init.js\n\n    Vue.prototype._init = function (options) {\n    const vm = this\n    vm.$options = options\n        if (options.data) {\n        // åˆå§‹åŒ–æ•°æ®\n        initState(vm)\n    }\n        if (options.computed) {\n        // åˆå§‹åŒ–computed\n        initComputed(vm)\n    }\n        if (options.watch) {\n        // åˆå§‹åŒ–watch\n        initWatch(vm)\n    }\n}\n```\n\nå®ç°ä¸€ä¸‹`initWatch`:\n\n```js\n// src/initWatch.js\n\nimport Watcher from './Watcher'\n\n    export default function initWatch (vm) {\n    const watch = vm.$options.watch\n        for(let key in watch) {\n    const handler = watch[key]\n    new Watcher(vm, key, handler, {user: true})\n}\n}\n```\n\nä¿®æ”¹ä¸€ä¸‹`Watcher.js`çš„ä»£ç \n\n```js\n// src/Watcher.js\n\nlet wId = 0\n    class Watcher {\n        constructor(vm, exprOrFn, cb, options) {\n        this.vm = vm\n            if (typeof exprOrFn === 'function') {\n            this.getter = exprOrFn\n                } else {\n                this.getter = parsePath(exprOrFn) // user watcher\n            }\n                if (options) {\n                this.lazy = !!options.lazy // ä¸ºcomputed è®¾è®¡çš„\n                this.user = !!options.user // ä¸ºuser watherè®¾è®¡çš„\n                    } else {\n                    this.user = this.lazy = false\n                }\n                this.dirty = this.lazy\n                this.cb = cb\n                this.options = options\n                this.id = wId++\n            this.deps = []\n            this.depsId = new Set() // dep å·²ç»æ”¶é›†è¿‡ç›¸åŒçš„watcher å°±ä¸è¦é‡å¤æ”¶é›†äº†\n            this.value = this.lazy ? undefined : this.get()\n        }\n            get() {\n            const vm = this.vm\n            pushTarget(this)\n            // æ‰§è¡Œå‡½æ•°\n            let value = this.getter.call(vm, vm)\n            popTarget()\n            return value\n        }\n            addDep(dep) {\n            let id = dep.id\n                if (!this.depsId.has(id)) {\n                this.depsId.add(id)\n                this.deps.push(dep)\n                dep.addSub(this);\n            }\n        }\n            update(){\n                if (this.lazy) {\n                this.dirty = true\n                    } else {\n                    this.run()\n                }\n            }\n            // æ‰§è¡Œgetï¼Œå¹¶ä¸” this.dirty = false\n                evaluate() {\n                this.value = this.get()\n                this.dirty = false\n            }\n            // æ‰€æœ‰çš„å±æ€§æ”¶é›†å½“å‰çš„watcer\n                depend() {\n                let i = this.deps.length\n                    while(i--) {\n                    this.deps[i].depend()\n                }\n            }\n                run () {\n                const value = this.get()\n                const oldValue = this.value\n                this.value = value\n                // æ‰§è¡Œcb\n                    if (this.user) {\n                        try{\n                        this.cb.call(this.vm, value, oldValue)\n                            } catch(error) {\n                            console.error(error)\n                        }\n                            } else {\n                            this.cb && this.cb.call(this.vm, oldValue, value)\n                        }\n                    }\n                }\n                    function parsePath (path) {\n                    const segments = path.split('.')\n                        return function (obj) {\n                            for (let i = 0; i < segments.length; i++) {\n                            if (!obj) return\n                        obj = obj[segments[i]]\n                    }\n                    return obj\n                }\n            }\n```\n\næœ€åæ¥çœ‹çœ‹æ•ˆæœï¼š\n\n![6ff71566df6adac8414a885725a61f8c.gif](/images/jueJin/9003b334c6fe4cf.png)\n\n### ç»“è¯­\n\nåŠ æ²¹ï¼Œå„ä½ï¼ï¼ï¼ç‚¹èµï¼Œç‚¹èµ·æ¥",
	"selfDefined": "likes:219,comments:0,collects:268,likes:17107"
}