---
author: "王宇"
title: "向量模型微调方案设计与实践总结"
date: 八月21,2024
description: "知识插件"
tags: ["知识插件"]
ShowReadingTime: "12s"
weight: 694
---
**0、前言**

本文主要针对“养猪领域”知识向量化和向量检索所用模型进行微调，并总结8月份微调实践的经验。

**1****、模型选择**

![](/download/attachments/123653194/image2024-5-28_9-31-38.png?version=1&modificationDate=1716859898246&api=v2)

这是基于5月份构建的“养猪专家”知识库，选用了100条问题，使用3个开源向量模型统计的检出率情况。根据以上测评结果，对于“养猪领域”向量模型微调优先选择 **m3e-base** 模型，然后才是 **bge-base** 模型。

**2****、训练策略**

*   FullParametersTraining：全参数微调，不进行任何修改，所有参数都参与训练。
*   BitFitTraining：只训练某些关键词参数，其他参数固定。通过 keywords 指定要训练的参数名。
*   PrefixTraining：只训练前缀 tokens 对应的 embedding 参数。通过 additional\_special\_tokens 指定前缀 tokens，并只训练这些 tokens 的 embedding。

这些策略可以平衡语料大小与模型大小，降低过拟合风险，帮助模型快速适应下游任务。通常先做全参数训练预热一下，再使用部分固定或前缀训练等策略微调到特定下游任务，具体策略选择应根据实际效果进行调整。训练是基于预训练的 embedding 模型，一般能让它在原来的基础上提升3%-10%的性能。

**3****、数据格式**

通常，有以下三种训练样本格式:

*   **Pair (句子对)：**每个样本包含一个正例句子对。用于学习区分正例和负例句子。

\[{  
    'text': '第1胎次母猪的日粮饲喂量和赖氨酸含量是多少？',  
    'positive\_text': '第1胎次母猪的日粮饲喂量为4.0lb(1.8kg)，含赖氨酸0.51%。'  
},  
{  
    'text': '对于群养在特定地板类型的母猪，温度可以如何调整？',  
    'positive\_text': '群养在水泥地板的母猪，温度可以降低4°F(2.2°C)，而在铺有干草的圈舍中的母猪，温度可以降低8°F(4.4°C)。'  
}\]

*   **Triplet (三元组) ：**每个样本包含一个正例句子和一个负例句子。可以更明确地学习区分正负样本。

\[{  
    'text': '第1胎次母猪的日粮饲喂量和赖氨酸含量是多少？',  
    'positive\_text': '第1胎次母猪的日粮饲喂量为4.0lb(1.8kg)，含赖氨酸0.51%。',  
    'negative\_text': '标准的母猪是指第1胎次的母猪，具有中等瘦肉生长力和理想的体况，在产后到断奶期间期望的体重损失不超过15Ib(7kg)。'  
},  
{  
    'text': '对于群养在特定地板类型的母猪，温度可以如何调整？',  
    'positive\_text': '群养在水泥地板的母猪，温度可以降低4°F(2.2°C)，而在铺有干草的圈舍中的母猪，温度可以降低8°F(4.4°C)。',  
    'negative\_text': '隔热条件差或者经常有缝隙风时，需要调整温度。'  
}\]

*    **Scored Pair (打分句子对)：**每个样本包含一对句子和它们的相似度分数。可以直接学习评估语义相似度。

\[{  
    'text': '第1胎次母猪的日粮饲喂量和赖氨酸含量是多少？',  
    'scored\_text': '第1胎次母猪的日粮饲喂量为4.0lb(1.8kg)，含赖氨酸0.51%。',  
    'score': 0.9  
},  
{  
    'text': '对于群养在特定地板类型的母猪，温度可以如何调整？',  
    'scored\_text': '群养在水泥地板的母猪，温度可以降低4°F(2.2°C)，而在铺有干草的圈舍中的母猪，温度可以降低8°F(4.4°C)。',  
    'score': 0.8  
}\]

这三种格式适用于不同的训练目的，对我们的训练任务来说，优先选择 Triplet 数据格式。

**4****、数据构建**

基于目前构建的“养猪专家”知识库中的文本块内容，采用 LLM 生成问答文本对。考虑到当前的任务偏向于 s2p（即 sentence to passage，代表了异质文本之间的嵌入能力），需要用 LLM 对每一个 chunk 生成一系列问题，组合成正例文本对，负例文本对则采用随机选择的策略生成。因生成的文本对存在质量不佳甚至错误的情况，故还需要对数据集进行校验，提升数据质量。最后构建出来的文本对，选出一部分作为训练集，一部分作为测试集。

**5、实践总结**

5月份，选用知识库中10000条不同类别的部分书籍文本块，使用讯飞 general 大模型，生成正例问答对。针对每一个问题，又从全域数据库中向量检索的top300-top500条知识中随机选择了5条阈值较低的负例文本（难负例）。然后，根据 query（问题）去重、去除 pos（正例文本）中大模型未回复的内容，再去除文本长度太短（小于5）或超长（大于750）的部分，构建了我们向量模型微调的初版数据集（22324条）。后续再由人工筛选，去除质量较差的数据，最终得到15865条可用数据。

领域问答对正负例数据集人工筛选的标准如下（目的：筛选出“养猪领域”的问题与 pos 回答语义相关，但与 neg（负例）语义无关的数据）：

（1）去掉整条数据的标准

*   问题（query）上下文明显缺失的去掉（不是一个完整清晰的问题或描述）；比如：门洞口的底标高一般是多少？（未说明是哪里的门洞口）
*   答非所问的去掉（不是一个匹配的问答对或问题与回答无关的query-pos）；
*   质量非常差劲的问答对去掉（与当前养猪领域完全无关、没有意义）比如：杆套病毒科(Roniviridae)的抗原特性是什么？目前尚不明确（这种回复没有意义）。

（2）去掉负例的标准（尽量保留至少2个负例，若某条数据中满足条件的 neg 负例少于2个，则随机从其他问题的负例中拿2个补齐）

*   与问题语义相关的负例去掉；
*   质量非常差劲的负例去掉（语义非常不完整或无意义）

然后使用这个数据集，随机选择95%作为训练集，5%作为测试集，微调训练了 bge-base-zh-v1.5 和 m3e-base 模型。因这一版训练的模型检出效果不理想，猜测是因为训练数据的负样本构建方式不太好（一方面是从检索的样本中筛选负例的难度较高，使得里面混杂了较多正例数据，且与真实检索场景的数据分布不太一致），故将负例样本生成方式优化为 batch 内随机负例（即只使用数据集中的正例文本对，负例则每次都从当前batch的数据中随机选择其他问题的正例文本作为当前问题的负例）。调整负例生成策略后，再次微调向量了一版模型，微调情况如下：

![](/download/attachments/123653194/image2024-8-21_11-35-15.png?version=1&modificationDate=1724211315532&api=v2)

![](/download/attachments/123653194/image2024-8-21_11-35-29.png?version=1&modificationDate=1724211329218&api=v2)

最后，使用100条“养猪领域”的问题，统计6月份最新构建的全域知识库中的检出率，情况如下：

![](/download/attachments/123653194/image2024-8-21_11-36-43.png?version=1&modificationDate=1724211403821&api=v2)

从检出率评测结果来看，对于 bge-base 模型，使用“养猪领域”数据微调效果提升较大。但对于 m3e-base 模型，开源模型在“养猪领域”内表现较好，微调未有提升。整体来看，bge-base 模型计算速率更快，且微调后其阈值分布更为合理，区分度更优；或许随着训练数据集的扩充，调整训练策略后，其微调会有较大的潜力和价值。

6、相关文件

*   [向量模型微调-qa-随机负例.xlsx](/download/attachments/123653194/%E5%90%91%E9%87%8F%E6%A8%A1%E5%9E%8B%E5%BE%AE%E8%B0%83-qa-%E9%9A%8F%E6%9C%BA%E8%B4%9F%E4%BE%8B.xlsx?version=1&modificationDate=1724211736851&api=v2)
*   [检索测试数据及结果统计.xlsx](/download/attachments/123653194/%E6%A3%80%E7%B4%A2%E6%B5%8B%E8%AF%95%E6%95%B0%E6%8D%AE%E5%8F%8A%E7%BB%93%E6%9E%9C%E7%BB%9F%E8%AE%A1.xlsx?version=1&modificationDate=1724211700390&api=v2)

[Filter table data](#)[Create a pivot table](#)[Create a chart from data series](#)

[Configure buttons visibility](/users/tfac-settings.action)