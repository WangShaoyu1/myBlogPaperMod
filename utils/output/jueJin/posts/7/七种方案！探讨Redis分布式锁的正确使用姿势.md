---
author: "æ¡ç”°èºçš„å°ç”·å­©"
title: "ä¸ƒç§æ–¹æ¡ˆï¼æ¢è®¨Redisåˆ†å¸ƒå¼é”çš„æ­£ç¡®ä½¿ç”¨å§¿åŠ¿"
date: 2021-03-08
description: "æ—¥å¸¸å¼€å‘ä¸­ï¼Œç§’æ€ä¸‹å•ã€æŠ¢çº¢åŒ…ç­‰ç­‰ä¸šåŠ¡åœºæ™¯ï¼Œéƒ½éœ€è¦ç”¨åˆ°åˆ†å¸ƒå¼é”ã€‚è€ŒRediséå¸¸é€‚åˆä½œä¸ºåˆ†å¸ƒå¼é”ä½¿ç”¨ã€‚æœ¬æ–‡å°†åˆ†ä¸ƒä¸ªæ–¹æ¡ˆå±•å¼€ï¼Œè·Ÿå¤§å®¶æ¢è®¨Redisåˆ†å¸ƒå¼é”çš„æ­£ç¡®ä½¿ç”¨æ–¹å¼ã€‚å¦‚æœæœ‰ä¸æ­£ç¡®çš„åœ°æ–¹ï¼Œæ¬¢è¿å¤§å®¶æŒ‡å‡ºå“ˆï¼Œä¸€èµ·å­¦ä¹ ä¸€èµ·è¿›æ­¥ã€‚ äº’æ–¥æ€§ ä»»æ„æ—¶åˆ»ï¼Œåªæœ‰ä¸€ä¸ªå®¢æˆ·ç«¯èƒ½æŒæœ‰é”ã€‚ é”è¶…æ—¶é‡Šæ”¾â€¦"
tags: ["Java","Redisä¸­æ–‡æŠ€æœ¯ç¤¾åŒº","å‰ç«¯å¼€å‘ç¤¾åŒº","å‰ç«¯æŠ€æœ¯äº¤æµ","å‰ç«¯æ¡†æ¶æ•™ç¨‹","JavaScript å­¦ä¹ èµ„æº","CSS æŠ€å·§ä¸æœ€ä½³å®è·µ","HTML5 æœ€æ–°åŠ¨æ€","å‰ç«¯å·¥ç¨‹å¸ˆèŒä¸šå‘å±•","å¼€æºå‰ç«¯é¡¹ç›®","å‰ç«¯æŠ€æœ¯è¶‹åŠ¿"]
ShowReadingTime: "é˜…è¯»10åˆ†é’Ÿ"
weight: 1
selfDefined:"likes:203,comments:17,collects:417,views:48529,"
---
### å‰è¨€

æ—¥å¸¸å¼€å‘ä¸­ï¼Œç§’æ€ä¸‹å•ã€æŠ¢çº¢åŒ…ç­‰ç­‰ä¸šåŠ¡åœºæ™¯ï¼Œéƒ½éœ€è¦ç”¨åˆ°åˆ†å¸ƒå¼é”ã€‚è€ŒRediséå¸¸é€‚åˆä½œä¸ºåˆ†å¸ƒå¼é”ä½¿ç”¨ã€‚æœ¬æ–‡å°†åˆ†ä¸ƒä¸ªæ–¹æ¡ˆå±•å¼€ï¼Œè·Ÿå¤§å®¶æ¢è®¨Redisåˆ†å¸ƒå¼é”çš„æ­£ç¡®ä½¿ç”¨æ–¹å¼ã€‚å¦‚æœæœ‰ä¸æ­£ç¡®çš„åœ°æ–¹ï¼Œæ¬¢è¿å¤§å®¶æŒ‡å‡ºå“ˆï¼Œä¸€èµ·å­¦ä¹ ä¸€èµ·è¿›æ­¥ã€‚

å…¬ä¼—å·ï¼š**æ¡ç”°èºçš„å°ç”·å­©**

*   ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼é”
    
*   æ–¹æ¡ˆä¸€ï¼šSETNX + EXPIRE
    
*   æ–¹æ¡ˆäºŒï¼šSETNX + valueå€¼æ˜¯ï¼ˆç³»ç»Ÿæ—¶é—´+è¿‡æœŸæ—¶é—´ï¼‰
    
*   æ–¹æ¡ˆä¸‰ï¼šä½¿ç”¨Luaè„šæœ¬(åŒ…å«SETNX + EXPIREä¸¤æ¡æŒ‡ä»¤)
    
*   æ–¹æ¡ˆå››ï¼šSETçš„æ‰©å±•å‘½ä»¤ï¼ˆSET EX PX NXï¼‰
    
*   æ–¹æ¡ˆäº”ï¼šSET EX PX NX + æ ¡éªŒå”¯ä¸€éšæœºå€¼,å†é‡Šæ”¾é”
    
*   æ–¹æ¡ˆå…­: å¼€æºæ¡†æ¶:Redisson
    
*   æ–¹æ¡ˆä¸ƒï¼šå¤šæœºå®ç°çš„åˆ†å¸ƒå¼é”Redlock
    
*   githubåœ°å€ï¼Œæ„Ÿè°¢æ¯é¢—star
    

> [github.com/whx123/Javaâ€¦](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fwhx123%2FJavaHome "https://github.com/whx123/JavaHome")

### ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼é”

> åˆ†å¸ƒå¼é”å…¶å®å°±æ˜¯ï¼Œæ§åˆ¶åˆ†å¸ƒå¼ç³»ç»Ÿä¸åŒè¿›ç¨‹å…±åŒè®¿é—®å…±äº«èµ„æºçš„ä¸€ç§é”çš„å®ç°ã€‚å¦‚æœä¸åŒçš„ç³»ç»Ÿæˆ–åŒä¸€ä¸ªç³»ç»Ÿçš„ä¸åŒä¸»æœºä¹‹é—´å…±äº«äº†æŸä¸ªä¸´ç•Œèµ„æºï¼Œå¾€å¾€éœ€è¦äº’æ–¥æ¥é˜²æ­¢å½¼æ­¤å¹²æ‰°ï¼Œä»¥ä¿è¯ä¸€è‡´æ€§ã€‚

æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹ï¼Œä¸€æŠŠé è°±çš„åˆ†å¸ƒå¼é”åº”è¯¥æœ‰å“ªäº›ç‰¹å¾ï¼š

![](/images/jueJin/42884a1613344c1.png)

*   **äº’æ–¥æ€§**: ä»»æ„æ—¶åˆ»ï¼Œåªæœ‰ä¸€ä¸ªå®¢æˆ·ç«¯èƒ½æŒæœ‰é”ã€‚
*   **é”è¶…æ—¶é‡Šæ”¾**ï¼šæŒæœ‰é”è¶…æ—¶ï¼Œå¯ä»¥é‡Šæ”¾ï¼Œé˜²æ­¢ä¸å¿…è¦çš„èµ„æºæµªè´¹ï¼Œä¹Ÿå¯ä»¥é˜²æ­¢æ­»é”ã€‚
*   **å¯é‡å…¥æ€§**:ä¸€ä¸ªçº¿ç¨‹å¦‚æœè·å–äº†é”ä¹‹å,å¯ä»¥å†æ¬¡å¯¹å…¶è¯·æ±‚åŠ é”ã€‚
*   **é«˜æ€§èƒ½å’Œé«˜å¯ç”¨**ï¼šåŠ é”å’Œè§£é”éœ€è¦å¼€é”€å°½å¯èƒ½ä½ï¼ŒåŒæ—¶ä¹Ÿè¦ä¿è¯é«˜å¯ç”¨ï¼Œé¿å…åˆ†å¸ƒå¼é”å¤±æ•ˆã€‚
*   **å®‰å…¨æ€§**ï¼šé”åªèƒ½è¢«æŒæœ‰çš„å®¢æˆ·ç«¯åˆ é™¤ï¼Œä¸èƒ½è¢«å…¶ä»–å®¢æˆ·ç«¯åˆ é™¤

### Redisåˆ†å¸ƒå¼é”æ–¹æ¡ˆä¸€ï¼šSETNX + EXPIRE

æåˆ°Redisçš„åˆ†å¸ƒå¼é”ï¼Œå¾ˆå¤šå°ä¼™ä¼´é©¬ä¸Šå°±ä¼šæƒ³åˆ°`setnx`\+ `expire`å‘½ä»¤ã€‚å³å…ˆç”¨`setnx`æ¥æŠ¢é”ï¼Œå¦‚æœæŠ¢åˆ°ä¹‹åï¼Œå†ç”¨`expire`ç»™é”è®¾ç½®ä¸€ä¸ªè¿‡æœŸæ—¶é—´ï¼Œé˜²æ­¢é”å¿˜è®°äº†é‡Šæ”¾ã€‚

> SETNX æ˜¯SET IF NOT EXISTSçš„ç®€å†™.æ—¥å¸¸å‘½ä»¤æ ¼å¼æ˜¯SETNX key valueï¼Œå¦‚æœ keyä¸å­˜åœ¨ï¼Œåˆ™SETNXæˆåŠŸè¿”å›1ï¼Œå¦‚æœè¿™ä¸ªkeyå·²ç»å­˜åœ¨äº†ï¼Œåˆ™è¿”å›0ã€‚

å‡è®¾æŸç”µå•†ç½‘ç«™çš„æŸå•†å“åšç§’æ€æ´»åŠ¨ï¼Œkeyå¯ä»¥è®¾ç½®ä¸ºkey\_resource\_id,valueè®¾ç½®ä»»æ„å€¼ï¼Œä¼ªä»£ç å¦‚ä¸‹ï¼š

```csharp
ifï¼ˆjedis.setnx(key_resource_id,lock_value) == 1ï¼‰{ //åŠ é”
expireï¼ˆkey_resource_idï¼Œ100ï¼‰; //è®¾ç½®è¿‡æœŸæ—¶é—´
    try {
    do something  //ä¸šåŠ¡è¯·æ±‚
        }catch(){
    }
        finally {
        jedis.del(key_resource_id); //é‡Šæ”¾é”
    }
}
```

ä½†æ˜¯è¿™ä¸ªæ–¹æ¡ˆä¸­ï¼Œ`setnx`å’Œ`expire`ä¸¤ä¸ªå‘½ä»¤åˆ†å¼€äº†ï¼Œ**ä¸æ˜¯åŸå­æ“ä½œ**ã€‚å¦‚æœæ‰§è¡Œå®Œ`setnx`åŠ é”ï¼Œæ­£è¦æ‰§è¡Œ`expire`è®¾ç½®è¿‡æœŸæ—¶é—´æ—¶ï¼Œè¿›ç¨‹crashæˆ–è€…è¦é‡å¯ç»´æŠ¤äº†ï¼Œé‚£ä¹ˆè¿™ä¸ªé”å°±â€œé•¿ç”Ÿä¸è€â€äº†ï¼Œ**åˆ«çš„çº¿ç¨‹æ°¸è¿œè·å–ä¸åˆ°é”å•¦**ã€‚

### Redisåˆ†å¸ƒå¼é”æ–¹æ¡ˆäºŒï¼šSETNX + valueå€¼æ˜¯(ç³»ç»Ÿæ—¶é—´+è¿‡æœŸæ—¶é—´)

ä¸ºäº†è§£å†³æ–¹æ¡ˆä¸€ï¼Œ**å‘ç”Ÿå¼‚å¸¸é”å¾—ä¸åˆ°é‡Šæ”¾çš„åœºæ™¯**ï¼Œæœ‰å°ä¼™ä¼´è®¤ä¸ºï¼Œå¯ä»¥æŠŠè¿‡æœŸæ—¶é—´æ”¾åˆ°`setnx`çš„valueå€¼é‡Œé¢ã€‚å¦‚æœåŠ é”å¤±è´¥ï¼Œå†æ‹¿å‡ºvalueå€¼æ ¡éªŒä¸€ä¸‹å³å¯ã€‚åŠ é”ä»£ç å¦‚ä¸‹ï¼š

```kotlin
long expires = System.currentTimeMillis() + expireTime; //ç³»ç»Ÿæ—¶é—´+è®¾ç½®çš„è¿‡æœŸæ—¶é—´
String expiresStr = String.valueOf(expires);

// å¦‚æœå½“å‰é”ä¸å­˜åœ¨ï¼Œè¿”å›åŠ é”æˆåŠŸ
    if (jedis.setnx(key_resource_id, expiresStr) == 1) {
    return true;
}
// å¦‚æœé”å·²ç»å­˜åœ¨ï¼Œè·å–é”çš„è¿‡æœŸæ—¶é—´
String currentValueStr = jedis.get(key_resource_id);

// å¦‚æœè·å–åˆ°çš„è¿‡æœŸæ—¶é—´ï¼Œå°äºç³»ç»Ÿå½“å‰æ—¶é—´ï¼Œè¡¨ç¤ºå·²ç»è¿‡æœŸ
    if (currentValueStr != null && Long.parseLong(currentValueStr) < System.currentTimeMillis()) {
    
    // é”å·²è¿‡æœŸï¼Œè·å–ä¸Šä¸€ä¸ªé”çš„è¿‡æœŸæ—¶é—´ï¼Œå¹¶è®¾ç½®ç°åœ¨é”çš„è¿‡æœŸæ—¶é—´ï¼ˆä¸äº†è§£redisçš„getSetå‘½ä»¤çš„å°ä¼™ä¼´ï¼Œå¯ä»¥å»å®˜ç½‘çœ‹ä¸‹å“ˆï¼‰
    String oldValueStr = jedis.getSet(key_resource_id, expiresStr);
    
        if (oldValueStr != null && oldValueStr.equals(currentValueStr)) {
        // è€ƒè™‘å¤šçº¿ç¨‹å¹¶å‘çš„æƒ…å†µï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹çš„è®¾ç½®å€¼å’Œå½“å‰å€¼ç›¸åŒï¼Œå®ƒæ‰å¯ä»¥åŠ é”
        return true;
    }
}

//å…¶ä»–æƒ…å†µï¼Œå‡è¿”å›åŠ é”å¤±è´¥
return false;
}
```

è¿™ä¸ªæ–¹æ¡ˆçš„ä¼˜ç‚¹æ˜¯ï¼Œå·§å¦™ç§»é™¤`expire`å•ç‹¬è®¾ç½®è¿‡æœŸæ—¶é—´çš„æ“ä½œï¼ŒæŠŠ**è¿‡æœŸæ—¶é—´æ”¾åˆ°setnxçš„valueå€¼**é‡Œé¢æ¥ã€‚è§£å†³äº†æ–¹æ¡ˆä¸€å‘ç”Ÿå¼‚å¸¸ï¼Œé”å¾—ä¸åˆ°é‡Šæ”¾çš„é—®é¢˜ã€‚ä½†æ˜¯è¿™ä¸ªæ–¹æ¡ˆè¿˜æœ‰åˆ«çš„ç¼ºç‚¹ï¼š

> *   è¿‡æœŸæ—¶é—´æ˜¯å®¢æˆ·ç«¯è‡ªå·±ç”Ÿæˆçš„ï¼ˆSystem.currentTimeMillis()æ˜¯å½“å‰ç³»ç»Ÿçš„æ—¶é—´ï¼‰ï¼Œå¿…é¡»è¦æ±‚åˆ†å¸ƒå¼ç¯å¢ƒä¸‹ï¼Œæ¯ä¸ªå®¢æˆ·ç«¯çš„æ—¶é—´å¿…é¡»åŒæ­¥ã€‚
> *   å¦‚æœé”è¿‡æœŸçš„æ—¶å€™ï¼Œå¹¶å‘å¤šä¸ªå®¢æˆ·ç«¯åŒæ—¶è¯·æ±‚è¿‡æ¥ï¼Œéƒ½æ‰§è¡Œjedis.getSet()ï¼Œæœ€ç»ˆåªèƒ½æœ‰ä¸€ä¸ªå®¢æˆ·ç«¯åŠ é”æˆåŠŸï¼Œä½†æ˜¯è¯¥å®¢æˆ·ç«¯é”çš„è¿‡æœŸæ—¶é—´ï¼Œå¯èƒ½è¢«åˆ«çš„å®¢æˆ·ç«¯è¦†ç›–
> *   è¯¥é”æ²¡æœ‰ä¿å­˜æŒæœ‰è€…çš„å”¯ä¸€æ ‡è¯†ï¼Œå¯èƒ½è¢«åˆ«çš„å®¢æˆ·ç«¯é‡Šæ”¾/è§£é”ã€‚

### Redisåˆ†å¸ƒå¼é”æ–¹æ¡ˆä¸‰ï¼šä½¿ç”¨Luaè„šæœ¬(åŒ…å«SETNX + EXPIREä¸¤æ¡æŒ‡ä»¤)

å®é™…ä¸Šï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨Luaè„šæœ¬æ¥ä¿è¯åŸå­æ€§ï¼ˆåŒ…å«setnxå’Œexpireä¸¤æ¡æŒ‡ä»¤ï¼‰ï¼Œluaè„šæœ¬å¦‚ä¸‹ï¼š

```vbnet
if redis.call('setnx',KEYS[1],ARGV[1]) == 1 then
redis.call('expire',KEYS[1],ARGV[2])
else
return 0
end;
```

åŠ é”ä»£ç å¦‚ä¸‹ï¼š

```ini
String lua_scripts = "if redis.call('setnx',KEYS[1],ARGV[1]) == 1 then" +
" redis.call('expire',KEYS[1],ARGV[2]) return 1 else return 0 end";
Object result = jedis.eval(lua_scripts, Collections.singletonList(key_resource_id), Collections.singletonList(values));
//åˆ¤æ–­æ˜¯å¦æˆåŠŸ
return result.equals(1L);
```

è¿™ä¸ªæ–¹æ¡ˆè¿˜æ˜¯æœ‰ç¼ºç‚¹çš„å“¦ï¼Œè‡³äºå“ªäº›ç¼ºç‚¹ï¼Œä½ å…ˆæ€è€ƒä¸€ä¸‹ã€‚ä¹Ÿå¯ä»¥æƒ³ä¸‹ã€‚è·Ÿæ–¹æ¡ˆäºŒå¯¹æ¯”ï¼Œå“ªä¸ªæ›´å¥½ï¼Ÿ

### Redisåˆ†å¸ƒå¼é”æ–¹æ¡ˆæ–¹æ¡ˆå››ï¼šSETçš„æ‰©å±•å‘½ä»¤ï¼ˆSET EX PX NXï¼‰

é™¤äº†ä½¿ç”¨ï¼Œä½¿ç”¨Luaè„šæœ¬ï¼Œä¿è¯`SETNX + EXPIRE`ä¸¤æ¡æŒ‡ä»¤çš„åŸå­æ€§ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å·§ç”¨Redisçš„SETæŒ‡ä»¤æ‰©å±•å‚æ•°ï¼ï¼ˆ`SET key value[EX seconds][PX milliseconds][NX|XX]`ï¼‰ï¼Œå®ƒä¹Ÿæ˜¯åŸå­æ€§çš„ï¼

> SET key value\[EX seconds\]\[PX milliseconds\]\[NX|XX\]
> 
> *   NX :è¡¨ç¤ºkeyä¸å­˜åœ¨çš„æ—¶å€™ï¼Œæ‰èƒ½setæˆåŠŸï¼Œä¹Ÿå³ä¿è¯åªæœ‰ç¬¬ä¸€ä¸ªå®¢æˆ·ç«¯è¯·æ±‚æ‰èƒ½è·å¾—é”ï¼Œè€Œå…¶ä»–å®¢æˆ·ç«¯è¯·æ±‚åªèƒ½ç­‰å…¶é‡Šæ”¾é”ï¼Œæ‰èƒ½è·å–ã€‚
> *   EX seconds :è®¾å®škeyçš„è¿‡æœŸæ—¶é—´ï¼Œæ—¶é—´å•ä½æ˜¯ç§’ã€‚
> *   PX milliseconds: è®¾å®škeyçš„è¿‡æœŸæ—¶é—´ï¼Œå•ä½ä¸ºæ¯«ç§’
> *   XX: ä»…å½“keyå­˜åœ¨æ—¶è®¾ç½®å€¼

ä¼ªä»£ç demoå¦‚ä¸‹ï¼š

```csharp
ifï¼ˆjedis.set(key_resource_id, lock_value, "NX", "EX", 100s) == 1ï¼‰{ //åŠ é”
    try {
    do something  //ä¸šåŠ¡å¤„ç†
        }catch(){
    }
        finally {
        jedis.del(key_resource_id); //é‡Šæ”¾é”
    }
}
```

ä½†æ˜¯å‘¢ï¼Œè¿™ä¸ªæ–¹æ¡ˆè¿˜æ˜¯å¯èƒ½å­˜åœ¨é—®é¢˜ï¼š

*   é—®é¢˜ä¸€ï¼š**é”è¿‡æœŸé‡Šæ”¾äº†ï¼Œä¸šåŠ¡è¿˜æ²¡æ‰§è¡Œå®Œ**ã€‚å‡è®¾çº¿ç¨‹aè·å–é”æˆåŠŸï¼Œä¸€ç›´åœ¨æ‰§è¡Œä¸´ç•ŒåŒºçš„ä»£ç ã€‚ä½†æ˜¯100sè¿‡å»åï¼Œå®ƒè¿˜æ²¡æ‰§è¡Œå®Œã€‚ä½†æ˜¯ï¼Œè¿™æ—¶å€™é”å·²ç»è¿‡æœŸäº†ï¼Œæ­¤æ—¶çº¿ç¨‹båˆè¯·æ±‚è¿‡æ¥ã€‚æ˜¾ç„¶çº¿ç¨‹bå°±å¯ä»¥è·å¾—é”æˆåŠŸï¼Œä¹Ÿå¼€å§‹æ‰§è¡Œä¸´ç•ŒåŒºçš„ä»£ç ã€‚é‚£ä¹ˆé—®é¢˜å°±æ¥äº†ï¼Œä¸´ç•ŒåŒºçš„ä¸šåŠ¡ä»£ç éƒ½ä¸æ˜¯ä¸¥æ ¼ä¸²è¡Œæ‰§è¡Œçš„å•¦ã€‚
*   é—®é¢˜äºŒï¼š**é”è¢«åˆ«çš„çº¿ç¨‹è¯¯åˆ **ã€‚å‡è®¾çº¿ç¨‹aæ‰§è¡Œå®Œåï¼Œå»é‡Šæ”¾é”ã€‚ä½†æ˜¯å®ƒä¸çŸ¥é“å½“å‰çš„é”å¯èƒ½æ˜¯çº¿ç¨‹bæŒæœ‰çš„ï¼ˆçº¿ç¨‹aå»é‡Šæ”¾é”æ—¶ï¼Œæœ‰å¯èƒ½è¿‡æœŸæ—¶é—´å·²ç»åˆ°äº†ï¼Œæ­¤æ—¶çº¿ç¨‹bè¿›æ¥å æœ‰äº†é”ï¼‰ã€‚é‚£çº¿ç¨‹aå°±æŠŠçº¿ç¨‹bçš„é”é‡Šæ”¾æ‰äº†ï¼Œä½†æ˜¯çº¿ç¨‹bä¸´ç•ŒåŒºä¸šåŠ¡ä»£ç å¯èƒ½éƒ½è¿˜æ²¡æ‰§è¡Œå®Œå‘¢ã€‚

### æ–¹æ¡ˆäº”ï¼šSET EX PX NX + æ ¡éªŒå”¯ä¸€éšæœºå€¼,å†åˆ é™¤

æ—¢ç„¶é”å¯èƒ½è¢«åˆ«çš„çº¿ç¨‹è¯¯åˆ ï¼Œé‚£æˆ‘ä»¬ç»™valueå€¼è®¾ç½®ä¸€ä¸ªæ ‡è®°å½“å‰çº¿ç¨‹å”¯ä¸€çš„éšæœºæ•°ï¼Œåœ¨åˆ é™¤çš„æ—¶å€™ï¼Œæ ¡éªŒä¸€ä¸‹ï¼Œä¸å°±OKäº†å˜›ã€‚ä¼ªä»£ç å¦‚ä¸‹ï¼š

```csharp
ifï¼ˆjedis.set(key_resource_id, uni_request_id, "NX", "EX", 100s) == 1ï¼‰{ //åŠ é”
    try {
    do something  //ä¸šåŠ¡å¤„ç†
        }catch(){
    }
        finally {
        //åˆ¤æ–­æ˜¯ä¸æ˜¯å½“å‰çº¿ç¨‹åŠ çš„é”,æ˜¯æ‰é‡Šæ”¾
            if (uni_request_id.equals(jedis.get(key_resource_id))) {
            jedis.del(lockKey); //é‡Šæ”¾é”
        }
    }
}
```

åœ¨è¿™é‡Œï¼Œ**åˆ¤æ–­æ˜¯ä¸æ˜¯å½“å‰çº¿ç¨‹åŠ çš„é”**å’Œ**é‡Šæ”¾é”**ä¸æ˜¯ä¸€ä¸ªåŸå­æ“ä½œã€‚å¦‚æœè°ƒç”¨jedis.del()é‡Šæ”¾é”çš„æ—¶å€™ï¼Œå¯èƒ½è¿™æŠŠé”å·²ç»ä¸å±äºå½“å‰å®¢æˆ·ç«¯ï¼Œä¼šè§£é™¤ä»–äººåŠ çš„é”ã€‚

![](/images/jueJin/9237655e6b1a470.png)

ä¸ºäº†æ›´ä¸¥è°¨ï¼Œä¸€èˆ¬ä¹Ÿæ˜¯ç”¨luaè„šæœ¬ä»£æ›¿ã€‚luaè„šæœ¬å¦‚ä¸‹ï¼š

```vbnet
if redis.call('get',KEYS[1]) == ARGV[1] then
return redis.call('del',KEYS[1])
else
return 0
end;
```

### Redisåˆ†å¸ƒå¼é”æ–¹æ¡ˆå…­ï¼šRedissonæ¡†æ¶

æ–¹æ¡ˆäº”è¿˜æ˜¯å¯èƒ½å­˜åœ¨**é”è¿‡æœŸé‡Šæ”¾ï¼Œä¸šåŠ¡æ²¡æ‰§è¡Œå®Œ**çš„é—®é¢˜ã€‚æœ‰äº›å°ä¼™ä¼´è®¤ä¸ºï¼Œç¨å¾®æŠŠé”è¿‡æœŸæ—¶é—´è®¾ç½®é•¿ä¸€äº›å°±å¯ä»¥å•¦ã€‚å…¶å®æˆ‘ä»¬è®¾æƒ³ä¸€ä¸‹ï¼Œæ˜¯å¦å¯ä»¥ç»™è·å¾—é”çš„çº¿ç¨‹ï¼Œå¼€å¯ä¸€ä¸ªå®šæ—¶å®ˆæŠ¤çº¿ç¨‹ï¼Œæ¯éš”ä¸€æ®µæ—¶é—´æ£€æŸ¥é”æ˜¯å¦è¿˜å­˜åœ¨ï¼Œå­˜åœ¨åˆ™å¯¹é”çš„è¿‡æœŸæ—¶é—´å»¶é•¿ï¼Œé˜²æ­¢é”è¿‡æœŸæå‰é‡Šæ”¾ã€‚

å½“å‰å¼€æºæ¡†æ¶Redissonè§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚æˆ‘ä»¬ä¸€èµ·æ¥çœ‹ä¸‹Redissonåº•å±‚åŸç†å›¾å§ï¼š

![](/images/jueJin/367cd1a7a3fb4d3.png)

åªè¦çº¿ç¨‹ä¸€åŠ é”æˆåŠŸï¼Œå°±ä¼šå¯åŠ¨ä¸€ä¸ª`watch dog`çœ‹é—¨ç‹—ï¼Œå®ƒæ˜¯ä¸€ä¸ªåå°çº¿ç¨‹ï¼Œä¼šæ¯éš”10ç§’æ£€æŸ¥ä¸€ä¸‹ï¼Œå¦‚æœçº¿ç¨‹1è¿˜æŒæœ‰é”ï¼Œé‚£ä¹ˆå°±ä¼šä¸æ–­çš„å»¶é•¿é”keyçš„ç”Ÿå­˜æ—¶é—´ã€‚å› æ­¤ï¼ŒRedissonå°±æ˜¯ä½¿ç”¨Redissonè§£å†³äº†**é”è¿‡æœŸé‡Šæ”¾ï¼Œä¸šåŠ¡æ²¡æ‰§è¡Œå®Œ**é—®é¢˜ã€‚

### Redisåˆ†å¸ƒå¼é”æ–¹æ¡ˆä¸ƒï¼šå¤šæœºå®ç°çš„åˆ†å¸ƒå¼é”Redlock+Redisson

å‰é¢å…­ç§æ–¹æ¡ˆéƒ½åªæ˜¯åŸºäºå•æœºç‰ˆçš„è®¨è®ºï¼Œè¿˜ä¸æ˜¯å¾ˆå®Œç¾ã€‚å…¶å®Redisä¸€èˆ¬éƒ½æ˜¯é›†ç¾¤éƒ¨ç½²çš„ï¼š

![](/images/jueJin/7349794feeee458.png)

å¦‚æœçº¿ç¨‹ä¸€åœ¨Redisçš„masterèŠ‚ç‚¹ä¸Šæ‹¿åˆ°äº†é”ï¼Œä½†æ˜¯åŠ é”çš„keyè¿˜æ²¡åŒæ­¥åˆ°slaveèŠ‚ç‚¹ã€‚æ°å¥½è¿™æ—¶ï¼ŒmasterèŠ‚ç‚¹å‘ç”Ÿæ•…éšœï¼Œä¸€ä¸ªslaveèŠ‚ç‚¹å°±ä¼šå‡çº§ä¸ºmasterèŠ‚ç‚¹ã€‚çº¿ç¨‹äºŒå°±å¯ä»¥è·å–åŒä¸ªkeyçš„é”å•¦ï¼Œä½†çº¿ç¨‹ä¸€ä¹Ÿå·²ç»æ‹¿åˆ°é”äº†ï¼Œé”çš„å®‰å…¨æ€§å°±æ²¡äº†ã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒRedisä½œè€… antirezæå‡ºä¸€ç§é«˜çº§çš„åˆ†å¸ƒå¼é”ç®—æ³•ï¼šRedlockã€‚Redlockæ ¸å¿ƒæ€æƒ³æ˜¯è¿™æ ·çš„ï¼š

> æå¤šä¸ªRedis masteréƒ¨ç½²ï¼Œä»¥ä¿è¯å®ƒä»¬ä¸ä¼šåŒæ—¶å®•æ‰ã€‚å¹¶ä¸”è¿™äº›masterèŠ‚ç‚¹æ˜¯å®Œå…¨ç›¸äº’ç‹¬ç«‹çš„ï¼Œç›¸äº’ä¹‹é—´ä¸å­˜åœ¨æ•°æ®åŒæ­¥ã€‚åŒæ—¶ï¼Œéœ€è¦ç¡®ä¿åœ¨è¿™å¤šä¸ªmasterå®ä¾‹ä¸Šï¼Œæ˜¯ä¸åœ¨Rediså•å®ä¾‹ï¼Œä½¿ç”¨ç›¸åŒæ–¹æ³•æ¥è·å–å’Œé‡Šæ”¾é”ã€‚

æˆ‘ä»¬å‡è®¾å½“å‰æœ‰5ä¸ªRedis masterèŠ‚ç‚¹ï¼Œåœ¨5å°æœåŠ¡å™¨ä¸Šé¢è¿è¡Œè¿™äº›Rediså®ä¾‹ã€‚

![](/images/jueJin/0df0a36c7ccd439.png)

RedLockçš„å®ç°æ­¥éª¤:å¦‚ä¸‹

> *   1.è·å–å½“å‰æ—¶é—´ï¼Œä»¥æ¯«ç§’ä¸ºå•ä½ã€‚
> *   2.æŒ‰é¡ºåºå‘5ä¸ªmasterèŠ‚ç‚¹è¯·æ±‚åŠ é”ã€‚å®¢æˆ·ç«¯è®¾ç½®ç½‘ç»œè¿æ¥å’Œå“åº”è¶…æ—¶æ—¶é—´ï¼Œå¹¶ä¸”è¶…æ—¶æ—¶é—´è¦å°äºé”çš„å¤±æ•ˆæ—¶é—´ã€‚ï¼ˆå‡è®¾é”è‡ªåŠ¨å¤±æ•ˆæ—¶é—´ä¸º10ç§’ï¼Œåˆ™è¶…æ—¶æ—¶é—´ä¸€èˆ¬åœ¨5-50æ¯«ç§’ä¹‹é—´,æˆ‘ä»¬å°±å‡è®¾è¶…æ—¶æ—¶é—´æ˜¯50mså§ï¼‰ã€‚å¦‚æœè¶…æ—¶ï¼Œè·³è¿‡è¯¥masterèŠ‚ç‚¹ï¼Œå°½å¿«å»å°è¯•ä¸‹ä¸€ä¸ªmasterèŠ‚ç‚¹ã€‚
> *   3.å®¢æˆ·ç«¯ä½¿ç”¨å½“å‰æ—¶é—´å‡å»å¼€å§‹è·å–é”æ—¶é—´ï¼ˆå³æ­¥éª¤1è®°å½•çš„æ—¶é—´ï¼‰ï¼Œå¾—åˆ°è·å–é”ä½¿ç”¨çš„æ—¶é—´ã€‚å½“ä¸”ä»…å½“è¶…è¿‡ä¸€åŠï¼ˆN/2+1ï¼Œè¿™é‡Œæ˜¯5/2+1=3ä¸ªèŠ‚ç‚¹ï¼‰çš„Redis masterèŠ‚ç‚¹éƒ½è·å¾—é”ï¼Œå¹¶ä¸”ä½¿ç”¨çš„æ—¶é—´å°äºé”å¤±æ•ˆæ—¶é—´æ—¶ï¼Œé”æ‰ç®—è·å–æˆåŠŸã€‚ï¼ˆå¦‚ä¸Šå›¾ï¼Œ10s> 30ms+40ms+50ms+4m0s+50msï¼‰
> *   å¦‚æœå–åˆ°äº†é”ï¼Œkeyçš„çœŸæ­£æœ‰æ•ˆæ—¶é—´å°±å˜å•¦ï¼Œéœ€è¦å‡å»è·å–é”æ‰€ä½¿ç”¨çš„æ—¶é—´ã€‚
> *   å¦‚æœè·å–é”å¤±è´¥ï¼ˆæ²¡æœ‰åœ¨è‡³å°‘N/2+1ä¸ªmasterå®ä¾‹å–åˆ°é”ï¼Œæœ‰æˆ–è€…è·å–é”æ—¶é—´å·²ç»è¶…è¿‡äº†æœ‰æ•ˆæ—¶é—´ï¼‰ï¼Œå®¢æˆ·ç«¯è¦åœ¨æ‰€æœ‰çš„masterèŠ‚ç‚¹ä¸Šè§£é”ï¼ˆå³ä¾¿æœ‰äº›masterèŠ‚ç‚¹æ ¹æœ¬å°±æ²¡æœ‰åŠ é”æˆåŠŸï¼Œä¹Ÿéœ€è¦è§£é”ï¼Œä»¥é˜²æ­¢æœ‰äº›æ¼ç½‘ä¹‹é±¼ï¼‰ã€‚

ç®€åŒ–ä¸‹æ­¥éª¤å°±æ˜¯ï¼š

*   æŒ‰é¡ºåºå‘5ä¸ªmasterèŠ‚ç‚¹è¯·æ±‚åŠ é”
*   æ ¹æ®è®¾ç½®çš„è¶…æ—¶æ—¶é—´æ¥åˆ¤æ–­ï¼Œæ˜¯ä¸æ˜¯è¦è·³è¿‡è¯¥masterèŠ‚ç‚¹ã€‚
*   å¦‚æœå¤§äºç­‰äºä¸‰ä¸ªèŠ‚ç‚¹åŠ é”æˆåŠŸï¼Œå¹¶ä¸”ä½¿ç”¨çš„æ—¶é—´å°äºé”çš„æœ‰æ•ˆæœŸï¼Œå³å¯è®¤å®šåŠ é”æˆåŠŸå•¦ã€‚
*   å¦‚æœè·å–é”å¤±è´¥ï¼Œè§£é”ï¼

Redissonå®ç°äº†redLockç‰ˆæœ¬çš„é”ï¼Œæœ‰å…´è¶£çš„å°ä¼™ä¼´ï¼Œå¯ä»¥å»äº†è§£ä¸€ä¸‹å“ˆ~

### å…¬ä¼—å·

*   æ¬¢è¿å…³æ³¨å…¬ä¼—å·ï¼šæ¡ç”°èºçš„å°ç”·å­©

### å‚è€ƒä¸æ„Ÿè°¢

*   [redisç³»åˆ—ï¼šåˆ†å¸ƒå¼é”](https://juejin.cn/post/6844903656911798285 "https://juejin.cn/post/6844903656911798285")
*   [æµ…æ Redis åˆ†å¸ƒå¼é”è§£å†³æ–¹æ¡ˆ](https://link.juejin.cn?target=https%3A%2F%2Fwww.infoq.cn%2Farticle%2Fdvaaj71f4fbqsxmgvdce "https://www.infoq.cn/article/dvaaj71f4fbqsxmgvdce")
*   [ç»†è¯´Redisåˆ†å¸ƒå¼é”ğŸ”’](https://juejin.cn/post/6844904082860146695#heading-3 "https://juejin.cn/post/6844904082860146695#heading-3")
*   [Redlockï¼šRedisåˆ†å¸ƒå¼é”æœ€ç‰›é€¼çš„å®ç°](https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzU5ODUwNzY1Nw%3D%3D%26mid%3D2247484155%26idx%3D1%26sn%3D0c73f45f2f641ba0bf4399f57170ac9b%26scene%3D21%23wechat_redirect "https://mp.weixin.qq.com/s?__biz=MzU5ODUwNzY1Nw==&mid=2247484155&idx=1&sn=0c73f45f2f641ba0bf4399f57170ac9b&scene=21#wechat_redirect")