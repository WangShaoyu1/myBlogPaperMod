---
author: "捡田螺的小男孩"
title: "Java程序员必备基础：Java代码是怎么运行的？"
date: 2020-03-14
description: "作为一名Java程序员，我们需要知道Java代码是怎么运行的。最近复习了深入理解Java虚拟机这本书，做了一下笔记，希望对大家有帮助，如果有不正确的地方，欢迎提出，感激不尽。 类加载器把字节码加载到虚拟机的方法区。 我们都知道，java代码是运行在Java虚拟机上的。但是jav…"
tags: ["Java中文技术社区","前端开发社区","前端技术交流","前端框架教程","JavaScript 学习资源","CSS 技巧与最佳实践","HTML5 最新动态","前端工程师职业发展","开源前端项目","前端技术趋势"]
ShowReadingTime: "阅读7分钟"
weight: 1
selfDefined:"likes:31,comments:0,collects:54,views:3736,"
---
前言
--

作为一名Java程序员，我们需要知道Java代码是怎么运行的。最近复习了深入理解Java虚拟机这本书，做了一下笔记，希望对大家有帮助，如果有不正确的地方，欢迎提出，感激不尽。

### java 代码运行主要流程

![](/images/jueJin/170d8ec8912704b.png)

本文主要讲解流程如下：

*   java源文件编译为class字节码
*   类加载器把字节码加载到虚拟机的方法区。
*   运行时创建对象
*   方法调用，执行引擎解释为机器码
*   CPU执行指令
*   多线程切换上下文

### 编译

我们都知道，java代码是运行在Java虚拟机上的。但是java是一门面向对象的高级语言，它不仅语法非常复杂，抽象程度也非常高，并不能直接运行在计算机硬件机器上。

> Java虚拟机（Java Virtual Machine 简称JVM）是运行所有Java程序的抽象计算机，是Java语言的运行环境。

因此，在运行Java程序之前，需要编译器把代码编译成java虚拟机所能识别的指令程序，这就是Java字节码，即class文件。

所以，Java代码运行的第一步是：把Java源代码编译成.class 字节码文件。

![](/images/jueJin/170b5b6fcf36091.png)

### 类加载

在Class文件中描述的各种信息，需要被加载到虚拟机之后才能运行和使用。因此，需要把class字节码文件加载到Java虚拟机来。

> 虚拟机把描述类的数据从 Class 文件加载到内存，并对数据进行校验、转换解析和初始化，最终形成可以被虚拟机直接使用的 Java 类型，这就是虚拟机的**类加载**机制。

#### 加载

在**加载阶段**，虚拟机需要完成以下3件事情：

*   通过一个类的全限定名来获取定义此类的二进制字节流。
*   将这个字节流所代表的静态存储结构转化为方法区的运行时数据结构。
*   在内存中生成一个代表这个类的java.lang.Class对象，作为方法区这个类的各种数据的访问入口

**加载**阶段完成后，这些二进制字节流按照虚拟机所需的格式存储在**方法区**之中。

![](/images/jueJin/170cf3b76bd0b4b.png)

#### 验证

为了确保Class文件的字节流中包含的信息符合当前虚拟机的要求，不会危害虚拟机的安全，Java虚拟机对输入的字节流走**验证**过程。

验证阶段包括四个阶段：文件格式验证、元数据验证、字节码验证、符号引用验证。

![](/images/jueJin/170d3fd43cad42d.png)

*   **文件格式验证：** 验证字节流是否符合Class文件格式规范，如：是否以魔数0xCAFEBABE开头。
*   **元数据验证：** 对字节码描述的信息进行语义分析，如：这个类的父类是否继承了不允许被继承的类（被final修饰的类）；
*   **字节码验证：** 主要目的是通过数据流和控制流分析，确定程序语义是合法的、符合逻辑的。如：保证跳转指令不会跳转到方法体以外的字节码指令上。
*   **符号引用验证：** 发生在虚拟机将符号引用转化为直接引用的时候，如：校验符号引用中通过字符串描述的全限定名是否能找到对应的类。

#### 准备

准备阶段是正式为类变量分配内存并设置类变量初始值，这些变量所使用的内存都将在方法区中进行分配。如：

```
public static int value =123；
```

变量value在准备阶段过后的初始值是0而不是123。

#### 解析

解析阶段是虚拟机将常量池内的符号引用替换为直接引用的过程。

> 比如:com.User类引用com.Tool类，在编译时，User类不知道Tool类的实际内存地址，因此只能使用符号com.Tool(假设)来表示。而在类加载加载User类的时候，可以通过虚拟机获取Tool类的实际内存地址，因此便可以将符号com.Tool替换为Tool类的实际内存地址，即直接引用地址。

解析动作主要针对类或接口、字段、类方法、接口方法、方法类型、方法句柄和调用点限定符 7 类符号引用进行。

#### 初始化

到了初始化阶段，才真正开始执行类中定义的Java字节码。在这个阶段，则根据程序员通过程序制定的主观计划去初始化类变量和其他资源。

### 创建对象

Java虚拟机是如何执行字节码的呢？我们先来看一下运行时创建对象。

Java是面向对象的编程语言，程序的运行是以对象为调用单位的。

*   字节码文件加载到虚拟机的方法区后，在程序运行过程，通过 class字节码文件创建与其对应的对象信息 。
*   创建对象的方式有：new关键字，反射等。
*   Java堆内存是线程共享的区域，创建后的对象信息就保存在Java堆内存中。

![](/images/jueJin/170d83933c9cedc.png)

### 方法调用

JVM的调用单位是对象，但是真正执行功能性的代码还是对象上的方法。

在运行过程中，每当调用进入一个java方法，java虚拟机会在当前线程的java方法栈中生成一个栈帧，用以存放局部变量以及字节码的操作数。方法栈内存是线程私有的，每个线程都有自己的方法栈。如果对应的方法是本地方法，则对应的就是本地方法栈。

java运行时数据区域如下：

![](/images/jueJin/170d8679b75472f.png)

### 解释

当调用Java对象的某个方法时，JVM执行引擎会将该方法的字节码文件翻译成计算机所能识别的机器码，机器码信息保存在方法区中。翻译有解释执行和即时编译两种方式。

![](/images/jueJin/170d85de8bd670f.png)

两种翻译方式的区别如下：

![](/images/jueJin/170d6bb2b0e6c3d.png)

**解释执行**

来一行代码，解释一行，大部分不常用的代码，都是采用这种方式。

**即使编译**

对于部分热点代码，将一个方法包含的所有字节码翻译成机器指令，以提高java虚拟机的运行效率。

即时编译是建立经典的**二八定律**上，即20%代码占据了80%的计算资源。

### 执行指令

![](/images/jueJin/170d704d693c59c.png)

*   Java程序被加载入内存后，指令也在内存中了。
*   指令的指令寄存器IP，指向下一条待执行指令的地址。
*   CPU的控制单元根据IP寄存器的指向，将主存中的指令装载到指令寄存器，这些加载的指令就是一串二进制码，还需要译码器进行解码。
*   解码后，如果需要获取操作数，则从内存中取数据，调用运算单元进行计算。

### 多线程上下文切换

CPU一通上电，就会周而复始从内存中获取指令、译码、执行。

![](/images/jueJin/170d89077ad3ede.png)

*   为了支持多任务，CPU 将执行时间这个资源划分成时间片，每个程序执行一段时间。
*   java虚拟机的多线程是通过线程轮流切换分配处理执行时间的方式来实现的，在任何一个确定的时刻，一个处理器（对于多核处理器来说是一个内核）都只会执行一条程序中的指令。
*   假设当前线程在运行中，CPU分配的时间执行完了，总得保存运行过的结果信息吧，要不然白白浪费之前的工作了，因此，程序计数器（PC寄存器）作用体现出来了，它是一块较小的内存空间，线程私有，可以看作当前线程执行的字节码的行号指示器。当CPU又给它分配时间跑的时候，可以把数据恢复，接着上一次执行到的位置继续执行就可以了。

### 参考与感谢

*   《深入理解Java虚拟机》
*   [《结合操作系统，如何理解一行 Java 代码是怎么运行的》，作者董鹏](https://link.juejin.cn?target=https%3A%2F%2Ftime.geekbang.org%2Fdailylesson%2Fdetail%2F100028498%2F "https://time.geekbang.org/dailylesson/detail/100028498/")
*   [JVM系列：(一)Java代码是怎么运行的](https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzA3Nzg5MDM5NA%3D%3D%26mid%3D2647741929%26idx%3D1%26sn%3Dea2e41451bfe17e9f9400ee1c5ec9ee4%26chksm%3D876ee3dcb0196aca96cd5fc98f4d64da43e5e5e1a3907ab6ad3e0d79f76132d60ce61bd010b9%26token%3D186505993%26lang%3Dzh_CN%23rd "https://mp.weixin.qq.com/s?__biz=MzA3Nzg5MDM5NA==&mid=2647741929&idx=1&sn=ea2e41451bfe17e9f9400ee1c5ec9ee4&chksm=876ee3dcb0196aca96cd5fc98f4d64da43e5e5e1a3907ab6ad3e0d79f76132d60ce61bd010b9&token=186505993&lang=zh_CN#rd")

个人公众号
-----

![](/images/jueJin/16c381c89b127bb.png)

*   觉得写得好的小伙伴给个点赞+关注啦，谢谢~
*   如果有写得不正确的地方，麻烦指出，感激不尽。
*   同时非常期待小伙伴们能够关注我公众号，后面慢慢推出更好的干货~嘻嘻