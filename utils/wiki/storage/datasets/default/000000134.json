{
	"title": "大模型LLM+（有限）在线搜索",
	"author": "王宇",
	"publishTime": "八月10,2024",
	"readTime": "12s",
	"tags": "[\"GPT相关\"]",
	"description": "GPT相关",
	"article": "        众所周知，大模型的能力非常强，但是其训练数据是截至某个时间的数据，故对于某些需要搜索近期信息的场景，无法满足，这可以结合搜索引擎来弥补。同时，还可以结合某些/某个具体的网站来提供近期信息。比如说，某个用户输入，大模型无法回答，就调用知乎或者github或者其他专业网站上的信息。\n\n1\\. 需求描述\n========\n\nActor\n\n大模型LLM\n\nPrompt\n\n大模型知识库\n\n外部知识  \n向量库\n\n外部搜索\n\n补充：本需求先不探讨这个方向\n\n大模型能够回复\n\n大模型不能回复\n\n![](data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0Ij48cGF0aCBkPSJNMjEuOTkgNGMwLTEuMS0uODktMi0xLjk5LTJINGMtMS4xIDAtMiAuOS0yIDJ2MTJjMCAxLjEuOSAyIDIgMmgxNGw0IDQtLjAxLTE4ek0xOCAxNEg2di0yaDEydjJ6bTAtM0g2VjloMTJ2MnptMC0zSDZWNmgxMnYyeiIvPjxwYXRoIGQ9Ik0wIDBoMjR2MjRIMHoiIGZpbGw9Im5vbmUiLz48L3N2Zz4= \"显示评论\")\n\n//<!\\[CDATA\\[ (function() { $ = AJS.$; var graphContainer = document.getElementById('drawio-macro-content-3e866b00-a6ca-4dc8-8b3c-e2624395e867'); DrawioProperties = { contextPath : AJS.contextPath(), buildNumber : 8401 }; var readerOpts = {}; readerOpts.loadUrl = '' + '/rest/drawio/1.0/diagram/crud/%E6%9C%AA%E5%91%BD%E5%90%8D%E7%BB%98%E5%9B%BE/129181863?revision=2'; readerOpts.imageUrl = '' + '/download/attachments/129181863/未命名绘图.png' + '?version=2&api=v2'; readerOpts.editUrl = '' + '/plugins/drawio/addDiagram.action?ceoId=129181863&owningPageId=129181863&diagramName=%E6%9C%AA%E5%91%BD%E5%90%8D%E7%BB%98%E5%9B%BE&revision=2'; readerOpts.editable = true; readerOpts.canComment = true; readerOpts.stylePath = STYLE\\_PATH; readerOpts.stencilPath = STENCIL\\_PATH; readerOpts.imagePath = IMAGE\\_PATH + '/reader'; readerOpts.border = true; readerOpts.width = '600'; readerOpts.simpleViewer = false; readerOpts.tbstyle = 'top'; readerOpts.links = 'auto'; readerOpts.lightbox = true; readerOpts.resourcePath = ATLAS\\_RESOURCE\\_BASE + '/resources/viewer'; readerOpts.disableButtons = false; readerOpts.zoomToFit = true; readerOpts.language = 'zh'; readerOpts.licenseStatus = 'OK'; readerOpts.contextPath = AJS.contextPath(); readerOpts.diagramName = decodeURIComponent('%E6%9C%AA%E5%91%BD%E5%90%8D%E7%BB%98%E5%9B%BE'); readerOpts.diagramDisplayName = ''; readerOpts.aspect = ''; readerOpts.ceoName = '大模型LLM+（有限）在线搜索'; readerOpts.attVer = '2'; readerOpts.attId = '129181867'; readerOpts.lastModifierName = '王宇'; readerOpts.lastModified = '2024-07-14 22:17:20.791'; readerOpts.creatorName = '王宇'; //Embed macro specific info readerOpts.extSrvIntegType = '$extSrvIntegType'; readerOpts.gClientId = '$gClientId'; readerOpts.oClientId = '$oClientId'; readerOpts.service = '$service'; readerOpts.sFileId = '$sFileId'; readerOpts.odriveId = '$odriveId'; readerOpts.diagramUrl = '$diagramUrl'; readerOpts.csvFileUrl = '$csvFileUrl'; readerOpts.pageId = '$pageId' || Confluence.getContentId(); readerOpts.aspectHash = '$aspectHash'; readerOpts.useExternalImageService = '$useExternalImageService' == 'true'; readerOpts.isTemplate = '$isTemplate' == 'true'; if (readerOpts.width == '') { readerOpts.width = null; } // LATER: Check if delayed loading of resources can be used for image placeholder mode var viewerPromise = createViewer(graphContainer, readerOpts); if(readerOpts.editable) { $(graphContainer).data('viewerConfig', readerOpts); $(graphContainer).on('drawioViewerUpdate', updateDrawioViewer); } viewerPromise.done(function(viewer) { updateCachedDiagram(graphContainer, readerOpts, viewer); }); })(); //\\]\\]>\n\n2\\. 方案设计\n========\n\nActor\n\n大模型知识库\n\n搜索引擎能力  \n(谷歌)\n\n大模型LLM  \n判断\n\n1、爬取网站  \n2、获取具体内容\n\n内容存放在文件中\n\n大模型LLM推理，组合答案\n\nPrompt\n\n能\n\n不能\n\nFunction Calling\n\n目标网址\n\n知乎\n\nGithub\n\nCSDN\n\nStackOverFlow\n\nHuggingFace\n\n......\n\n![](data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0Ij48cGF0aCBkPSJNMjEuOTkgNGMwLTEuMS0uODktMi0xLjk5LTJINGMtMS4xIDAtMiAuOS0yIDJ2MTJjMCAxLjEuOSAyIDIgMmgxNGw0IDQtLjAxLTE4ek0xOCAxNEg2di0yaDEydjJ6bTAtM0g2VjloMTJ2MnptMC0zSDZWNmgxMnYyeiIvPjxwYXRoIGQ9Ik0wIDBoMjR2MjRIMHoiIGZpbGw9Im5vbmUiLz48L3N2Zz4= \"显示评论\")\n\n//<!\\[CDATA\\[ (function() { $ = AJS.$; var graphContainer = document.getElementById('drawio-macro-content-17c00d34-7b64-4e82-924c-c1515904e05a'); DrawioProperties = { contextPath : AJS.contextPath(), buildNumber : 8401 }; var readerOpts = {}; readerOpts.loadUrl = '' + '/rest/drawio/1.0/diagram/crud/%31%31/129181863?revision=1'; readerOpts.imageUrl = '' + '/download/attachments/129181863/11.png' + '?version=1&api=v2'; readerOpts.editUrl = '' + '/plugins/drawio/addDiagram.action?ceoId=129181863&owningPageId=129181863&diagramName=%31%31&revision=1'; readerOpts.editable = true; readerOpts.canComment = true; readerOpts.stylePath = STYLE\\_PATH; readerOpts.stencilPath = STENCIL\\_PATH; readerOpts.imagePath = IMAGE\\_PATH + '/reader'; readerOpts.border = true; readerOpts.width = '600'; readerOpts.simpleViewer = false; readerOpts.tbstyle = 'top'; readerOpts.links = 'auto'; readerOpts.lightbox = true; readerOpts.resourcePath = ATLAS\\_RESOURCE\\_BASE + '/resources/viewer'; readerOpts.disableButtons = false; readerOpts.zoomToFit = true; readerOpts.language = 'zh'; readerOpts.licenseStatus = 'OK'; readerOpts.contextPath = AJS.contextPath(); readerOpts.diagramName = decodeURIComponent('%31%31'); readerOpts.diagramDisplayName = ''; readerOpts.aspect = ''; readerOpts.ceoName = '大模型LLM+（有限）在线搜索'; readerOpts.attVer = '1'; readerOpts.attId = '129181878'; readerOpts.lastModifierName = '王宇'; readerOpts.lastModified = '2024-07-14 22:45:25.331'; readerOpts.creatorName = '王宇'; //Embed macro specific info readerOpts.extSrvIntegType = '$extSrvIntegType'; readerOpts.gClientId = '$gClientId'; readerOpts.oClientId = '$oClientId'; readerOpts.service = '$service'; readerOpts.sFileId = '$sFileId'; readerOpts.odriveId = '$odriveId'; readerOpts.diagramUrl = '$diagramUrl'; readerOpts.csvFileUrl = '$csvFileUrl'; readerOpts.pageId = '$pageId' || Confluence.getContentId(); readerOpts.aspectHash = '$aspectHash'; readerOpts.useExternalImageService = '$useExternalImageService' == 'true'; readerOpts.isTemplate = '$isTemplate' == 'true'; if (readerOpts.width == '') { readerOpts.width = null; } // LATER: Check if delayed loading of resources can be used for image placeholder mode var viewerPromise = createViewer(graphContainer, readerOpts); if(readerOpts.editable) { $(graphContainer).data('viewerConfig', readerOpts); $(graphContainer).on('drawioViewerUpdate', updateDrawioViewer); } viewerPromise.done(function(viewer) { updateCachedDiagram(graphContainer, readerOpts, viewer); }); })(); //\\]\\]>\n\n2.1. 技术选型\n---------\n\n功能模块\n\n技术选型\n\n备注\n\n功能模块\n\n技术选型\n\n备注\n\n大模型\n\nGPT模型/GLM4大模型/其他模型\n\n调用API的方法，目前绝大部分模型都和GPT系列差不多。考虑到获取API\\_KEY操作的方便性，本文选用智谱AI的API\n\n搜索技术\n\n谷歌搜索API、爬虫\n\n也可以用其他的搜索。如：DuckDuckGo\n\n性能优化\n\n提示词工程\n\n针对不同的网站，提示词可以进一步优化\n\n  \n\n  \n\n  \n\n2.2. 谷歌云平台注册\n------------\n\n### 2.2.1. 第一步：获取API\\_KEY\n\n访问地址：[https://console.cloud.google.com/](https://console.cloud.google.com/)\n\n操作步骤如下：  \n  \n\n  \n\n第一步\n\n第二步\n\n第三步\n\n第四步\n\n第五步\n\n第六步\n\n![](/download/thumbnails/129181863/image2024-7-14_22-51-48.png?version=1&modificationDate=1720968708407&api=v2)\n\n![](/download/thumbnails/129181863/image2024-7-14_22-52-41.png?version=1&modificationDate=1720968761954&api=v2)\n\n  \n\n![](/download/thumbnails/129181863/image2024-7-14_22-53-31.png?version=1&modificationDate=1720968811749&api=v2)\n\n![](/download/thumbnails/129181863/image2024-7-14_22-56-34.png?version=1&modificationDate=1720968994372&api=v2)\n\n![](/download/thumbnails/129181863/image2024-7-14_22-57-19.png?version=1&modificationDate=1720969039726&api=v2)\n\n![](/download/thumbnails/129181863/image2024-7-14_22-59-17.png?version=1&modificationDate=1720969157865&api=v2)\n\n第七步\n\n第八步\n\n第九步\n\n第十步\n\n  \n\n  \n\n![](/download/thumbnails/129181863/image2024-7-14_23-1-52.png?version=1&modificationDate=1720969312873&api=v2)\n\n![](/download/thumbnails/129181863/image2024-7-14_23-6-16.png?version=1&modificationDate=1720969576876&api=v2)\n\n![](/download/thumbnails/129181863/image2024-7-14_23-6-43.png?version=1&modificationDate=1720969604151&api=v2)\n\n![](/download/thumbnails/129181863/image2024-7-14_23-7-0.png?version=1&modificationDate=1720969620622&api=v2)\n\n![](/download/thumbnails/129181863/image2024-7-14_23-8-47.png?version=1&modificationDate=1720969728209&api=v2)\n\n  \n\n### 2.2.2. 第二步：注册可编程的搜索引擎\n\n访问地址：[https://programmablesearchengine.google.com/](https://programmablesearchengine.google.com/)\n\n第一步\n\n第二步\n\n第三步\n\n第一步\n\n第二步\n\n第三步\n\n![](/download/attachments/129181863/image2024-7-14_23-18-59.png?version=1&modificationDate=1720970339800&api=v2)\n\n![](/download/attachments/129181863/image2024-7-14_23-19-47.png?version=1&modificationDate=1720970388167&api=v2)\n\n  \n\n![](/download/attachments/129181863/image2024-7-14_23-22-26.png?version=1&modificationDate=1720970547035&api=v2)\n\n经过这两个步骤，就能够完成谷歌搜索的API调用了，有两个地方需要注意下：\n\n*   搜索引擎可以选择在指定域名下搜索，见2.2.2第二步\n*   谷歌搜索API每天免费使用100次，见：[https://developers.google.com/custom-search/v1/overview?hl=zh\\_CN](https://developers.google.com/custom-search/v1/overview?hl=zh_CN)\n\n### 2.2.3. 谷歌搜索API的使用\n\n请求网址为：[https://www.googleapis.com/customsearch/v1?\\[parameters](https://www.googleapis.com/customsearch/v1?[parameters)\\]\n\n具体的使用文档见：[https://developers.google.com/custom-search/v1/using\\_rest?hl=zh-cn](https://developers.google.com/custom-search/v1/using_rest?hl=zh-cn)\n\n详细的字段说明文档见：[https://developers.google.com/custom-search/v1/reference/rest/v1/cse/list#request](https://developers.google.com/custom-search/v1/reference/rest/v1/cse/list#request)\n\n常用参数解析：\n\n参数名\n\n详情\n\n备注\n\n参数名\n\n详情\n\n备注\n\nkey\n\n谷歌搜索API密钥，详见：2.2.1步骤\n\n必填\n\ncx\n\n可编程搜索引擎ID，详见：2.2.2步骤\n\n必填\n\nq\n\n搜索内容表达式\n\n必填\n\nc2coff\n\n启用或停用简体中文，默认为0（启用）\n\n0：启用  \n1：停用\n\ncr\n\n将搜索结果限制为来自特定国家/地区的文档\n\n1、国家 /地区标识查询：[https://developers.google.com/custom-search/docs/json\\_api\\_reference?hl=zh-cn#countryCollections](https://developers.google.com/custom-search/docs/json_api_reference?hl=zh-cn#countryCollections)\n\n2、Google 搜索通过分析以下内容来确定文档所在的国家/地区：\n\n*   文档网址的顶级域名 (TLD)\n    \n*   Web 服务器 IP 地址的地理位置\n    \n\ndateRestrict\n\n搜索特定时间段\n\n  \n\nlr\n\n搜索以特定语言撰写的文档\n\n  \n\nnum\n\n要返回的搜索结果数\n\n有效值为 1 到 10 之间的整数（包括 1 和 10）\n\nsiteSearch\n\n指定应始终从结果中包含或排除的给定网站\n\n结合下面的siteSearchFilter\n\nsiteSearchFilter\n\n``enum (`[SiteSearchFilter](https://developers.google.com/custom-search/v1/reference/rest/v1/SiteSearchFilter?hl=zh-cn)`)``\n\n控制是否包含或排除 `siteSearch` 参数中指定的网站的结果。\n\n可接受的值为：\n\n*   `\"e\"`：排除\n    \n*   `\"i\"`：包含\n    \n\n默认为：`\"i\"：包含`\n\n  \n\n  \n\n  \n\n3\\. 具体实现（含代码）\n=============\n\n3.1. ZhiPu AI GPT模型（示例）\n-----------------------\n\n智谱AI官网：[https://bigmodel.cn/](https://bigmodel.cn/)，注册一个账号，登录进去，进入 “开发工作台”，很方便就能获取到API\\_KEY\n\n一个最简版本的请求如下：\n\n[?](#)\n\n1\n\n2\n\n3\n\n4\n\n5\n\n6\n\n7\n\n8\n\n9\n\n10\n\n11\n\n12\n\n13\n\n14\n\n15\n\n16\n\n`ffrom zhipuai` `import` `ZhipuAI`\n\n`client` `=` `ZhipuAI(api_key``=``api_key)`\n\n`def` `chat_completion_request(messages, tools``=``None``, tool_choice``=``None``, model``=``GPT_MODEL):`\n\n    `try``:`\n\n        `response` `=` `client.chat.completions.create(`\n\n            `model``=``model,`\n\n            `messages``=``messages,`\n\n            `tools``=``tools,`\n\n            `tool_choice``=``tool_choice,`\n\n        `)`\n\n        `return` `response`\n\n    `except` `Exception as e:`\n\n        `print``(``\"Unable to generate ChatCompletion response\"``)`\n\n        `print``(f``\"Exception: {e}\"``)`\n\n        `return` `e`\n\n在一步中，需要用到ZhiPu的Function calling功能，以实现，如果大模型能回答则直接回答，如果不能回答就执行Function Calling。其中需要关注的有两点：\n\n1.  ZhiPu GPT的Function Calling的写法\n2.  提示词上需要实现如上流程流转\n\n补充上Function calling实现：\n\n[?](#)\n\n1\n\n`/``/` `定义Tool，函数定义`\n\n3.2. 一些测试\n---------\n\n### 3.2.1. 大模型回答问题策略测试\n\n#### 3.2.1.1. 提示词\n\n[?](#)\n\n1\n\n2\n\n3\n\n4\n\n5\n\n6\n\n7\n\n8\n\n9\n\n10\n\n11\n\n`response` `=` `client.chat.completions.create(`\n\n  `model``=``\"glm-4\"``,`\n\n  `messages``=``[`\n\n    `{``\"role\"``:` `\"system\"``,` `\"content\"``:` `\"根据用户输入的问题进行回答，如果知道问题的答案，请回答问题答案，如果不知道问题答案，请回复‘抱歉，这个问题我并不知道’\"``},`\n\n    `{``\"role\"``:` `\"user\"``,` `\"content\"``:` `\"请问，什么是机器学习？\"``}`\n\n  `]`\n\n`)`\n\n`response.choices[``0``].message.content`\n\n`-``-``-``output`\n\n`'机器学习是人工智能的一个核心领域，它让计算机能够模拟人类的学习和思考方式。通过使用大量数据和算法，机器学习可以使计算机学会分类、回归和聚类等任务，从而让计算机能够从数据中提取知识，进行决策和预测。在机器学习的流程中，包括数据获取、特征工程、建立模型、模型评估以及调参等步骤。深度学习和强化学习是机器学习的两个重要分支。深度学习主要用于处理复杂结构数据的建模问题，而强化学习则让机器在探索环境中通过试错进行学习。'`\n\n[?](#)\n\n1\n\n2\n\n3\n\n4\n\n5\n\n6\n\n7\n\n8\n\n9\n\n10\n\n11\n\n`response` `=` `client.chat.completions.create(`\n\n  `model``=``\"glm-4\"``,`\n\n  `messages``=``[`\n\n    `{``\"role\"``:` `\"system\"``,` `\"content\"``:` `\"根据用户输入的问题进行回答，如果知道问题的答案，请回答问题答案，如果不知道问题答案，请回复‘抱歉，这个问题我并不知道’\"``},`\n\n    `{``\"role\"``:` `\"user\"``,` `\"content\"``:` `\"介绍一下关于GPT-6的猜想\"``}`\n\n  `]`\n\n`)`\n\n`response.choices[``0``].message.content`\n\n`-``-``-``output`\n\n`'抱歉，这个问题我并不知道。\\n\\n到2023为止，GPT-6尚未被公开提及或发布。GPT（Generative Pre-trained Transformer）系列模型由OpenAI开发，至今已发布了多个版本，如GPT-2和GPT-3。关于未来版本的GPT，如GPT-6，可能会有很多猜想和预期，但具体的内容和功能我无法提供，因为那将基于未来尚未公开的技术和信息。如果GPT-6在您提问之后有了新的消息，我可能无法获取那些最新的信息。'`\n\n#### 3.2.1.2. 增加外部函数\n\n测试的目的是：检测增加了外部函数的情况下，glm4回答同一个问题的时候，是不是都倾向于走外部函数\n\n外部函数：有参数定义、函数描述、返回值\n\n智谱的tools格式为：\n\n[?](#)\n\n1\n\n2\n\n3\n\n4\n\n5\n\n6\n\n7\n\n8\n\n9\n\n10\n\n11\n\n12\n\n13\n\n`tools` `=` `[`\n\n    `{`\n\n        `\"type\"``:` `\"function\"``,`\n\n        `\"function\"``: {`\n\n            `\"name\"``:` `\"get_flight_number\"``,`\n\n            `\"description\"``:` `\"根据始发地、目的地和日期，查询对应日期的航班号\"``,`\n\n            `\"parameters\"``: {`\n\n                `......`\n\n            `},`\n\n        `}`\n\n    `}，`\n\n    `...`\n\n`]`\n\n测试函数为：\n\n[?](#)\n\n1\n\n2\n\n3\n\n4\n\n5\n\n6\n\n7\n\n`def` `ml_answer(q``=``'什么是机器学习'``):`\n\n    `\"\"\"`\n\n    `解释什么是机器学习，返回机器学习的定义和解释`\n\n    `:param q: 询问的问题，非必要参数，字符串类型对象`\n\n    `:return：返回机器学习的定义和解释`\n\n    `\"\"\"`\n\n    `return``(``\"机器学习是一种人工智能（AI）的分支领域，旨在使计算机系统通过学习和经验改进性能。\"``)`\n\n现在将测试函数转化为tool需要的格式，写一个转换函数，里面也会用到glm4：\n\n**auto\\_functions生成tool需要的格式**  展开源码\n\n[expand source](#)[?](#)\n\n1\n\n2\n\n3\n\n4\n\n5\n\n6\n\n7\n\n8\n\n9\n\n10\n\n11\n\n12\n\n13\n\n14\n\n15\n\n16\n\n17\n\n18\n\n19\n\n20\n\n21\n\n22\n\n23\n\n24\n\n25\n\n26\n\n27\n\n28\n\n29\n\n30\n\n31\n\n32\n\n33\n\n34\n\n35\n\n36\n\n37\n\n38\n\n39\n\n40\n\n41\n\n42\n\n43\n\n44\n\n45\n\n46\n\n47\n\n48\n\n49\n\n50\n\n51\n\n52\n\n53\n\n`def` `auto_functions(functions_list):`\n\n    `\"\"\"`\n\n    `Chat模型的functions参数编写函数`\n\n    `:param functions_list: 包含一个或者多个函数对象的列表；`\n\n    `:return：满足Chat模型functions参数要求的functions对象`\n\n    `\"\"\"`\n\n    `def` `functions_generate(functions_list):`\n\n        `# 创建空列表，用于保存每个函数的描述字典`\n\n        `functions` `=` `[]`\n\n        `# 对每个外部函数进行循环`\n\n        `for` `function` `in` `functions_list:`\n\n            `# 读取函数对象的函数说明`\n\n            `function_description` `=` `inspect.getdoc(function)`\n\n            `# 读取函数的函数名字符串`\n\n            `function_name` `=` `function.__name__`\n\n            `system_prompt` `=` `'以下是某的函数说明：%s,输出结果必须是一个JSON格式的字典，只输出这个字典即可，前后不需要任何前后修饰或说明的语句'` `%` `function_description`\n\n            `user_prompt` `=` `'根据这个函数的函数说明，请帮我创建一个JSON格式的字典，这个字典有如下``5``点要求：\\`\n\n                           `1.``字典总共有三个键值对；\\`\n\n                           `2.``第一个键值对的Key是字符串name，value是该函数的名字：``%``s，也是字符串；\\`\n\n                           `3.``第二个键值对的Key是字符串description，value是该函数的函数的功能说明，也是字符串；\\`\n\n                           `4.``第三个键值对的Key是字符串parameters，value是一个JSON Schema对象，用于说明该函数的参数输入规范。\\`\n\n                           `5.``输出结果必须是一个JSON格式的字典，只输出这个字典即可，前后不需要任何前后修饰或说明的语句'` `%` `function_name`\n\n            `response` `=` `client.chat.completions.create(`\n\n                              `model``=``\"glm-4\"``,`\n\n                              `messages``=``[`\n\n                                `{``\"role\"``:` `\"system\"``,` `\"content\"``: system_prompt},`\n\n                                `{``\"role\"``:` `\"user\"``,` `\"content\"``: user_prompt}`\n\n                              `]`\n\n                            `)`\n\n            `json_str``=``response.choices[``0``].message.content.replace(``\"```json\"``,\"``\").replace(\"`` ``` ``\",\"``\")`\n\n            `json_function_description``=``json.loads(json_str)`\n\n            `json_str``=``{``\"type\"``:` `\"function\"``,``\"function\"``:json_function_description}`\n\n            `functions.append(json_str)`\n\n        `return` `functions`\n\n    `## 最大可以尝试4次`\n\n    `max_attempts` `=` `4`\n\n    `attempts` `=` `0`\n\n    `while` `attempts < max_attempts:`\n\n        `try``:`\n\n            `functions` `=` `functions_generate(functions_list)`\n\n            `break`  `# 如果代码成功执行，跳出循环`\n\n        `except` `Exception as e:`\n\n            `attempts` `+``=` `1`  `# 增加尝试次数`\n\n            `print``(``\"发生错误：\"``, e)`\n\n            `if` `attempts` `=``=` `max_attempts:`\n\n                `print``(``\"已达到最大尝试次数，程序终止。\"``)`\n\n                `raise`  `# 重新引发最后一个异常`\n\n            `else``:`\n\n                `print``(``\"正在重新运行...\"``)`\n\n    `return` `functions`\n\n执行auto\\_function(\\[ml\\_answer\\])，能够生成tool需要的格式。接下来测试面对一个问题，在有外部函数能执行functuon call的情况下，到底是执行function call呢还是大模型直接执行。\n\n直接执行glm4执行函数，发现面对同一个问题“什么是机器学习”，有时候直接回答，有时候通过外部函数回答，要解决这个不稳定的问题\n\n**glm4执行**  展开源码\n\n[expand source](#)[?](#)\n\n1\n\n2\n\n3\n\n4\n\n5\n\n6\n\n7\n\n8\n\n9\n\n`response` `=` `client.chat.completions.create(`\n\n        `model``=``\"glm-4\"``,`\n\n        `messages``=``[`\n\n            `{``\"role\"``:` `\"user\"``,` `\"content\"``:` `\"解释什么是机器学习？\"``}`\n\n        `],`\n\n        `tools``=``tools,`\n\n        `tool_choice``=``\"auto\"`\n\n    `)`\n\n`response.choices[``0``].message`\n\n提示词很细腻，轻微的差别，也许回复就会差别很大，\n\n提示词1：system\\_prompt \\= '以下是某函数的函数说明：%s，输出结果必须是一个JSON格式的字典，只输出这个字典即可，前后不需要任何修饰或说明的语句' % function\\_description\n\n提示词2：system\\_prompt \\= '以下是某函数的函数说明：%s，输出结果必须是一个JSON格式的字典，只输出这个字典即可，前后不需要任何前后修饰或说明的语句' % function\\_description\n\n提示词1返回结果为：\n\n**glm4执行**  展开源码\n\n[expand source](#)[?](#)\n\n1\n\n2\n\n3\n\n4\n\n5\n\n6\n\n7\n\n8\n\n9\n\n10\n\n11\n\n12\n\n13\n\n14\n\n15\n\n16\n\n17\n\n18\n\n19\n\n20\n\n21\n\n22\n\n23\n\n24\n\n25\n\n`以下是符合您要求的JSON格式字典：`\n\n` ```json `\n\n`{`\n\n`\"name\"``:` `\"sunwukong_function\"``,`\n\n`\"description\"``:` `\"该函数定义了数据集计算过程，接受数据表作为输入，并返回计算后的结果。\"``,`\n\n`\"parameters\"``: {`\n\n`\"type\"``:` `\"object\"``,`\n\n`\"required\"``: [``\"data\"``],`\n\n`\"properties\"``: {`\n\n`\"data\"``: {`\n\n`\"type\"``:` `\"string\"``,`\n\n`\"description\"``:` `\"带入计算的数据表，用字符串进行表示\"`\n\n`}`\n\n`},`\n\n`\"additionalProperties\"``: false`\n\n`}`\n\n`}`\n\n` ``` `\n\n`这个JSON对象包含三个键值对：`\n\n`1.` `` ` ```\"name\"``` ` 键对应着函数的名字。 ``\n\n`2.` `` ` ```\"description\"``` ` 键提供了函数的功能说明。 ``\n\n`3.` `` ` ```\"parameters\"``` ` 键包含一个JSON Schema对象，描述了函数的参数输入规范，包括数据类型和描述，并指出` ```\"data\"``` `参数是必须的（` ```\"required\"``: [``\"data\"``` ]`）。此外，` ```\"additionalProperties\"```: false`确保没有其他额外的参数被传入函数。``\n\n提示词2返回结果为：\n\n**glm4执行**  展开源码\n\n[expand source](#)[?](#)\n\n1\n\n2\n\n3\n\n4\n\n5\n\n6\n\n7\n\n8\n\n9\n\n10\n\n11\n\n12\n\n13\n\n14\n\n`{`\n\n  `\"name\"``:` `\"sunwukong_function\"``,`\n\n  `\"description\"``:` `\"该函数定义了数据集计算过程，接收一个数据表作为输入，并返回计算后的结果。\"``,`\n\n  `\"parameters\"``: {`\n\n    `\"type\"``:` `\"object\"``,`\n\n    `\"properties\"``: {`\n\n      `\"data\"``: {`\n\n        `\"type\"``:` `\"string\"``,`\n\n        `\"description\"``:` `\"必要参数，表示带入计算的数据表，用字符串进行表示\"`\n\n      `}`\n\n    `},`\n\n    `\"required\"``: [``\"data\"``]`\n\n  `}`\n\n`}`\n\n提示词2的输出100%是json格式的内容，而提示词1的输出内容中，每次都包含前后的修饰性的中文，当然也包含JSON部分的内容，夹在在一起。而这两份提示词之间的区别，就是提示词2多了两个字“前后”，差别却很大。\n\n工程上的处理，其实要预防着 输出的文本不只是 纯字符串类型的JSON格式的内容，抽取夹杂着修饰性文本+JSON格式内容字符串的，而不能完全依赖大模型的返回。可以保险期间，如果结果是需要代码块的，需要执行代码提取函数。函数如下：\n\n**extract\\_code\\_block提取代码块**\n\n[?](#)\n\n1\n\n2\n\n3\n\n4\n\n5\n\n6\n\n7\n\n8\n\n9\n\n10\n\n11\n\n12\n\n13\n\n14\n\n15\n\n`def` `extract_code_block(text, language):`\n\n    `\"\"\"`\n\n    `提取文本中的指定语言的代码块，并返回代码块的字符串内容。`\n\n    `:param text: 包含代码块的字符串`\n\n    `:param language: 代码块语言标记，例如'json', 'python', 'java'等`\n\n    `:return: 提取的代码块内容字符串，如果未找到则返回None`\n\n    `\"\"\"`\n\n    `pattern` `=` `re.``compile``(rf``'```{language}\\n(.*?)\\n```'``, re.DOTALL)`\n\n    `match` `=` `pattern.search(text)`\n\n    `if` `match:`\n\n        `return` `match.group(``1``)`\n\n    `else``:`\n\n        `print``(f``\"未找到 {language} 代码块\"``)`\n\n        `return` `None`\n\n3.3. 增加外部函数回复稳定性\n----------------\n\n  \n\n  \n\n  \n\n  \n\n  \n\n[Filter table data](#)[Create a pivot table](#)[Create a chart from data series](#)\n\n[Configure buttons visibility](/users/tfac-settings.action)"
}