{
	"title": "大模型知识问答技术实践方案总结",
	"author": "王宇",
	"publishTime": "八月21,2024",
	"readTime": "12s",
	"tags": "[\"知识插件\"]",
	"description": "知识插件",
	"article": "1\\. 文档拆分与处理\n===========\n\n1.1. 文档拆分\n---------\n\n### 1.1.1. 粒度分级\n\n*   **FAQ 类型/短文本文档：**直接按照一问一答的粒度拆分。\n*   **长文本/带章节标题的书籍类文档**：需要分级（段落、各章节）进行拆分。\n*   **结构化/表格数据类文档：**按列、行进行拆分。\n\n### 1.1.2. 基本原则\n\n*   **整体拆分原则：**保证语义完整性、一致性。\n*   **FAQ 类长度限制：**最长不能超过750个词（太长的内容做摘要），最短不能少于1个词（过短的内容去除）。\n*   **长文本类长度限制：**最长不能超过400个词（太长的内容做摘要），最短段落级内容长度不能少于30个词，章节级内容长度不能少于50个词（过短的内容去除）。\n*   **表格类长度限制：**最长不能超过400个词，最短表格内容不能为空。\n\n### 1.1.3. 拆分方式\n\n*   **FAQ 类型文档：**根据每一条问题+答案之间的分隔符进行拆分，该类文件可以是具有明确分隔符的 txt\\\\doc\\\\docx 文本形式，也可以是带表头区分的表格形式。通常问题和答案都可以作为检索知识入库，故可以拼接每一对问题+答案作为一条独立的知识，常以换行符（\\\\n）作为每条知识的分隔符。\n*   **长文本类文档：**该类文件一般要求是带不同层级标题的docx或doc文本，先按段落进行拆分，然后单独拆分每个章节下的文本。通常需要在文本中引入各级标题信息，增强文本的语义完整性。因为涉及多级拆分，所以还需要对各级内容进行去重，去重可用simhash算法，对于重复内容，优先去除较短的文本内容。\n*   **表格类文档：**该类文件一般要求是带表头的csv和excel文件，可在固定位置放置表的标题和表的备注。一般根据长度限制先按列进行拆分，再考虑按行拆分，列拆分通常需要保留第一列，且要求每条数据加上第一列的内容后，字符数不超过限制，否则做摘要处理。每个拆分后的子表需要使用大模型做增强信息，以此来提高数据的检出率。因子表缺少全局信息，可以在拆分内容中加入全表的一些基础统计信息，比如：数值型数据的平均值、最大值、最小值，类别型数据的最高频值和最低频值等。\n\n1.2. 长文档数据处理\n------------\n\n*   **分隔符定义：**标题与内容或子标题（：）；标题类别与标题（-）；并列标题（；）；段落之间（ ）。\n*   **标题处理：**每个文本块都要引入各级标题内容，书名或文档名按最大一级标题处理，纳入文件下每个文本块的文本内容中。\n    \n*   **段落级处理：**段落内容直接入库或摘要后入库。\n*   **句级处理（保留，暂未采用）：**针对做了摘要的超长原始段落内容，按语义切分后直接入库。\n*   **章节级处理：**全文按各章节标题切分，各级章节内容处理方式如下：  \n    （1）若无子标题且是单段落内容：段落级处理已完成，无需重复处理。  \n    （2）若无子标题且是多段落内容：所有章节内容去重后直接入库或摘要（超长内容）后入库。  \n    （3）若有子标题且是单段落内容：提取出明确的标题关系才入库（若段落内容超出大模型长度，先做摘要再提取标题关系）  \n    （4）若有子标题且是多段落内容：所有章节内容做摘要的同时需提取标题关系生成最终内容再入库。\n*   **摘要处理：**根据文本块内容类型，选择不同的摘要处理方式：  \n    （1）纯摘要：可选短文本摘要'summary'、分知识点摘要'point\\_summary'、问答对生成'qa\\_generation'三种方式，默认为智能方式（即文本长度不超过2倍块长度时，使用'summary'方式，否则使用'point\\_summary'方式）。  \n    （2）标题关系提取：只支持'summary'摘要方式。  \n    （3）摘要及标题关系提取：可选'summary'和'point\\_summary'方式，默认为智能方式（即文本长度不超过2倍块长度时，使用'summary'方式，否则使用'point\\_summary'方式）\n\n1.3. 表格数据处理\n-----------\n\n● **基本要求：**格式统一（列名规范在一个单元格内，标题和附加信息统一放在指定区域，一个sheet只能有一个表格内容）。  \n● **预处理：**根据列的类型（数值型、类别型）做基础统计（平均值、最大最小值、中位数、频率等），并生成统计信息；  \n● **大模型增强信息：**将表格相关内容输入大模型，让大模型生成拓展信息（表格的功能场景、关键词别名等）。  \n● **最终处理：**整合统计信息（可选，根据内容长度限制做取舍）、大模型生成的拓展信息和原表格数据内容，作为文本块构建表格知识库。\n\n2\\. 检索技术\n========\n\n2.1. 开源向量化模型选择\n--------------\n\nrank\n\nmodel\n\nmodel size (GB)\n\n向量维度\n\n最长tokens\n\n平均检索得分\n\nrank\n\nmodel\n\nmodel size (GB)\n\n向量维度\n\n最长tokens\n\n平均检索得分\n\n1\n\n[BAAI/bge-large-zh-v1.5](https://huggingface.co/BAAI/bge-large-zh-v1.5)\n\n1.3\n\n1024\n\n512\n\n70.46\n\n2\n\n[BAAI/bge-base-zh-v1.5](https://huggingface.co/BAAI/bge-base-zh-v1.5)\n\n0.41\n\n768\n\n512\n\n69.49\n\n3\n\n[BAAI/bge-small-zh-v1.5](https://huggingface.co/BAAI/bge-small-zh-v1.5)\n\n0.1\n\n512\n\n512\n\n61.77\n\n4\n\n[moka-ai/m3e-base](https://huggingface.co/moka-ai/m3e-base)\n\n0.41\n\n768\n\n512\n\n56.91\n\n5\n\n[moka-ai/m3e-large](https://huggingface.co/moka-ai/m3e-large)\n\n0.41\n\n768\n\n512\n\n54.75\n\n6\n\n[GanymedeNil/text2vec-large-chinese](https://huggingface.co/GanymedeNil/text2vec-large-chinese)\n\n1.3\n\n1024\n\n512\n\n41.94\n\n7\n\n[GanymedeNil/text2vec-base-chinese](https://huggingface.co/shibing624/text2vec-base-chinese)\n\n0.41\n\n768\n\n512\n\n38.79\n\n从公开数据评测榜单 [leaderboard](https://huggingface.co/spaces/mteb/leaderboard) 来看，bge 向量化模型在中文检索场景中得分较高，但这不一定适用于真实的生产场景，具体选用哪个向量化模型还需要基于场景数据进行评估。我们当前的技术实践暂时统一使用的[BAAI/bge-base-zh-v1.5](https://huggingface.co/BAAI/bge-base-zh-v1.5)模型。\n\n2.2. 向量模型部署\n-----------\n\n### 2.2.1. 向量模型并发推理\n\n当前使用CPU部署的向量模型，基本也是几十毫秒就能完成一次计算，基本满足在线推理的需求。且考虑到并发需求，使用uwsgi开启了多进程的服务。\n\n### 2.2.2. 向量化知识库构建加速\n\n采用 pandas 多进程或 swift 加速 apply，能有一定的速率提升，但GPU不支持。经测试，[bge-base-zh-v1.5](https://huggingface.co/BAAI/bge-base-zh-v1.5) 模型部署在单张 16 G V100 GPU 上的向量化速率是纯 CPU 速率的10-20倍左右。故对于向量知识库构建这种需要大量计算的场景，采用了GPU部署。\n\n2.3. 知识召回\n---------\n\n采用向量+关键词的混合召回方式，能有效提升召回效果，但权重和阈值的设定较为复杂。当前技术实践均使用这种混合召回方式，每次更新数据，都需要测评检出情况，以此来选择最佳权重和阈值。\n\n需要特别注意的是 FAQ 类数据的检索召回比较特殊，因数据涉及许多相似问，其答案是一样的，本质上是一条知识的多种表述，故此场景下，只需要在召回的每组相似问知识中取得分最高的一条数据就行。\n\n[Filter table data](#)[Create a pivot table](#)[Create a chart from data series](#)\n\n[Configure buttons visibility](/users/tfac-settings.action)"
}