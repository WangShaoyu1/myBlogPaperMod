{
	"title": "微信小程序运行虚拟人方案",
	"author": "王宇",
	"publishTime": "九月06,2023",
	"readTime": "12s",
	"tags": "[\"数字员工（H5）\"]",
	"description": "数字员工（H5）",
	"article": "背景\n==\n\n需要获取用户信息分析用户数据，需要跑在小程序，获取openId\n\n选型\n==\n\n1.小程序里嵌套web-view\n================\n\n1.  通信成本\n2.  维护两个应用，小程序和h5\n3.  兼容问题\n\n  \n\n2.uniapp打包\n==========\n\n1.  本地调试麻烦，目前脚手架跑不起来https(用来调试语音)\n2.  兼容问题，可能跑不了(20230724构建失败)\n\n  \n\n3.直接小程序写\n========\n\nH5的sdk需要挂载dom节点初始化，但小程序不能操作dom\n\n  \n\n问题\n==\n\n1.杀掉小程序，webview里的storage丢失\n--------------------------\n\n比较多功能涉及到storage能力，比较麻烦\n\n### 方案1\n\nwebview（H5）先读取小程序里的storage，同步到自己的localstorage，后面的所有localstorage操作同步到小程序的storage\n\n<webview>H5</webview>\n\n小程序\n\n挂载后赋值\n\n更新\n\n更新\n\n![](data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0Ij48cGF0aCBkPSJNMjEuOTkgNGMwLTEuMS0uODktMi0xLjk5LTJINGMtMS4xIDAtMiAuOS0yIDJ2MTJjMCAxLjEuOSAyIDIgMmgxNGw0IDQtLjAxLTE4ek0xOCAxNEg2di0yaDEydjJ6bTAtM0g2VjloMTJ2MnptMC0zSDZWNmgxMnYyeiIvPjxwYXRoIGQ9Ik0wIDBoMjR2MjRIMHoiIGZpbGw9Im5vbmUiLz48L3N2Zz4= \"显示评论\")\n\n//<!\\[CDATA\\[ (function() { $ = AJS.$; var graphContainer = document.getElementById('drawio-macro-content-98d8b561-d040-41c2-9454-5e08465c00ec'); DrawioProperties = { contextPath : AJS.contextPath(), buildNumber : 8401 }; var readerOpts = {}; readerOpts.loadUrl = '' + '/rest/drawio/1.0/diagram/crud/%E6%9C%AA%E5%91%BD%E5%90%8D%E7%BB%98%E5%9B%BE/105268443?revision=6'; readerOpts.imageUrl = '' + '/download/attachments/105268443/未命名绘图.png' + '?version=6&api=v2'; readerOpts.editUrl = '' + '/plugins/drawio/addDiagram.action?ceoId=105268443&owningPageId=105268443&diagramName=%E6%9C%AA%E5%91%BD%E5%90%8D%E7%BB%98%E5%9B%BE&revision=6'; readerOpts.editable = true; readerOpts.canComment = true; readerOpts.stylePath = STYLE\\_PATH; readerOpts.stencilPath = STENCIL\\_PATH; readerOpts.imagePath = IMAGE\\_PATH + '/reader'; readerOpts.border = true; readerOpts.width = '400'; readerOpts.simpleViewer = false; readerOpts.tbstyle = 'top'; readerOpts.links = 'auto'; readerOpts.lightbox = true; readerOpts.resourcePath = ATLAS\\_RESOURCE\\_BASE + '/resources/viewer'; readerOpts.disableButtons = false; readerOpts.zoomToFit = true; readerOpts.language = 'zh'; readerOpts.licenseStatus = 'OK'; readerOpts.contextPath = AJS.contextPath(); readerOpts.diagramName = decodeURIComponent('%E6%9C%AA%E5%91%BD%E5%90%8D%E7%BB%98%E5%9B%BE'); readerOpts.diagramDisplayName = ''; readerOpts.aspect = ''; readerOpts.ceoName = '微信小程序运行虚拟人方案'; readerOpts.attVer = '6'; readerOpts.attId = '109710023'; readerOpts.lastModifierName = '吴家杰'; readerOpts.lastModified = '2023-09-06 15:28:14.444'; readerOpts.creatorName = '吴家杰'; //Embed macro specific info readerOpts.extSrvIntegType = '$extSrvIntegType'; readerOpts.gClientId = '$gClientId'; readerOpts.oClientId = '$oClientId'; readerOpts.service = '$service'; readerOpts.sFileId = '$sFileId'; readerOpts.odriveId = '$odriveId'; readerOpts.diagramUrl = '$diagramUrl'; readerOpts.csvFileUrl = '$csvFileUrl'; readerOpts.pageId = '$pageId' || Confluence.getContentId(); readerOpts.aspectHash = '$aspectHash'; readerOpts.useExternalImageService = '$useExternalImageService' == 'true'; readerOpts.isTemplate = '$isTemplate' == 'true'; if (readerOpts.width == '') { readerOpts.width = null; } // LATER: Check if delayed loading of resources can be used for image placeholder mode var viewerPromise = createViewer(graphContainer, readerOpts); if(readerOpts.editable) { $(graphContainer).data('viewerConfig', readerOpts); $(graphContainer).on('drawioViewerUpdate', updateDrawioViewer); } viewerPromise.done(function(viewer) { updateCachedDiagram(graphContainer, readerOpts, viewer); }); })(); //\\]\\]>\n\n#### 优点：简单理解\n\n#### 缺点：侵入原本的H5项目，增加胶水代码\n\n  \n\n### 方案二\n\n类似方案1，webview（H5）先读取小程序里的storage，直接通信操作小程序storage，区别是不用再操作H5的localstorage\n\n<webview>H5</webview>\n\n小程序\n\n挂载后赋值\n\n操作\n\n操作\n\n![](data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0Ij48cGF0aCBkPSJNMjEuOTkgNGMwLTEuMS0uODktMi0xLjk5LTJINGMtMS4xIDAtMiAuOS0yIDJ2MTJjMCAxLjEuOSAyIDIgMmgxNGw0IDQtLjAxLTE4ek0xOCAxNEg2di0yaDEydjJ6bTAtM0g2VjloMTJ2MnptMC0zSDZWNmgxMnYyeiIvPjxwYXRoIGQ9Ik0wIDBoMjR2MjRIMHoiIGZpbGw9Im5vbmUiLz48L3N2Zz4= \"显示评论\")\n\n//<!\\[CDATA\\[ (function() { $ = AJS.$; var graphContainer = document.getElementById('drawio-macro-content-4122fdf3-ac28-405d-a99a-589d17b46ea5'); DrawioProperties = { contextPath : AJS.contextPath(), buildNumber : 8401 }; var readerOpts = {}; readerOpts.loadUrl = '' + '/rest/drawio/1.0/diagram/crud/%E6%9C%AA%E5%91%BD%E5%90%8D%E7%BB%98%E5%9B%BE%31/105268443?revision=1'; readerOpts.imageUrl = '' + '/download/attachments/105268443/未命名绘图1.png' + '?version=1&api=v2'; readerOpts.editUrl = '' + '/plugins/drawio/addDiagram.action?ceoId=105268443&owningPageId=105268443&diagramName=%E6%9C%AA%E5%91%BD%E5%90%8D%E7%BB%98%E5%9B%BE%31&revision=1'; readerOpts.editable = true; readerOpts.canComment = true; readerOpts.stylePath = STYLE\\_PATH; readerOpts.stencilPath = STENCIL\\_PATH; readerOpts.imagePath = IMAGE\\_PATH + '/reader'; readerOpts.border = true; readerOpts.width = '400'; readerOpts.simpleViewer = false; readerOpts.tbstyle = 'top'; readerOpts.links = 'auto'; readerOpts.lightbox = true; readerOpts.resourcePath = ATLAS\\_RESOURCE\\_BASE + '/resources/viewer'; readerOpts.disableButtons = false; readerOpts.zoomToFit = true; readerOpts.language = 'zh'; readerOpts.licenseStatus = 'OK'; readerOpts.contextPath = AJS.contextPath(); readerOpts.diagramName = decodeURIComponent('%E6%9C%AA%E5%91%BD%E5%90%8D%E7%BB%98%E5%9B%BE%31'); readerOpts.diagramDisplayName = ''; readerOpts.aspect = ''; readerOpts.ceoName = '微信小程序运行虚拟人方案'; readerOpts.attVer = '1'; readerOpts.attId = '109710039'; readerOpts.lastModifierName = '吴家杰'; readerOpts.lastModified = '2023-09-06 15:28:44.223'; readerOpts.creatorName = '吴家杰'; //Embed macro specific info readerOpts.extSrvIntegType = '$extSrvIntegType'; readerOpts.gClientId = '$gClientId'; readerOpts.oClientId = '$oClientId'; readerOpts.service = '$service'; readerOpts.sFileId = '$sFileId'; readerOpts.odriveId = '$odriveId'; readerOpts.diagramUrl = '$diagramUrl'; readerOpts.csvFileUrl = '$csvFileUrl'; readerOpts.pageId = '$pageId' || Confluence.getContentId(); readerOpts.aspectHash = '$aspectHash'; readerOpts.useExternalImageService = '$useExternalImageService' == 'true'; readerOpts.isTemplate = '$isTemplate' == 'true'; if (readerOpts.width == '') { readerOpts.width = null; } // LATER: Check if delayed loading of resources can be used for image placeholder mode var viewerPromise = createViewer(graphContainer, readerOpts); if(readerOpts.editable) { $(graphContainer).data('viewerConfig', readerOpts); $(graphContainer).on('drawioViewerUpdate', updateDrawioViewer); } viewerPromise.done(function(viewer) { updateCachedDiagram(graphContainer, readerOpts, viewer); }); })(); //\\]\\]>\n\n#### 优点：简单理解\n\n#### 缺点：侵入原本的H5项目，增加胶水代码\n\n2.额外通信成本\n--------\n\n### webview端\n\n[?](#)\n\n`wx.miniProgram.postMessage({`  \n\n  `data:` `'hello world'`\n\n`})`\n\n  \n\n### 小程序端\n\n[微信开发文档](https://developers.weixin.qq.com/miniprogram/dev/component/web-view.html)\n\n[?](#)\n\n`<web-view` `class``=``\"data-v-19d3a847\"` `src=``\"[https://vdh-cs.dev.yingzi.com](https://vdh-cs.dev.yingzi.com)\"` `bindmessage=``\"handleBindmessage\"``></web-view>`\n\n  \n\n3.H5唤醒小程序API可能有一定延时，0.3~1秒\n--------------------------\n\n4.web-view一定是撑满全屏的，自定义顶部菜单，悬浮的都没用\n---------------------------------\n\n  \n\n学习资料\n====\n\n[https://developers.weixin.qq.com/community/develop/article/doc/000a0ce2858618976b0a2df3b5bc13](https://developers.weixin.qq.com/community/develop/article/doc/000a0ce2858618976b0a2df3b5bc13)\n\n  \n\n  \n\n  \n\n[Filter table data](#)[Create a pivot table](#)[Create a chart from data series](#)\n\n[Configure buttons visibility](/users/tfac-settings.action)"
}