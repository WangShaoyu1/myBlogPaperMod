{
	"title": "chatgptfunctioncall实现天气预报",
	"author": "王宇",
	"publishTime": "十二月01,2023",
	"readTime": "12s",
	"tags": "[\"任鹏\"]",
	"description": "任鹏",
	"article": "function\\_call和plugin区别是function\\_call是客户端调用，plugin是服务端调用\n\n[https://platform.openai.com/docs/guides/function-calling](https://platform.openai.com/docs/guides/function-calling)\n\n[https://platform.openai.com/docs/plugins/introduction](https://platform.openai.com/docs/plugins/introduction)\n\n1\\. 概述\n======\n\nNotebook 介绍了如何将 Chat Completions API 与外部函数结合使用，以扩展 GPT 模型的功能。包含以下2个部分：\n\n1.  如何使用 functions 参数\n2.  如何使用 function\\_call 参数\n\n本demo做一个天气预报查询，跑在jupyter\n\n首先需要配置环境变量OPENAI\\_API\\_KEY，值为gpt的key\n\n[?](#)\n\n1\n\n`!pip install scipy tenacity tiktoken termcolor openai requests`\n\n[?](#)\n\n1\n\n2\n\n3\n\n4\n\n5\n\n6\n\n7\n\n8\n\n9\n\n10\n\n11\n\n12\n\n13\n\n14\n\n15\n\n16\n\n17\n\n18\n\n19\n\n20\n\n21\n\n22\n\n23\n\n24\n\n25\n\n26\n\n27\n\n28\n\n29\n\n30\n\n`Requirement already satisfied: scipy in c:\\python310\\lib\\site-packages (1.11.4)`\n\n`Requirement already satisfied: tenacity in c:\\python310\\lib\\site-packages (8.2.3)`\n\n`Requirement already satisfied: tiktoken in c:\\python310\\lib\\site-packages (0.5.1)`\n\n`Requirement already satisfied: termcolor in c:\\python310\\lib\\site-packages (2.3.0)`\n\n`Requirement already satisfied: openai in c:\\python310\\lib\\site-packages (0.28.0)`\n\n`Requirement already satisfied: requests in c:\\python310\\lib\\site-packages (2.31.0)`\n\n`Requirement already satisfied: numpy<1.28.0,>=1.21.6 in c:\\python310\\lib\\site-packages (from scipy) (1.26.2)`\n\n`Requirement already satisfied: regex>=2022.1.18 in c:\\python310\\lib\\site-packages (from tiktoken) (2023.10.3)`\n\n`Requirement already satisfied: tqdm in c:\\python310\\lib\\site-packages (from openai) (4.66.1)`\n\n`Requirement already satisfied: aiohttp in c:\\python310\\lib\\site-packages (from openai) (3.9.0)`\n\n`Requirement already satisfied: charset-normalizer<4,>=2 in c:\\python310\\lib\\site-packages (from requests) (3.3.2)`\n\n`Requirement already satisfied: idna<4,>=2.5 in c:\\python310\\lib\\site-packages (from requests) (3.5)`\n\n`Requirement already satisfied: urllib3<3,>=1.21.1 in c:\\python310\\lib\\site-packages (from requests) (2.1.0)`\n\n`Requirement already satisfied: certifi>=2017.4.17 in c:\\python310\\lib\\site-packages (from requests) (2023.11.17)`\n\n`Requirement already satisfied: attrs>=17.3.0 in c:\\python310\\lib\\site-packages (from aiohttp->openai) (23.1.0)`\n\n`Requirement already satisfied: multidict<7.0,>=4.5 in c:\\python310\\lib\\site-packages (from aiohttp->openai) (6.0.4)`\n\n`Requirement already satisfied: yarl<2.0,>=1.0 in c:\\python310\\lib\\site-packages (from aiohttp->openai) (1.9.3)`\n\n`Requirement already satisfied: frozenlist>=1.1.1 in c:\\python310\\lib\\site-packages (from aiohttp->openai) (1.4.0)`\n\n`Requirement already satisfied: aiosignal>=1.1.2 in c:\\python310\\lib\\site-packages (from aiohttp->openai) (1.3.1)`\n\n`Requirement already satisfied: async-timeout<5.0,>=4.0 in c:\\python310\\lib\\site-packages (from aiohttp->openai) (4.0.3)`\n\n`Requirement already satisfied: colorama in c:\\python310\\lib\\site-packages (from tqdm->openai) (0.4.6)`\n\n`WARNING: Ignoring invalid distribution - (c:\\python310\\lib\\site-packages)`\n\n`WARNING: Ignoring invalid distribution -p (c:\\python310\\lib\\site-packages)`\n\n`WARNING: Ignoring invalid distribution -p (c:\\python310\\lib\\site-packages)`\n\n`WARNING: Ignoring invalid distribution -ip (c:\\python310\\lib\\site-packages)`\n\n`WARNING: Ignoring invalid distribution - (c:\\python310\\lib\\site-packages)`\n\n`WARNING: Ignoring invalid distribution -p (c:\\python310\\lib\\site-packages)`\n\n`WARNING: Ignoring invalid distribution -p (c:\\python310\\lib\\site-packages)`\n\n`WARNING: Ignoring invalid distribution -ip (c:\\python310\\lib\\site-packages)`\n\n  \n\n  \n\n[?](#)\n\n`import` `os`\n\n`import` `openai`\n\n`import` `json`\n\n`openai.api_key` `=` `os.getenv(``\"OPENAI_API_KEY\"``)`\n\n`#通过写死返回天气的demo`\n\n`# 实际上你可以调用后台或者外部api`\n\n`def` `get_current_weather(location, unit``=``\"摄氏度\"``):`\n\n    `\"\"\"Get the current weather in a given location\"\"\"`\n\n    `if` `\"北京\"` `in` `location.lower():`\n\n        `return` `json.dumps({``\"location\"``:` `\"北京\"``,` `\"temperature\"``:` `\"10\"``,` `\"unit\"``:` `\"摄氏度\"``})`\n\n    `elif` `\"上海\"` `in` `location.lower():`\n\n        `return` `json.dumps({``\"location\"``:` `\"上海\"``,` `\"temperature\"``:` `\"72\"``,` `\"unit\"``:` `\"华氏度\"``})`\n\n    `elif` `\"广州\"` `in` `location.lower():`\n\n        `return` `json.dumps({``\"location\"``:` `\"广州\"``,` `\"temperature\"``:` `\"22\"``,` `\"unit\"``:` `\"摄氏度\"``})`\n\n    `else``:`\n\n        `return` `json.dumps({``\"location\"``: location,` `\"temperature\"``:` `\"unknown\"``})`\n\n`def` `run_conversation():`\n\n    `# Step 1:发送会话和函数定义给大模型`\n\n    `messages` `=` `[{``\"role\"``:` `\"user\"``,` `\"content\"``:` `\"广州的天气情况？\"``}]`\n\n    `tools` `=` `[`\n\n        `{`\n\n            `\"type\"``:` `\"function\"``,`\n\n            `\"function\"``: {`\n\n                `\"name\"``:` `\"get_current_weather\"``,`\n\n                `\"description\"``:` `\"获取给定城市的天气情况\"``,`\n\n                `\"parameters\"``: {`\n\n                    `\"type\"``:` `\"object\"``,`\n\n                    `\"properties\"``: {`\n\n                        `\"location\"``: {`\n\n                            `\"type\"``:` `\"string\"``,`\n\n                            `\"description\"``:` `\"城市,像北京、上海\"``,`\n\n                        `},`\n\n                        `\"unit\"``: {``\"type\"``:` `\"string\"``,` `\"enum\"``: [``\"摄氏度\"``,` `\"华氏度\"``]},`\n\n                    `},`\n\n                    `\"required\"``: [``\"location\"``],`\n\n                `},`\n\n            `},`\n\n        `}`\n\n    `]`\n\n    `response` `=` `openai.ChatCompletion.create(`\n\n        `model``=``\"gpt-3.5-turbo-1106\"``,`\n\n        `messages``=``messages,`\n\n        `tools``=``tools,`\n\n        `tool_choice``=``\"auto\"``,` \n\n    `)`\n\n    `print``(response)`\n\n    `response_message` `=` `response.choices[``0``].message`\n\n    `tool_calls` `=` `response_message.tool_calls`\n\n    `# Step 2: 模型返回的函数调用`\n\n    `if` `tool_calls:`\n\n        `# Step 3: 调用这个函数`\n\n        `#注意返回的函数可能为空`\n\n        `available_functions` `=` `{`\n\n            `\"get_current_weather\"``: get_current_weather,`\n\n        `}`  `# 例子中只有一个函数，但实际可以有多个`\n\n        `messages.append(response_message)`  `# extend conversation with assistant's reply`\n\n        `# Step 4: 把大模型返回的信息传给函数，把函数的返回值传给大模型`\n\n        `for` `tool_call` `in` `tool_calls:`\n\n            `function_name` `=` `tool_call.function.name`\n\n            `function_to_call` `=` `available_functions[function_name]`\n\n            `function_args` `=` `json.loads(tool_call.function.arguments)`\n\n            `function_response` `=` `function_to_call(`\n\n                `location``=``function_args.get(``\"location\"``),`\n\n                `unit``=``function_args.get(``\"unit\"``),`\n\n            `)`\n\n            `messages.append(`\n\n                `{`\n\n                    `\"tool_call_id\"``: tool_call.``id``,`\n\n                    `\"role\"``:` `\"tool\"``,`\n\n                    `\"name\"``: function_name,`\n\n                    `\"content\"``: function_response,`\n\n                `}`\n\n            `)`  `# extend conversation with function response`\n\n        `second_response` `=` `openai.ChatCompletion.create(`\n\n            `model``=``\"gpt-3.5-turbo-1106\"``,`\n\n            `messages``=``messages,`\n\n        `)`  `#通过大模型获取一个关于函数返回值新的回复`\n\n        `text` `=` `second_response[``'choices'``][``0``][``'message'``][``'content'``]`\n\n        `print``(text)`\n\n    `return` `second_response`\n\n`print``(run_conversation())`\n\n[?](#)\n\n`{`\n\n    `\"id\"``:``\"chatcmpl-8Qne5zppsIzUXkklFfN3JjXP3xjbp\"``,`\n\n    `\"object\"``:``\"chat.completion\"``,`\n\n    `\"created\"``:1701398057,`\n\n    `\"model\"``:``\"gpt-3.5-turbo-1106\"``,`\n\n    `\"choices\"``:[`\n\n        `{`\n\n            `\"index\"``:0,`\n\n            `\"message\"``:{`\n\n                `\"role\"``:``\"assistant\"``,`\n\n                `\"content\"``:``null``,`\n\n                `\"tool_calls\"``:[`\n\n                    `{`\n\n                        `\"id\"``:``\"call_I32tbDLPexTVpgseGpy4jp5y\"``,`\n\n                        `\"type\"``:``\"function\"``,`\n\n                        `\"function\"``:{`\n\n                            `\"name\"``:``\"get_current_weather\"``,`\n\n                            `\"arguments\"``:``\"{\\\"location\\\": \\\"\\u5e7f\\u5dde\\\", \\\"unit\\\": \\\"\\u6444\\u6c0f\\u5ea6\\\"}\"`\n\n                        `}`\n\n                    `}`\n\n                `]`\n\n            `},`\n\n            `\"finish_reason\"``:``\"tool_calls\"`\n\n        `}`\n\n    `],`\n\n    `\"usage\"``:{`\n\n        `\"prompt_tokens\"``:91,`\n\n        `\"completion_tokens\"``:39,`\n\n        `\"total_tokens\"``:130`\n\n    `},`\n\n    `\"system_fingerprint\"``:``\"fp_eeff13170a\"`\n\n`}`\n\n`广州目前的气温是22摄氏度。`\n\n`{`\n\n    `\"id\"``:``\"chatcmpl-8Qne6rcwvpqyw0QpykFqN2SuUsUTP\"``,`\n\n    `\"object\"``:``\"chat.completion\"``,`\n\n    `\"created\"``:1701398058,`\n\n    `\"model\"``:``\"gpt-3.5-turbo-1106\"``,`\n\n    `\"choices\"``:[`\n\n        `{`\n\n            `\"index\"``:0,`\n\n            `\"message\"``:{`\n\n                `\"role\"``:``\"assistant\"``,`\n\n                `\"content\"``:``\"\\u5e7f\\u5dde\\u76ee\\u524d\\u7684\\u6c14\\u6e29\\u662f22\\u6444\\u6c0f\\u5ea6\\u3002\"`\n\n            `},`\n\n            `\"finish_reason\"``:``\"stop\"`\n\n        `}`\n\n    `],`\n\n    `\"usage\"``:{`\n\n        `\"prompt_tokens\"``:86,`\n\n        `\"completion_tokens\"``:17,`\n\n        `\"total_tokens\"``:103`\n\n    `},`\n\n    `\"system_fingerprint\"``:``\"fp_eeff13170a\"`\n\n`}`\n\n  \n\n[![](/s/-vky9ok/8401/008d09724398b50e93468e30a239d4f6d750af9b/4.1.1/_/download/resources/com.atlassian.confluence.plugins.confluence-view-file-macro:view-file-macro-resources/images/placeholder-medium-file.png)functioncall.ipynb](/download/attachments/114666942/functioncall.ipynb?version=1&modificationDate=1701409925669&api=v2)\n\n[Filter table data](#)[Create a pivot table](#)[Create a chart from data series](#)\n\n[Configure buttons visibility](/users/tfac-settings.action)"
}