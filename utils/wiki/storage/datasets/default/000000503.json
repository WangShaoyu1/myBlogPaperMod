{
	"title": "图片延迟加载优化",
	"author": "王宇",
	"publishTime": "一月04,2024",
	"readTime": "12s",
	"tags": "[\"年度报告\"]",
	"description": "年度报告",
	"article": "图片主要以两种形式呈现img标签和background-image，分别以不同方式来做延迟请求资源来避免阻塞首屏渲染\n----------------------------------------------------------\n\n1.img标签\n=======\n\n增加lazy\n\n[?](#)\n\n`<img :src=``\"item.value\"` `loading=``\"lazy\"` `/>`\n\n浏览器看到它会以自己优化的形式来做按需加载\n\n  \n\n2.background-image\n==================\n\n先定义个全局css，需要优化的class都加上img-lazy\n\n[?](#)\n\n`.img-lazy {`\n\n   `background-image``:` `none``!important``;`\n\n `}`\n\n增加js，在需要时调用loadLazyImage\n\n原理带着img-lazy类名的元素进入视口后，移除img-lazy，background-image里的值得以解析，浏览器再去请求资源\n\n[?](#)\n\n`export` `function` `isInViewPort(elm) {`\n\n  `const viewWidth = window.innerWidth || document.documentElement.clientWidth;`\n\n  `const viewHeight =`\n\n    `window.innerHeight || document.documentElement.clientHeight;`\n\n  `const { top, right, bottom, left } = elm.getBoundingClientRect();`\n\n  `return` `top >= 0 && top <= viewHeight && left >= 0;`\n\n`}`\n\n`export` `function` `loadLazyImage () {`\n\n  `const lazyloadImages = document.querySelectorAll(``\".img-lazy\"``);`\n\n  `let lazyloadThrottleTimeout;`\n\n  `function` `lazyload() {`\n\n    `if` `(lazyloadThrottleTimeout) {`\n\n      `clearTimeout(lazyloadThrottleTimeout);`\n\n    `}`\n\n    `lazyloadThrottleTimeout = setTimeout(() => {`\n\n      `lazyloadImages.forEach(img => {`\n\n        `if` `(isInViewPort(img)) {`\n\n          `img.classList.remove(``'img-lazy'``);`\n\n        `}`\n\n      `})`\n\n      `if` `(lazyloadImages.length === 0) {`\n\n        `document.removeEventListener(``'touchmove'``, lazyload)`\n\n        `document.removeEventListener(``'click'``, lazyload)`\n\n      `}`\n\n    `}， 500);` `// 这个时间得斟酌，太快会不触发，例如swiper的切换效果没那么快`\n\n  `}`\n\n  `document.addEventListener(``'touchmove'``, lazyload)`\n\n  `document.addEventListener(``'click'``, lazyload)`\n\n  `return` `lazyload`\n\n`}`\n\n注意：return了lazyload给特殊情况使用，例如这次场景有可能用户一直不触发交互，那就没机会执行懒加载逻辑，需要返回给slicechange时调用一下\n\n[Filter table data](#)[Create a pivot table](#)[Create a chart from data series](#)\n\n[Configure buttons visibility](/users/tfac-settings.action)"
}